<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separação de Cargas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body {
            background-color: #212529;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #2b3035;
            border: 1px solid #495057;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25), 0 2px 3px rgba(0,0,0,0.22);
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.29), 0 6px 6px rgba(0,0,0,0.23);
        }
        .accordion-button {
            background-color: #343a40;
            color: #f8f9fa;
        }
        .accordion-button:not(.collapsed) {
            background-color: #0d6efd;
            color: white;
        }
        .accordion-body {
            background-color: #2b3035;
        }
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: var(--bs-table-striped-bg);
        }
        .status-message {
            min-height: 24px; /* Prevent layout shift */
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        @media print {
            body { background-color: #fff; color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container, .card, .accordion-item, .accordion-body { background-color: #fff !important; color: #000 !important; border: none !important; box-shadow: none !important; }
            .no-print, .d-flex.align-items-center.mb-3, .card.p-3.mb-4.shadow-sm, button, .status-message, .card-subtitle, .accordion-button.collapsed, .accordion-collapse.collapse { display: none !important; }
            .table-responsive { overflow: visible !important; }
            table, th, td { border: 1px solid #dee2e6 !important; color: #000 !important; }
            h1, h2, h3, h4, h5 { color: #000 !important; margin-top: 1rem; margin-bottom: 0.5rem; }
            .accordion-collapse { display: block !important; }
            .accordion-button { display: block !important; background-color: #f8f9fa !important; color: #000 !important; border: 1px solid #dee2e6 !important; margin-bottom: 0.5rem; }
            .accordion-button strong, .accordion-button .badge { color: #000 !important; }
            .bg-warning { background-color: #ffc107 !important; color: black !important; }
            .text-danger { color: #dc3545 !important; }
        }
        #drop-zone-text {
            border: 2px dashed #495057;
            border-radius: .25rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        #drop-zone.border-primary #drop-zone-text {
            border-color: #0d6efd;
        }
        .resultado-container {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-4">
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-truck display-4 me-3"></i>
            <h1 class="mb-0">Dashboard de Separação de Cargas</h1>
        </div>

        <div class="card p-3 mb-4 no-print" id="drop-zone">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold">1. Arraste e solte a planilha:</label>
                    <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display: none;">
                    <div id="drop-zone-text" class="text-center p-5 border-2 border-dashed rounded-3">
                        <p><i class="bi bi-file-earmark-spreadsheet-fill fs-2"></i></p>
                        <p>Arraste o arquivo aqui ou</p>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()"><i class="bi bi-folder2-open me-2"></i>Selecionar Arquivo</button>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Defina a Faixa de Rotas (Opcional):</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-signpost-split-fill"></i></span>
                        <input type="text" class="form-control" id="rotaInicialInput" placeholder="Rota Inicial">
                        <input type="text" class="form-control" id="rotaFinalInput" placeholder="Rota Final">
                    </div>
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100 py-2" id="processarBtn" onclick="processar()" disabled><i class="bi bi-gear-fill me-2"></i>Processar Cargas</button>
                </div>
            </div>
            <div id="status" class="mt-2 status-message"></div>
        </div>
        
        <div class="card p-3 mb-4 no-print">
            <h2 class="card-title h5"><i class="bi bi-sliders me-2"></i>Configurações de Veículos</h2>
            <p class="card-subtitle mb-3 text-body-secondary small">Defina as capacidades preferenciais e os limites máximos de peso/cubagem para cada veículo.</p>
            
            <div class="row g-3 mb-3 border-bottom pb-3">
                <div class="col-md-12"><strong class="text-success">Fiorino</strong></div>
                <div class="col-md-3">
                    <label for="fiorinoMinCapacity" class="form-label">Peso Mín (kg)</label>
                    <input type="number" class="form-control config-input" id="fiorinoMinCapacity" value="300" step="10">
                </div>
                <div class="col-md-3">
                    <label for="fiorinoMaxCapacity" class="form-label">Peso Pref. (kg)</label>
                    <input type="number" class="form-control config-input" id="fiorinoMaxCapacity" value="500" step="10">
                </div>
                <div class="col-md-3">
                    <label for="fiorinoCubage" class="form-label">Cubagem Pref. (m³)</label>
                    <input type="number" class="form-control config-input" id="fiorinoCubage" value="1.5" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetFiorino">Reset Fiorino</button>
                </div>
                <div class="col-md-3"></div>
                <div class="col-md-3">
                    <label for="fiorinoHardMaxCapacity" class="form-label fw-bold">Peso Máx Final (kg)</label>
                    <input type="number" class="form-control config-input" id="fiorinoHardMaxCapacity" value="560" step="10">
                </div>
                 <div class="col-md-3">
                    <label for="fiorinoHardCubage" class="form-label fw-bold">Cubagem Máx Final (m³)</label>
                    <input type="number" class="form-control config-input" id="fiorinoHardCubage" value="1.7" step="0.1">
                </div>
            </div>

            <div class="row g-3 mb-3 border-bottom pb-3">
                <div class="col-md-12"><strong class="text-primary">Van</strong></div>
                <div class="col-md-3">
                    <label for="vanMinCapacity" class="form-label">Peso Mín (kg)</label>
                    <input type="number" class="form-control config-input" id="vanMinCapacity" value="1100" step="10">
                </div>
                <div class="col-md-3">
                    <label for="vanMaxCapacity" class="form-label">Peso Pref. (kg)</label>
                    <input type="number" class="form-control config-input" id="vanMaxCapacity" value="1560" step="10">
                </div>
                <div class="col-md-3">
                    <label for="vanCubage" class="form-label">Cubagem Pref. (m³)</label>
                    <input type="number" class="form-control config-input" id="vanCubage" value="5.0" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetVan">Reset Van</button>
                </div>
                <div class="col-md-3"></div>
                <div class="col-md-3">
                    <label for="vanHardMaxCapacity" class="form-label fw-bold">Peso Máx Final (kg)</label>
                    <input type="number" class="form-control config-input" id="vanHardMaxCapacity" value="1600" step="10">
                </div>
                 <div class="col-md-3">
                    <label for="vanHardCubage" class="form-label fw-bold">Cubagem Máx Final (m³)</label>
                    <input type="number" class="form-control config-input" id="vanHardCubage" value="5.6" step="0.1">
                </div>
            </div>

            <div class="row g-3 mb-3 border-bottom pb-3">
                <div class="col-md-12"><strong class="text-warning">3/4</strong></div>
                <div class="col-md-3">
                    <label for="tresQuartosMinCapacity" class="form-label">Peso Mín (kg)</label>
                    <input type="number" class="form-control config-input" id="tresQuartosMinCapacity" value="2300" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tresQuartosMaxCapacity" class="form-label">Peso Máx (kg)</label>
                    <input type="number" class="form-control config-input" id="tresQuartosMaxCapacity" value="4100" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tresQuartosCubage" class="form-label">Cubagem Máx (m³)</label>
                    <input type="number" class="form-control config-input" id="tresQuartosCubage" value="15.0" step="0.1">
                </div>
                 <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetTresQuartos">Reset 3/4</button>
                </div>
            </div>

             <div class="row g-3">
                 <div class="col-md-12"><strong>Toco</strong></div>
                <div class="col-md-3">
                    <label for="tocoMinCapacity" class="form-label">Peso Mín (kg)</label>
                    <input type="number" class="form-control config-input" id="tocoMinCapacity" value="5000" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tocoMaxCapacity" class="form-label">Peso Máx (kg)</label>
                    <input type="number" class="form-control config-input" id="tocoMaxCapacity" value="8500" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tocoCubage" class="form-label">Cubagem Máx (m³)</label>
                    <input type="number" class="form-control config-input" id="tocoCubage" value="30.0" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetToco">Reset Toco</button>
                </div>
            </div>

            <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-success me-2" id="saveConfig">Salvar Configurações</button>
                <button class="btn btn-danger" id="resetAllConfigs">Resetar Todas</button>
            </div>
             <div id="configStatus" class="mt-2 status-message"></div>
        </div>

        <div class="card p-3 mb-4 no-print">
            <h2 class="card-title h5"><i class="bi bi-slash-circle-fill me-2"></i>Bloqueio Manual de Pedidos</h2>
            <p class="card-subtitle mb-3 text-body-secondary small">Adicione o número de um pedido para impedi-lo de ser incluído em qualquer carga. Lembre-se de clicar em "Processar Cargas" após bloquear para que a alteração tenha efeito.</p>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="bloquearPedidoInput" class="form-label">Número do Pedido a Bloquear:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="bloquearPedidoInput" placeholder="Digite o número do pedido...">
                        <button class="btn btn-danger" type="button" onclick="bloquearPedido()">Bloquear Pedido</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Pedidos Atualmente Bloqueados:</label>
                    <div id="lista-pedidos-bloqueados" class="p-2 border rounded" style="min-height: 40px; background-color: #212529;">
                        <span class="text-muted">Nenhum pedido bloqueado.</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100 border-danger">
                    <div class="card-body">
                        <h2 class="card-title h5 text-danger"><i class="bi bi-slash-circle-fill me-2"></i>Resultado do Bloqueio Manual (após processar)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos removidos da lista geral por terem sido bloqueados manualmente por você.</p>
                        <div id="resultado-bloqueados"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="card-title h5"><i class="bi bi-list-check me-2"></i>Pedidos Disponíveis para Montagem</h2>
                            <div>
                                <button class="btn btn-sm btn-outline-danger ms-2 no-print" onclick="exportarPedidosAtrasados()"><i class="bi bi-file-earmark-excel-fill me-1"></i> Exportar Atrasados</button>
                                <button class="btn btn-sm btn-outline-light no-print" onclick="window.print()"><i class="bi bi-printer-fill me-1"></i> Imprimir Tudo</button>
                            </div>
                        </div>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos que <strong>não possuem CF numérico</strong>, agrupados por rota. Use os botões no painel abaixo para montar as cargas.</p>
                        <div class="input-group mb-3 no-print">
                            <input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar por Nº do Pedido...">
                            <button class="btn btn-outline-secondary" type="button" onclick="buscarPedido()"><i class="bi bi-search"></i></button>
                        </div>
                        <div id="search-result" class="mb-3"></div>
                        <div id="resultado-geral"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark-subtle">
                        <h2 class="card-title h5 mb-0"><i class="bi bi-check2-square me-2"></i>Painel de Montagem de Cargas</h2>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-fill" id="vehicleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="fiorino-tab" data-bs-toggle="tab" data-bs-target="#fiorino-tab-pane" type="button" role="tab"><i class="bi bi-box-seam-fill me-2"></i>Fiorino</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="van-tab" data-bs-toggle="tab" data-bs-target="#van-tab-pane" type="button" role="tab"><i class="bi bi-truck-front-fill me-2"></i>Van</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tres-quartos-tab" data-bs-toggle="tab" data-bs-target="#tres-quartos-tab-pane" type="button" role="tab"><i class="bi bi-truck-flatbed me-2"></i>3/4</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="vehicleTabsContent">
                            <div class="tab-pane fade show active p-3" id="fiorino-tab-pane" role="tabpanel">
                                <p class="card-subtitle text-body-secondary small">Selecione uma rota para montar as Fiorinos. Sobras com potencial de Van serão destacadas.</p>
                                <div class="no-print mt-3" id="botoes-fiorino">
                                    <p class="text-muted">Processe um arquivo para ver as rotas de Fiorino disponíveis.</p>
                                </div>
                                <hr>
                                <div id="resultado-fiorino-geral" class="mt-3"></div>
                            </div>
                            <div class="tab-pane fade p-3" id="van-tab-pane" role="tabpanel">
                                <p class="card-subtitle text-body-secondary small">Selecione uma rota de Van para separar as cargas.</p>
                                <div class="no-print mt-3" id="botoes-van">
                                   <p class="text-muted">Processe um arquivo para ver as rotas de Van disponíveis.</p>
                                </div>
                                <hr>
                                <div id="resultado-van-geral" class="mt-3"></div>
                            </div>
                            <div class="tab-pane fade p-3" id="tres-quartos-tab-pane" role="tabpanel">
                                <p class="card-subtitle text-body-secondary small">Selecione uma rota de 3/4 para separar as cargas.</p>
                                <div class="no-print mt-3" id="botoes-34">
                                    <p class="text-muted">Processe um arquivo para ver as rotas de 3/4 disponíveis.</p>
                                </div>
                                <hr>
                                <div id="resultado-34-geral" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100 border-warning">
                    <div class="card-body">
                        <h2 class="card-title h5 text-warning"><i class="bi bi-sign-turn-right-fill me-2"></i>Pedidos da Rota 1 para Alteração</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos da Rota 1 sem CF numérico e com Coluna 5 específica, que precisam de alteração de rota.</p>
                        <div id="resultado-rota1"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5"><i class="bi bi-lightning-charge-fill me-2"></i>Cargas 3/4 (Formadas Automaticamente)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Cargas formadas a partir de um pedido muito grande na mesma rota.</p>
                        <div id="resultado-tres-quartos"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5"><i class="bi bi-inboxes-fill me-2"></i>Cargas "Toco"</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Grupos de cargas onde a Coluna4/5 contém "TOCO" e o CF se repete.</p>
                        <div id="resultado-toco"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100 border-secondary">
                    <div class="card-body">
                        <h2 class="card-title h5 text-secondary"><i class="bi bi-funnel-fill me-2"></i>Pedidos Filtrados (CF Numérico ou Bloqueados por Regra)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos removidos da lista geral por possuírem CF numérico, ou por pertencerem a clientes com pedidos bloqueados por regra do sistema.</p>
                        <div id="resultado-cf-numerico"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        const agendamentoClientCodes = new Set([
            '1398', '1494', '4639', '4872', '5546', '6896', 'D11238', '17163', '19622', '20350', '22545', '23556', '23761', '24465', '29302', '32462', '32831', '32851', '32869', '32905', '33039', '33046', '33047', '33107', '33388', '33392', '33400', '33401', '33403', '33406', '33420', '33494', '33676', '33762', '33818', '33859', '33907', '33971', '34011', '34096', '34167', '34425', '34511', '34810', '34981', '35050', '35054', '35798', '36025', '36580', '36792', '36853', '36945', '37101', '37589', '37634', '38207', '38448', '38482', '38564', '38681', '38735', 'D38896', '39081', '39177', '39620', '40144', '40442', '40702', '40844', '41233', '42200', '42765', '47244', '47253', '47349', '50151', '50816', '51993', '52780', '53134', '58645', '60900', '61182', '61315', '61316', '61317', '61318', '61324', '63080', '63500', '63705', '64288', '66590', '67660', '67884', '69281', '69286', '69318', '70968', '71659', '73847', '76019', '76580', '77475', '77520', '78895', '79838', '80727', '81353', 'DB3183', '83184', '83634', '85534', 'DB6159', '86350', '86641', '89073', '89151', '90373', '92017', '95092', '95660', '96758', '98227', '99268', '100087', '101246', '101253', '101346', '103518', '105394', '106198', '109288', '110023', '110894', '111145', '111154', '111302', '112207', '112670', '117028', '117123', '120423', '120455', '120473', '120533', '121747', '122155', '122785', '123815', '124320', '125228', '126430', '131476', '132397', '133916', '135395', '135928', '136086', '136260', '137919', '138825', '139013', '139329', '139611', '143102', '44192', '144457', '145014', '145237', '145322', '146644', '146988', '148071', '149598', '150503', '151981', '152601', '152835', '152925', '153289', '154423', '154778', '154808', '155177', '155313', '155368', '155419', '155475', '155823', '155888', '156009', '156585', '156696', '157403', '158235', '159168', '160382', '160982', '161737', '162499', '162789', '163234', '163382', '163458', '164721', '164779', '164780', '164924', '165512', '166195', '166337', '166353', '166468', '166469', '167353', '167810', '167819', '168464', '169863', '169971', '170219', '170220', '170516', '171147', '171160', '171191', '171200', '171320', '171529', '171642', '171863', '172270', '172490', '172656', '172859', '173621', '173964', '173977', '174249', '174593', '174662', '174901', '175365', '175425', '175762', '175767', '175783', '176166', '176278', '176453', '176747', '177327', '177488', '177529', '177883', '177951', '177995', '178255', '178377', '178666', '179104', '179510', '179542', '179690', '180028', '180269', '180342', '180427', '180472', '180494', '180594', '180772', '181012', '181052', '181179', '182349', '182885', '182901', '183011', '183016', '183046', '183048', '183069', '183070', '183091', '183093', '183477', '183676', '183787', '184011', '184038', '189677', '190163', '190241', '190687', '190733', '191148', '191149', '191191', '191902', '191972', '192138', '192369', '192638', '192713', '193211', '193445', '193509', '194432', '194508', '194750', '194751', '194821', '194831', '195287', '195338', '195446', '196084', '196118', '196405', '196446', '196784', '197168', '197249', '197983', '198187', '198438', '198747', '198774', '198796', '198895', '198907', '198908', '199172', '199615', '199625', '199650', '199651', '199713', '199733', '199927', '199991', '200091', '200194', '200239', '200253', '200382', '200404', '200597', '200917', '201294', '201754', '201853', '201936', '201948', '201956', '201958', '201961', '201974', '202022', '202187', '202199', '202714', '203072', '203093', '203201', '203435', '203436', '203451', '203512', '203769', '204895', '204910', '204911', '204913', '204914', '204915', '204917', '204971', '204979', '205108', '205220', '205744', '205803', '206116', '206163', '206208', '206294', '206380', '206628', '206730', '206731', '206994', '207024', '207029', '207403', '207689', '207902', '208489', '208613', '208622', '208741', '208822', '208844', '208853', '208922', '209002', '209004', '209248', '209281', '209321', '209322', '209684', '210124', '210230', '210490', '210747', '210759', '210819', '210852', '211059', '211110', '211276', '211277', '211279', '211332', '211411', '212401', '212417', '212573', '212900', '213188', '213189', '213190', '213202', '213203', '213242', '213442', '213454', '213855', '213909', '213910', '213967', '214046', '214150', '214387', '214433', '214442', '214594', '214746', '215022', '215116', '215160', '215161', '215493', '215494', '215651', '215687', '215733', '215777', '215942', '216112', '216393', '216400', '216630', '216684', '217190', '217283', '217310', '217343', '217545', '217605', '217828', '217871', '217872', '217877', '217949', '217965', '218169', '218196', '218383', '218578', '218580', '218640', '218820', '218845', '219539', '219698', '219715', '219884', '220158', '220183', '220645', '220950', '221023', '221248', '221251', '222164', '222165', '223025', '223379', '223525', '223703', '223727', '223877', '223899', '223900', '223954', '224956', '224957', '224958', '224959', '224961', '224962', '225112', '225408', '225449', '225904', '226903', '226939', '227190', '227387', '228589', '228693', '228695'
        ]);

        function checkAgendamento(pedido) {
            if (!pedido || typeof pedido.Cliente === 'undefined' || pedido.Cliente === null) {
                pedido.Agendamento = 'Não';
                return;
            }
            const normalizedCode = String(pedido.Cliente).replace(/^0+/, '');
            pedido.Agendamento = agendamentoClientCodes.has(normalizedCode) ? 'Sim' : 'Não';
        }
        
        let planilhaData = [];
        let pedidosGeraisAtuais = [];
        let gruposToco = {};
        let pedidosComCFNumericoIsolado = [];
        let pedidosPrioritarios = [];
        let pedidosBloqueados = new Set(); // NOVO: Armazena pedidos bloqueados manualmente
        let rota1SemCarga = [];
        let tocoPedidoIds = new Set();
        let currentLeftoversForPrinting = [];
        let currentAllOrdersForReoptimization = []; // Armazena todos os pedidos da rota para reotimização

        const defaultConfigs = {
            fiorinoMinCapacity: 300, fiorinoMaxCapacity: 500, fiorinoCubage: 1.5, fiorinoHardMaxCapacity: 560, fiorinoHardCubage: 1.7,
            vanMinCapacity: 1100, vanMaxCapacity: 1560, vanCubage: 5.0, vanHardMaxCapacity: 1600, vanHardCubage: 5.6,
            tresQuartosMinCapacity: 2300, tresQuartosMaxCapacity: 4100, tresQuartosCubage: 15.0,
            tocoMinCapacity: 5000, tocoMaxCapacity: 8500, tocoCubage: 30.0
        };

        function saveConfigurations() {
            const configStatus = document.getElementById('configStatus');
            try {
                const configs = {};
                Object.keys(defaultConfigs).forEach(key => { 
                    const element = document.getElementById(key);
                    if (element) configs[key] = element.value; 
                });
                localStorage.setItem('vehicleConfigs', JSON.stringify(configs));
                configStatus.innerHTML = '<p class="text-success">Configurações salvas com sucesso!</p>';
                setTimeout(() => { configStatus.innerHTML = ''; }, 3000);
            } catch (error) {
                configStatus.innerHTML = '<p class="text-danger">Erro ao salvar as configurações.</p>';
            }
        }

        function loadConfigurations() {
            const savedConfigs = localStorage.getItem('vehicleConfigs');
            const configs = savedConfigs ? JSON.parse(savedConfigs) : defaultConfigs;
            Object.keys(configs).forEach(key => {
                const element = document.getElementById(key);
                if (element) { element.value = configs[key]; }
            });
        }
        
        function resetFiorino() {
            document.getElementById('fiorinoMinCapacity').value = defaultConfigs.fiorinoMinCapacity;
            document.getElementById('fiorinoMaxCapacity').value = defaultConfigs.fiorinoMaxCapacity;
            document.getElementById('fiorinoCubage').value = defaultConfigs.fiorinoCubage;
            document.getElementById('fiorinoHardMaxCapacity').value = defaultConfigs.fiorinoHardMaxCapacity;
            document.getElementById('fiorinoHardCubage').value = defaultConfigs.fiorinoHardCubage;
            saveConfigurations();
        }
        function resetVan() {
            document.getElementById('vanMinCapacity').value = defaultConfigs.vanMinCapacity;
            document.getElementById('vanMaxCapacity').value = defaultConfigs.vanMaxCapacity;
            document.getElementById('vanCubage').value = defaultConfigs.vanCubage;
            document.getElementById('vanHardMaxCapacity').value = defaultConfigs.vanHardMaxCapacity;
            document.getElementById('vanHardCubage').value = defaultConfigs.vanHardCubage;
            saveConfigurations();
        }
        function resetTresQuartos() {
            document.getElementById('tresQuartosMinCapacity').value = defaultConfigs.tresQuartosMinCapacity;
            document.getElementById('tresQuartosMaxCapacity').value = defaultConfigs.tresQuartosMaxCapacity;
            document.getElementById('tresQuartosCubage').value = defaultConfigs.tresQuartosCubage;
            saveConfigurations();
        }
        function resetToco() {
            document.getElementById('tocoMinCapacity').value = defaultConfigs.tocoMinCapacity;
            document.getElementById('tocoMaxCapacity').value = defaultConfigs.tocoMaxCapacity;
            document.getElementById('tocoCubage').value = defaultConfigs.tocoCubage;
            saveConfigurations();
        }
        function resetAll() {
            Object.keys(defaultConfigs).forEach(key => { 
                const element = document.getElementById(key);
                if(element) element.value = defaultConfigs[key]; 
            });
            saveConfigurations();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadConfigurations();
            document.getElementById('saveConfig').addEventListener('click', saveConfigurations);
            document.getElementById('resetFiorino').addEventListener('click', resetFiorino);
            document.getElementById('resetVan').addEventListener('click', resetVan);
            document.getElementById('resetTresQuartos').addEventListener('click', resetTresQuartos);
            document.getElementById('resetToco').addEventListener('click', resetToco);
            document.getElementById('resetAllConfigs').addEventListener('click', resetAll);
        });

        const rotaVeiculoMap = {
            '11101': { type: 'fiorino', title: 'Rota 11101' }, '11301': { type: 'fiorino', title: 'Rota 11301' }, '11311': { type: 'fiorino', title: 'Rota 11311' }, '11561': { type: 'fiorino', title: 'Rota 11561' }, '11721': { type: 'fiorino', title: 'Rotas 11721 & 11731', combined: ['11731'] }, '11731': { type: 'fiorino', title: 'Rotas 11721 & 11731', combined: ['11721'] },
            '11102': { type: 'van', title: 'Rota 11102' }, '11331': { type: 'van', title: 'Rota 11331' }, '11341': { type: 'van', title: 'Rota 11341' }, '11342': { type: 'van', title: 'Rota 11342' }, '11351': { type: 'van', title: 'Rota 11351' }, '11521': { type: 'van', title: 'Rota 11521' }, '11531': { type: 'van', title: 'Rota 11531' }, '11551': { type: 'van', title: 'Rota 11551' }, '11571': { type: 'van', title: 'Rota 11571' }, '11701': { type: 'van', title: 'Rota 11701' }, '11711': { type: 'van', title: 'Rota 11711' },
            '11361': { type: 'tresQuartos', title: 'Rota 11361' }, '11501': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11502', '11511'] }, '11502': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11501', '11511'] }, '11511': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11501', '11502'] }, '11541': { type: 'tresQuartos', title: 'Rota 11541' }
        };
        
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');
        const dropZone = document.getElementById('drop-zone');
        const dropZoneText = document.getElementById('drop-zone-text');
        const isNumeric = (str) => str && /^\d+$/.test(String(str).trim());

        fileInput.addEventListener('change', (event) => { handleFile(event.target.files[0]); });
        dropZone.addEventListener('dragover', (event) => { event.stopPropagation(); event.preventDefault(); dropZone.classList.add('border-primary'); });
        dropZone.addEventListener('dragleave', (event) => { event.stopPropagation(); event.preventDefault(); dropZone.classList.remove('border-primary'); });
        dropZone.addEventListener('drop', (event) => { event.stopPropagation(); event.preventDefault(); dropZone.classList.remove('border-primary'); handleFile(event.dataTransfer.files[0]); });

        function handleFile(file) {
            if (!file) return;
            statusDiv.innerHTML = '<p class="text-info">Carregando planilha...</p>';
            processarBtn.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates:true});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    let headerRowIndex = -1, headers = [];
                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && row.includes('Cod_Rota')) { headerRowIndex = i; headers = row.map(h => String(h).trim()); break; }
                    }
                    if (headerRowIndex === -1) throw new Error("Não foi possível encontrar a linha de cabeçalho com 'Cod_Rota'.");
                    const dataRows = rawData.slice(headerRowIndex + 1);
                    planilhaData = dataRows.map(row => { 
                        const pedido = {}; 
                        headers.forEach((header, i) => { 
                            if (header) { 
                                if ((header.toLowerCase() === 'predat' || header.toLowerCase() === 'dat_ped')) {
                                    let cellValue = row[i];
                                    if (typeof cellValue === 'number') {
                                        const date = new Date(Math.round((cellValue - 25569) * 86400 * 1000));
                                        if (!isNaN(date.getTime())) {
                                            pedido[header] = date;
                                        } else {
                                            pedido[header] = '';
                                        }
                                    } else if (cellValue instanceof Date) {
                                       if (!isNaN(cellValue.getTime())) {
                                            pedido[header] = cellValue;
                                        } else {
                                            pedido[header] = '';
                                        }
                                    } else {
                                        pedido[header] = cellValue !== undefined ? cellValue : '';
                                    }
                                } else {
                                    pedido[header] = row[i] !== undefined ? row[i] : ''; 
                                }
                            } 
                        }); 
                        return pedido; 
                    });
                    planilhaData.forEach(checkAgendamento);
                    statusDiv.innerHTML = `<p class="text-success">Planilha \"${file.name}\" carregada. ${planilhaData.length} linhas prontas para processar.</p>`;
                    processarBtn.disabled = false;
                    dropZoneText.innerHTML = `<p>Arquivo \"${file.name}\" carregado.</p><button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Selecionar Outro Arquivo</button>`;
                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Erro ao ler o arquivo:</strong> ${error.message}</p>`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function buscarPedido() {
            const searchInput = document.getElementById('pedidoSearchInput').value.trim();
            const searchResultDiv = document.getElementById('search-result');
            searchResultDiv.innerHTML = '';
            if (!searchInput) return;
            if (planilhaData.length === 0) { searchResultDiv.innerHTML = '<p class="text-warning">Por favor, carregue e processe a planilha primeiro.</p>'; return; }
            let pedidoEncontrado = null; let local = 'Não encontrado'; let accordionId = '';
            pedidoEncontrado = pedidosGeraisAtuais.find(p => String(p.Num_Pedido) === searchInput);
            if (pedidoEncontrado) { local = 'Pedidos Disponíveis para Montagem'; accordionId = 'accordionGeral'; }
            if (!pedidoEncontrado) {
                pedidoEncontrado = pedidosComCFNumericoIsolado.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos Filtrados'; accordionId = 'accordionCF'; }
            }
            if (!pedidoEncontrado) {
                for (const cf in gruposToco) {
                    pedidoEncontrado = gruposToco[cf].pedidos.find(p => String(p.Num_Pedido) === searchInput);
                    if (pedidoEncontrado) { local = `Cargas "Toco" (CF: ${cf})`; accordionId = 'accordionToco'; break; }
                }
            }
            if (!pedidoEncontrado) {
                pedidoEncontrado = rota1SemCarga.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos da Rota 1 para Alteração'; }
            }
            if (!pedidoEncontrado) {
                 const originalPedido = planilhaData.find(p => String(p.Num_Pedido) === searchInput);
                 if (originalPedido) {
                    pedidoEncontrado = originalPedido;
                     if(pedidosBloqueados.has(String(originalPedido.Num_Pedido))) {
                        local = 'Bloqueado Manualmente por você.';
                     } else {
                        local = 'Encontrado na planilha original, mas foi filtrado por alguma regra (bloqueio, tipo de coluna, etc.).';
                     }
                 }
             }
            if (pedidoEncontrado) {
                let buttons = '';
                if (local === 'Pedidos Disponíveis para Montagem') {
                    const isPrioritized = pedidosPrioritarios.includes(String(pedidoEncontrado.Num_Pedido));
                    buttons = `<button class="btn btn-primary btn-sm" onclick="priorizarPedido('${pedidoEncontrado.Num_Pedido}')" ${isPrioritized ? 'disabled' : ''}>${isPrioritized ? 'Prioridade Marcada' : 'Marcar como Prioridade'}</button>
                                       <button class="btn btn-secondary btn-sm ms-2" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`;
                } else if (accordionId) {
                                        buttons = `<button class="btn btn-secondary btn-sm" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`;
                }
                searchResultDiv.innerHTML = `<div class="alert alert-info"><h5>Pedido ${searchInput} encontrado!</h5><p class="mb-1"><strong>Local:</strong> ${local}</p><p class="mb-1"><strong>Cliente:</strong> ${pedidoEncontrado.Nome_Cliente}<br><strong>Peso:</strong> ${pedidoEncontrado.Quilos_Saldo} kg</p>${buttons ? `<div class="mt-2">${buttons}</div>` : ''}</div>`;
            } else { searchResultDiv.innerHTML = '<p class="text-danger">Pedido não encontrado em nenhuma das listas.</p>'; }
        }

        function priorizarPedido(numPedido) { if (!pedidosPrioritarios.includes(numPedido)) { pedidosPrioritarios.push(numPedido); buscarPedido(); } }

        function highlightPedido(numPedido) {
            const row = document.getElementById(`pedido-${numPedido}`);
            if (row) {
                row.classList.toggle('table-info');
                if (row.classList.contains('table-info')) {
                    const collapseEl = row.closest('.accordion-collapse');
                    if (collapseEl && !collapseEl.classList.contains('show')) { bootstrap.Collapse.getOrCreateInstance(collapseEl).show(); }
                    setTimeout(() => { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 350);
                }
            }
        }
        
        // --- INÍCIO: Funções de Bloqueio Manual ---
        function atualizarListaBloqueados() {
            const divLista = document.getElementById('lista-pedidos-bloqueados');
            divLista.innerHTML = '';
            if (pedidosBloqueados.size === 0) {
                divLista.innerHTML = '<span class="text-muted">Nenhum pedido bloqueado.</span>';
                return;
            }
            
            const list = document.createElement('ul');
            list.className = 'list-group';
            pedidosBloqueados.forEach(numPedido => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center py-1';
                item.style.backgroundColor = '#343a40';
                item.innerHTML = `<span>${numPedido}</span> <button class="btn btn-sm btn-outline-secondary" onclick="desbloquearPedido('${numPedido}')">Desbloquear</button>`;
                list.appendChild(item);
            });
            divLista.appendChild(list);
        }

        function bloquearPedido() {
            const input = document.getElementById('bloquearPedidoInput');
            const numPedido = input.value.trim();
            if (numPedido) {
                pedidosBloqueados.add(numPedido);
                input.value = '';
                atualizarListaBloqueados();
            }
        }

        function desbloquearPedido(numPedido) {
            pedidosBloqueados.delete(numPedido);
            atualizarListaBloqueados();
        }
        // --- FIM: Funções de Bloqueio Manual ---

        function resetarEstadoGlobal() {
            pedidosGeraisAtuais = [];
            gruposToco = {};
            pedidosComCFNumericoIsolado = [];
            pedidosPrioritarios = [];
            rota1SemCarga = [];
            tocoPedidoIds.clear();
            currentLeftoversForPrinting = [];
            currentAllOrdersForReoptimization = [];
        }

        function processar() {
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div><span class="text-primary">Processando, por favor aguarde...</span>';
            processarBtn.disabled = true;
            setTimeout(() => {
                const resultadoGeralDiv = document.getElementById('resultado-geral');
                const resultadoTocoDiv = document.getElementById('resultado-toco');
                const resultadoTresQuartosDiv = document.getElementById('resultado-tres-quartos');
                const resultadoCfNumericoDiv = document.getElementById('resultado-cf-numerico');
                const resultadoRota1Div = document.getElementById('resultado-rota1');
                const resultadoBloqueadosDiv = document.getElementById('resultado-bloqueados');
                
                try {
                    if (planilhaData.length === 0) { throw new Error("Nenhum dado de planilha carregado."); }
                    
                    resetarEstadoGlobal();
                    ['resultado-fiorino-geral', 'resultado-van-geral', 'resultado-34-geral', 'resultado-geral', 'resultado-toco', 'resultado-tres-quartos', 'resultado-cf-numerico', 'resultado-rota1', 'resultado-bloqueados'].forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.innerHTML = '';
                    });

                    // Filtragem de pedidos bloqueados manualmente PRIMEIRO
                    let pedidosManualmenteBloqueados = [];
                    let pedidosDisponiveis = [];
                    planilhaData.filter(p => p.Num_Pedido).forEach(p => {
                        if (pedidosBloqueados.has(String(p.Num_Pedido))) {
                            pedidosManualmenteBloqueados.push(p);
                        } else {
                            pedidosDisponiveis.push(p);
                        }
                    });
                    displayPedidosBloqueados(resultadoBloqueadosDiv, pedidosManualmenteBloqueados);


                    const col5ValuesForRota1 = ['TBL 08', 'TBL TODESCHINI'];
                    rota1SemCarga = pedidosDisponiveis.filter(p => {
                        const codRota = String(p.Cod_Rota || '').trim();
                        const cfIsNumeric = isNumeric(p.CF);
                        const col5 = String(p.Coluna5 || '').trim();
                        return codRota === '1' && !cfIsNumeric && col5ValuesForRota1.includes(col5);
                    });
                    const rota1PedidoIds = new Set(rota1SemCarga.map(p => p.Num_Pedido));
                    displayRota1(resultadoRota1Div, rota1SemCarga);

                    let pedidosParaProcessamentoGeral = pedidosDisponiveis.filter(p => !rota1PedidoIds.has(p.Num_Pedido));

                    const rotaInicialInput = document.getElementById('rotaInicialInput').value; const rotaFinalInput = document.getElementById('rotaFinalInput').value;
                    const pedidos = pedidosParaProcessamentoGeral.filter(p => String(p.Coluna4) != '500');

                    const clientesComBloqueio = new Set();
                    pedidos.forEach(p => {
                        if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') {
                            clientesComBloqueio.add(String(p.Cliente));
                        }
                    });

                    const pedidosTocoBase = pedidos.filter(p => (p.Coluna4 && String(p.Coluna4).toUpperCase().includes('TOCO')) || (p.Coluna5 && String(p.Coluna5).toUpperCase().includes('TOCO')));
                    const cfCounts = {};
                    pedidosTocoBase.forEach(p => { if (p.CF && isNumeric(p.CF)) { cfCounts[p.CF] = (cfCounts[p.CF] || 0) + 1; } });
                    const cfsRepetidos = Object.keys(cfCounts).filter(cf => cfCounts[cf] > 1);
                    const pedidosTocoFiltrados = pedidosTocoBase.filter(p => cfsRepetidos.includes(String(p.CF)));
                    gruposToco = pedidosTocoFiltrados.reduce((acc, p) => {
                        const cf = p.CF;
                        if (!acc[cf]) { acc[cf] = { pedidos: [], totalKg: 0 }; } acc[cf].pedidos.push(p); acc[cf].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc;
                    }, {});
                    displayToco(resultadoTocoDiv, gruposToco);
                    tocoPedidoIds = new Set(pedidosTocoFiltrados.map(p => String(p.Num_Pedido)));

                    const rotaMin = rotaInicialInput ? parseInt(rotaInicialInput, 10) : 0; const rotaMax = rotaFinalInput ? parseInt(rotaFinalInput, 10) : 99999;
                    let pedidosParaProcessamento = [];
                    
                    pedidos.forEach(p => {
                        if (tocoPedidoIds.has(String(p.Num_Pedido))) return;
                        if (clientesComBloqueio.has(String(p.Cliente))) {
                            pedidosComCFNumericoIsolado.push(p);
                            return;
                        }
                        if (['21', '23', '17'].includes(String(p.Coluna4))) return;
                        const rotaAtualNum = parseInt(String(p.Cod_Rota), 10);
                        if (rotaMin > 0 && rotaMax > 0 && !(rotaAtualNum >= rotaMin && rotaAtualNum <= rotaMax)) return;
                        if (isNumeric(p.CF)) {
                            pedidosComCFNumericoIsolado.push(p);
                        } else {
                            pedidosParaProcessamento.push(p);
                        }
                    });
                    
                    displayPedidosCFNumerico(resultadoCfNumericoDiv, pedidosComCFNumericoIsolado);

                    let tresQuartosLoads = [];
                    const MIN_KG_3_4 = parseFloat(document.getElementById('tresQuartosMinCapacity').value);
                    const MAX_KG_3_4 = parseFloat(document.getElementById('tresQuartosMaxCapacity').value);
                    const LARGE_ORDER_KG = 1700;
                    const largeOrdersByRoute = pedidosParaProcessamento.reduce((acc, p) => {
                        const peso = parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                        if (peso >= LARGE_ORDER_KG) { const rota = p.Cod_Rota; if (!acc[rota]) acc[rota] = []; acc[rota].push(p); } return acc;
                    }, {});
                    const pedidosEmCargas3_4 = new Set();
                    Object.keys(largeOrdersByRoute).forEach(rota => {
                        const largeOrders = largeOrdersByRoute[rota];
                        if (largeOrders.length === 1) {
                            const largeOrder = largeOrders[0]; if (pedidosEmCargas3_4.has(largeOrder.Num_Pedido)) return;
                            let newLoad = { pedidos: [largeOrder], totalKg: parseFloat(String(largeOrder.Quilos_Saldo).replace(',', '.')) || 0, rota: rota };
                            const otherOrdersInRoute = pedidosParaProcessamento.filter(p => p.Cod_Rota === rota && p.Num_Pedido !== largeOrder.Num_Pedido).sort((a, b) => (parseFloat(String(b.Quilos_Saldo).replace(',', '.')) || 0) - (parseFloat(String(a.Quilos_Saldo).replace(',', '.')) || 0));
                            for (const order of otherOrdersInRoute) {
                                if (pedidosEmCargas3_4.has(order.Num_Pedido)) continue;
                                const orderKg = parseFloat(String(order.Quilos_Saldo).replace(',', '.')) || 0;
                                if (newLoad.totalKg + orderKg <= MAX_KG_3_4) { newLoad.pedidos.push(order); newLoad.totalKg += orderKg; }
                            }
                            if (newLoad.totalKg >= MIN_KG_3_4) { tresQuartosLoads.push(newLoad); newLoad.pedidos.forEach(p => pedidosEmCargas3_4.add(p.Num_Pedido)); }
                        }
                    });
                    tresQuartosLoads.forEach((load, index) => { load.numero = index + 1; });
                    displayTresQuartos(resultadoTresQuartosDiv, tresQuartosLoads);

                    pedidosGeraisAtuais = pedidosParaProcessamento.filter(p => !pedidosEmCargas3_4.has(p.Num_Pedido));
                    const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => {
                        const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc;
                    }, {});
                    displayGerais(resultadoGeralDiv, gruposGerais);

                    statusDiv.innerHTML = `<p class="text-success">Processamento concluído com sucesso!</p>`;
                } catch (error) { 
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Ocorreu um erro:</strong></p><pre>${error.stack}</pre>`; 
                    console.error(error); 
                } finally {
                    processarBtn.disabled = false;
                }
            }, 50);
        }

        function isOverdue(predat) {
            if (!predat) { return false; }
            const date = predat instanceof Date ? predat : new Date(predat);
            if (isNaN(date)) { return false; } 

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date < today;
        }

        function exportarPedidosAtrasados() {
            if (pedidosGeraisAtuais.length === 0) { alert("Por favor, processe a planilha primeiro para definir as rotas."); return; }
            const pedidosAtrasados = pedidosGeraisAtuais.filter(p => isOverdue(p.Predat));
            if (pedidosAtrasados.length === 0) { alert("Nenhum pedido em atraso encontrado nos resultados processados."); return; }
            const header = [ "Empresa", "Cod_Rota", "Den_Rota", "Cliente", "Nome_Cliente", "AGENDAS/PALLET", "Nome_Repres", "Cod_Supervisor", "Nome_Supervisor", "Cod_Regional", "Nome_Regional", "Num_Pedido", "Quilos_Saldo", "OBS", "Predat", "Cidade", "UF", "Dat_Ped", "BLOQ.", "Coluna4", "Coluna5", "CF", "Descricao_CF", "Cubagem", "PED. ATRASO 3D.", "PED. ATRASO 3D.2", "PED. ATRASO 4D.", "PED. ATRASO 4D.2", "PED. ATRASO 6D.", "PED. ATRASO 6D.2" ];
            const dataToExport = pedidosAtrasados.map(p => {
                const newP = {...p};
                if (newP.Predat instanceof Date) { newP.Predat = newP.Predat.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); }
                return newP;
            });
            const worksheet = XLSX.utils.json_to_sheet(dataToExport, { header: header });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Pedidos Atrasados");
            XLSX.writeFile(workbook, "pedidos_atrasados.xlsx");
        }
        
        function createTable(pedidos, columnsToDisplay) {
            if (!pedidos || pedidos.length === 0) return '';
            const colunasExibir = columnsToDisplay || ['Cod_Rota', 'Cliente', 'Nome_Cliente', 'Agendamento', 'Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cidade', 'Predat', 'BLOQ.', 'Coluna4', 'Coluna5', 'CF'];
            let table = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped"><thead><tr>';
            colunasExibir.forEach(c => table += `<th>${c.replace('_', ' ')}</th>`);
            table += '</tr></thead><tbody>';
            pedidos.forEach(p => {
                const isPriorityRow = pedidosPrioritarios.includes(String(p.Num_Pedido)); // Usado para a cor da linha
                table += `<tr id="pedido-${p.Num_Pedido}" class="${isPriorityRow ? 'table-primary' : ''}">`;
                colunasExibir.forEach(c => {
                    let cellContent = p[c] === undefined || p[c] === null ? '' : p[c];
                    if (c === 'Num_Pedido') { // MUDANÇA: Adiciona o selo de prioridade aqui
                        const isPriority = pedidosPrioritarios.includes(String(p.Num_Pedido));
                        const priorityBadge = isPriority ? ' <span class="badge bg-primary">Prioridade</span>' : '';
                        table += `<td>${cellContent}${priorityBadge}</td>`;
                    } else if (c === 'Agendamento' && cellContent === 'Sim') {
                        table += `<td><span class="badge bg-warning text-dark">${cellContent}</span></td>`;
                    } else if (c === 'Predat' || c === 'Dat_Ped') {
                        let formattedDate = '';
                        const dateObj = cellContent instanceof Date ? cellContent : new Date(cellContent);

                        if (dateObj instanceof Date && !isNaN(dateObj)) {
                            formattedDate = dateObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                        } else {
                            formattedDate = cellContent || '';
                        }
                        
                        if (c === 'Predat' && isOverdue(p.Predat)) {
                            table += `<td><span class="text-danger fw-bold">${formattedDate}</span></td>`;
                        } else {
                            table += `<td>${formattedDate}</td>`;
                        }
                    } else {
                        table += `<td>${cellContent}</td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        function displayGerais(div, grupos) {
            if (Object.keys(grupos).length === 0) { 
                div.innerHTML = '<div class="alert alert-secondary text-center">Nenhum pedido disponível para montagem.</div>'; 
                document.getElementById('botoes-fiorino').innerHTML = '<p class="text-muted">Nenhuma rota de Fiorino encontrada.</p>';
                document.getElementById('botoes-van').innerHTML = '<p class="text-muted">Nenhuma rota de Van encontrada.</p>';
                document.getElementById('botoes-34').innerHTML = '<p class="text-muted">Nenhuma rota de 3/4 encontrada.</p>';
                return; 
            }
            const rotasDisponiveis = new Set(Object.keys(grupos));
            const botoes = { fiorino: '', van: '', tresQuartos: '' };
            const addedButtons = new Set();
            rotasDisponiveis.forEach(rota => {
                const config = rotaVeiculoMap[rota];
                if (config && !addedButtons.has(rota)) {
                    let rotaValue = `'${rota}'`;
                    if (config.combined) {
                        const combinedRoutes = [rota, ...config.combined];
                        rotaValue = `[${combinedRoutes.map(r => `'${r}'`).join(', ')}]`;
                        combinedRoutes.forEach(r => addedButtons.add(r));
                    }
                    const vehicleType = config.type;
                    const colorClass = vehicleType === 'fiorino' ? 'success' : (vehicleType === 'van' ? 'primary' : 'warning');
                    const functionCall = vehicleType === 'fiorino' ? 'separarCargasFiorino' : (vehicleType === 'van' ? 'separarCargasVan' : 'separarCargas34');
                    const divId = vehicleType === 'fiorino' ? 'resultado-fiorino-geral' : (vehicleType === 'van' ? 'resultado-van-geral' : 'resultado-34-geral');
                    const btnId = `btn-${vehicleType}-${rota}`;
                    botoes[vehicleType] += `<button id="${btnId}" class="btn btn-outline-${colorClass} mt-2 me-2" onclick="${functionCall}(${rotaValue}, '${divId}', '${config.title}', this)">${config.title}</button>`;
                }
            });
            document.getElementById('botoes-fiorino').innerHTML = botoes.fiorino || '<p class="text-muted">Nenhuma rota de Fiorino encontrada.</p>';
            document.getElementById('botoes-van').innerHTML = botoes.van || '<p class="text-muted">Nenhuma rota de Van encontrada.</p>';
            document.getElementById('botoes-34').innerHTML = botoes.tresQuartos || '<p class="text-muted">Nenhuma rota de 3/4 encontrada.</p>';
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionGeral">';
            Object.keys(grupos).sort().forEach((rota, index) => {
                const grupo = grupos[rota];
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const veiculo = rotaVeiculoMap[rota]?.type || 'N/D';
                const veiculoNome = veiculo.replace('tresQuartos', '3/4').replace(/^\w/, c => c.toUpperCase());
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingGeral${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral${index}"><strong>Rota: ${rota} (${veiculoNome})</strong> &nbsp; <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${grupo.pedidos.length} pedidos</span> <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span></button></h2><div id="collapseGeral${index}" class="accordion-collapse collapse" data-bs-parent="#accordionGeral"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }
        
        function displayPedidosBloqueados(div, pedidos) {
            if (pedidos.length === 0) {
                div.innerHTML = '<div class="alert alert-secondary text-center">Nenhum pedido bloqueado manualmente no último processamento.</div>';
                return;
            }
            const totalKg = pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
            const totalKgFormatado = totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            let html = `<div class="alert alert-danger"><strong>Total Bloqueado:</strong> ${pedidos.length} pedidos / ${totalKgFormatado} kg</div>`;
            html += createTable(pedidos);
            div.innerHTML = html;
        }

        function displayPedidosCFNumerico(div, pedidos) {
            if (pedidos.length === 0) { div.innerHTML = '<div class="alert alert-secondary text-center">Nenhum pedido filtrado por CF numérico ou por Regra de Bloqueio.</div>'; return; }
            const grupos = pedidos.reduce((acc, p) => {
                const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc;
            }, {});
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionCF">';
            Object.keys(grupos).sort().forEach((rota, index) => {
                const grupo = grupos[rota];
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingCF${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCF${index}"><strong>Rota: ${rota}</strong> &nbsp; <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${grupo.pedidos.length} pedidos</span> <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span></button></h2><div id="collapseCF${index}" class="accordion-collapse collapse" data-bs-parent="#accordionCF"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }

        function displayTresQuartos(div, loads) {
            if (loads.length === 0) { div.innerHTML = '<div class="alert alert-secondary text-center">Nenhuma carga 3/4 formada automaticamente.</div>'; return; }
            let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h4 class="mb-0">Cargas 3/4 (Automático):</h4>${loads.length > 0 ? `<button class="btn btn-sm btn-outline-light no-print" onclick="imprimirGeneric('${div.id}', 'Cargas 3/4 (Automático)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Concluídas</button>` : ''}</div>`;
            loads.forEach(load => {
                const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                html += `<div class="card mb-3"><div class="card-header bg-warning text-dark">Carga 3/4 #${load.numero} (Rota: ${load.rota}) - Total: ${totalKgFormatado} kg</div><div class="card-body">${createTable(load.pedidos)}</div></div>`;
            });
            div.innerHTML = html;
        }
        
        function displayRota1(div, pedidos) {
            if (!pedidos || pedidos.length === 0) {
                div.innerHTML = '<div class="alert alert-secondary text-center">Nenhum pedido da Rota 1 para alteração encontrado.</div>';
                return;
            }

            let html = `
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-warning no-print" onclick="imprimirGeneric('resultado-rota1', 'Pedidos Rota 1 para Alteração')">
                        <i class="bi bi-printer-fill me-1"></i>Imprimir Lista
                    </button>
                </div>
                ${createTable(pedidos, ['Num_Pedido', 'Cliente', 'Nome_Cliente', 'Quilos_Saldo', 'Cidade', 'Predat', 'CF', 'Coluna5'])}
            `;
            div.innerHTML = html;
        }

        function imprimirGeneric(divId, title) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;

            const printWindow = createPrintWindow(title);
            const contentToPrint = divToPrint.cloneNode(true);
            const buttonInContent = contentToPrint.querySelector('button');
            if (buttonInContent) {
                buttonInContent.remove();
            }

            printWindow.document.body.innerHTML = `<h3>${title}</h3>` + contentToPrint.innerHTML;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }

        // --- INÍCIO DA LÓGICA DE OTIMIZAÇÃO COM A NOVA REGRA ---
        function createInitialSolution(pedidos, vehicleType, sortStrategy = 'descending', targetVehicleCount = null, minKgOverride = null, ignoreSpecialClients = false) {
            const MIN_KG = minKgOverride !== null ? minKgOverride : parseFloat(document.getElementById(`${vehicleType}MinCapacity`).value);
            const SOFT_MAX_KG = parseFloat(document.getElementById(`${vehicleType}MaxCapacity`).value);
            const SOFT_MAX_CUBAGE = parseFloat(document.getElementById(`${vehicleType}Cubage`).value);
            const HARD_MAX_KG = document.getElementById(`${vehicleType}HardMaxCapacity`) ? parseFloat(document.getElementById(`${vehicleType}HardMaxCapacity`).value) : SOFT_MAX_KG;
            const HARD_MAX_CUBAGE = document.getElementById(`${vehicleType}HardCubage`) ? parseFloat(document.getElementById(`${vehicleType}HardCubage`).value) : SOFT_MAX_CUBAGE;
            
            let loads = [];
            if (targetVehicleCount) {
                for (let i = 0; i < targetVehicleCount; i++) {
                    loads.push({ pedidos: [], totalKg: 0, totalCubagem: 0 });
                }
            }

            const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO'];
            const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());
            
            const clientGroupsMap = pedidos.reduce((acc, pedido) => {
                const clienteId = pedido.Cliente;
                if (!acc[clienteId]) { acc[clienteId] = { pedidos: [], isSpecial: isSpecialClient(pedido) }; }
                acc[clienteId].pedidos.push(pedido);
                return acc;
            }, {});

            let packableItems = [];
            Object.values(clientGroupsMap).forEach(group => {
                const totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                const totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0);
                if (totalKg > HARD_MAX_KG || totalCubagem > HARD_MAX_CUBAGE) {
                    group.pedidos.forEach(pedido => {
                        packableItems.push({
                            pedidos: [pedido],
                            totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0,
                            totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0,
                            isSpecial: group.isSpecial
                        });
                    });
                } else {
                    packableItems.push({ ...group, totalKg, totalCubagem });
                }
            });
            
            const priorityItems = packableItems.filter(item => item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            const regularItems = packableItems.filter(item => !item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            
            if (sortStrategy === 'ascending') {
                priorityItems.sort((a, b) => a.totalKg - b.totalKg); regularItems.sort((a, b) => a.totalKg - b.totalKg);
            } else {
                priorityItems.sort((a, b) => b.totalKg - a.totalKg); regularItems.sort((a, b) => b.totalKg - a.totalKg);
            }
            packableItems = [...priorityItems, ...regularItems];

            let leftoverItems = [];
            packableItems.forEach(item => {
                if (item.totalKg > HARD_MAX_KG || item.totalCubagem > HARD_MAX_CUBAGE) {
                    leftoverItems.push(item); return;
                }
                
                let placed = false;
                let bestFit = null;

                for (const load of loads) {
                    const newKg = load.totalKg + item.totalKg;
                    const newCubage = load.totalCubagem + item.totalCubagem;
                    
                    let canPlace = true;
                    // --- NOVA REGRA PARA CLIENTES ESPECIAIS ---
                    if (!ignoreSpecialClients && item.isSpecial) {
                        const specialClientName = item.pedidos[0].Nome_Cliente.toUpperCase().trim();
                        const specialClientCodesInLoad = new Set(
                            load.pedidos
                                .filter(p => p.Nome_Cliente && p.Nome_Cliente.toUpperCase().trim() === specialClientName)
                                .map(p => p.Cliente)
                        );
                        item.pedidos.forEach(p => specialClientCodesInLoad.add(p.Cliente));
                        if (specialClientCodesInLoad.size > 2) {
                            canPlace = false;
                        }
                    }
                    // --- FIM DA NOVA REGRA ---

                    if (canPlace && newKg <= HARD_MAX_KG && newCubage <= HARD_MAX_CUBAGE) {
                        const remainingCapacity = (targetVehicleCount ? SOFT_MAX_KG : HARD_MAX_KG) - newKg;
                        if (bestFit === null || remainingCapacity < bestFit.remainingCapacity) {
                            bestFit = { load: load, remainingCapacity: remainingCapacity };
                        }
                    }
                }

                if (bestFit) {
                    bestFit.load.pedidos.push(...item.pedidos);
                    bestFit.load.totalKg += item.totalKg;
                    bestFit.load.totalCubagem += item.totalCubagem;
                    bestFit.load.usedHardLimit = bestFit.load.totalKg > SOFT_MAX_KG || bestFit.load.totalCubagem > SOFT_MAX_CUBAGE;
                    placed = true;
                }

                if (!placed && !targetVehicleCount) {
                    loads.push({
                        pedidos: [...item.pedidos],
                        totalKg: item.totalKg,
                        totalCubagem: item.totalCubagem,
                        usedHardLimit: (item.totalKg > SOFT_MAX_KG || item.totalCubagem > SOFT_MAX_CUBAGE)
                    });
                } else if (!placed && targetVehicleCount) {
                    leftoverItems.push(item);
                }
            });
            
            let finalLoads = [];
            let unplacedFromMinRule = [];
            loads.forEach(load => {
                const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                const allowPriorityOverride = vehicleType !== 'tresQuartos';
                
                if (load.pedidos.length > 0 && (load.totalKg >= MIN_KG || (hasPriority && allowPriorityOverride))) {
                    finalLoads.push(load);
                } else {
                    unplacedFromMinRule.push(...load.pedidos);
                }
            });
            const leftovers = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule);
            return { loads: finalLoads, leftovers };
        }
        
        function createSolutionLargeSmall(pedidos, vehicleType, minKgOverride = null, ignoreSpecialClients = false) {
            const MIN_KG = minKgOverride !== null ? minKgOverride : parseFloat(document.getElementById(`${vehicleType}MinCapacity`).value);
            const SOFT_MAX_KG = parseFloat(document.getElementById(`${vehicleType}MaxCapacity`).value);
            const SOFT_MAX_CUBAGE = parseFloat(document.getElementById(`${vehicleType}Cubage`).value);
            const HARD_MAX_KG = document.getElementById(`${vehicleType}HardMaxCapacity`) ? parseFloat(document.getElementById(`${vehicleType}HardMaxCapacity`).value) : SOFT_MAX_KG;
            const HARD_MAX_CUBAGE = document.getElementById(`${vehicleType}HardCubage`) ? parseFloat(document.getElementById(`${vehicleType}HardCubage`).value) : SOFT_MAX_CUBAGE;
            
            const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO'];
            const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());
            
            const clientGroupsMap = pedidos.reduce((acc, pedido) => {
                const clienteId = pedido.Cliente;
                if (!acc[clienteId]) { acc[clienteId] = { pedidos: [], isSpecial: isSpecialClient(pedido) }; }
                acc[clienteId].pedidos.push(pedido);
                return acc;
            }, {});

            let packableItems = [];
            Object.values(clientGroupsMap).forEach(group => {
                const totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                const totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0);
                if (totalKg > HARD_MAX_KG || totalCubagem > HARD_MAX_CUBAGE) {
                    group.pedidos.forEach(pedido => {
                        packableItems.push({
                            pedidos: [pedido],
                            totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0,
                            totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0,
                            isSpecial: group.isSpecial
                        });
                    });
                } else {
                    packableItems.push({ ...group, totalKg, totalCubagem });
                }
            });
            
            const priorityItems = packableItems.filter(item => item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            const regularItems = packableItems.filter(item => !item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            
            priorityItems.sort((a, b) => b.totalKg - a.totalKg);
            regularItems.sort((a, b) => b.totalKg - a.totalKg);

            packableItems = [...priorityItems, ...regularItems];
            
            let loads = [];
            let usedItems = new Array(packableItems.length).fill(false);

            for (let i = 0; i < packableItems.length; i++) {
                if (usedItems[i]) continue;

                const largeItem = packableItems[i];
                if (largeItem.totalKg > HARD_MAX_KG || largeItem.totalCubagem > HARD_MAX_CUBAGE) {
                    continue;
                }

                let currentLoad = { 
                    pedidos: [...largeItem.pedidos], 
                    totalKg: largeItem.totalKg, 
                    totalCubagem: largeItem.totalCubagem
                };
                usedItems[i] = true;

                for (let j = packableItems.length - 1; j > i; j--) {
                    if (usedItems[j]) continue;

                    const smallItem = packableItems[j];
                    const newKg = currentLoad.totalKg + smallItem.totalKg;
                    const newCubage = currentLoad.totalCubagem + smallItem.totalCubagem;

                    let canPlace = true;
                     // --- NOVA REGRA PARA CLIENTES ESPECIAIS ---
                     if (!ignoreSpecialClients && smallItem.isSpecial) {
                        const specialClientName = smallItem.pedidos[0].Nome_Cliente.toUpperCase().trim();
                        const specialClientCodesInLoad = new Set(
                            currentLoad.pedidos
                                .filter(p => p.Nome_Cliente && p.Nome_Cliente.toUpperCase().trim() === specialClientName)
                                .map(p => p.Cliente)
                        );
                        smallItem.pedidos.forEach(p => specialClientCodesInLoad.add(p.Cliente));
                        if (specialClientCodesInLoad.size > 2) {
                            canPlace = false;
                        }
                    }
                    // --- FIM DA NOVA REGRA ---

                    if (canPlace && newKg <= HARD_MAX_KG && newCubage <= HARD_MAX_CUBAGE) {
                        currentLoad.pedidos.push(...smallItem.pedidos);
                        currentLoad.totalKg = newKg;
                        currentLoad.totalCubagem = newCubage;
                        usedItems[j] = true;
                    }
                }
                currentLoad.usedHardLimit = currentLoad.totalKg > SOFT_MAX_KG || currentLoad.totalCubagem > SOFT_MAX_CUBAGE;
                loads.push(currentLoad);
            }

            let finalLoads = [];
            let unplacedFromMinRule = [];
            loads.forEach(load => {
                const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                const allowPriorityOverride = vehicleType !== 'tresQuartos';
                if (load.pedidos.length > 0 && (load.totalKg >= MIN_KG || (hasPriority && allowPriorityOverride))) {
                    finalLoads.push(load);
                } else {
                    unplacedFromMinRule.push(...load.pedidos);
                }
            });
            
            const leftovers = packableItems.filter((item, index) => !usedItems[index]).flatMap(item => item.pedidos).concat(unplacedFromMinRule);
            return { loads: finalLoads, leftovers };
        }
        
        function runAdvancedOptimization(pedidos, vehicleType, targetVehicleCount = null, minKgOverride = null) {
            if (targetVehicleCount) {
               return createInitialSolution(pedidos, vehicleType, 'descending', targetVehicleCount, minKgOverride);
            }
            
            const initialResult1 = createInitialSolution(pedidos, vehicleType, 'descending', null, minKgOverride);
            const initialResult2 = createInitialSolution(pedidos, vehicleType, 'ascending', null, minKgOverride);

            const pedidosPorCubagemDesc = [...pedidos].sort((a, b) => (parseFloat(String(b.Cubagem).replace(',', '.')) || 0) - (parseFloat(String(a.Cubagem).replace(',', '.')) || 0));
            const initialResult3 = createInitialSolution(pedidosPorCubagemDesc, vehicleType, 'descending', null, minKgOverride);
            
            const pedidosPorCubagemAsc = [...pedidos].sort((a, b) => (parseFloat(String(a.Cubagem).replace(',', '.')) || 0) - (parseFloat(String(b.Cubagem).replace(',', '.')) || 0));
            const initialResult4 = createInitialSolution(pedidosPorCubagemAsc, vehicleType, 'descending', null, minKgOverride);
            
            const initialResult5 = createSolutionLargeSmall(pedidos, vehicleType, minKgOverride);

            const allResults = [initialResult1, initialResult2, initialResult3, initialResult4, initialResult5].map(res => ({
                result: res,
                weight: res.leftovers.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0)
            })).sort((a, b) => a.weight - b.weight);

            let currentState = allResults[0].result;
            let bestCost = allResults[0].weight;
            let bestState = JSON.parse(JSON.stringify(currentState));

            if (bestCost === 0) return bestState;

            let temperature = 1000.0; const coolingRate = 0.99; const absoluteTemperature = 1.0; const MAX_ITERATIONS = 5000;
            for(let i = 0; i < MAX_ITERATIONS && temperature > absoluteTemperature; i++) {
                let neighborState = JSON.parse(JSON.stringify(currentState));
                if (Math.random() < 0.7 && neighborState.leftovers.length > 0) {
                    const leftoverIndex = Math.floor(Math.random() * neighborState.leftovers.length);
                    const orderToMove = neighborState.leftovers[leftoverIndex];
                    if (neighborState.loads.length > 0) {
                        const loadIndex = Math.floor(Math.random() * neighborState.loads.length);
                        const tempLoadPedidos = [...neighborState.loads[loadIndex].pedidos, orderToMove];
                        const tempSolution = createInitialSolution(tempLoadPedidos, vehicleType);
                        if (tempSolution.leftovers.length === 0 && tempSolution.loads.length === 1) {
                            neighborState.loads[loadIndex] = tempSolution.loads[0];
                            neighborState.leftovers.splice(leftoverIndex, 1);
                        }
                    }
                } else if (neighborState.loads.length > 1) {
                    const idx1 = Math.floor(Math.random() * neighborState.loads.length); let idx2 = Math.floor(Math.random() * neighborState.loads.length);
                    if (idx1 === idx2) continue;
                    const load1 = neighborState.loads[idx1]; const load2 = neighborState.loads[idx2];
                    if (load1.pedidos.length === 0 || load2.pedidos.length === 0) continue;
                    const order1Index = Math.floor(Math.random() * load1.pedidos.length); const order2Index = Math.floor(Math.random() * load2.pedidos.length);
                    const newLoad1Pedidos = [...load1.pedidos]; const newLoad2Pedidos = [...load2.pedidos];
                    [newLoad1Pedidos[order1Index], newLoad2Pedidos[order2Index]] = [newLoad2Pedidos[order2Index], newLoad1Pedidos[order1Index]];
                    const tempSolution1 = createInitialSolution(newLoad1Pedidos, vehicleType);
                    const tempSolution2 = createInitialSolution(newLoad2Pedidos, vehicleType);
                    if (tempSolution1.leftovers.length === 0 && tempSolution2.leftovers.length === 0) {
                        neighborState.loads[idx1] = tempSolution1.loads[0];
                        neighborState.loads[idx2] = tempSolution2.loads[0];
                    }
                }
                const currentCost = currentState.leftovers.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                const neighborCost = neighborState.leftovers.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                const deltaCost = neighborCost - currentCost;
                if (deltaCost < 0 || Math.exp(-deltaCost / temperature) > Math.random()) {
                    currentState = neighborState;
                    if (neighborCost < bestCost) {
                        bestState = neighborState; bestCost = neighborCost;
                    }
                }
                temperature *= coolingRate;
            }
            return bestState;
        }
        // --- FIM DA LÓGICA DE OTIMIZAÇÃO ---
        
        function separarCargasGeneric(routeOrRoutes, divId, title, vehicleType, buttonElement, reoptimizing = false, targetVehicleCount = null) {
            const resultadoDiv = document.getElementById(divId);
            resultadoDiv.innerHTML = '<div class="d-flex align-items-center justify-content-center p-5"><div class="spinner-border text-primary" role="status"></div><span class="ms-3">Otimizando e montando cargas...</span></div>';
            
            if (!reoptimizing && buttonElement) { 
                currentLeftoversForPrinting = [];
                currentAllOrdersForReoptimization = [];
                const parentContainer = buttonElement.parentElement;
                parentContainer.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active', 'btn-success', 'btn-primary', 'btn-warning', 'btn-secondary');
                    const originalColorClass = btn.id.includes('fiorino') ? 'success' : (btn.id.includes('van') ? 'primary' : 'warning');
                    btn.classList.add(`btn-outline-${originalColorClass}`);
                    btn.innerHTML = btn.innerHTML.replace('<i class="bi bi-check-circle-fill me-2"></i>', '');
                });
                const colorClass = vehicleType === 'fiorino' ? 'success' : (vehicleType === 'van' ? 'primary' : 'warning');
                buttonElement.classList.remove(`btn-outline-${colorClass}`);
                buttonElement.classList.add(`btn-${colorClass}`, 'active');
                buttonElement.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${title}`;
            }

            setTimeout(() => {
                if (planilhaData.length === 0) {
                    resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>';
                    return;
                }
                
                const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [String(routeOrRoutes)];
                let pedidosRota = reoptimizing ? currentAllOrdersForReoptimization : pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota)));
                
                if (!reoptimizing) {
                    currentAllOrdersForReoptimization = [...pedidosRota];
                }

                let effectiveTargetVehicleCount = targetVehicleCount;
                if (vehicleType === 'tresQuartos' && !reoptimizing) {
                    const minKg = parseFloat(document.getElementById('tresQuartosMinCapacity').value);
                    const maxKg = parseFloat(document.getElementById('tresQuartosMaxCapacity').value);
                    const totalRotaKg = pedidosRota.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                    if (totalRotaKg >= minKg && totalRotaKg <= maxKg) {
                        effectiveTargetVehicleCount = 1;
                    }
                }
                
                let bestResult = runAdvancedOptimization(pedidosRota, vehicleType, effectiveTargetVehicleCount);
                
                let primaryLoads = bestResult.loads;
                let currentLeftovers = bestResult.leftovers;

                primaryLoads.forEach((load, index) => { load.numero = index + 1; });
                const vehicleInfo = {
                    fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                    van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                    tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' }
                };
                let html = '';
                const vInfo = vehicleInfo[vehicleType];
                let summaryTitle = reoptimizing ? `Resultado Reotimizado para ${targetVehicleCount} Veículos` : `Resultados para <strong>${title}</strong>`;
                let summaryHeader = `<div class="d-flex justify-content-between align-items-center mb-3">
                                                 <h4 class="mb-0 h5">${summaryTitle}: 
                                                     <span id="loads-count-${divId}" class="badge bg-light text-dark">${primaryLoads.length} Carga(s)</span> | 
                                                     <span id="leftovers-count-${divId}" class="badge bg-light text-dark">${currentLeftovers.length} Pedido(s) Restante(s)</span>
                                                     <span class="badge bg-info-subtle text-info-emphasis ms-2">Refinamento Iterativo</span>
                                                 </h4>
                                                 <div id="print-button-container-${divId}" class="d-inline-block">
                                                     ${primaryLoads.length > 0 ? `<button class="btn btn-sm btn-outline-light no-print" onclick="imprimirCargasGeneric('${divId}', '${title}')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>` : ''}
                                                 </div>
                                               </div>`;
                html += summaryHeader;
                if (primaryLoads.length === 0) { html += `<div class="alert alert-secondary">Nenhuma carga de ${vInfo.name} foi formada.</div>`; }
                primaryLoads.forEach(load => {
                    html += renderLoadCard(load, vehicleType, vInfo);
                });
                
                if (currentLeftovers.length > 0) {
                    const totalKgUnassigned = currentLeftovers.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                    
                    let actionButton = '';
                    let printButtonHtml = '';
                    
                    const vanMin = parseFloat(document.getElementById('vanMinCapacity').value);
                    const tresQuartosMin = parseFloat(document.getElementById('tresQuartosMinCapacity').value);
                    
                    if (vehicleType === 'fiorino' && totalKgUnassigned >= vanMin) {
                        currentLeftoversForPrinting = [...currentLeftovers];
                        printButtonHtml = `<button class="btn btn-info ms-auto no-print" onclick="imprimirSobras('Possível Carga de Van')"><i class="bi bi-printer-fill me-1"></i>Imprimir Sobra (p/ Van)</button>`;
                    } else if (vehicleType === 'van') {
                        if (totalKgUnassigned >= tresQuartosMin) {
                            currentLeftoversForPrinting = [...currentLeftovers];
                            printButtonHtml = `<button class="btn btn-warning ms-auto no-print" onclick="imprimirSobras('Possível Carga de 3/4')"><i class="bi bi-printer-fill me-1"></i>Imprimir Sobra (p/ 3/4)</button>`;
                        } else if (totalKgUnassigned >= 900) {
                            currentLeftoversForPrinting = [...currentLeftovers];
                            printButtonHtml = `<button class="btn btn-info ms-auto no-print" onclick="imprimirSobras('Sobra para Van')"><i class="bi bi-printer-fill me-1"></i>Imprimir Sobra</button>`;
                            actionButton = `<button class="btn btn-primary btn-sm ms-3 no-print" onclick="tentarFormarVanExtra('${divId}', this, ${primaryLoads.length}, '${title}')"><i class="bi bi-plus-circle-fill me-1"></i>Formar +1 Van da Sobra</button>`;
                        }
                    } else if (vehicleType === 'tresQuartos' && totalKgUnassigned >= tresQuartosMin) {
                        currentLeftoversForPrinting = [...currentLeftovers];
                    }
                    
                    html += `<div id="leftovers-card-${divId}">
                                 <h5 class="mt-4">Pedidos restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h5>
                                 <div class="card mb-3">
                                     <div class="card-header bg-danger text-white d-flex align-items-center">Detalhes dos Pedidos Restantes ${actionButton} ${printButtonHtml}</div>
                                     <div class="card-body">${createTable(currentLeftovers, ['Num_Pedido', 'Quilos_Saldo', 'Agendamento', 'Cubagem', 'Predat', 'Cliente', 'Nome_Cliente', 'Cidade', 'CF'])}</div>
                                 </div>
                               </div>`;
                }
                resultadoDiv.innerHTML = `<div class="resultado-container">${html}</div>`;
            }, 50);
        }

        function tentarFormarVanExtra(divId, buttonElement, initialLoadCount, title) {
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...';

            setTimeout(() => {
                let leftoversToProcess = [...currentLeftoversForPrinting];
                if (leftoversToProcess.length === 0) {
                    alert("Não há sobras para processar.");
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-plus-circle-fill me-1"></i>Formar +1 Van da Sobra';
                    return;
                }
                
                const result = createInitialSolution(leftoversToProcess, 'van', 'descending', null, 900, true);
                
                const extraVanLoads = result.loads;
                const finalLeftovers = result.leftovers;

                if (extraVanLoads.length === 0) {
                    alert("Não foi possível formar uma nova carga de Van com pelo menos 900 kg a partir das sobras.");
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-plus-circle-fill me-1"></i>Formar +1 Van da Sobra';
                    return;
                }

                updateUIAfterExtraVan(divId, extraVanLoads, finalLeftovers, initialLoadCount, title);

            }, 50);
        }

        function updateUIAfterExtraVan(divId, newLoads, finalLeftovers, initialLoadCount, title) {
            const resultadoDiv = document.getElementById(divId);
            const leftoversCard = document.getElementById(`leftovers-card-${divId}`);

            const newTotalLoads = initialLoadCount + newLoads.length;

            const loadsCountEl = document.getElementById(`loads-count-${divId}`);
            if (loadsCountEl) {
                loadsCountEl.innerHTML = `${newTotalLoads} Carga(s)`;
            }

            const leftoversCountEl = document.getElementById(`leftovers-count-${divId}`);
            if (leftoversCountEl) {
                leftoversCountEl.innerHTML = `${finalLeftovers.length} Pedido(s) Restante(s)`;
            }

            const printContainerEl = document.getElementById(`print-button-container-${divId}`);
            if (printContainerEl && initialLoadCount === 0 && newTotalLoads > 0) {
                printContainerEl.innerHTML = `<button class="btn btn-sm btn-outline-light no-print" onclick="imprimirCargasGeneric('${divId}', '${title}')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>`;
            }

            const vInfo = { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' };
            let newLoadsHtml = '';
            newLoads.forEach((load, index) => {
                load.numero = initialLoadCount + index + 1;
                newLoadsHtml += renderLoadCard(load, 'van', vInfo);
            });

            if (leftoversCard) {
                leftoversCard.remove();
            }

            let finalContentHtml = newLoadsHtml;
            currentLeftoversForPrinting = [...finalLeftovers];

            if (finalLeftovers.length > 0) {
                const totalKgUnassigned = finalLeftovers.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                const printButtonHtml = `<button class="btn btn-info ms-auto no-print" onclick="imprimirSobras('Sobra Final')"><i class="bi bi-printer-fill me-1"></i>Imprimir Sobra Final</button>`;
                finalContentHtml += `<div id="leftovers-card-${divId}">
                                                 <h5 class="mt-4">Novos Pedidos Restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h5>
                                                 <div class="card mb-3">
                                                     <div class="card-header bg-danger text-white d-flex align-items-center">
                                                         Detalhes da Sobra Final
                                                         ${printButtonHtml}
                                                     </div>
                                                     <div class="card-body">${createTable(finalLeftovers, ['Num_Pedido', 'Quilos_Saldo', 'Agendamento', 'Cubagem', 'Predat', 'Cliente', 'Nome_Cliente', 'Cidade', 'CF'])}</div>
                                                 </div>
                                               </div>`;
            }
            
            resultadoDiv.insertAdjacentHTML('beforeend', `<div class="resultado-container">${finalContentHtml}</div>`);
        }
        
        function reotimizarComVeiculoExtra(routesStr, divId, title, vehicleType, targetVehicleCount) {
            const routes = routesStr.split(',');
            separarCargasGeneric(routes, divId, title, vehicleType, null, true, targetVehicleCount);
        }
        
        function renderLoadCard(load, vehicleType, vInfo) {
            load.pedidos.sort((a, b) => {
                const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                if (clienteA < clienteB) return -1; if (clienteA > clienteB) return 1;
                return pedidoA.localeCompare(pedidoB);
            });
            const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const totalCubagemFormatado = (load.totalCubagem || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const isPriorityLoad = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
            const priorityBadge = isPriorityLoad ? '<span class="badge bg-light text-dark ms-3">CARGA COM PRIORIDADE</span>' : '';
            const hardLimitBadge = load.usedHardLimit ? '<span class="badge bg-danger-subtle text-danger-emphasis ms-3"><i class="bi bi-exclamation-triangle-fill"></i> CAPACIDADE EXTRA</span>' : '';
            return `<div class="card mb-3 ${isPriorityLoad ? 'border-primary' : ''}"><div class="card-header ${vInfo.colorClass} ${vInfo.textColor}"><i class="bi ${vInfo.icon} me-2"></i>${vInfo.name} #${load.numero} - <i class="bi bi-database me-1"></i>Total: ${totalKgFormatado} kg / <i class="bi bi-rulers me-1"></i>${totalCubagemFormatado} m³ ${priorityBadge} ${hardLimitBadge}</div><div class="card-body">${createTable(load.pedidos)}</div></div>`;
        }
        
        function separarCargasFiorino(routes, divId, title, buttonElement) { separarCargasGeneric(routes, divId, title, 'fiorino', buttonElement); }
        function separarCargasVan(routes, divId, title, buttonElement) { separarCargasGeneric(routes, divId, title, 'van', buttonElement); }
        function separarCargas34(routes, divId, title, buttonElement) { separarCargasGeneric(routes, divId, title, 'tresQuartos', buttonElement); }

        function displayToco(div, grupos) {
            if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="alert alert-secondary text-center">Nenhuma carga "Toco" encontrada.</div>'; return; }
            const MAX_KG_TOCO = parseFloat(document.getElementById('tocoMaxCapacity').value);
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionToco">';
            Object.keys(grupos).sort().forEach((cf, index) => {
                const grupo = grupos[cf]; 
                const pedidos = grupo.pedidos;
                pedidos.sort((a, b) => {
                    const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                    const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                    if (clienteA < clienteB) return -1; if (clienteA > clienteB) return 1;
                    return pedidoA.localeCompare(pedidoB);
                });
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const overWeight = grupo.totalKg > MAX_KG_TOCO;
                const weightBadge = overWeight
                    ? `<span class="badge bg-danger ms-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>${totalKgFormatado} kg (ACIMA DO PESO!)</span>`
                    : `<span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>`;
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingToco${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToco${index}"><strong>CF: ${cf}</strong> &nbsp; <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${pedidos.length} pedidos</span> ${weightBadge}</button></h2><div id="collapseToco${index}" class="accordion-collapse collapse" data-bs-parent="#accordionToco"><div class="accordion-body"><button class="btn btn-sm btn-outline-info mb-3 no-print" onclick="imprimirTocoIndividual('${cf}')"><i class="bi bi-printer-fill me-1"></i>Imprimir esta Carga Toco</button>${createTable(pedidos)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }

        function createPrintWindow(title) {
            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write(`<style>body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .card { break-inside: avoid; margin-bottom: 1rem; page-break-inside: avoid; } .no-print { display: none !important; } .bg-success { background-color: #198754 !important; color: white !important; } .bg-primary { background-color: #0d6efd !important; color: white !important; } .bg-warning { background-color: #ffc107 !important; color: black !important; } .table-responsive { overflow: visible !important; } table, th, td { border: 1px solid #dee2e6 !important; } .table-primary, .table-primary > th, .table-primary > td { --bs-table-bg: #cfe2ff !important; color: #000 !important; } h1, h2, h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }</style></head><body>`);
            return printWindow;
        }
        
        function imprimirSobras(title) {
            if (currentLeftoversForPrinting.length === 0) { alert("Nenhuma sobra para imprimir."); return; }
            const totalKgFormatado = currentLeftoversForPrinting.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const printWindow = createPrintWindow(title);
            let contentToPrint = `<h3>${title} (Pedidos da Sobra) - Total: ${totalKgFormatado} kg</h3>` + createTable(currentLeftoversForPrinting);
            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function imprimirCargasGeneric(divId, title) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;
            
            const completedLoadsCards = divToPrint.querySelectorAll('.card .card-header:not(.bg-danger)');
            
            if (completedLoadsCards.length === 0) { alert("Nenhuma carga concluída para imprimir."); return; }
            
            const printWindow = createPrintWindow('Imprimir: ' + title);
            let contentToPrint = `<h3>${title}</h3>`;
            completedLoadsCards.forEach(header => { contentToPrint += header.closest('.card.mb-3').outerHTML; });
            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }

        function imprimirTocoIndividual(cf) {
            if (!gruposToco[cf]) { alert(`Nenhuma carga Toco encontrada para o CF: ${cf}`); return; }
            const grupo = gruposToco[cf]; const pedidos = grupo.pedidos;
            const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const printWindow = createPrintWindow('Imprimir Carga Toco CF: ' + cf);
            let contentToPrint = `<h3>Carga Toco CF: ${cf} - Total: ${totalKgFormatado} kg</h3>` + createTable(pedidos);
            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
