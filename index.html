<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Separação de Cargas Otimizado</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --dark-bg: #1a1d21;
            --dark-surface: #24282f;
            --dark-border: #3e444c;
            --dark-primary: #3677f5;
            --dark-primary-hover: #528eff;
            --dark-text-primary: #f8f9fa;
            --dark-text-secondary: #adb5bd;
            --highlight-bg: #3465a4;
        }

        body {
            background-color: var(--dark-bg);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            color: var(--dark-text-primary);
        }

        #sidebar {
            width: 290px;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.3);
            background-color: var(--dark-surface);
            padding: 1rem;
        }

        #main-content {
            margin-left: 290px;
            width: calc(100% - 290px);
            animation: fadeIn 0.6s ease-in-out;
            padding: 1.5rem;
            min-height: 100vh;
        }

        #sidebar .nav-link {
            transition: background-color 0.2s ease-in-out;
            color: var(--dark-text-secondary);
        }

        #sidebar .nav-link:hover,
        #sidebar .nav-link.active {
            background-color: var(--dark-primary);
            color: white;
        }

        #sidebar .nav-link .bi {
            color: var(--dark-text-secondary);
        }

        #sidebar .nav-link:hover .bi,
        #sidebar .nav-link.active .bi {
            color: white;
        }

        @media (max-width: 992px) {
            .d-flex {
                flex-direction: column;
            }

            #sidebar {
                position: relative;
                width: 100%;
                min-height: auto;
                margin-bottom: 1rem;
                box-shadow: none;
                border-bottom: 1px solid var(--dark-border);
            }

            #main-content {
                margin-left: 0;
                width: 100%;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .card {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s ease-in-out;
        }

        .card:hover {
            border-color: #4a515a;
        }

        .card-header {
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--dark-border);
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--dark-primary);
            border-color: var(--dark-primary);
        }

        .btn-primary:hover {
            background-color: var(--dark-primary-hover);
            border-color: var(--dark-primary-hover);
        }

        .modal-content {
            background-color: var(--dark-surface);
        }

        .accordion-button {
            background-color: #343a40;
            color: var(--dark-text-primary);
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--dark-primary);
            color: white;
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
        }

        .accordion-body {
            background-color: var(--dark-surface);
        }

        .table {
            --bs-table-bg: var(--dark-surface);
            --bs-table-striped-bg: rgba(255, 255, 255, 0.03);
            --bs-table-hover-bg: rgba(255, 255, 255, 0.06);
            --bs-table-border-color: var(--dark-border);
            color: var(--dark-text-primary);
        }

        thead th {
            background-color: #2b3035;
            font-weight: 500;
            color: var(--dark-text-primary);
        }

        tbody tr {
            cursor: pointer;
        }

        tbody tr:hover,
        tr.client-highlight>td {
            background-color: var(--highlight-bg) !important;
            outline: none;
        }

        .nav-tabs .nav-link {
            color: var(--dark-text-secondary);
            border: none;
            border-bottom: 2px solid transparent;
        }

        .nav-tabs .nav-link.active,
        .nav-tabs .nav-item.show .nav-link {
            color: var(--dark-primary);
            background-color: transparent;
            border-color: var(--dark-primary);
            font-weight: 500;
        }

        .tab-content {
            background-color: rgba(0, 0, 0, 0.1);
            border: 1px solid var(--dark-border);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .drop-zone-card.drag-over {
            border-color: var(--dark-primary);
            border-width: 2px;
            box-shadow: 0 0 15px rgba(54, 119, 245, 0.5);
        }

        .status-message {
            min-height: 24px;
        }

        #processing-modal .modal-dialog {
            max-width: 400px;
        }

        #upload-status {
            min-height: 1.5rem;
            margin-top: 0.25rem;
            font-weight: 600;
            color: lightgreen;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1100;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
    </style>
</head>

<body>

    <div class="d-flex">
        <nav id="sidebar" class="d-flex flex-column p-3 text-white no-print" aria-label="Menu de navegação principal">
            <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <i class="bi bi-truck-front-fill me-2 fs-4 text-primary" aria-hidden="true"></i>
                <span class="fs-5">Otimizador de Cargas</span>
            </div>
            <hr>

            <label for="fileInput" class="form-label small fw-bold">1. Selecione a planilha:</label>
            <input class="form-control form-control-sm" type="file" id="fileInput" accept=".xlsx, .xls, .csv" aria-describedby="upload-status" aria-label="Selecionar arquivo de planilha de pedidos" />
            <div id="upload-status" role="status" aria-live="polite"></div>

            <div class="form-check form-switch mt-2 small">
                <input class="form-check-input" type="checkbox" role="switch" id="autoProcessCheckbox" aria-checked="false" aria-label="Processar ao selecionar arquivo" />
                <label class="form-check-label" for="autoProcessCheckbox">Processar ao selecionar</label>
            </div>

            <div id="filtro-avancado-container" class="mt-3" style="display: none;">
                <label class="form-label small fw-bold">2. Filtros Avançados (Cliente, Rota e Status):</label>
                <input type="text" id="filtroCliente" placeholder="Buscar por Cliente" class="form-control form-control-sm mb-2" aria-label="Filtro por cliente" />
                <input type="text" id="filtroRota" placeholder="Buscar por Rota" class="form-control form-control-sm mb-2" aria-label="Filtro por rota" />
                <select id="filtroStatus" class="form-select form-select-sm" aria-label="Filtro por status do pedido">
                    <option value="">Todos os status</option>
                    <option value="pendente">Pendente</option>
                    <option value="em andamento">Em andamento</option>
                    <option value="entregue">Entregue</option>
                    <option value="cancelado">Cancelado</option>
                </select>
                <button class="btn btn-outline-secondary btn-sm w-100 mt-2" id="limpar-filtros-btn" aria-label="Limpar filtros">Limpar Filtros</button>
            </div>

            <div class="d-grid mt-3">
                <button class="btn btn-primary" id="processarBtn" disabled aria-disabled="true" aria-live="polite" aria-label="Botão para processar cargas">
                    <i class="bi bi-gear-fill me-2"></i>Processar Cargas
                </button>
            </div>
            <div id="status" class="mt-2 status-message small" aria-live="polite"></div>

            <hr>

            <ul class="nav nav-pills flex-column mb-auto" id="sidebar-nav">
                <li class="nav-item mb-1">
                    <a href="#card-resumo-geral-container" class="nav-link rounded-2">
                        <i class="bi bi-bar-chart-line me-2"></i>Resumo
                    </a>
                </li>
                <li class="mb-1">
                    <a href="#workspace-card" class="nav-link rounded-2">
                        <i class="bi bi-tools me-2"></i>Mesas de Trabalho
                    </a>
                </li>
                <li class="mb-1">
                    <a href="#additional-results" class="nav-link rounded-2">
                        <i class="bi bi-card-list me-2"></i>Resultados Adicionais
                    </a>
                </li>
            </ul>

            <hr>

            <div class="d-grid gap-2">
                <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#configModal" aria-label="Abrir configurações e ações manuais">
                    <i class="bi bi-sliders me-2"></i>Configurações & Ações
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="limparResultadosBtn" aria-label="Limpar todos os resultados">
                    <i class="bi bi-eraser-fill me-1"></i>Limpar Tudo
                </button>
            </div>
        </nav>

        <main id="main-content" class="p-4" tabindex="-1" aria-label="Área principal com resultados e controles">

            <h1 class="h3 mb-4">Dashboard de Separação de Cargas</h1>

            <div id="resultado-venda-antecipada" class="mb-4" aria-live="polite"></div>
            <div id="resultado-carga-especial" class="mb-4" aria-live="polite"></div>
            <div id="card-resumo-geral-container" class="mb-4" style="display: none;" aria-live="polite"></div>

            <div class="row" id="workspace-card">
                <div class="col-lg-8 mb-4">
                    <div class="card h-100" role="region" aria-label="Mesa de Trabalho: Montagem de Cargas">
                        <div class="card-header">
                            <h2 class="card-title h5 mb-0"><i class="bi bi-tools me-2"></i>Mesa de Trabalho: Montagem de Cargas</h2>
                        </div>
                        <div class="card-body p-0">

                            <ul class="nav nav-tabs nav-fill px-3 pt-2" id="vehicleTabs" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="fiorino-tab" data-bs-toggle="tab" data-bs-target="#fiorino-tab-pane" type="button" role="tab" aria-controls="fiorino-tab-pane" aria-selected="true"><i class="bi bi-box-seam-fill me-2"></i>Fiorino (Varejo)</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="van-tab" data-bs-toggle="tab" data-bs-target="#van-tab-pane" type="button" role="tab" aria-controls="van-tab-pane" aria-selected="false"><i class="bi bi-truck-front-fill me-2"></i>Van (Varejo)</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="tres-quartos-tab" data-bs-toggle="tab" data-bs-target="#tres-quartos-tab-pane" type="button" role="tab" aria-controls="tres-quartos-tab-pane" aria-selected="false"><i class="bi bi-truck-flatbed me-2"></i>3/4 (Varejo)</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="cf-tab" data-bs-toggle="tab" data-bs-target="#cf-tab-pane" type="button" role="tab" aria-controls="cf-tab-pane" aria-selected="false"><i class="bi bi-truck me-2"></i>CARGAS TRUCK E CARRETA</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="funcionarios-tab" data-bs-toggle="tab" data-bs-target="#funcionarios-tab-pane" type="button" role="tab" aria-controls="funcionarios-tab-pane" aria-selected="false"><i class="bi bi-people-fill me-2"></i>Funcionários</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="transferencias-tab" data-bs-toggle="tab" data-bs-target="#transferencias-tab-pane" type="button" role="tab" aria-controls="transferencias-tab-pane" aria-selected="false"><i class="bi bi-arrow-left-right me-2"></i>Transferências</button></li>
                            </ul>
                            <div class="tab-content" id="vehicleTabsContent">
                                <div class="tab-pane fade show active p-3 workspace-tab-pane" id="fiorino-tab-pane" role="tabpanel" aria-labelledby="fiorino-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota de varejo para montar as Fiorinos.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-fiorino-geral', 'Cargas de Fiorino (Varejo)')" aria-label="Imprimir cargas de Fiorino">
                                            <i class="bi bi-printer-fill me-1"></i>Imprimir Cargas
                                        </button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-fiorino" aria-live="polite" aria-atomic="true"><p class="text-muted">Processe um arquivo para ver as rotas disponíveis.</p></div>
                                    <hr class="no-print" />
                                    <div id="resultado-fiorino-geral" class="mt-3" tabindex="0" aria-live="polite" aria-atomic="true"></div>
                                </div>
                                <div class="tab-pane fade p-3 workspace-tab-pane" id="van-tab-pane" role="tabpanel" aria-labelledby="van-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota de varejo para montar as Vans.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-van-geral', 'Cargas de Van (Varejo)')" aria-label="Imprimir cargas de Van">
                                            <i class="bi bi-printer-fill me-1"></i>Imprimir Cargas
                                        </button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-van" aria-live="polite" aria-atomic="true"><p class="text-muted">Processe um arquivo para ver as rotas disponíveis.</p></div>
                                    <hr class="no-print" />
                                    <div id="resultado-van-geral" class="mt-3" tabindex="0" aria-live="polite" aria-atomic="true"></div>
                                </div>
                                <div class="tab-pane fade p-3 workspace-tab-pane" id="tres-quartos-tab-pane" role="tabpanel" aria-labelledby="tres-quartos-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota de varejo para montar as cargas 3/4.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-34-geral', 'Cargas de 3/4 (Varejo)')" aria-label="Imprimir cargas 3/4">
                                            <i class="bi bi-printer-fill me-1"></i>Imprimir Cargas
                                        </button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-34" aria-live="polite" aria-atomic="true"><p class="text-muted">Processe um arquivo para ver as rotas disponíveis.</p></div>
                                    <hr class="no-print" />
                                    <div id="resultado-34-geral" class="mt-3" tabindex="0" aria-live="polite" aria-atomic="true"></div>
                                </div>
                                <div class="tab-pane fade p-3" id="cf-tab-pane" role="tabpanel" aria-labelledby="cf-tab">
                                    <p class="card-subtitle text-body-secondary small mb-3">Pedidos agrupados por CF, Condor ou Carreta sem CF.</p>
                                    <div id="resultado-cf-accordion-container" aria-live="polite" aria-atomic="true"><p class="text-muted">Processe um arquivo para ver os grupos de cargas.</p></div>
                                </div>
                                <div class="tab-pane fade p-3" id="funcionarios-tab-pane" role="tabpanel" aria-labelledby="funcionarios-tab">
                                    <div id="resultado-funcionarios-tab" aria-live="polite" aria-atomic="true">
                                        <p class="text-muted">Processe um arquivo para ver os pedidos de funcionários.</p>
                                    </div>
                                </div>
                                <div class="tab-pane fade p-3" id="transferencias-tab-pane" role="tabpanel" aria-labelledby="transferencias-tab">
                                    <div id="resultado-transferencias-tab" aria-live="polite" aria-atomic="true">
                                        <p class="text-muted">Processe um arquivo para ver os pedidos de transferência.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card" id="pedidos-disponiveis-card" role="region" aria-label="Pedidos Disponíveis com busca">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="card-title h5 mb-0"><i class="bi bi-list-check me-2"></i>Pedidos Disponíveis (Varejo)</h2>
                            <div class="no-print">
                                <button class="btn btn-sm btn-outline-danger" onclick="exportarPedidosAtrasados()" aria-label="Exportar pedidos atrasados no Excel">
                                    <i class="bi bi-file-earmark-excel-fill me-1"></i>Atrasados
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-subtitle mb-3 text-body-secondary small">Pedidos sem CF numérico, agrupados por rota.</p>
                            <div class="input-group mb-3 no-print">
                                <input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar por Nº do Pedido..." aria-label="Campo para buscar por número do pedido" />
                                <button class="btn btn-outline-secondary" type="button" onclick="buscarPedido()" aria-label="Buscar pedido">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div id="search-result" aria-live="polite" aria-atomic="true"></div>
                            <div id="resultado-geral" aria-live="polite" aria-atomic="true"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="additional-results">
                <hr class="my-4" />
                <h3 class="mb-3">Resultados Adicionais da Análise</h3>

                <div class="card mb-4 border-danger" role="region" aria-label="Pedidos Bloqueados Manualmente">
                    <div class="card-header bg-danger-subtle text-danger-emphasis">
                        <h2 class="card-title h5 mb-0"><i class="bi bi-slash-circle-fill me-2"></i>Pedidos Bloqueados Manualmente</h2>
                    </div>
                    <div class="card-body">
                        <div id="resultado-bloqueados" aria-live="polite" aria-atomic="true"></div>
                    </div>
                </div>

                <div class="card mb-4 border-warning" role="region" aria-label="Pedidos da Rota 1 para Alteração">
                    <div class="card-header bg-warning-subtle text-warning-emphasis">
                        <h2 class="card-title h5 mb-0"><i class="bi bi-sign-turn-right-fill me-2"></i>Pedidos da Rota 1 para Alteração</h2>
                    </div>
                    <div class="card-body">
                        <div id="resultado-rota1" aria-live="polite" aria-atomic="true"></div>
                    </div>
                </div>

                <div class="card mb-4" role="region" aria-label="Cargas Toco">
                    <div class="card-header">
                        <h2 class="card-title h5 mb-0"><i class="bi bi-inboxes-fill me-2"></i>Cargas "Toco"</h2>
                    </div>
                    <div class="card-body">
                        <div id="resultado-toco" aria-live="polite" aria-atomic="true"></div>
                    </div>
                </div>

                <div class="card mb-4 border-secondary" role="region" aria-label="Pedidos Filtrados Bloqueio Varejo">
                    <div class="card-header bg-secondary-subtle text-secondary-emphasis">
                        <h2 class="card-title h5 mb-0"><i class="bi bi-funnel-fill me-2"></i>Pedidos Filtrados (Bloqueio de Varejo por Regra)</h2>
                    </div>
                    <div class="card-body">
                        <div id="resultado-cf-numerico" aria-live="polite" aria-atomic="true"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="loadingOverlay" role="alert" aria-live="assertive" aria-label="Processando cargas, aguarde...">
        <div><i class="bi bi-hourglass-split me-2"></i>Processando cargas, por favor aguarde...</div>
    </div>

    <!-- Modal Configurações & Ações (permanece igual ao seu código original) -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel"><i class="bi bi-sliders me-2"></i>Configurações & Ações Manuais</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- O conteúdo do modal permanece inalterado -->
                    <!-- Recomendado preservar e integrar o script abaixo -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global para dados e cache
        let dadosPedidos = [];
        let cacheFiltros = null;

        // Referências principais
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const uploadStatus = document.getElementById('upload-status');
        const filtroAvancadoContainer = document.getElementById('filtro-avancado-container');
        const filtroCliente = document.getElementById('filtroCliente');
        const filtroRota = document.getElementById('filtroRota');
        const filtroStatus = document.getElementById('filtroStatus');
        const limparFiltrosBtn = document.getElementById('limpar-filtros-btn');
        const statusMessage = document.getElementById('status');
        const loadingOverlay = document.getElementById('loadingOverlay');

        function setStatus(message, isError = false) {
            uploadStatus.textContent = message;
            uploadStatus.style.color = isError ? 'tomato' : 'lightgreen';
            uploadStatus.setAttribute('aria-live', 'polite');
        }

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // Habilitar filtro avançado e botões após arquivo selecionado
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                processarBtn.disabled = false;
                processarBtn.setAttribute('aria-disabled', 'false');
                setStatus('Arquivo selecionado. Você pode aplicar filtros avançados.');
                filtroAvancadoContainer.style.display = 'block';

                if (document.getElementById('autoProcessCheckbox').checked) {
                    processarBtn.click();
                }
            } else {
                processarBtn.disabled = true;
                processarBtn.setAttribute('aria-disabled', 'true');
                setStatus('');
                filtroAvancadoContainer.style.display = 'none';
            }
        });

        // Limpar filtros avançados
        limparFiltrosBtn.addEventListener('click', () => {
            filtroCliente.value = '';
            filtroRota.value = '';
            filtroStatus.value = '';
            cacheFiltros = null;
            if (dadosPedidos.length) {
                exibirPedidos(dadosPedidos);
                statusMessage.textContent = `Filtros limpos. ${dadosPedidos.length} pedidos exibidos.`;
            }
        });

        // Carregar e ler arquivo Excel/CSV de forma assíncrona
        function lerArquivo(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });
                        resolve(jsonData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = () => reject(new Error('Erro ao ler o arquivo.'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Aplicar filtros avançados com cache
        function aplicarFiltros() {
            const valCliente = filtroCliente.value.trim().toLowerCase();
            const valRota = filtroRota.value.trim().toLowerCase();
            const valStatus = filtroStatus.value;

            if (cacheFiltros &&
                cacheFiltros.cliente === valCliente &&
                cacheFiltros.rota === valRota &&
                cacheFiltros.status === valStatus) {
                return cacheFiltros.result;
            }

            const filtrado = dadosPedidos.filter(p => {
                const clienteOk = valCliente ? (p.Cliente && p.Cliente.toLowerCase().includes(valCliente)) : true;
                const rotaOk = valRota ? (p.Rota && p.Rota.toLowerCase().includes(valRota)) : true;
                const statusOk = valStatus ? (p.Status && p.Status.toLowerCase() === valStatus.toLowerCase()) : true;
                return clienteOk && rotaOk && statusOk;
            });

            cacheFiltros = {
                cliente: valCliente,
                rota: valRota,
                status: valStatus,
                result: filtrado
            };

            return filtrado;
        }

        // Função para exibir pedidos na área de resultados gerais
        function exibirPedidos(listaPedidos) {
            const container = document.getElementById('resultado-geral');
            if (!listaPedidos.length) {
                container.innerHTML = '<p class="text-muted">Nenhum pedido encontrado com os filtros aplicados.</p>';
                return;
            }

            let tabela = `<table class="table table-striped" aria-label="Tabela de pedidos processados">
                            <thead>
                                <tr>
                                    <th scope="col">Pedido</th>
                                    <th scope="col">Cliente</th>
                                    <th scope="col">Rota</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Peso (kg)</th>
                                    <th scope="col">Cubagem (m³)</th>
                                </tr>
                            </thead>
                            <tbody>`;

            listaPedidos.forEach(p => {
                tabela += `<tr tabindex="0" aria-label="Pedido número ${p.Pedido}, cliente ${p.Cliente}, rota ${p.Rota}, status ${p.Status}">
                    <td>${p.Pedido}</td>
                    <td>${p.Cliente}</td>
                    <td>${p.Rota}</td>
                    <td>${p.Status}</td>
                    <td>${p.Peso}</td>
                    <td>${p.Cubagem}</td>
                </tr>`;
            });

            tabela += '</tbody></table>';
            container.innerHTML = tabela;
        }

        // Botão processar: leitura, tratamento, filtros e exibição
        processarBtn.addEventListener('click', async () => {
            if (!fileInput.files.length) {
                setStatus('Nenhum arquivo selecionado.', true);
                return;
            }
            processarBtn.disabled = true;
            processarBtn.setAttribute('aria-disabled', 'true');
            setStatus('Carregando arquivo e processando...');
            showLoading(true);
            try {
                const dadosBrutos = await lerArquivo(fileInput.files[0]);
                dadosPedidos = dadosBrutos.map(p => ({
                    Pedido: p.Pedido || p['Número do Pedido'] || 'N/A',
                    Cliente: p.Cliente || p['Cliente'] || 'N/A',
                    Rota: p.Rota || p['Rota'] || 'N/A',
                    Status: p.Status || 'Pendente',
                    Peso: Number(p.Peso) || 0,
                    Cubagem: Number(p.Cubagem) || 0
                }));

                cacheFiltros = null;
                filtroAvancadoContainer.style.display = 'block';

                // Exibe pedidos sem filtro na primeira carga
                exibirPedidos(dadosPedidos);
                statusMessage.textContent = `Arquivo carregado com sucesso! ${dadosPedidos.length} pedidos processados. Aplique os filtros ou processe as cargas.`;

            } catch (error) {
                setStatus('Erro ao processar arquivo: ' + error.message, true);
                dadosPedidos = [];
                document.getElementById('resultado-geral').innerHTML = '';
                statusMessage.textContent = '';
                filtroAvancadoContainer.style.display = 'none';
            } finally {
                showLoading(false);
                processarBtn.disabled = false;
                processarBtn.setAttribute('aria-disabled', 'false');
            }
        });

        // Atualizar tabela ao digitar nos filtros
        [filtroCliente, filtroRota, filtroStatus].forEach(filtro => {
            filtro.addEventListener('input', () => {
                if (!dadosPedidos.length) return;
                const filtrados = aplicarFiltros();
                exibirPedidos(filtrados);
                statusMessage.textContent = `Filtros aplicados. ${filtrados.length} pedidos exibidos.`;
            });
        });

        // Limpar resultados e estado
        document.getElementById('limparResultadosBtn').addEventListener('click', () => {
            dadosPedidos = [];
            cacheFiltros = null;
            fileInput.value = '';
            processarBtn.disabled = true;
            processarBtn.setAttribute('aria-disabled', 'true');
            filtroCliente.value = '';
            filtroRota.value = '';
            filtroStatus.value = '';
            filtroAvancadoContainer.style.display = 'none';
            document.getElementById('resultado-geral').innerHTML = '';
            statusMessage.textContent = '';
            setStatus('');
        });

        // Função de busca rápida por nº pedido (exemplo)
        function buscarPedido() {
            const termo = document.getElementById('pedidoSearchInput').value.trim();
            if (!termo) {
                document.getElementById('search-result').textContent = 'Digite um número para buscar.';
                return;
            }
            if (!dadosPedidos.length) {
                document.getElementById('search-result').textContent = 'Nenhum dado carregado.';
                return;
            }
            const resultado = dadosPedidos.filter(p => p.Pedido.toString().includes(termo));
            let texto = resultado.length ? `Encontrados ${resultado.length} pedido(s): ${resultado.map(r => r.Pedido).join(', ')}` : 'Nenhum pedido encontrado.';
            document.getElementById('search-result').textContent = texto;
        }
    </script>

</body>

</html>
