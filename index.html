<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separação de Cargas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #212529;
        }
        .card {
            background-color: #2b3035;
            border: 1px solid #495057;
        }
        .accordion-button {
            background-color: #343a40;
            color: #f8f9fa;
        }
        .accordion-button:not(.collapsed) {
            background-color: #0d6efd;
            color: white;
        }
        .accordion-body {
            background-color: #2b3035;
        }
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: var(--bs-table-striped-bg);
        }
        .status-message {
            min-height: 24px; /* Prevent layout shift */
        }

        .btn-success, .btn-primary, .btn-warning {
            transition: all 0.2s ease-in-out;
        }

        .btn-success:hover, .btn-primary:hover, .btn-warning:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        /* Estilos para a área de Drag and Drop */
        #drop-zone {
            border: 2px dashed #495057;
            border-radius: .375rem;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #drop-zone.dragover {
            background-color: #343a40;
            border-color: #0d6efd;
        }
        #drop-zone-text {
            color: #adb5bd;
        }
        
        /* Estilo para a barra de progresso nas cargas */
        .progress-container {
            width: 100%;
            font-size: 0.8em;
            margin-top: 5px;
        }

        @media print {
            body {
                background-color: #fff; /* White background for printing */
                color: #000; /* Black text for printing */
            }
            .container, .card, .accordion-item, .accordion-body {
                background-color: #fff !important;
                color: #000 !important;
                border: none !important;
                box-shadow: none !important;
            }
            /* Hide elements not relevant for printing */
            .d-flex.align-items-center.mb-3, /* Title and truck icon */
            .card.p-3.mb-4.shadow-sm, /* Input form */
            button, /* All buttons */
            .status-message, /* Status messages */
            .card-subtitle, /* Subtitles */
            .accordion-button.collapsed, /* Collapsed accordion buttons */
            .accordion-collapse.collapse, /* Collapsed accordion content */
            #settingsBtn { /* Hide settings button */
                display: none !important;
            }
            /* Ensure tables are visible and well-formatted */
            .table-responsive {
                overflow: visible !important;
            }
            table, th, td {
                border: 1px solid #dee2e6 !important;
                color: #000 !important;
            }
            h3, h4, h5 {
                color: #000 !important;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            /* Ensure all accordion content is visible when printing */
            .accordion-collapse {
                display: block !important;
            }
            .accordion-button {
                display: block !important; /* Make accordion headers visible */
                background-color: #f8f9fa !important; /* Light background for headers */
                color: #000 !important;
                border: 1px solid #dee2e6 !important;
                margin-bottom: 0.5rem;
            }
            .accordion-button strong, .accordion-button .badge {
                color: #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-truck me-3" viewBox="0 0 16 16"><path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-4 0a1 1 0 0 1-1-1V3.5ZM1.5 3a.5.5 0 0 0-.5.5V11h.5a1 1 0 0 1 1 1 1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V3.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v.364c-.606.252-1.134.63-1.562 1.136l-1.48-1.85A.5.5 0 0 0 9.02 3H1.5Zm3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm9 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/></svg>
                <h1 class="mb-0">Dashboard de Separação de Cargas</h1>
            </div>
            <button class="btn btn-outline-secondary" id="settingsBtn" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                Configurações
            </button>
        </div>

        <div class="card p-3 mb-4 shadow-sm">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold">1. Selecione ou Arraste a Planilha:</label>
                    <div id="drop-zone">
                        <p id="drop-zone-text">Arraste o arquivo aqui ou clique para selecionar</p>
                        <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv" hidden>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Defina a Faixa de Rotas (Opcional):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="rotaInicialInput" placeholder="Rota Inicial">
                        <input type="text" class="form-control" id="rotaFinalInput" placeholder="Rota Final">
                    </div>
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100" id="processarBtn" onclick="processar()" disabled>3. Processar Cargas</button>
                </div>
            </div>
            <div id="status" class="mt-2 status-message"></div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados Gerais</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos que não são 'Toco', agrupados por rota.</p>
                        <div class="input-group mb-3">
                            <input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar por Nº do Pedido...">
                            <button class="btn btn-outline-secondary" type="button" onclick="buscarPedido()">Buscar</button>
                        </div>
                        <div id="search-result" class="mb-3"></div>
                        <div id="resultado-geral"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separação de Cargas (Fiorino)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Fiorino para separar as cargas.</p>
                        <div id="fiorino-buttons-container">
                            </div>
                        <div id="resultado-fiorino-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separação de Cargas (Van)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Van para separar as cargas.</p>
                        <div id="van-buttons-container" class="d-flex flex-wrap gap-2">
                            </div>
                        <div id="resultado-van-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separação de Cargas (3/4)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de 3/4 para separar as cargas.</p>
                         <div id="tres-quartos-buttons-container" class="d-flex flex-wrap gap-2">
                            </div>
                        <div id="resultado-34-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados Cargas 3/4 (Automático)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Cargas formadas a partir de um pedido muito grande.</p>
                        <div id="resultado-tres-quartos"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados das Cargas "Toco"</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Grupos de cargas onde a Coluna4/5 contém "TOCO" e o CF se repete.</p>
                        <div id="resultado-toco"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                 <button class="btn btn-info mt-2" onclick="window.print()">Imprimir Todos os Resultados</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mt-3 mb-0" id="loadingModalText">Processando...</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="settingsModalLabel">Configurações de Veículos</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-body-secondary small">Defina os parâmetros para cada tipo de veículo. As configurações são salvas automaticamente no seu navegador.</p>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>Nome da Rota</th>
                                    <th>Tipo</th>
                                    <th>Peso Mínimo (kg)</th>
                                    <th>Peso Máximo (kg)</th>
                                    <th>Cubagem Máxima (m³)</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="vehicle-configs-tbody">
                                </tbody>
                        </table>
                    </div>
                    <button class="btn btn-outline-success btn-sm" id="add-vehicle-config-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        Adicionar Rota
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="save-settings-btn">Salvar e Atualizar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        // Variáveis de estado da aplicação
        let planilhaData = [];
        let pedidosGeraisAtuais = [];
        let gruposToco = {};
        let pedidosPrioritarios = [];
        let tocoPedidoIds = new Set();
        let vehicleConfigs = [];

        const distanciasCidades = {
             'LONDRINA': 25, 'CAMBE': 15, 'ARAPONGAS': 10, 'APUCARANA': 30, 'MARINGA': 60, 'IBIPORA': 40, 'SERTANOPOLIS': 60, 'JATAIZINHO': 50, 'CORNELIO PROCOPIO': 85, 'BANDEIRANTES': 115, 'SANTA MARIANA': 100, 'JANDAIA DO SUL': 45, 'MANDAGUARI': 80, 'PORECATU': 85, 'PARANAPOEMA': 130, 'ITAMBARACA': 85, 'CURITIBA': 400, 'PONTA GROSSA': 300, 'IMBAU': 200, 'ORTIGUEIRA': 180, 'MAUA DA SERRA': 100, 'CALIFORNIA': 50, 'CAMPO LARGO': 380, 'SAO JOSE DOS PINHAIS': 420, 'FOZ DO IGUACU': 550, 'COLOMBO': 410, 'GUARAPUAVA': 350, 'PARANAGUA': 450, 'TOLEDO': 400, 'PINHAIS': 400, 'ARAUCARIA': 400, 'UMUARAMA': 250, 'PARANAVAI': 150, 'FRANCISCO BELTRAO': 450, 'CAMPO MOURAO': 180, 'SARANDI': 70, 'PATO BRANCO': 400, 'TELEMACO BORBA': 250, 'CASTRO': 300, 'IRATI': 350, 'UNIAO DA VITORIA': 450, 'PRUDENTOPOLIS': 300, 'MARECHAL CANDIDO RONDON': 400, 'SANTO ANTONIO DA PLATINA': 150, 'LAPA': 400, 'PALMAS': 450, 'SAO MATEUS DO SUL': 400, 'JACAREZINHO': 150, 'MEDIANEIRA': 500, 'PAICANDU': 70, 'GUARATUBA': 500, 'JAGUARIAIVA': 200, 'RIO BRANCO DO SUL': 400, 'PALMEIRA': 350, 'QUEDAS DO IGUACU': 450, 'LARANJEIRAS DO SUL': 350, 'GUAIRA': 300, 'GOIOERE': 150, 'IBAITI': 150, 'PALOTINA': 350, 'IMBITUVA': 300, 'ARAPOTI': 200, 'NOVA ESPERANCA': 100, 'RESERVA': 200, 'ASTORGA': 50, 'CAMBARA': 100, 'CAMPO MAGRO': 400, 'PIRAI DO SUL': 250, 'MATINHOS': 500, 'ITAPERUCU': 400, 'CORONEL VIVIDA': 400, 'ANDIRA': 100, 'MANDIRITUBA': 400, 'CRUZEIRO DO OESTE': 200, 'SANTA TEREZINHA DE ITAIPU': 550, 'SENGES': 200,
        };

        // Elementos do DOM
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');
        const dropZone = document.getElementById('drop-zone');
        const dropZoneText = document.getElementById('drop-zone-text');
        
        // Modal de Carregamento
        const loadingModalEl = document.getElementById('loadingModal');
        const loadingModal = new bootstrap.Modal(loadingModalEl);
        const loadingModalText = document.getElementById('loadingModalText');

        // --- LÓGICA DE CONFIGURAÇÕES DE VEÍCULOS ---
        const defaultVehicleConfigs = [
            { name: 'Rota 11101', type: 'Fiorino', routes: ['11101'], minKg: 330, maxKg: 570, maxCubagem: 1.5 },
            { name: 'Rota 11301', type: 'Fiorino', routes: ['11301'], minKg: 330, maxKg: 570, maxCubagem: 1.5 },
            { name: 'Rota 11311', type: 'Fiorino', routes: ['11311'], minKg: 330, maxKg: 570, maxCubagem: 1.5 },
            { name: 'Rota 11561', type: 'Fiorino', routes: ['11561'], minKg: 330, maxKg: 570, maxCubagem: 1.5 },
            { name: 'Rotas 11721 & 11731', type: 'Fiorino', routes: ['11721', '11731'], minKg: 330, maxKg: 570, maxCubagem: 1.5 },
            
            { name: 'Rota 11102', type: 'Van', routes: ['11102'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11331', type: 'Van', routes: ['11331'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11341', type: 'Van', routes: ['11341'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11342', type: 'Van', routes: ['11342'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11351', type: 'Van', routes: ['11351'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11521', type: 'Van', routes: ['11521'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11531', type: 'Van', routes: ['11531'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11551', type: 'Van', routes: ['11551'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11571', type: 'Van', routes: ['11571'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11701', type: 'Van', routes: ['11701'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },
            { name: 'Rota 11711', type: 'Van', routes: ['11711'], minKg: 1100, maxKg: 1560, maxCubagem: 5.0 },

            { name: 'Rota 11361', type: '3/4', routes: ['11361'], minKg: 2300, maxKg: 4100, maxCubagem: 15.0 },
            { name: 'Rotas 11501, 11502 & 11511', type: '3/4', routes: ['11501', '11502', '11511'], minKg: 2300, maxKg: 4100, maxCubagem: 15.0 },
            { name: 'Rota 11541', type: '3/4', routes: ['11541'], minKg: 2300, maxKg: 4100, maxCubagem: 15.0 },
        ];
        
        function loadVehicleConfigs() {
            try {
                const storedConfigs = localStorage.getItem('dashboardCargasConfigs');
                if (storedConfigs) {
                    vehicleConfigs = JSON.parse(storedConfigs);
                } else {
                    vehicleConfigs = JSON.parse(JSON.stringify(defaultVehicleConfigs)); // Deep copy
                    saveVehicleConfigs();
                }
            } catch (e) {
                console.error("Erro ao carregar configurações, usando padrão.", e);
                vehicleConfigs = JSON.parse(JSON.stringify(defaultVehicleConfigs));
            }
        }

        function saveVehicleConfigs() {
            try {
                localStorage.setItem('dashboardCargasConfigs', JSON.stringify(vehicleConfigs));
            } catch (e) {
                console.error("Erro ao salvar configurações.", e);
            }
        }
        
        function populateSettingsModal() {
            const tbody = document.getElementById('vehicle-configs-tbody');
            tbody.innerHTML = '';
            vehicleConfigs.forEach((config, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" class="form-control" value="${config.name}" data-key="name"></td>
                    <td>
                        <select class="form-select" data-key="type">
                            <option value="Fiorino" ${config.type === 'Fiorino' ? 'selected' : ''}>Fiorino</option>
                            <option value="Van" ${config.type === 'Van' ? 'selected' : ''}>Van</option>
                            <option value="3/4" ${config.type === '3/4' ? 'selected' : ''}>3/4</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-control" value="${config.minKg}" data-key="minKg"></td>
                    <td><input type="number" class="form-control" value="${config.maxKg}" data-key="maxKg"></td>
                    <td><input type="number" class="form-control" step="0.1" value="${config.maxCubagem}" data-key="maxCubagem"></td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeVehicleConfig(${index})">&times;</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removeVehicleConfig(index) {
            vehicleConfigs.splice(index, 1);
            populateSettingsModal();
        }
        
        document.getElementById('add-vehicle-config-btn').addEventListener('click', () => {
             vehicleConfigs.push({ name: 'Nova Rota', type: 'Fiorino', routes: [], minKg: 330, maxKg: 570, maxCubagem: 1.5 });
             populateSettingsModal();
        });

        document.getElementById('save-settings-btn').addEventListener('click', () => {
            const newConfigs = [];
            const rows = document.getElementById('vehicle-configs-tbody').querySelectorAll('tr');
            rows.forEach(row => {
                const config = {};
                // Special handling for name to extract routes
                const nameInput = row.querySelector('input[data-key="name"]');
                config.name = nameInput.value;
                config.routes = nameInput.value.match(/\d{5}/g) || []; // Extract 5-digit numbers as routes

                row.querySelectorAll('select, input:not([data-key="name"])').forEach(input => {
                    config[input.dataset.key] = input.type === 'number' ? parseFloat(input.value) : input.value;
                });
                newConfigs.push(config);
            });
            vehicleConfigs = newConfigs;
            saveVehicleConfigs();
            renderVehicleButtons();
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            statusDiv.innerHTML = '<p class="text-success">Configurações salvas e botões atualizados!</p>';
        });

        document.getElementById('settingsModal').addEventListener('show.bs.modal', populateSettingsModal);

        // --- LÓGICA DE DRAG AND DROP ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            if (!file) return;
            
            loadingModalText.textContent = `Carregando ${file.name}...`;
            loadingModal.show();
            processarBtn.disabled = true;

            setTimeout(() => { // Allow UI to update
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        let headerRowIndex = -1, headers = [];
                        for (let i = 0; i < rawData.length; i++) {
                            const row = rawData[i];
                            if (row && row.includes('Cod_Rota')) {
                                headerRowIndex = i;
                                headers = row.map(h => String(h).trim());
                                break;
                            }
                        }
                        if (headerRowIndex === -1) throw new Error("Não foi possível encontrar a linha de cabeçalho com 'Cod_Rota'.");
                        const dataRows = rawData.slice(headerRowIndex + 1);
                        planilhaData = dataRows.map(row => {
                            const pedido = {};
                            headers.forEach((header, i) => { if (header) { pedido[header] = row[i] !== undefined ? row[i] : ''; } });
                            return pedido;
                        });
                        statusDiv.innerHTML = `<p class="text-success">Planilha "${file.name}" carregada. ${planilhaData.length} linhas prontas para processar.</p>`;
                        dropZoneText.textContent = file.name;
                        processarBtn.disabled = false;
                    } catch (error) {
                        statusDiv.innerHTML = `<p class="text-danger"><strong>Erro ao ler o arquivo:</strong> ${error.message}</p>`;
                        dropZoneText.textContent = "Erro no arquivo. Tente novamente.";
                        console.error(error);
                    } finally {
                        loadingModal.hide();
                    }
                };
                reader.readAsArrayBuffer(file);
            }, 100);
        }

        // --- GERAÇÃO DINÂMICA DE BOTÕES ---
        function renderVehicleButtons() {
            const containers = {
                Fiorino: document.getElementById('fiorino-buttons-container'),
                Van: document.getElementById('van-buttons-container'),
                '3/4': document.getElementById('tres-quartos-buttons-container'),
            };

            // Limpa containers
            Object.values(containers).forEach(c => c.innerHTML = '');

            const groupedConfigs = vehicleConfigs.reduce((acc, config) => {
                if (!acc[config.type]) acc[config.type] = [];
                acc[config.type].push(config);
                return acc;
            }, {});

            // Fiorino - Botões individuais
            if (groupedConfigs.Fiorino) {
                groupedConfigs.Fiorino.forEach(config => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-success mt-2 me-2';
                    btn.textContent = config.name;
                    // Passando o objeto de configuração inteiro para a função
                    btn.onclick = () => separarCargas(config, 'resultado-fiorino-geral');
                    containers.Fiorino.appendChild(btn);
                });
            }

            // Van e 3/4 - Dropdowns
            ['Van', '3/4'].forEach(type => {
                if (groupedConfigs[type]) {
                    const color = type === 'Van' ? 'primary' : 'warning';
                    const resultDivId = type === 'Van' ? 'resultado-van-geral' : 'resultado-34-geral';
                    const dropdownHTML = `
                        <div class="dropdown">
                            <button class="btn btn-${color} dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Selecione a Rota (${type})
                            </button>
                            <ul class="dropdown-menu">
                                ${groupedConfigs[type].map(config => `
                                    <li><a class="dropdown-item" href="#" onclick='separarCargas(${JSON.stringify(config)}, "${resultDivId}")'>${config.name}</a></li>
                                `).join('')}
                            </ul>
                        </div>`;
                    containers[type].innerHTML += dropdownHTML;
                }
            });
        }


        function calculateEstimatedDistance(pedidos) {
            const uniqueCities = new Set();
            pedidos.forEach(p => {
                if (p.Cidade) {
                    uniqueCities.add(String(p.Cidade).toUpperCase().trim());
                }
            });

            let totalDistance = 0;
            uniqueCities.forEach(city => {
                if (distanciasCidades[city]) {
                    totalDistance += distanciasCidades[city];
                } else {
                    console.warn(`Distância para a cidade '${city}' não encontrada.`);
                }
            });
            return totalDistance * 1.50;
        }

        function buscarPedido() {
             const searchInput = document.getElementById('pedidoSearchInput').value.trim();
             const searchResultDiv = document.getElementById('search-result');
             searchResultDiv.innerHTML = '';
             if (!searchInput) return;

             if (planilhaData.length === 0) {
                 searchResultDiv.innerHTML = '<p class="text-warning">Por favor, carregue e processe a planilha primeiro.</p>';
                 return;
             }

             let pedidoEncontrado = null;
             let local = 'Não encontrado';
             let accordionId = '';

             pedidoEncontrado = pedidosGeraisAtuais.find(p => String(p.Num_Pedido) === searchInput);
             if (pedidoEncontrado) {
                 local = 'Resultados Gerais';
                 accordionId = 'accordionGeral';
             }

             if (!pedidoEncontrado) {
                 for (const cf in gruposToco) {
                     pedidoEncontrado = gruposToco[cf].pedidos.find(p => String(p.Num_Pedido) === searchInput);
                     if (pedidoEncontrado) {
                         local = `Cargas "Toco" (CF: ${cf})`;
                         accordionId = 'accordionToco';
                         break;
                     }
                 }
             }
            
             if (!pedidoEncontrado) {
                 const originalPedido = planilhaData.find(p => String(p.Num_Pedido) === searchInput);
                 if (originalPedido) {
                     pedidoEncontrado = originalPedido; // Use for display
                     if (tocoPedidoIds.has(String(originalPedido.Num_Pedido))) {
                         local = 'Filtrado (pertence a um grupo Toco)';
                     } else if (['21', '23', '17'].includes(String(originalPedido.Coluna4))) {
                         local = 'Filtrado (Coluna4 é 21, 23, ou 17)';
                     } else if (String(originalPedido['BLOQ.']) === 'C' || String(originalPedido['BLOQ.']) === 'V') {
                         local = 'Filtrado (Bloqueio C ou V)';
                     } else {
                         local = 'Filtrado (outro motivo, verifique filtros de rota ou cliente)';
                     }
                 }
             }

             if (pedidoEncontrado) {
                 let buttons = '';
                 if (local === 'Resultados Gerais') {
                     const isPrioritized = pedidosPrioritarios.includes(String(pedidoEncontrado.Num_Pedido));
                     buttons = `
                         <button class="btn btn-primary btn-sm" onclick="priorizarPedido('${pedidoEncontrado.Num_Pedido}')" ${isPrioritized ? 'disabled' : ''}>
                             ${isPrioritized ? 'Prioridade Marcada' : 'Marcar como Prioridade'}
                         </button>
                         <button class="btn btn-secondary btn-sm ms-2" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">
                             Destacar na Lista
                         </button>
                     `;
                 } else if (accordionId) {
                      buttons = `<button class="btn btn-secondary btn-sm" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">
                             Destacar na Lista
                         </button>`;
                 }

                 searchResultDiv.innerHTML = `
                     <div class="alert alert-info">
                         <h5>Pedido ${searchInput} encontrado!</h5>
                         <p class="mb-1"><strong>Local:</strong> ${local}</p>
                         <p class="mb-1"><strong>Cliente:</strong> ${pedidoEncontrado.Nome_Cliente}<br>
                             <strong>Peso:</strong> ${pedidoEncontrado.Quilos_Saldo} kg</p>
                         ${buttons ? `<div class="mt-2">${buttons}</div>` : ''}
                     </div>
                 `;
             } else {
                 searchResultDiv.innerHTML = '<p class="text-danger">Pedido não encontrado em nenhuma das listas.</p>';
             }
        }

        function priorizarPedido(numPedido) {
             if (!pedidosPrioritarios.includes(numPedido)) {
                 pedidosPrioritarios.push(numPedido);
                 buscarPedido(); 
             }
        }

        function highlightPedido(numPedido) {
             const row = document.getElementById(`pedido-${numPedido}`);
             if (row) {
                 row.classList.toggle('table-info');

                 if (row.classList.contains('table-info')) {
                     const collapseEl = row.closest('.accordion-collapse');
                     if (collapseEl && !collapseEl.classList.contains('show')) {
                         bootstrap.Collapse.getOrCreateInstance(collapseEl).show();
                     }
                    
                     setTimeout(() => {
                         row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     }, 350);
                 }
             }
        }

        function processar() {
            loadingModalText.textContent = 'Processando cargas...';
            loadingModal.show();

            // Usamos setTimeout para garantir que o modal apareça antes do processamento pesado
            setTimeout(() => {
                const resultadoGeralDiv = document.getElementById('resultado-geral');
                const resultadoTocoDiv = document.getElementById('resultado-toco');
                const resultadoTresQuartosDiv = document.getElementById('resultado-tres-quartos');
                try {
                    if (planilhaData.length === 0) {
                        statusDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>';
                        return;
                    }
                    const rotaInicialInput = document.getElementById('rotaInicialInput').value;
                    const rotaFinalInput = document.getElementById('rotaFinalInput').value;
                    resultadoGeralDiv.innerHTML = '';
                    resultadoTocoDiv.innerHTML = '';
                    resultadoTresQuartosDiv.innerHTML = '';

                    const pedidos = planilhaData.filter(p => String(p.Coluna4) != '500');

                    const pedidosTocoBase = pedidos.filter(p => (p.Coluna4 && String(p.Coluna4).toUpperCase().includes('TOCO')) || (p.Coluna5 && String(p.Coluna5).toUpperCase().includes('TOCO')));
                    const cfCounts = {};
                    const isNumeric = (str) => /^\d+$/.test(str);
                    pedidosTocoBase.forEach(p => { if (p.CF && isNumeric(String(p.CF))) { cfCounts[p.CF] = (cfCounts[p.CF] || 0) + 1; } });
                    const cfsRepetidos = Object.keys(cfCounts).filter(cf => cfCounts[cf] > 1);
                    const pedidosTocoFiltrados = pedidosTocoBase.filter(p => cfsRepetidos.includes(String(p.CF)));
                    gruposToco = pedidosTocoFiltrados.reduce((acc, p) => {
                        const cf = p.CF;
                        if (!acc[cf]) { acc[cf] = { pedidos: [], totalKg: 0 }; }
                        acc[cf].pedidos.push(p);
                        acc[cf].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                        return acc;
                    }, {});
                    displayToco(resultadoTocoDiv, gruposToco);

                    tocoPedidoIds = new Set(pedidosTocoFiltrados.map(p => String(p.Num_Pedido)));
                    const clientesComBloqueio = new Set();
                    const clientesSemBloqueio = new Set();
                    pedidos.forEach(p => { if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') { clientesComBloqueio.add(String(p.Cliente)); } else { clientesSemBloqueio.add(String(p.Cliente)); } });
                    const clientesParaRemover = new Set([...clientesComBloqueio].filter(c => clientesSemBloqueio.has(c)));
                    const rotaMin = rotaInicialInput ? parseInt(rotaInicialInput, 10) : 11101;
                    const rotaMax = rotaFinalInput ? parseInt(rotaFinalInput, 10) : 11731;
                    const pedidosGeraisFiltrados = pedidos.filter(p => {
                        if (tocoPedidoIds.has(String(p.Num_Pedido))) return false;
                        if (['21', '23', '17'].includes(String(p.Coluna4))) return false;
                        const rotaAtualNum = parseInt(String(p.Cod_Rota), 10);
                        if ((rotaAtualNum === 11311 || rotaAtualNum === 11521 || rotaAtualNum === 11361) && isNumeric(String(p.CF))) {
                            return false;
                        }
                        if (!(rotaAtualNum >= rotaMin && rotaAtualNum <= rotaMax)) return false;
                        if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') return false;
                        if (clientesParaRemover.has(String(p.Cliente))) return false;
                        return true;
                    });

                    // Lógica para 3/4 automático
                    let tresQuartosLoads = [];
                    const config34Auto = vehicleConfigs.find(c => c.type === '3/4') || { minKg: 2300, maxKg: 4100 };
                    const LARGE_ORDER_KG = 1700;
                    
                    const largeOrdersByRoute = pedidosGeraisFiltrados.reduce((acc, p) => {
                        const peso = parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                        if (peso >= LARGE_ORDER_KG) {
                            const rota = p.Cod_Rota;
                            if (!acc[rota]) acc[rota] = [];
                            acc[rota].push(p);
                        }
                        return acc;
                    }, {});

                    const pedidosEmCargas3_4 = new Set();
                    Object.keys(largeOrdersByRoute).forEach(rota => {
                        const largeOrders = largeOrdersByRoute[rota];
                        if (largeOrders.length === 1) {
                            const largeOrder = largeOrders[0];
                            if (pedidosEmCargas3_4.has(largeOrder.Num_Pedido)) return;

                            let newLoad = { pedidos: [largeOrder], totalKg: parseFloat(String(largeOrder.Quilos_Saldo).replace(',', '.')) || 0, rota: rota };
                            const otherOrdersInRoute = pedidosGeraisFiltrados.filter(p => p.Cod_Rota === rota && p.Num_Pedido !== largeOrder.Num_Pedido).sort((a, b) => (parseFloat(String(b.Quilos_Saldo).replace(',', '.')) || 0) - (parseFloat(String(a.Quilos_Saldo).replace(',', '.')) || 0));

                            for (const order of otherOrdersInRoute) {
                                if (pedidosEmCargas3_4.has(order.Num_Pedido)) continue;
                                const orderKg = parseFloat(String(order.Quilos_Saldo).replace(',', '.')) || 0;
                                if (newLoad.totalKg + orderKg <= config34Auto.maxKg) {
                                    newLoad.pedidos.push(order);
                                    newLoad.totalKg += orderKg;
                                }
                            }
                            if (newLoad.totalKg >= config34Auto.minKg) {
                                tresQuartosLoads.push(newLoad);
                                newLoad.pedidos.forEach(p => pedidosEmCargas3_4.add(p.Num_Pedido));
                            }
                        }
                    });
                    
                    tresQuartosLoads.forEach((load, index) => { load.numero = index + 1; });
                    displayTresQuartos(resultadoTresQuartosDiv, tresQuartosLoads, config34Auto);

                    pedidosGeraisAtuais = pedidosGeraisFiltrados.filter(p => !pedidosEmCargas3_4.has(p.Num_Pedido));
                    const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => {
                        const rota = p.Cod_Rota;
                        if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; }
                        acc[rota].pedidos.push(p);
                        acc[rota].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                        return acc;
                    }, {});
                    displayGerais(resultadoGeralDiv, gruposGerais);

                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Ocorreu um erro:</strong></p><pre>${error.stack}</pre>`;
                    console.error(error);
                } finally {
                    loadingModal.hide();
                }
            }, 100);
        }

        // --- FUNÇÃO DE SEPARAÇÃO DE CARGAS REATORADA ---
        function separarCargas(config, divId) {
            const resultadoDiv = document.getElementById(divId);
            resultadoDiv.innerHTML = '';
            if (planilhaData.length === 0) {
                resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>';
                return;
            }

            const pedidosRota = pedidosGeraisAtuais.filter(p => config.routes.includes(String(p.Cod_Rota)));
            const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO'];
            const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());

            let packableItems = [];
            const otherPedidos = pedidosRota.filter(p => !isSpecialClient(p));
            const specialPedidos = pedidosRota.filter(p => isSpecialClient(p));

            specialPedidos.forEach(pedido => {
                packableItems.push({ isSpecial: true, pedidos: [pedido], totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0, totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0 });
            });

            const otherClientGroupsMap = otherPedidos.reduce((acc, pedido) => {
                const clienteId = pedido.Cliente;
                if (!acc[clienteId]) {
                    acc[clienteId] = { isSpecial: false, pedidos: [], totalKg: 0, totalCubagem: 0 };
                }
                acc[clienteId].pedidos.push(pedido);
                return acc;
            }, {});
            
            Object.values(otherClientGroupsMap).forEach(group => {
                group.totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                group.totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0);
                packableItems.push(group);
            });
            
            const priorityItems = packableItems.filter(item => item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            const regularItems = packableItems.filter(item => !item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            priorityItems.sort((a, b) => b.totalKg - a.totalKg);
            regularItems.sort((a, b) => b.totalKg - a.totalKg);
            packableItems = [...priorityItems, ...regularItems];

            let loads = [];
            let leftoverItems = [];

            packableItems.forEach(item => {
                if (item.totalKg > config.maxKg || item.totalCubagem > config.maxCubagem) {
                    leftoverItems.push(item);
                    return;
                }
                let placed = false;
                for (const load of loads) {
                    const specialCountInLoad = load.pedidos.filter(p => isSpecialClient(p)).length;
                    const specialOrdersInItem = item.isSpecial ? item.pedidos.length : 0;
                    if ((load.totalKg + item.totalKg <= config.maxKg) && (load.totalCubagem + item.totalCubagem <= config.maxCubagem) && (specialCountInLoad + specialOrdersInItem <= 2)) {
                        load.pedidos.push(...item.pedidos);
                        load.totalKg += item.totalKg;
                        load.totalCubagem += item.totalCubagem;
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    loads.push({ pedidos: [...item.pedidos], totalKg: item.totalKg, totalCubagem: item.totalCubagem });
                }
            });

            let finalLoads = [];
            let unplacedFromMinRule = [];
            loads.forEach(load => {
                const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                if (hasPriority || load.totalKg >= config.minKg) {
                    finalLoads.push(load);
                } else {
                    unplacedFromMinRule.push(...load.pedidos);
                }
            });

            finalLoads.forEach((load, index) => { 
                load.numero = index + 1;
                if (config.type === 'Fiorino') {
                    load.estimatedDistance = calculateEstimatedDistance(load.pedidos);
                }
            });
            
            if (config.type === 'Fiorino') {
                finalLoads.sort((a, b) => a.estimatedDistance - b.estimatedDistance);
            }

            let leftoverPedidos = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule);

            // Geração de HTML
            const vehicleColors = { Fiorino: 'success', Van: 'primary', '3/4': 'warning' };
            const printFunctionNames = { Fiorino: 'imprimirCargas', Van: 'imprimirCargasVan', '3/4': 'imprimirCargas34' };
            const colorClass = vehicleColors[config.type] || 'secondary';
            const printFunction = printFunctionNames[config.type] || 'imprimirCargas';
            
            let html = `<div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="mb-0">${finalLoads.length} Carga(s) de ${config.type} para ${config.name}:</h3>
                            ${finalLoads.length > 0 ? `<button class="btn btn-sm btn-outline-light" onclick="${printFunction}('${divId}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir Concluídas</button>` : ''}
                        </div>`;

            if (finalLoads.length === 0) {
                html += `<p>Nenhuma carga de ${config.type} foi formada para esta rota.</p>`;
            } else {
                finalLoads.forEach(load => {
                    const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const totalCubagemFormatado = load.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const isPriorityLoad = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                    const priorityBadge = isPriorityLoad ? '<span class="badge bg-light text-dark ms-3">PRIORIDADE</span>' : '';
                    
                    const weightPercent = (load.totalKg / config.maxKg * 100).toFixed(2);
                    const progressBar = `
                        <div class="progress-container text-white">
                            <small>${totalKgFormatado} kg / ${config.maxKg} kg</small>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar ${weightPercent > 100 ? 'bg-danger' : 'bg-light'}" role="progressbar" style="width: ${Math.min(weightPercent, 100)}%;" aria-valuenow="${weightPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>`;
                    
                    let headerInfo = `${config.type} #${load.numero} - ${totalCubagemFormatado} m³ ${priorityBadge}`;
                    if (config.type === 'Fiorino') {
                        headerInfo += ` (Distância Estimada: ${load.estimatedDistance.toFixed(0)} km)`;
                    }

                    html += `
                        <div class="card mb-3 ${isPriorityLoad ? 'border-primary' : ''}">
                            <div class="card-header bg-${colorClass} text-white">
                                <div>${headerInfo}</div>
                                ${progressBar}
                            </div>
                            <div class="card-body">
                                ${createTable(load.pedidos)}
                            </div>
                        </div>
                    `;
                });
            }

            if (leftoverPedidos.length > 0) {
                const totalKgUnassigned = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                html += `<h4 class="mt-4">Pedidos restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h4>
                         <div class="card mb-3">
                             <div class="card-header bg-danger text-white">Detalhes dos Pedidos Restantes</div>
                             <div class="card-body">${createTable(leftoverPedidos, ['Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cliente', 'Nome_Cliente', 'Cidade'])}</div>
                         </div>`;
            }

            resultadoDiv.innerHTML = html;
        }


        // --- FUNÇÕES DE DISPLAY E TABELAS ---

        function createTable(pedidos, columnsToDisplay) {
             if (!pedidos || pedidos.length === 0) return '';
             const colunasExibir = columnsToDisplay || ['Cod_Rota', 'Cliente', 'Nome_Cliente', 'Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cidade', 'BLOQ.', 'Coluna4', 'Coluna5', 'CF'];
             let table = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped"><thead><tr>';
             colunasExibir.forEach(c => table += `<th>${c}</th>`);
             table += '</tr></thead><tbody>';
             pedidos.forEach(p => {
                 table += `<tr id="pedido-${p.Num_Pedido}">`;
                 colunasExibir.forEach(c => table += `<td>${p[c] === undefined || p[c] === null ? '' : p[c]}</td>`);
                 table += '</tr>';
             });
             table += '</tbody></table></div>';
             return table;
        }

        function displayGerais(div, grupos) {
             if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhum pedido geral encontrado.</div>'; return; }
             let accordionHtml = '<div class="accordion accordion-flush" id="accordionGeral">';
             Object.keys(grupos).sort().forEach((rota, index) => {
                 const grupo = grupos[rota];
                 const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                 accordionHtml += `
                     <div class="accordion-item">
                         <h2 class="accordion-header" id="headingGeral${index}">
                             <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral${index}">
                                 <strong>Rota: ${rota}</strong> &nbsp; <span class="badge bg-secondary ms-2">${grupo.pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span>
                             </button>
                         </h2>
                         <div id="collapseGeral${index}" class="accordion-collapse collapse" data-bs-parent="#accordionGeral"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div>
                     </div>`;
             });
             accordionHtml += '</div>';
             div.innerHTML = accordionHtml;
        }
        
        function displayTresQuartos(div, loads, config) {
            if (loads.length === 0) {
                div.innerHTML = '<div class="text-center p-3">Nenhuma carga 3/4 formada automaticamente.</div>';
                return;
            }
            let html = `<div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="mb-0">Cargas 3/4 (Automático):</h3>
                            ${loads.length > 0 ? `<button class="btn btn-sm btn-outline-light" onclick="imprimirCargasTresQuartosAutomatico('${div.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir Concluídas</button>` : ''}
                        </div>`;
            loads.forEach(load => {
                const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const weightPercent = (load.totalKg / config.maxKg * 100).toFixed(2);
                const progressBar = `
                    <div class="progress-container text-dark">
                        <small>${totalKgFormatado} kg / ${config.maxKg} kg</small>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar ${weightPercent > 100 ? 'bg-danger' : 'bg-dark'}" role="progressbar" style="width: ${Math.min(weightPercent, 100)}%;" aria-valuenow="${weightPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>`;

                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <div>Carga 3/4 #${load.numero} (Rota: ${load.rota})</div>
                            ${progressBar}
                        </div>
                        <div class="card-body">
                            ${createTable(load.pedidos)}
                        </div>
                    </div>
                `;
            });
            div.innerHTML = html;
        }


        function displayToco(div, grupos) {
             if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhuma carga toco encontrada.</div>'; return; }
             let accordionHtml = '<div class="accordion accordion-flush" id="accordionToco">';
             Object.keys(grupos).sort().forEach((cf, index) => {
                 const grupo = grupos[cf];
                 const pedidos = grupo.pedidos;
                 const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                 accordionHtml += `
                     <div class="accordion-item">
                         <h2 class="accordion-header" id="headingToco${index}">
                             <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToco${index}">
                                 <strong>CF: ${cf}</strong> &nbsp; <span class="badge bg-secondary ms-2">${pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span>
                             </button>
                         </h2>
                         <div id="collapseToco${index}" class="accordion-collapse collapse" data-bs-parent="#accordionToco"><div class="accordion-body">
                             <button class="btn btn-sm btn-outline-info mb-3" onclick="imprimirTocoIndividual('${cf}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir esta Carga Toco</button>
                             ${createTable(pedidos)}</div></div>
                     </div>`;
             });
             accordionHtml += '</div>';
             div.innerHTML = accordionHtml;
        }

        // --- FUNÇÕES DE IMPRESSÃO ---
        function imprimirCargas(divId) {
             const divToPrint = document.getElementById(divId);
             if (!divToPrint) return;

             const completedLoadsHeaders = divToPrint.querySelectorAll('.card-header.bg-success');
             if (completedLoadsHeaders.length === 0) {
                 alert("Nenhuma carga de Fiorino concluída para imprimir.");
                 return;
             }

             const printWindow = window.open('', '', 'height=800,width=1200');
             printWindow.document.write('<html><head><title>Imprimir Cargas de Fiorino Concluídas</title>');
             printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
             printWindow.document.write('<style>');
             printWindow.document.write(`
                 body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                 .card { break-inside: avoid; margin-bottom: 1rem; }
                 .card-header { background-color: #198754 !important; color: #fff !important; }
                 .progress-bar { background-color: #fff !important; }
                 .table-responsive { overflow: visible !important; }
                 table, th, td { border: 1px solid #dee2e6 !important; }
                 h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }
             `);
             printWindow.document.write('</style></head><body>');
            
             let contentToPrint = '<h3>Cargas de Fiorino Concluídas</h3>';
             completedLoadsHeaders.forEach(header => {
                 contentToPrint += header.closest('.card.mb-3').outerHTML;
             });

             printWindow.document.body.innerHTML = contentToPrint;
             printWindow.document.close();
             printWindow.focus(); 
             setTimeout(() => { 
                 printWindow.print(); 
                 printWindow.close(); 
             }, 500);
        }

        function imprimirCargasVan(divId) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;

            const completedLoadsHeaders = divToPrint.querySelectorAll('.card-header.bg-primary');
            if (completedLoadsHeaders.length === 0) {
                alert("Nenhuma carga de Van concluída para imprimir.");
                return;
            }

            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Imprimir Cargas de Van Concluídas</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .card-header { background-color: #0d6efd !important; color: #fff !important; }
                .progress-bar { background-color: #fff !important; }
                .table-responsive { overflow: visible !important; }
                table, th, td { border: 1px solid #dee2e6 !important; }
                h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }
            `);
            printWindow.document.write('</style></head><body>');
            
            let contentToPrint = '<h3>Cargas de Van Concluídas</h3>';
            completedLoadsHeaders.forEach(header => {
                contentToPrint += header.closest('.card.mb-3').outerHTML;
            });

            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }

        function imprimirCargas34(divId) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;

            const completedLoadsHeaders = divToPrint.querySelectorAll('.card-header.bg-warning');
            if (completedLoadsHeaders.length === 0) {
                alert("Nenhuma carga de 3/4 concluída para imprimir.");
                return;
            }

            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Imprimir Cargas de 3/4 Concluídas</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .card-header { background-color: #ffc107 !important; color: #000 !important; }
                .progress-bar { background-color: #000 !important; }
                .table-responsive { overflow: visible !important; }
                table, th, td { border: 1px solid #dee2e6 !important; }
                h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }
            `);
            printWindow.document.write('</style></head><body>');
            
            let contentToPrint = '<h3>Cargas de 3/4 Concluídas</h3>';
            completedLoadsHeaders.forEach(header => {
                contentToPrint += header.closest('.card.mb-3').outerHTML;
            });

            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }

        function imprimirCargasTresQuartosAutomatico(divId) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;

            const completedLoadsHeaders = divToPrint.querySelectorAll('.card-header.bg-warning');
            if (completedLoadsHeaders.length === 0) {
                alert("Nenhuma carga 3/4 automática concluída para imprimir.");
                return;
            }

            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Imprimir Cargas 3/4 Automáticas Concluídas</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .card-header { background-color: #ffc107 !important; color: #000 !important; }
                .progress-bar { background-color: #000 !important; }
                .table-responsive { overflow: visible !important; }
                table, th, td { border: 1px solid #dee2e6 !important; }
                h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }
            `);
            printWindow.document.write('</style></head><body>');
            
            let contentToPrint = '<h3>Cargas de 3/4 Automáticas Concluídas</h3>';
            completedLoadsHeaders.forEach(header => {
                contentToPrint += header.closest('.card.mb-3').outerHTML;
            });

            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }

        function imprimirTocoIndividual(cf) {
            if (!gruposToco[cf]) {
                alert(`Nenhuma carga Toco encontrada para o CF: ${cf}`);
                return;
            }

            const grupo = gruposToco[cf];
            const pedidos = grupo.pedidos;
            const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Imprimir Carga Toco CF: ' + cf + '</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .card-header { background-color: #f8f9fa !important; color: #000 !important; border: 1px solid #dee2e6 !important; }
                .table-responsive { overflow: visible !important; }
                table, th, td { border: 1px solid #dee2e6 !important; }
                h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }
            `);
            printWindow.document.write('</style></head><body>');
            
            let contentToPrint = `<h3>Carga Toco CF: ${cf} - Total: ${totalKgFormatado} kg</h3>`;
            contentToPrint += createTable(pedidos);

            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadVehicleConfigs();
            renderVehicleButtons();
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
