<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separação de Cargas Otimizado</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            /* Paleta de Cores "Cyber Glow" */
            --dark-bg: #0D0E18; /* Azul quase preto, profundo */
            --dark-surface: rgba(22, 24, 40, 0.65); /* Superfície com tom azulado, mais translúcida */
            --dark-surface-secondary: rgba(30, 33, 52, 0.75);
            --dark-border: rgba(139, 132, 255, 0.15); /* Borda com brilho violeta mais sutil */
            --dark-primary: #8B84FF; /* Violeta principal, um pouco mais claro */
            --dark-primary-hover: #A49EFF;
            --dark-primary-glow: rgba(139, 132, 255, 0.35);
            --dark-accent: #00E5FF; /* Ciano elétrico para acentos */
            --dark-accent-glow: rgba(0, 229, 255, 0.3);
            --dark-text-primary: #EAEBF0; /* Branco levemente azulado */
            --dark-text-secondary: #9298B9; /* Cinza-azulado para texto secundário */
            --box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.35); /* Sombra mais suave e difundida */
            --backdrop-blur: 12px;
        }

        /* --- Animação de Fundo "Aurora" --- */
        @keyframes move-aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Melhorias Gerais --- */
        body {
            background-color: var(--dark-bg);
            /* Efeito Aurora: gradientes radiais grandes e animados */
            background-image: 
                radial-gradient(at 20% 20%, hsla(253, 98%, 77%, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 20%, hsla(187, 100%, 50%, 0.1) 0px, transparent 50%),
                radial-gradient(at 20% 80%, hsla(253, 98%, 77%, 0.1) 0px, transparent 50%),
                radial-gradient(at 80% 80%, hsla(187, 100%, 50%, 0.15) 0px, transparent 50%);
            background-size: 200% 200%;
            font-family: 'Inter', sans-serif;
            color: var(--dark-text-primary);
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            background-attachment: fixed;
            animation: move-aurora 25s ease-in-out infinite;
        }        

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--dark-bg); }
        ::-webkit-scrollbar-thumb { background-color: var(--dark-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--dark-primary-hover); }

        h1, h2, h3, h4, h5 { font-weight: 700; letter-spacing: -0.5px; }

        /* --- Tipografia Responsiva (Valores ajustados para uma aparência mais compacta e profissional) --- */
        h1.h2 { font-size: clamp(1.15rem, 1.8vw, 1.4rem); }
        h3 { font-size: clamp(0.95rem, 1.5vw, 1.1rem); }
        .card-title.h5, .modal-title { font-size: clamp(0.85rem, 1.1vw, 0.95rem); }
        #sidebar .fs-4 { font-size: clamp(0.95rem, 1.4vw, 1.1rem); }


        /* --- Animações --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes glow {
            0% { box-shadow: 0 0 8px var(--dark-primary-glow); }
            50% { box-shadow: 0 0 25px var(--dark-primary-glow), 0 0 15px var(--dark-primary-glow); }
            100% { box-shadow: 0 0 8px var(--dark-primary-glow); }
        }
        .animated-entry { animation: fadeIn 0.6s ease-out forwards; }
        .animated-entry:nth-child(1) { animation-delay: 0.1s; }
        .animated-entry:nth-child(2) { animation-delay: 0.2s; }
        .animated-entry:nth-child(3) { animation-delay: 0.3s; }

        /* --- Layout Principal --- */
        #main-content {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Altura total da viewport */
            --sidebar-width: clamp(250px, 16vw, 300px);
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.4s ease, width 0.4s ease; /* Animação fluida */
            min-width: 0; 
        }

        .main-view {
            display: none; /* All views are hidden by default */
            min-width: 0; 
        }

        #sidebar {
            width: clamp(250px, 16vw, 300px);
            height: 100vh; /* Alterado de min-height para height */
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            background: var(--dark-surface);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
            border-right: 1px solid var(--dark-border);
            transition: all 0.4s ease; /* Animação fluida para width e padding */
            display: flex;
            flex-direction: column;
        }

        /* Estilo para a barra de rolagem personalizada (Chrome, Edge, Safari) - CORRIGIDO */
        .sidebar-scrollable-content::-webkit-scrollbar { width: 6px; }
        .sidebar-scrollable-content::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollable-content::-webkit-scrollbar-thumb { background-color: rgba(120, 111, 255, 0.15); border-radius: 10px; transition: background-color 0.3s ease; }
        .sidebar-scrollable-content::-webkit-scrollbar-thumb:hover { background-color: var(--dark-primary); }

        /* --- Nova Estrutura da Sidebar --- */
        #sidebar-process-section {
            padding: 0 1rem 1rem 1rem;
            border-bottom: 1px solid var(--dark-border);
        }
        #sidebar-nav-section {
            flex: 1 1 auto; /* Ocupa o espaço restante */
            overflow-y: auto; /* Rolagem apenas se necessário */
            min-height: 0;
            padding: 1rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(120, 111, 255, 0.15) transparent;
        }

        #sidebar .sidebar-header { 
            padding: 1rem 1.25rem 1rem 1rem; 
        }
        #sidebar .sidebar-header .fs-4 { font-weight: 700; transition: opacity 0.3s ease; }
        #sidebar .sidebar-step { margin-bottom: 1rem; }
        #sidebar .step-number { /* Tamanho do número do passo reduzido */
            background-color: var(--dark-primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem; /* Menor */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 0.5rem;
        }
        #sidebar .form-label { 
            font-weight: 500; color: var(--dark-text-secondary); 
            font-size: 0.85rem; /* Menor */
        }
        #sidebar .nav-link {
            color: var(--dark-text-secondary);
            font-weight: 500; font-size: 0.9rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            position: relative;
            font-size: 0.9rem; /* Levemente maior para legibilidade */
            transition: all 0.3s ease;
            white-space: nowrap; /* Impede que o texto quebre linha durante a animação */
            border-left: 3px solid transparent; /* Indicador lateral */
            display: flex; 
            align-items: center; /* Adicionado para alinhar ícone e texto */
        }
        #sidebar .nav-link i {
            margin-right: 0.5rem; /* Margem padrão para ícones */
        }
        #sidebar .nav-link:hover {
            background-color: var(--dark-surface-secondary);
            color: var(--dark-text-primary);
            border-left-color: var(--dark-primary-hover);
        }
        #sidebar .nav-link.active {
            background: linear-gradient(90deg, rgba(139, 132, 255, 0.2), transparent);
            color: white;
            font-weight: 600;
            box-shadow: 0 0 20px var(--dark-primary-glow);
            border-left-color: var(--dark-primary);
        }

        /* --- Estilo para Submenu na Sidebar --- */
        #sidebar .nav-link .submenu-arrow {
            transition: transform 0.3s ease;
            float: right;
        }
        #sidebar .nav-link.collapsed .submenu-arrow {
            transform: rotate(-90deg);
        }
        #sidebar .nav-submenu {
            padding-left: 1.5rem; /* Indentação para itens do submenu */
            background-color: rgba(0,0,0,0.15);
        }
        #sidebar .nav-submenu .nav-link {
            padding: 0.5rem 1.25rem; /* Padding menor para itens de submenu */
        }

        #sidebar hr {
            border-color: rgba(120, 111, 255, 0.1); /* HR mais sutil */
        }

        /* --- Estilos para Sidebar Recolhida --- */
        .sidebar-collapsed #sidebar {
            width: 88px; /* Largura suficiente para os ícones e padding */
        }
        .sidebar-collapsed #main-content {
            margin-left: 88px;
            width: calc(100% - 88px);
        }
        .sidebar-collapsed #sidebar .sidebar-header .fs-4,
        .sidebar-collapsed #sidebar .nav-link span:not(.step-number), /* Oculta o texto dos links */
        .sidebar-collapsed #sidebar .nav-link .submenu-arrow, /* Oculta a seta do submenu */
        .sidebar-collapsed #sidebar .form-label,
        .sidebar-collapsed #sidebar .form-check-label,
        .sidebar-collapsed #sidebar #sidebar-process-section,
        .sidebar-collapsed #sidebar #sidebar-header-actions, /* Esconde os botões de ação */
        .sidebar-collapsed #sidebar .sidebar-header .badge {
            display: none !important; /* Garante que os elementos sejam completamente removidos do layout */
        }

        .sidebar-collapsed #sidebar .nav-link i {
            font-size: 1.5rem; /* Aumenta o ícone no modo recolhido */
            margin-right: 0 !important; /* Remove margem para centralizar ícone */
        }
        .sidebar-collapsed #sidebar .nav-link {
            justify-content: center;
            padding: 0.75rem; /* Padding ajustado para apenas ícone */
        }
        .sidebar-collapsed #sidebar #sidebar-footer .btn {
            justify-content: center; /* Centraliza o ícone do botão */
            display: flex;
            align-items: center;
            padding: 0.5rem; /* Padding ajustado para botões com apenas ícone */
        }
        .sidebar-collapsed #sidebar #sidebar-toggle i {
            transform: rotate(180deg);
        }
        .sidebar-collapsed #sidebar .sidebar-header {
            justify-content: center; /* Centraliza o ícone principal quando os botões somem */
            padding: 1rem 0.5rem; /* Padding ajustado para ícone centralizado */
        }
        .sidebar-collapsed #sidebar .sidebar-header i {
            margin-right: 0 !important; /* Remove margem do ícone do cabeçalho */
        }
        .sidebar-collapsed #sidebar #sidebar-nav-section {
            padding: 1rem 0; /* Remove padding para centralizar ícones */
            overflow-y: hidden; /* Esconde a rolagem no modo recolhido */
        }

        /* --- Botão de Toggle da Sidebar --- */
        .sidebar-footer-toggle {
            border-top: 1px solid var(--dark-border);
        }
        .sidebar-footer-toggle .nav-link i {
            transition: transform 0.4s ease;
        }
        /* --- Estilo dos Cards --- */
        /* Efeito de borda com gradiente no hover */
        .card {
            position: relative;
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 0.75rem; /* Raio da borda reduzido */
            box-shadow: var(--box-shadow);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            overflow: hidden;
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            border-radius: inherit;
            border: 1px solid transparent;
            background: radial-gradient(circle at top left, var(--dark-primary), var(--dark-accent)) border-box;
            -webkit-mask: 
                linear-gradient(#fff 0 0) padding-box, 
                linear-gradient(#fff 0 0);
            mask:
                linear-gradient(#fff 0 0) padding-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 50px rgba(0,0,0,0.5), 0 0 30px var(--dark-primary-glow);
        }
        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            background-color: var(--dark-surface-secondary);
            border-bottom: 1px solid var(--dark-border);
            font-weight: 600;
            padding: 0.75rem 1.25rem; /* Padding reduzido */
        }
        .card-body { padding: 1.25rem; } /* Padding reduzido */

        /* --- Ajuste para card de Pedidos Disponíveis rolável --- */
        #pedidos-disponiveis-card .card-body {
            max-height: calc(100vh - 220px); /* Altura dinâmica baseada na altura da tela */
            overflow-y: auto;
        }
        @media (max-width: 992px) {
            #main-content { height: auto; }
            #pedidos-disponiveis-card .card-body { max-height: 50vh; } /* Limita a altura no mobile */
        }

        /* --- Ajuste para card de Pedidos Filtrados rolável --- */
        #pedidos-filtrados-card .card-body {
            max-height: 35vh; /* Altura máxima para este card */
            overflow-y: auto;
        }

        /* --- Botões e Controles --- */
        .btn {
            font-weight: 600;
            font-size: 0.85rem; /* Menor */
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            padding: 0.4rem 0.8rem; /* Padding reduzido */
        }
        .btn:hover {
            transform: translateY(-1px); /* Efeito mais sutil */
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--dark-primary), #a49eff);
            border: none;
            box-shadow: 0 0 15px var(--dark-primary-glow);
        }
        .btn-primary#processarBtn {
            animation: glow 2.5s ease-in-out infinite;
        }

        .btn-primary:hover { transform: translateY(-2px) scale(1.02); }
        .btn-primary:hover { box-shadow: 0 4px 20px var(--dark-primary-glow); }
        .form-control, .form-select {
            background-color: var(--dark-surface-secondary);
            border: 1px solid var(--dark-border); font-size: 0.85rem; /* Menor */
            color: var(--dark-text-primary);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--dark-surface-secondary);
            border-color: var(--dark-primary);
            box-shadow: 0 0 0 .2rem var(--dark-primary-glow); /* Sombra de foco reduzida */
            color: var(--dark-text-primary);
        }
        
        /* --- Componentes --- */
        .modal-content { /* Modal mais compacto */
            font-size: 0.9rem;
            background-color: var(--dark-surface);
            backdrop-filter: blur(var(--backdrop-blur));
            border-radius: 1rem;
            border: 1px solid var(--dark-border);
        }
        
        .accordion-item, .accordion-button {
            background-color: transparent;
            border-color: var(--dark-border);
        }
        .accordion-button {
            background-color: var(--dark-surface-secondary);
            color: var(--dark-text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .accordion-button:hover {
            background-color: rgba(139, 132, 255, 0.1);
        }
        .accordion-button:not(.collapsed) {
            background: linear-gradient(45deg, var(--dark-primary), var(--dark-accent));
            color: white;
            box-shadow: 0 0 15px var(--dark-primary-glow);
        }
        .accordion-button::after { /* Ícone de seta do Bootstrap */
            transition: transform 0.3s ease-in-out; /* Suaviza a rotação do ícone */
        }
        .accordion-button:focus { box-shadow: 0 0 0 .2rem var(--dark-primary-glow); }
        .accordion-body { background-color: var(--dark-surface); }
        
        .table { --bs-table-hover-bg: rgba(106, 90, 205, 0.15); }
        thead th { /* Cabeçalho da tabela com a nova cor primária */
            background-color: var(--dark-surface-secondary);
            font-weight: 600; font-size: 0.85rem;
            border-bottom: 2px solid var(--dark-border);
        }
        tbody td { padding: 0.5rem 0.75rem; vertical-align: middle; font-size: 0.875rem; } /* Padding e fonte reduzidos */
        tbody tr { transition: background-color 0.2s ease; }

        .nav-tabs .nav-link { /* Abas mais compactas */
            color: var(--dark-text-secondary);
            border: none;
            border-bottom: 3px solid transparent; /* Transição na borda */
            font-weight: 600;
            padding: 0.6rem 0.9rem; /* Menor */
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link.active, .nav-tabs .nav-item.show .nav-link {
            color: var(--dark-accent);
            background-color: transparent;
            border-color: var(--dark-accent);
        }
        .tab-content {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-top: none;
            border-radius: 0 0 0.75rem 0.75rem; /* Menor */
            padding: 1.25rem; /* Padding reduzido */
        }

        /* Melhoria de Usabilidade */
        .empty-state {
            text-align: center;
            padding: 2rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: 0.75rem;
            color: var(--dark-text-secondary);
        }
        .empty-state .bi { font-size: 2.5rem; color: var(--dark-primary-glow); margin-bottom: 1rem; }
        
        tr.client-highlight > td {
            background-color: rgba(120, 111, 255, 0.25) !important;
        }
        
        .drop-zone-card.drag-over {
            border: 2px dashed var(--dark-primary);
            box-shadow: 0 0 25px var(--dark-primary-glow);
        }

        .print-only {
            display: none;
        }

        /* --- Responsividade --- */
        @media (max-width: 992px) {
            body { display: flex; flex-direction: column; }
            #sidebar {
                position: static; /* Alterado de relative */
                width: 100%;
                height: auto; /* Alterado de min-height */
                margin-bottom: 1.5rem;
                border-right: none;
                border-bottom: 1px solid var(--dark-border);
            }
            .sidebar-scrollable-content { overflow-y: visible; } /* Desativa a rolagem no mobile */
            #sidebar-nav-section { overflow-y: visible; }
            #main-content { margin-left: 0; width: 100%; }
        }
        
        /* --- Estilos de Impressão (Ajustes para tabelas mais compactas) --- */
        @media print {
            body { background-color: #fff; color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-content { margin-left: 0 !important; width: 100% !important; padding: 0 !important; }
            .no-print, #sidebar, .sidebar-step { display: none !important; }
            .container, .card, .accordion-item, .accordion-body, .card-header, .modal-content { background-color: #fff !important; color: #000 !important; border: 1px solid #dee2e6 !important; box-shadow: none !important; }
            button, .status-message, .card-subtitle, .accordion-button.collapsed, .accordion-collapse.collapse, .nav-tabs, .tab-content { display: none !important; }
            .table-responsive { overflow: visible !important; }
            table, th, td { border: 1px solid #dee2e6 !important; color: #000 !important; padding: 0.25rem 0.4rem; font-size: 9pt; }
            h1, h2, h3, h4, h5 { color: #000 !important; }
            .accordion-collapse, .tab-pane { display: block !important; padding: 0 !important; }
            .accordion-button { display: block !important; background-color: #f8f9fa !important; color: #000 !important; }
            .bg-warning { background-color: #ffc107 !important; color: black !important; }
            .bg-success, .bg-primary, .bg-danger { color: white !important; }
            .text-danger { color: #dc3545 !important; }
        }
        @media print { .print-only { display: block !important; } }
    </style>
</head>

    <style>
        /* --- Animação de Carregamento V2 - Mais Realista --- */
        .loading-animation-container {
            position: relative;
            width: 100%;
            height: 120px; /* Aumenta a altura para acomodar a animação */
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-truck {
            position: absolute;
            bottom: 10px;
            left: 55%;
            width: 120px;
            height: 70px;
        }

        .loading-truck-cab {
            position: absolute;
            width: 45px;
            height: 50px;
            background-color: var(--dark-accent);
            bottom: 0;
            left: 0;
            border-radius: 10px 15px 0 0;
        }
        .loading-truck-cab::before { /* Janela */
            content: '';
            position: absolute;
            top: 8px; right: 6px;
            width: 25px; height: 20px;
            background: #0D0E18;
            border-radius: 3px;
            border: 2px solid var(--dark-accent-glow);
        }

        .loading-truck-trailer {
            position: absolute;
            width: 80px;
            height: 65px;
            background-color: var(--dark-surface-secondary);
            border: 2px solid var(--dark-accent);
            bottom: 20px;
            right: -15px;
            border-radius: 5px 8px 8px 5px;
        }

        .wheel {
            position: absolute;
            bottom: 10px;
            width: 22px; height: 22px;
            background: #222;
            border-radius: 50%;
            border: 3px solid #444;
            animation: spin 1s linear infinite;
        }
        .wheel::after { /* Calota */
            content: '';
            position: absolute;
            width: 8px; height: 8px;
            background: #777;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .wheel-front { left: 10px; }
        .wheel-rear { right: 5px; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .person {
            position: absolute;
            bottom: 10px;
            left: 10%;
            width: 25px;
            height: 50px;
            animation: walk-and-load 4s ease-in-out infinite;
        }

        .person-head {
            width: 15px; height: 15px; background-color: var(--dark-primary); border-radius: 50%; margin: 0 auto; position: relative;
        }

        .person-body {
            width: 18px; height: 25px; background-color: var(--dark-primary); border-radius: 10px 10px 0 0; margin: 0 auto; position: relative;
        }

        .person-arm, .person-leg {
            position: absolute;
            background-color: var(--dark-primary);
            border-radius: 5px;
        }
        .person-arm { width: 6px; height: 22px; top: 5px; }
        .person-leg { width: 7px; height: 15px; bottom: -13px; }
        .arm-left { left: -4px; }
        .arm-right { right: -4px; }
        .leg-left { left: 2px; animation: walk-leg-left 4s ease-in-out infinite; }
        .leg-right { right: 2px; animation: walk-leg-right 4s ease-in-out infinite; }

        .box-carried {
            position: absolute;
            width: 25px; height: 25px;
            background-color: #c5a880; /* Cor de caixa de papelão */
            border: 2px solid #8b6e4b;
            opacity: 0; /* Começa invisível */
            animation: carry-box 4s ease-in-out infinite;
            z-index: 10;
        }

        .box-stack {
            position: absolute; bottom: 10px; left: 10%;
        }
        .box-stack .box-item {
            position: relative; opacity: 1; animation: none; margin-top: -10px;
            width: 25px; height: 25px; background-color: #c5a880; border: 2px solid #8b6e4b;
        }

        @keyframes walk-and-load {
            0%, 100% { left: 10%; } /* Posição inicial na pilha */
            20% { left: 10%; } /* Pega a caixa */
            45% { left: 48%; } /* Caminha até o caminhão */
            55% { left: 48%; } /* Coloca a caixa */
            80% { left: 10%; } /* Volta para a pilha */
        }

        @keyframes carry-box {
            0%, 20%, 60%, 100% { opacity: 0; transform: translate(0, 0); }
            25% { opacity: 1; transform: translate(5px, -30px); } /* Pega a caixa */
            45% { opacity: 1; transform: translate(180px, -30px); } /* Leva até o caminhão */
            55% { opacity: 0; transform: translate(180px, 20px); } /* Solta no caminhão */
        }

        @keyframes walk-leg-left {
            0%, 20%, 55%, 80%, 100% { transform: rotate(0deg); }
            32% { transform: rotate(25deg); }
            45% { transform: rotate(-25deg); }
            67% { transform: rotate(25deg); }
        }
        @keyframes walk-leg-right {
            0%, 20%, 55%, 80%, 100% { transform: rotate(0deg); }
            32% { transform: rotate(-25deg); }
            45% { transform: rotate(25deg); }
            67% { transform: rotate(-25deg); }
        }
    </style>
<body>
    
    <div class="d-flex">
        <nav id="sidebar" class="text-white no-print">
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-box-seam-fill me-3 fs-2" style="color: var(--dark-accent);"></i>
                    <span class="fs-4">ApexLog</span>
                    <span class="badge bg-primary-subtle text-primary-emphasis fw-normal ms-2">v1.1</span>
                </div>
                <!-- Ações movidas para o cabeçalho -->
                <div class="d-flex align-items-center" id="sidebar-header-actions">
                    <button class="btn btn-sm btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#configModal" title="Configurações & Ações"><i class="bi bi-sliders"></i></button>
                    <button class="btn btn-sm btn-outline-danger" id="limparResultadosBtn" title="Limpar Tudo"><i class="bi bi-eraser-fill"></i></button>
                </div>
            </div>
            
            <!-- Seção de Processo (Fixa no topo) -->
            <div id="sidebar-process-section">
                <!-- Seção 1: Processo Principal -->
                <h6 class="form-label text-uppercase small fw-bold mt-3">Processo Principal</h6>
                <div id="sidebar-controls">
                    <div class="sidebar-step">
                        <label for="fileInput" class="form-label small"><span class="step-number">1</span> Carregar Arquivo</label>
                        <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="autoProcessCheckbox">
                            <label class="form-check-label small" for="autoProcessCheckbox">Processar ao selecionar</label>
                        </div>
                    </div>

                    <div id="filtro-rota-container" class="sidebar-step" style="display: none;">
                        <label class="form-label small"><span class="step-number">2</span> Filtrar Rotas (Opcional)</label>
                        <div class="mb-2">
                            <select id="rotaInicioSelect" class="form-select form-select-sm">
                                <option value="">Rota de Início...</option>
                            </select>
                        </div>
                        <div>
                            <select id="rotaFimSelect" class="form-select form-select-sm">
                                <option value="">Rota de Fim...</option>
                            </select>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="limparFiltroDeRota()"><span>Limpar Filtro</span></button>
                    </div>

                    <div class="sidebar-step d-grid">
                        <label class="form-label small"><span class="step-number">3</span> Otimizar</label>
                        <button class="btn btn-primary" id="processarBtn" onclick="processar()" disabled>
                            <i class="bi bi-magic me-2"></i><span>Processar Cargas</span>
                        </button>
                        <div id="status" class="mt-2 status-message small text-center"></div>
                    </div>
                </div>
            </div>
            <!-- Seção de Navegação (Rolável se necessário) -->
            <div id="sidebar-nav-section">
                <!-- Seção 2: Navegação -->
                <h6 class="form-label text-uppercase small fw-bold">Navegação</h6>
                <ul class="nav nav-pills flex-column" id="sidebar-nav">
                    <li class="nav-item mb-1"><a href="#summary-view" class="nav-link active"><i class="bi bi-pie-chart-fill me-2 fs-5"></i><span>Resumo</span></a></li>
                    <li class="nav-item mb-1"><a href="#workspace-view" class="nav-link main-nav-link"><i class="bi bi-tools me-2 fs-5"></i><span>Mesas de Trabalho</span></a></li>
                    <li class="nav-item mb-1"><a href="#montagens-especiais-view" class="nav-link main-nav-link"><i class="bi bi-star-fill me-2 fs-5"></i><span>Montagens Especiais</span></a></li>
                    
                    <!-- Submenu para Análises -->
                    <li class="nav-item mb-1">
                        <a class="nav-link collapsed" data-bs-toggle="collapse" href="#analysis-submenu" role="button" aria-expanded="false" aria-controls="analysis-submenu">
                            <i class="bi bi-clipboard2-data-fill me-2 fs-5"></i><span>Análises & Alertas</span> <i class="bi bi-chevron-down submenu-arrow"></i>
                        </a>
                        <div class="collapse nav-submenu" id="analysis-submenu">
                            <ul class="nav flex-column">
                                <li class="nav-item"><a href="#pedidos-bloqueados-view" class="nav-link sub-nav-link"><i class="bi bi-slash-circle-fill me-2"></i><span>Pedidos Bloqueados</span></a></li>
                                <li class="nav-item"><a href="#alteracao-rota-view" class="nav-link sub-nav-link"><i class="bi bi-sign-turn-right-fill me-2"></i><span>Alteração de Rota</span></a></li>
                            </ul>
                        </div>
                    </li>

                    <li class="nav-item mb-1"><a href="#reports-view" class="nav-link"><i class="bi bi-file-earmark-pdf-fill me-2 fs-5"></i><span>Relatórios</span></a></li>
                </ul>
            </div>

            <div class="sidebar-footer-toggle no-print mt-auto">
                <a href="#" id="sidebar-toggle" class="nav-link text-center">
                    <i class="bi bi-chevron-double-left fs-5"></i>
                </a>
            </div>
        </nav>

        <main id="main-content">
            
            <!-- ======================================================================================= -->
            <!-- VIEW: RESUMO GERAL -->
            <!-- ======================================================================================= -->
            <div id="summary-view" class="main-view p-4 overflow-auto" style="display: block;">
                <h1 class="h2 mb-4 animated-entry">ApexLog - Dashboard Otimizado</h1>
                <div class="card animated-entry" id="card-resumo-geral-container" style="display: none;">
                    <div class="card-header"><i class="bi bi-bar-chart-line-fill me-2"></i>Resumo Geral (Varejo)</div>
                    <div class="card-body">
                        <div class="row mb-4" id="kpi-container"></div>
                        <div id="chart-resumo-veiculos" style="min-height: 350px;"></div>
                    </div>
                </div>
                <div id="summary-empty-state" class="empty-state mt-4 animated-entry"><i class="bi bi-pie-chart"></i><p>O resumo geral será exibido aqui após o processamento de um arquivo.</p></div>
            </div>

            <!-- ======================================================================================= -->
            <!-- VIEW: MESAS DE TRABALHO -->
            <!-- ======================================================================================= -->
            <div id="workspace-view" class="main-view p-4" style="display: none;">
                <h1 class="h2 mb-4 animated-entry">Mesas de Trabalho</h1>
                <div class="row h-100">
                <div class="col-lg-8 mb-4 animated-entry">
                    <div class="card h-100">
                        <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-tools me-2"></i>Mesa de Trabalho: Montagem de Cargas</h2></div>
                        <div class="card-body p-0">
                             <ul class="nav nav-tabs nav-fill px-3 pt-2" id="vehicleTabs" role="tablist">
                                 <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fiorino-tab-pane"><i class="bi bi-box-seam-fill me-2"></i>Fiorino</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#van-tab-pane"><i class="bi bi-truck-front-fill me-2"></i>Van</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tres-quartos-tab-pane"><i class="bi bi-truck-flatbed me-2"></i>3/4</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#toco-tab-pane"><i class="bi bi-inboxes-fill me-2"></i>Toco</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cf-tab-pane"><i class="bi bi-truck me-2"></i>Truck</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#funcionarios-tab-pane"><i class="bi bi-people-fill me-2"></i>Funcionários</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#transferencias-tab-pane"><i class="bi bi-arrow-left-right me-2"></i>Transferências</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#exportacao-tab-pane"><i class="bi bi-globe-americas me-2"></i>Exportação</button></li>
                             </ul>
                            <div class="tab-content" id="vehicleTabsContent">
                                <div class="tab-pane fade show active workspace-tab-pane" id="fiorino-tab-pane" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota para montar as Fiorinos.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-fiorino-geral', 'Cargas de Fiorino (Varejo)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-fiorino"><div class="empty-state"><i class="bi bi-box"></i><p>Nenhuma rota de Fiorino disponível. Processe um arquivo para começar.</p></div></div>
                                    <hr class="no-print"><div id="resultado-fiorino-geral" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade workspace-tab-pane" id="van-tab-pane" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota para montar as Vans.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-van-geral', 'Cargas de Van (Varejo)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-van"><div class="empty-state"><i class="bi bi-truck-front-fill"></i><p>Nenhuma rota de Van disponível. Processe um arquivo para começar.</p></div></div>
                                    <hr class="no-print"><div id="resultado-van-geral" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade workspace-tab-pane" id="tres-quartos-tab-pane" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota para montar as cargas 3/4.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-34-geral', 'Cargas de 3/4 (Varejo)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-34"><div class="empty-state"><i class="bi bi-truck-flatbed"></i><p>Nenhuma rota de 3/4 disponível. Processe um arquivo para começar.</p></div></div>
                                    <hr class="no-print"><div id="resultado-34-geral" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade" id="toco-tab-pane" role="tabpanel">
                                    <div id="resultado-toco"><div class="empty-state"><i class="bi bi-inboxes-fill"></i><p>Nenhuma carga "Toco" encontrada. Processe um arquivo.</p></div></div>
                                </div>
                                <div class="tab-pane fade" id="cf-tab-pane" role="tabpanel">
                                    <div id="resultado-cf-accordion-container"><div class="empty-state"><i class="bi bi-truck"></i><p>Nenhum grupo de carga maior encontrado. Processe um arquivo.</p></div></div>
                                </div>
                                <div class="tab-pane fade" id="funcionarios-tab-pane" role="tabpanel">
                                    <div id="resultado-funcionarios-tab"><div class="empty-state"><i class="bi bi-people-fill"></i><p>Nenhum pedido de funcionário encontrado. Processe um arquivo.</p></div></div>
                                </div>
                                <div class="tab-pane fade" id="transferencias-tab-pane" role="tabpanel">
                                    <div id="resultado-transferencias-tab"><div class="empty-state"><i class="bi bi-arrow-left-right"></i><p>Nenhum pedido de transferência encontrado. Processe um arquivo.</p></div></div>
                                </div>
                                <div class="tab-pane fade" id="exportacao-tab-pane" role="tabpanel">
                                    <div id="resultado-exportacao-tab"><div class="empty-state"><i class="bi bi-globe-americas"></i><p>Nenhum pedido de exportação encontrado. Processe um arquivo.</p></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4 animated-entry">
                    <div class="card" id="pedidos-disponiveis-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="card-title h5 mb-0"><i class="bi bi-list-check me-2"></i>Pedidos Disponíveis (Varejo)</h2>
                            <div class="no-print"><button class="btn btn-sm btn-outline-danger" onclick="exportarPedidosAtrasados()"><i class="bi bi-file-earmark-excel-fill me-1"></i>Atrasados</button></div>
                        </div>
                       <div class="card-body">
                           <div class="input-group mb-3 no-print"><input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar Pedido, Cliente ou Cidade..."><button id="searchBtn" class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button></div>
                           <div id="search-result" class="mb-3"></div>
                           <div id="resultado-geral"><div class="empty-state"><i class="bi bi-file-earmark-excel"></i><p>Nenhum pedido de varejo disponível.</p></div></div>
                       </div>
                    </div>

                    <!-- CARD DE PEDIDOS FILTRADOS MOVIDO PARA CÁ -->
                    <div class="card mt-4 animated-entry" id="pedidos-filtrados-card">
                        <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-funnel-fill me-2"></i>Pedidos Filtrados (Bloqueio por Regra)</h2></div>
                        <div class="card-body" id="card-cf-numerico"><div id="resultado-cf-numerico"><div class="empty-state"><i class="bi bi-funnel"></i><p>Aguardando processamento...</p></div></div></div>
                    </div>
                </div>
                </div>
            </div>

            <!-- ======================================================================================= -->
            <!-- VIEW: RESULTADOS ADICIONAIS -->
            <!-- ESTA VIEW FOI DESMEMBRADA EM NOVAS VIEWS DEDICADAS -->
            <!-- ======================================================================================= -->
            <div id="additional-results-view" class="main-view p-4 overflow-auto" style="display: none;">
                <!-- Este container está vazio de propósito, pois seu conteúdo foi movido -->
            </div>
            <div id="montagens-especiais-view" class="main-view p-4 overflow-auto" style="display: none;">
                <h1 class="h2 mb-4 animated-entry">Montagens Especiais</h1>
                <div class="row">
                    <div class="col-lg-6 mb-4 animated-entry">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-cash-coin me-2"></i>Venda Antecipada</h2></div>
                            <div class="card-body">
                                <label for="vendaAntecipadaInput" class="form-label small">Cole os números dos pedidos (um por linha):</label>
                                <textarea class="form-control" id="vendaAntecipadaInput" rows="4" placeholder="Ex: 12345&#10;12346&#10;12347"></textarea>
                                <button class="btn btn-success w-100 mt-3" type="button" onclick="montarCargaPredefinida('vendaAntecipadaInput', 'resultado-venda-antecipada', pedidosVendaAntecipadaProcessados, 'Venda Antecipada')"><i class="bi bi-box-seam me-2"></i>Montar Carga Antecipada</button>
                            </div>
                        </div>
                        <div id="resultado-venda-antecipada" class="mt-4"></div>
                    </div>
                    <div class="col-lg-6 mb-4 animated-entry">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-star-fill me-2"></i>Carga Especial</h2></div>
                            <div class="card-body">
                                <label for="pedidosEspeciaisInput" class="form-label small">Cole os números dos pedidos (um por linha):</label>
                                <textarea class="form-control" id="pedidosEspeciaisInput" rows="4" placeholder="Ex: 54321&#10;54322&#10;54323"></textarea>
                                <button class="btn btn-info w-100 mt-3" type="button" onclick="montarCargaPredefinida('pedidosEspeciaisInput', 'resultado-carga-especial', pedidosEspeciaisProcessados, 'Especial')"><i class="bi bi-magic me-2"></i>Montar Carga Especial</button>
                            </div>
                        </div>
                        <div id="resultado-carga-especial" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <div id="pedidos-bloqueados-view" class="main-view p-4 overflow-auto" style="display: none;">
                <h1 class="h2 mb-4 animated-entry">Análise: Pedidos Bloqueados Manualmente</h1>
                <div class="card border-danger animated-entry">
                    <div class="card-header bg-danger-subtle text-danger-emphasis"><h2 class="card-title h5 mb-0"><i class="bi bi-slash-circle-fill me-2"></i>Pedidos Bloqueados Manualmente</h2></div>
                    <div class="card-body" id="card-bloqueados"><div id="resultado-bloqueados"></div></div>
                </div>
            </div>

            <div id="alteracao-rota-view" class="main-view p-4 overflow-auto" style="display: none;">
                <h1 class="h2 mb-4 animated-entry">Análise: Alteração de Rota</h1>
                <div class="card border-warning animated-entry">
                    <div class="card-header bg-warning-subtle text-warning-emphasis"><h2 class="card-title h5 mb-0"><i class="bi bi-sign-turn-right-fill me-2"></i>Pedidos da Rota 1 para Alteração</h2></div>
                    <div class="card-body"><div id="resultado-rota1"></div></div>
                </div>
            </div>

            <!-- ======================================================================================= -->
            <!-- VIEW: RELATÓRIOS -->
            <!-- ======================================================================================= -->
            <div id="reports-view" class="main-view p-4 overflow-auto" style="display: none;">
                <h1 class="h2 mb-4 animated-entry">Relatórios Gerenciais</h1>
                <div class="card animated-entry">
                     <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-file-earmark-pdf-fill me-2"></i>Previsão de Expedição</h2></div>
                     <div class="card-body text-center">
                         <p class="text-muted">Gere um relatório gerencial em PDF com a previsão de expedição baseada nos resultados atuais.</p>
                         <p class="text-muted small">O relatório incluirá um resumo geral e o detalhamento das cargas de varejo montadas.</p>
                         <button class="btn btn-primary btn-lg mt-2" onclick="gerarRelatorioPDF()">
                             <i class="bi bi-download me-2"></i>Gerar Relatório PDF
                         </button>
                     </div>
                 </div>
            </div>

        </main>
    </div>

    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Configurações & Ações Manuais</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-cpu-fill me-2"></i>Algoritmo de Otimização (Varejo)</h2></div>
                                <div class="card-body">
                                    <label for="optimizationLevelSelect" class="form-label">Nível de Otimização:</label>
                                    <select class="form-select" id="optimizationLevelSelect" onchange="updateOptimizationDescription()">
                                        <option value="1">Nível 1: Rápido</option>
                                        <option value="2" selected>Nível 2: Especialista</option>
                                    </select>
                                    <div id="optimization-description" class="form-text mt-3 small">
                                        <!-- A descrição será inserida aqui pelo JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                             <div class="card h-100">
                                 <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-slash-circle-fill me-2"></i>Bloqueio Manual</h2></div>
                                 <div class="card-body d-flex flex-column">
                                     <label for="bloquearPedidoInput" class="form-label">Número do Pedido a Bloquear:</label>
                                     <div class="input-group mb-3"><input type="text" class="form-control" id="bloquearPedidoInput" placeholder="Digite o número..."><button class="btn btn-outline-danger" type="button" onclick="bloquearPedido()">Bloquear</button></div>
                                     <label class="form-label mt-2">Pedidos Bloqueados:</label>
                                     <div id="lista-pedidos-bloqueados" class="p-2 border rounded flex-grow-1" style="background-color: var(--dark-bg); min-height: 150px;"><div class="empty-state"><i class="bi bi-shield-slash"></i><p>Nenhum pedido bloqueado.</p></div></div>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-truck me-2"></i>Configurações de Veículos</h2></div>
                        <div class="card-body">
                             <div class="row g-3 mb-3 border-bottom pb-3 border-secondary">
                                 <div class="col-md-12"><strong class="text-success fs-5">Fiorino</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="fiorinoMinCapacity" value="300" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Pref. (kg)</label><input type="number" class="form-control" id="fiorinoMaxCapacity" value="500" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Pref. (m³)</label><input type="number" class="form-control" id="fiorinoCubage" value="1.5" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetFiorino">Reset</button></div>
                                 <div class="col-md-3"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Peso Máx Final (kg)</label><input type="number" class="form-control" id="fiorinoHardMaxCapacity" value="560" step="10"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Cubagem Máx Final (m³)</label><input type="number" class="form-control" id="fiorinoHardCubage" value="1.7" step="0.1"></div>
                             </div>
                            <div class="row g-3 mb-3 border-bottom pb-3 border-secondary">
                                 <div class="col-md-12"><strong class="text-primary fs-5">Van</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="vanMinCapacity" value="1100" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Pref. (kg)</label><input type="number" class="form-control" id="vanMaxCapacity" value="1560" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Pref. (m³)</label><input type="number" class="form-control" id="vanCubage" value="5.0" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetVan">Reset</button></div>
                                 <div class="col-md-3"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Peso Máx Final (kg)</label><input type="number" class="form-control" id="vanHardMaxCapacity" value="1600" step="10"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Cubagem Máx Final (m³)</label><input type="number" class="form-control" id="vanHardCubage" value="5.6" step="0.1"></div>
                             </div>
                            <div class="row g-3 mb-3 border-bottom pb-3 border-secondary">
                                 <div class="col-md-12"><strong class="text-warning fs-5">3/4</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="tresQuartosMinCapacity" value="2300" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Máx (kg)</label><input type="number" class="form-control" id="tresQuartosMaxCapacity" value="4100" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Máx (m³)</label><input type="number" class="form-control" id="tresQuartosCubage" value="15.0" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetTresQuartos">Reset</button></div>
                             </div>
                            <div class="row g-3">
                                 <div class="col-md-12"><strong class="fs-5">Toco</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="tocoMinCapacity" value="5000" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Máx (kg)</label><input type="number" class="form-control" id="tocoMaxCapacity" value="8500" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Máx (m³)</label><input type="number" class="form-control" id="tocoCubage" value="30.0" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetToco">Reset</button></div>
                             </div>
                            <div class="mt-4 d-flex justify-content-end"><button class="btn btn-success me-2" id="saveConfig"><i class="bi bi-check-circle-fill me-2"></i>Salvar Tudo</button><button class="btn btn-danger" id="resetAllConfigs"><i class="bi bi-arrow-clockwise me-2"></i>Resetar Tudo</button></div>
                            <div id="configStatus" class="mt-2 status-message text-end"></div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                       <div class="col-lg-6 mb-4 mb-lg-0">
                           <div class="card h-100">
                               <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-scissors me-2"></i>Pedidos Sem Corte</h2></div>
                               <div class="card-body d-flex flex-column">
                                   <label for="semCorteInput" class="form-label">Pedidos a marcar como "Sem Corte":</label>
                                   <div class="input-group mb-3"><textarea class="form-control" id="semCorteInput" rows="3" placeholder="Cole os números aqui..."></textarea><button class="btn btn-outline-warning" type="button" onclick="marcarPedidosSemCorte()">Marcar</button></div>
                                   <label class="form-label mt-2">Pedidos Marcados:</label>
                                   <div id="lista-pedidos-sem-corte" class="p-2 border rounded flex-grow-1" style="background-color: var(--dark-bg); min-height: 100px;"><div class="empty-state"><i class="bi bi-scissors"></i><p>Nenhum pedido marcado.</p></div></div>
                               </div>
                           </div>
                       </div>
                       <div class="col-lg-6 mb-4 mb-lg-0">
                           <div class="card h-100">
                               <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-star-fill me-2"></i>Carga Especial</h2></div>
                               <div class="card-body d-flex flex-column">
                                   <p class="text-muted small">Esta funcionalidade foi movida para a tela principal para facilitar o acesso.</p>
                                   <p class="text-muted small">Você pode encontrar os cards de "Venda Antecipada" e "Carga Especial" logo abaixo da "Mesa de Trabalho".</p>
                                   <i class="bi bi-arrow-down-circle-fill fs-1 text-info text-center mt-3"></i>
                               </div>
                           </div>
                       </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade no-print" id="processing-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: var(--dark-surface); backdrop-filter: blur(12px);">
                <div class="modal-body text-center p-4">
                    <!-- Nova Animação de Carregamento -->
                    <div class="loading-animation-container">
                        <!-- Pilha de caixas no chão -->
                        <div class="box-stack">
                            <div class="box-item"></div>
                            <div class="box-item"></div>
                        </div>
                        <!-- Personagem -->
                        <div class="person">
                            <div class="person-head"></div>
                            <div class="person-body">
                                <div class="person-arm arm-left"></div>
                                <div class="person-arm arm-right"></div>
                                <div class="person-leg leg-left"></div>
                                <div class="person-leg leg-right"></div>
                            </div>
                        </div>
                        <div class="box-carried"></div> <!-- Caixa que o personagem carrega -->
                        <div class="loading-truck">
                            <div class="loading-truck-cab"></div><div class="loading-truck-trailer"></div><div class="wheel wheel-front"></div><div class="wheel wheel-rear"></div>
                        </div>
                    </div>

                    <h5 id="processing-status-text" class="mb-2">Montando Cargas...</h5>
                    <p id="thinking-text" class="text-muted small mb-3" style="height: 20px;"></p>
                    <div class="progress" role="progressbar" style="height: 6px; background-color: rgba(255,255,255,0.1);"><div id="processing-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%; background-color: var(--dark-primary);"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================================================================================
        //  A LÓGICA DO GRÁFICO FOI ATUALIZADA PARA MELHORAR A VISUALIZAÇÃO DOS NÚMEROS E A ESTÉTICA.
        //  O RESTANTE DO CÓDIGO JAVASCRIPT PERMANECE IDÊNTICO E TOTALMENTE FUNCIONAL.
        // ================================================================================================
        let resumoChart = null;

        function updateAndRenderChart() {
            const vehicleCounts = { fiorino: 0, van: 0, tresQuartos: 0, toco: 0 };
            const vehicleWeights = { fiorino: 0, van: 0, tresQuartos: 0, toco: 0 };

            for (const loadId in activeLoads) {
                const load = activeLoads[loadId];
                if (load.vehicleType === 'fiorino') {
                    vehicleCounts.fiorino++;
                    vehicleWeights.fiorino += load.totalKg;
                } else if (load.vehicleType === 'van') {
                    vehicleCounts.van++;
                    vehicleWeights.van += load.totalKg;
                } else if (load.vehicleType === 'tresQuartos') {
                    vehicleCounts.tresQuartos++;
                    vehicleWeights.tresQuartos += load.totalKg;
                }
            }

            vehicleCounts.toco = Object.keys(gruposToco).length;
            for (const cf in gruposToco) {
                vehicleWeights.toco += gruposToco[cf].totalKg;
            }

            const totalVarejoCount = vehicleCounts.fiorino + vehicleCounts.van + vehicleCounts.tresQuartos + vehicleCounts.toco;
            const totalVarejoWeight = vehicleWeights.fiorino + vehicleWeights.van + vehicleWeights.tresQuartos + vehicleWeights.toco;

            const countSeriesData = [vehicleCounts.fiorino, vehicleCounts.van, vehicleCounts.tresQuartos, vehicleCounts.toco, totalVarejoCount];
            const weightSeriesData = [vehicleWeights.fiorino, vehicleWeights.van, vehicleWeights.tresQuartos, vehicleWeights.toco, totalVarejoWeight];
            const categories = ['Fiorino', 'Van', '3/4', 'Toco', 'Total Varejo'];

            const series = [
                { name: 'Quantidade', type: 'column', data: countSeriesData },
                { name: 'Peso (kg)', type: 'column', data: weightSeriesData }
            ];

            if (resumoChart) {
                resumoChart.updateSeries(series);
            } else {
                const options = {
                    series: series,
                    chart: {
                        height: 350,
                        type: 'line',
                        stacked: false,
                        toolbar: { show: false },
                        foreColor: 'var(--dark-text-secondary)',
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800,
                            animateGradually: {
                                enabled: true,
                                delay: 150
                            },
                            dynamicAnimation: {
                                enabled: true,
                                speed: 350
                            }
                        }
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'dark',
                            type: "vertical",
                            shadeIntensity: 0.5,
                            gradientToColors: undefined,
                            inverseColors: false,
                            opacityFrom: 0.85,
                            opacityTo: 0.95,
                            stops: [0, 100]
                        }
                    },
                    stroke: {
                        width: [0, 0],
                        curve: 'smooth'
                    },
                    plotOptions: {
                        bar: {
                            columnWidth: '60%',
                            borderRadius: 5
                        }
                    },
                    colors: ['var(--dark-primary)', 'var(--dark-accent)'], /* Paleta dinâmica do CSS */
                    dataLabels: {
                        enabled: true,
                        formatter: function (val, { seriesIndex }) {
                            if (seriesIndex === 0) { // Quantidade
                                return val.toFixed(0);
                            } else { // Peso
                                if (val >= 1000) {
                                    return (val / 1000).toFixed(1) + 'k';
                                }
                                return val.toFixed(0);
                            }
                        },
                        offsetY: -25,
                        style: {
                            fontSize: '13px',
                            fontWeight: 'bold',
                            colors: ['#fff']
                        },
                        background: {
                          enabled: true,
                          foreColor: '#fff',
                          borderRadius: 3,
                          padding: 5,
                          opacity: 0.7,
                          borderWidth: 1,
                          borderColor: '#666',
                        },
                    },
                    grid: {
                        borderColor: 'var(--dark-border)',
                        strokeDashArray: 4,
                        yaxis: { lines: { show: true } }
                    },
                    xaxis: {
                        categories: categories,
                        labels: { 
                            style: { 
                                fontWeight: 600,
                                fontSize: '13px'
                            } 
                        }
                    },
                    yaxis: [
                        {
                            seriesName: 'Quantidade',
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: 'var(--dark-primary)' },
                            labels: {
                                style: { colors: 'var(--dark-primary)' },
                                formatter: function (val) {
                                    return val.toFixed(0);
                                }
                            },
                            title: {
                                text: "Quantidade de Veículos",
                                style: { color: 'var(--dark-primary)', fontWeight: 600 }
                            },
                        },
                        {
                            seriesName: 'Peso (kg)',
                            opposite: true,
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: 'var(--dark-accent)' },
                            labels: {
                                style: { colors: 'var(--dark-accent)' },
                                formatter: function (val) {
                                    return (val / 1000).toFixed(1) + "k kg";
                                }
                            },
                            title: {
                                text: "Peso Total (kg)",
                                style: { color: 'var(--dark-accent)', fontWeight: 600 }
                            }
                        }
                    ],
                    tooltip: {
                        theme: 'dark',
                        shared: true,
                        intersect: false,
                        y: {
                            formatter: function (val, { seriesIndex }) {
                                if (seriesIndex === 0) { // Quantidade
                                    return val.toFixed(0) + " veículos";
                                } else { // Peso
                                    return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " kg";
                                }
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right',
                        offsetY: -10
                    }
                };

                const chartContainer = document.querySelector("#chart-resumo-veiculos");
                if (chartContainer) {
                    chartContainer.innerHTML = '';
                    resumoChart = new ApexCharts(chartContainer, options);
                    resumoChart.render();
                }
            }

            const container = document.getElementById('card-resumo-geral-container');
            document.getElementById('summary-empty-state').style.display = 'none';
            if (container) container.style.display = 'block';
        }
        
        const agendamentoClientCodes = new Set([
            '1398', '1494', '4639', '4872', '5546', '6896', 'D11238', '17163', '19622', '20350', '22545', '23556', '23761', '24465', '29302', '32462', '32831', '32851', '32869', '32905', '33039', '33046', '33047', '33107', '33388', '33392', '33400', '33401', '33403', '33406', '33420', '33494', '33676', '33762', '33818', '33859', '33907', '33971', '34011', '34096', '34167', '34425', '34511', '34810', '34981', '35050', '35054', '35798', '36025', '36580', '36792', '36853', '36945', '37101', '37589', '37634', '38207', '38448', '38482', '38564', '38681', '38735', 'D38896', '39081', '39177', '39620', '40144', '40442', '40702', '40844', '41233', '42200', '42765', '47244', '47253', '47349', '50151', '50816', '51993', '52780', '53134', '58645', '60900', '61182', '61315', '61316', '61317', '61318', '61324', '63080', '63500', '63705', '64288', '66590', '67660', '67884', '69281', '69286', '69318', '70968', '71659', '73847', '76019', '76580', '77475', '77520', '78895', '79838', '80727', '81353', 'DB3183', '83184', '83634', '85534', 'DB6159', '86350', '86641', '89073', '89151', '90373', '92017', '95092', '95660', '96758', '98227', '99268', '100087', '101246', '101253', '101346', '103518', '105394', '106198', '109288', '110023', '110894', '111145', '111154', '111302', '112207', '112670', '117028', '117123', '120423', '120455', '120473', '120533', '121747', '122155', '122785', '123815', '124320', '125228', '126430', '131476', '132397', '133916', '135395', '135928', '136086', '136260', '137919', '138825', '139013', '139329', '139611', '143102', '44192', '144457', '145014', '145237', '145322', '146644', '146988', '148071', '149598', '150503', '151981', '152601', '152835', '152925', '153289', '154423', '154778', '154808', '155177', '155313', '155368', '155419', '155475', '155823', '155888', '156009', '156585', '156696', '157403', '158235', '159168', '160382', '160982', '161737', '162499', '162789', '163234', '163382', '163458', '164721', '164779', '164780', '164924', '165512', '166195', '166337', '166353', '166468', '166469', '167353', '167810', '167819', '168464', '169863', '169971', '170219', '170220', '170516', '171147', '171160', '171191', '171200', '171320', '171529', '171642', '171863', '172270', '172490', '172656', '172859', '173621', '173964', '173977', '174249', '174593', '174662', '174901', '175365', '175425', '175762', '175767', '175783', '176166', '176278', '176453', '176747', '177327', '177488', '177529', '177883', '177951', '177995', '178255', '178377', '178666', '179104', '179510', '179542', '179690', '180028', '180269', '180342', '180427', '180472', '180494', '180594', '180772', '181012', '181052', '181179', '182349', '182885', '182901', '183011', '183016', '183046', '183048', '183069', '183070', '183091', '183093', '183477', '183676', '183787', '184011', '184038', '189677', '190163', '190241', '190687', '190733', '191148', '191149', '191191', '191902', '191972', '192138', '192369', '192638', '192713', '193211', '193445', '193509', '194432', '194508', '194750', '194751', '194821', '194831', '195287', '195338', '195446', '196118', '196405', '196446', '196784', '197168', '197249', '197983', '198187', '198438', '198747', '198796', '198895', '198907', '198908', '199172', '199615', '199625', '199650', '199651', '199713', '199733', '199927', '199991', '200091', '200194', '200239', '200253', '200382', '200404', '200597', '200917', '201294', '201754', '201853', '201936', '201948', '201956', '201958', '201961', '201974', '202022', '202187', '202199', '202714', '203072', '203093', '203201', '203435', '203436', '203451', '203512', '203769', '204895', '204910', '204911', '204913', '204914', '204915', '204917', '204971', '204979', '205108', '205220', '205744', '205803', '206116', '206163', '206208', '206294', '206380', '206628', '206730', '206731', '206994', '207024', '207029', '207403', '207689', '207902', '208489', '208613', '208622', '208741', '208822', '208844', '208853', '208922', '209002', '209004', '209248', '209281', '209321', '209322', '209684', '210124', '210230', '210490', '210747', '210759', '210819', '210852', '211059', '211110', '211276', '211277', '211279', '211332', '211411', '212401', '212417', '212573', '212900', '213188', '213189', '213190', '213202', '213203', '213242', '213442', '213454', '213855', '213909', '213910', '213967', '214046', '214150', '214387', '214433', '214442', '214594', '214746', '215022', '215116', '215160', '215161', '215493', '215494', '215651', '215687', '215733', '215777', '215942', '216112', '216393', '216400', '216630', '216684', '217190', '217283', '217310', '217343', '217545', '217605', '217828', '217871', '217872', '217877', '217949', '217965', '218169', '218196', '218383', '218486', '218578', '218580', '218640', '218820', '218845', '219539', '219698', '219715', '219884', '220158', '220183', '220645', '220950', '221023', '221248', '221251', '222164', '222165', '223025', '223379', '223525', '223703', '223727', '223877', '223899', '223900', '223954', '224956', '224957', '224958', '224959', '224961', '224962', '225112', '225408', '225449', '225904', '226903', '226939', '227190', '227387', '228589', '228693', '228695'
        ]);

        const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO', 'BOM DIA', 'CASA VISCARD S/A COM. E IMPORTACAO'];
        
        // ================================================================================================
        //  INÍCIO DO SEU CÓDIGO JAVASCRIPT ORIGINAL (SEM MODIFICAÇÕES NA LÓGICA)
        // ================================================================================================

        function deepClone(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }
            if (obj instanceof Date) {
                return new Date(obj.getTime());
            }
            if (Array.isArray(obj)) {
                const arrCopy = [];
                for (let i = 0; i < obj.length; i++) {
                    arrCopy[i] = deepClone(obj[i]);
                }
                return arrCopy;
            }
            const objCopy = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    objCopy[key] = deepClone(obj[key]);
                }
            }
            return objCopy;
        }

        // Função centralizada para ordenar rotas de forma consistente
        function getSortedVarejoRoutes(rotas) {
            const spRoutesSet = new Set(['2555', '2560', '2561', '2571', '2575', '2705', '2735', '2745']);
            const rotasNormais = rotas.filter(r => !spRoutesSet.has(r)).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            const rotasSP = rotas.filter(r => spRoutesSet.has(r)).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            return [...rotasNormais, ...rotasSP];
        }

        function normalizeClientId(id) {
            if (id === null || typeof id === 'undefined') return '';
            return String(id).trim().replace(/^0+/, '');
        }

        function checkAgendamento(pedido) {
            if (!pedido) return;
            const normalizedCode = normalizeClientId(pedido.Cliente);
            pedido.Agendamento = agendamentoClientCodes.has(normalizedCode) ? 'Sim' : 'Não';
        }

        const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());
        
        let planilhaData = [];
        let originalColumnHeaders = [];
        let pedidosGeraisAtuais = [];
        let gruposToco = {};
        let gruposPorCFGlobais = {};
        let pedidosComCFNumericoIsolado = [];
        let pedidosManualmenteBloqueadosAtuais = [];
        let pedidosPrioritarios = [];
        let pedidosRecall = [];
        let pedidosBloqueados = new Set();
        let pedidosEspeciaisProcessados = new Set();
        let pedidosSemCorte = new Set();
        let pedidosVendaAntecipadaProcessados = new Set();
        let rota1SemCarga = [];
        let pedidosFuncionarios = [];
        let pedidosCarretaSemCF = [];
        let pedidosTransferencias = [];
        let pedidosExportacao = [];
        let pedidosCondorTruck = [];
        let tocoPedidoIds = new Set();
        let currentLeftoversForPrinting = [];
        let activeLoads = {};
        let kpiData = {}; // Objeto para armazenar dados dos KPIs
        let processedRoutes = new Set();
        let processedRouteContexts = {};
        let manualLoadInProgress = null;

        const defaultConfigs = {
            fiorinoMinCapacity: 300, fiorinoMaxCapacity: 500, fiorinoCubage: 1.5, fiorinoHardMaxCapacity: 560, fiorinoHardCubage: 1.7,
            vanMinCapacity: 1100, vanMaxCapacity: 1560, vanCubage: 5.0, vanHardMaxCapacity: 1600, vanHardCubage: 5.6,
            tresQuartosMinCapacity: 2300, tresQuartosMaxCapacity: 4100, tresQuartosCubage: 15.0,
            tocoMinCapacity: 5000, tocoMaxCapacity: 8500, tocoCubage: 30.0
        };
        
        function saveConfigurations() {
            const configStatus = document.getElementById('configStatus');
            configStatus.innerHTML = '<p class="text-info">Salvando configurações no armazenamento local...</p>';
            try {
                const configs = {};
                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        configs[key] = parseFloat(element.value);
                    }
                });
                localStorage.setItem('vehicleConfigs', JSON.stringify(configs));
                configStatus.innerHTML = '<p class="text-success">Configurações salvas com sucesso!</p>';
                setTimeout(() => { configStatus.innerHTML = ''; }, 3000);
            } catch (error) {
                console.error("Erro ao salvar no localStorage:", error);
                configStatus.innerHTML = `<p class="text-danger">Erro ao salvar as configurações: ${error.message}</p>`;
            }
        }

        function loadConfigurations() {
            const configStatus = document.getElementById('configStatus');
            configStatus.innerHTML = '<p class="text-info">Carregando configurações...</p>';
            try {
                const savedConfigs = localStorage.getItem('vehicleConfigs');
                const configs = savedConfigs ? JSON.parse(savedConfigs) : defaultConfigs;

                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = configs[key] !== undefined ? configs[key] : defaultConfigs[key];
                    }
                });
                configStatus.innerHTML = '<p class="text-success">Configurações carregadas!</p>';
                setTimeout(() => { configStatus.innerHTML = ''; }, 2000);
            } catch (error) {
                console.error("Erro ao carregar do localStorage:", error);
                configStatus.innerHTML = `<p class="text-warning">Não foi possível carregar configurações. Usando valores padrão.</p>`;
                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) { element.value = defaultConfigs[key]; }
                });
            }
        }
        
        function resetFiorino() {
            document.getElementById('fiorinoMinCapacity').value = defaultConfigs.fiorinoMinCapacity;
            document.getElementById('fiorinoMaxCapacity').value = defaultConfigs.fiorinoMaxCapacity;
            document.getElementById('fiorinoCubage').value = defaultConfigs.fiorinoCubage;
            document.getElementById('fiorinoHardMaxCapacity').value = defaultConfigs.fiorinoHardMaxCapacity;
            document.getElementById('fiorinoHardCubage').value = defaultConfigs.fiorinoHardCubage;
            saveConfigurations();
        }
        function resetVan() {
            document.getElementById('vanMinCapacity').value = defaultConfigs.vanMinCapacity;
            document.getElementById('vanMaxCapacity').value = defaultConfigs.vanMaxCapacity;
            document.getElementById('vanCubage').value = defaultConfigs.vanCubage;
            document.getElementById('vanHardMaxCapacity').value = defaultConfigs.vanHardMaxCapacity;
            document.getElementById('vanHardCubage').value = defaultConfigs.vanHardCubage;
            saveConfigurations();
        }
        function resetTresQuartos() {
            document.getElementById('tresQuartosMinCapacity').value = defaultConfigs.tresQuartosMinCapacity;
            document.getElementById('tresQuartosMaxCapacity').value = defaultConfigs.tresQuartosMaxCapacity;
            document.getElementById('tresQuartosCubage').value = defaultConfigs.tresQuartosCubage;
            saveConfigurations();
        }
        function resetToco() {
            document.getElementById('tocoMinCapacity').value = defaultConfigs.tocoMinCapacity;
            document.getElementById('tocoMaxCapacity').value = defaultConfigs.tocoMaxCapacity;
            document.getElementById('tocoCubage').value = defaultConfigs.tocoCubage;
            saveConfigurations();
        }
        function resetAll() {
            Object.keys(defaultConfigs).forEach(key => { 
                const element = document.getElementById(key);
                if(element) element.value = defaultConfigs[key]; 
            });
            saveConfigurations();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadConfigurations(); 
            } catch (e) {
                console.error("Falha crítica ao carregar configurações, listeners ainda serão ativados.", e);
            }

            document.getElementById('saveConfig').addEventListener('click', saveConfigurations);
            document.getElementById('resetFiorino').addEventListener('click', resetFiorino);
            document.getElementById('resetVan').addEventListener('click', resetVan);
            document.getElementById('resetTresQuartos').addEventListener('click', resetTresQuartos);
            document.getElementById('resetToco').addEventListener('click', resetToco);
            document.getElementById('resetAllConfigs').addEventListener('click', resetAll);
            document.getElementById('limparResultadosBtn').addEventListener('click', limparTudo);

            document.getElementById('searchBtn').addEventListener('click', buscarPedido);
            document.getElementById('pedidoSearchInput').addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    buscarPedido();
                }
            });

            // Lógica de navegação por abas/views na sidebar
            document.querySelectorAll('#sidebar-nav a[href^="#"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    // Se o link clicado for um submenu, não faz nada (o bootstrap cuida do collapse)
                    if (this.getAttribute('data-bs-toggle') === 'collapse') {
                        return;
                    }
                    
                    e.preventDefault();
                    // Remove 'active' de todos os links e adiciona no que foi clicado

                    // Remove 'active' de TODOS os links de navegação para um reset completo
                    document.querySelectorAll('#sidebar-nav a.nav-link.active').forEach(activeLink => {
                        activeLink.classList.remove('active');
                    });
                    
                    // Adiciona 'active' no link clicado
                    this.classList.add('active');

                    // Se for um sub-link, garante que o pai (o link do submenu) também pareça ativo
                    const parentCollapse = this.closest('.collapse');
                    if (parentCollapse) {
                        parentCollapse.previousElementSibling.classList.add('active');
                    }
                    
                    // Esconde todas as views principais
                    document.querySelectorAll('.main-view').forEach(view => {
                        view.style.display = 'none';
                    });
                    // Mostra a view correta com base no href do link
                    const targetViewId = this.getAttribute('href');
                    document.querySelector(targetViewId).style.display = 'block';

                    if (targetViewId === '#summary-view' && resumoChart) { updateAndRenderChart(); }
                });
            });
            
            document.getElementById('optimizationLevelSelect').addEventListener('change', updateOptimizationDescription);
            updateOptimizationDescription();

            // --- Lógica para Sidebar Recolhível ---
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const body = document.body;

            sidebarToggle.addEventListener('click', (e) => {
                e.preventDefault();
                body.classList.toggle('sidebar-collapsed');
                // Salva o estado no localStorage
                localStorage.setItem('sidebarCollapsed', body.classList.contains('sidebar-collapsed'));
                // Redesenha o gráfico se a view de resumo estiver ativa
                if (document.getElementById('summary-view').style.display === 'block' && resumoChart) {
                    setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 400); // Atraso para coincidir com a animação
                }
            });
            // Verifica o estado salvo ao carregar a página
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                body.classList.add('sidebar-collapsed');
            }

            loadStateFromLocalStorage();

            document.addEventListener('shown.bs.collapse', function (event) {
                const accordionCollapse = event.target;
                const accordionHeader = accordionCollapse.previousElementSibling;

                if (!accordionHeader) return;

                // Verifica se o acordeão está dentro do card de pedidos disponíveis
                const pedidosDisponiveisCard = accordionCollapse.closest('#pedidos-disponiveis-card');

                setTimeout(() => {
                    if (pedidosDisponiveisCard) {
                        // Caso especial: acordeão dentro do card com rolagem interna
                        const cardBody = pedidosDisponiveisCard.querySelector('.card-body');
                        if (cardBody) {
                            // Calcula a posição do cabeçalho relativo ao corpo do card e rola
                            const headerTop = accordionHeader.offsetTop;
                            cardBody.scrollTo({
                                top: headerTop - cardBody.offsetTop - 10, // -10 para dar uma pequena margem
                                behavior: 'smooth'
                            });
                        }
                    } else {
                        // Comportamento padrão para todos os outros acordeões
                        accordionHeader.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 150); // Delay para garantir que a animação de abertura não interfira na rolagem.
            });
        });

        function updateOptimizationDescription() {
            const level = document.getElementById('optimizationLevelSelect').value;
            const descriptionDiv = document.getElementById('optimization-description');
            if (level === '1') {
                descriptionDiv.innerHTML = `<p class="mb-1"><strong>Rápido:</strong> Usa uma abordagem direta para agrupar pedidos. Ideal para resultados imediatos com boa qualidade.</p>`;
            } else {
                descriptionDiv.innerHTML = `<p class="mb-1"><strong>Especialista (Recomendado):</strong> Simula um profissional experiente. Utiliza múltiplas estratégias, otimização profunda e reconstrução inteligente para minimizar as sobras ao máximo, respeitando todas as regras.</p>`;
            }
        }


        const rotaVeiculoMap = {
            // Novas rotas de São Paulo (Varejo - Van/3/4)
            '2555': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2555' }, '2560': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2560' }, '2561': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2561' }, '2571': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2571' }, '2575': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2575' }, '2705': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2705' }, '2735': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2735' }, '2745': { type: 'van', title: 'Van / 3/4 São Paulo - Rota 2745' },
            // Rotas do Paraná (Varejo)
            '11101': { type: 'fiorino', title: 'Rota 11101' }, '11301': { type: 'fiorino', title: 'Rota 11301' }, '11311': { type: 'fiorino', title: 'Rota 11311' }, '11561': { type: 'fiorino', title: 'Rota 11561' }, '11721': { type: 'fiorino', title: 'Rotas 11721 & 11731', combined: ['11731'] }, '11731': { type: 'fiorino', title: 'Rotas 11721 & 11731', combined: ['11721'] },
            '11102': { type: 'van', title: 'Rota 11102' }, '11331': { type: 'van', title: 'Rota 11331' }, '11341': { type: 'van', title: 'Rota 11341' }, '11342': { type: 'van', title: 'Rota 11342' }, '11351': { type: 'van', title: 'Rota 11351' }, '11521': { type: 'van', title: 'Rota 11521' }, '11531': { type: 'van', title: 'Rota 11531' }, '11551': { type: 'van', title: 'Rota 11551' }, '11571': { type: 'van', title: 'Rota 11571' }, '11701': { type: 'van', title: 'Rota 11701' }, '11711': { type: 'van', title: 'Rota 11711' },
            '11361': { type: 'tresQuartos', title: 'Rota 11361' }, '11501': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11502', '11511'] }, '11502': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11501', '11511'] }, '11511': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11501', '11502'] }, '11541': { type: 'tresQuartos', title: 'Rota 11541' }
        };
        
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');
        const isNumeric = (str) => str && /^\d+$/.test(String(str).trim());

        fileInput.addEventListener('change', (event) => { handleFile(event.target.files[0]); });

        function handleFile(file) {
            if (!file) return;
            limparTudo();
            statusDiv.innerHTML = '<p class="text-info">Carregando planilha...</p>';
            processarBtn.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates:true});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    let headerRowIndex = -1;
                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && row.some(cell => String(cell).trim().toLowerCase() === 'cod_rota')) {
                            headerRowIndex = i;
                            originalColumnHeaders = row.map(h => h ? String(h).trim() : '');
                            break;
                        }
                    }

                    if (headerRowIndex === -1) throw new Error("Não foi possível encontrar a linha de cabeçalho com 'Cod_Rota'. Verifique o arquivo.");
                    
                    const dataRows = rawData.slice(headerRowIndex + 1);
                    planilhaData = dataRows.map(row => { 
                        const pedido = {}; 
                        originalColumnHeaders.forEach((header, i) => { 
                            if (header) { 
                                if ((header.toLowerCase() === 'predat' || header.toLowerCase() === 'dat_ped')) {
                                    let cellValue = row[i];
                                    if (typeof cellValue === 'number') {
                                        const date = new Date(Math.round((cellValue - 25569) * 86400 * 1000));
                                        if (!isNaN(date.getTime())) {
                                            pedido[header] = date;
                                        } else {
                                            pedido[header] = '';
                                        }
                                    } else if (cellValue instanceof Date) {
                                       if (!isNaN(cellValue.getTime())) {
                                           pedido[header] = cellValue;
                                       } else {
                                           pedido[header] = '';
                                       }
                                    } else {
                                        pedido[header] = cellValue !== undefined ? cellValue : '';
                                    }
                                } else {
                                    pedido[header] = row[i] !== undefined ? row[i] : ''; 
                                }
                            } 
                        }); 
                        pedido.Quilos_Saldo = parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0;
                        pedido.Cubagem = parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0;
                        return pedido; 
                    });
                    planilhaData.forEach(checkAgendamento);
                    statusDiv.innerHTML = `<p class="text-success">Planilha "${file.name}" carregada.</p>`;
                    processarBtn.disabled = false;
                    
                    popularFiltrosDeRota();

                    if (document.getElementById('autoProcessCheckbox').checked) {
                        processar();
                    }

                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Erro:</strong> ${error.message}</p>`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function popularFiltrosDeRota() {
            const container = document.getElementById('filtro-rota-container');
            const rotaInicioSelect = document.getElementById('rotaInicioSelect');
            const rotaFimSelect = document.getElementById('rotaFimSelect');

            rotaInicioSelect.innerHTML = '<option value="">Rota de Início...</option>';
            rotaFimSelect.innerHTML = '<option value="">Rota de Fim...</option>';

            if (planilhaData.length === 0) {
                container.style.display = 'none'; return;
            }

            const rotas = [...new Set(planilhaData.map(p => String(p.Cod_Rota || ''))) ].filter(Boolean);
            rotas.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

            rotas.forEach(rota => {
                const option = new Option(rota, rota);
                rotaInicioSelect.add(option.cloneNode(true));
                rotaFimSelect.add(option);
            });

            container.style.display = 'block';
        }

        function limparFiltroDeRota() {
            document.getElementById('rotaInicioSelect').value = '';
            document.getElementById('rotaFimSelect').value = '';
        }

        function buscarPedido() {
            const searchTerm = document.getElementById('pedidoSearchInput').value.trim().toLowerCase();
            const searchResultDiv = document.getElementById('search-result');
            searchResultDiv.innerHTML = '';

            if (!searchTerm) return;

            if (planilhaData.length === 0) {
                searchResultDiv.innerHTML = '<p class="text-warning">Por favor, carregue e processe a planilha primeiro.</p>';
                return;
            }

            const searchPredicate = p => p && (
                String(p.Num_Pedido).toLowerCase().includes(searchTerm) ||
                String(p.Nome_Cliente).toLowerCase().includes(searchTerm) ||
                String(p.Cidade).toLowerCase().includes(searchTerm)
            );

            let resultados = [];

            // Função auxiliar para adicionar resultados
            const addResult = (pedido, local, viewId, tabId, accordionId, cardId) => {
                resultados.push({ pedido, local, viewId, tabId, accordionId, cardId });
            };

            // 1. Cargas Ativas (Varejo, Toco, Manuais)
            for (const loadId in activeLoads) {
                const load = activeLoads[loadId];
                const foundPedidos = load.pedidos.filter(searchPredicate);

                if (foundPedidos.length > 0) {
                    let viewId = 'workspace-view';
                    let tabId = null;
                    let accordionId = null;
                    const local = `Carga ${load.numero || load.id.split('-')[1]} (${load.vehicleType})`;

                    if (['fiorino', 'van', 'tresQuartos'].includes(load.vehicleType)) {
                        tabId = `${load.vehicleType === 'tresQuartos' ? 'tres-quartos' : load.vehicleType}-tab-pane`;
                    } else if (load.vehicleType === 'toco') {
                        tabId = 'cf-tab-pane'; // Toco está na aba de CF
                        const cf = load.pedidos[0]?.CF;
                        const sortedTocoKeys = Object.keys(gruposToco).sort();
                        const index = sortedTocoKeys.indexOf(String(cf));
                        if (index !== -1) accordionId = `collapseToco${index}`;
                    } else if (load.id.startsWith('venda-antecipada') || load.id.startsWith('especial')) {
                        viewId = 'additional-results-view';
                    }

                    foundPedidos.forEach(p => addResult(p, local, viewId, tabId, accordionId, load.id));
                }
            }

            // 2. Pedidos Disponíveis (Varejo)
            const rotasUnicas = [...new Set(pedidosGeraisAtuais.map(p => String(p.Cod_Rota || ''))) ].filter(Boolean);
            const rotasGerais = getSortedVarejoRoutes(rotasUnicas);
            pedidosGeraisAtuais.filter(searchPredicate).forEach(p => {
                const rotaIndex = rotasGerais.indexOf(String(p.Cod_Rota));
                if (rotaIndex !== -1) {
                    addResult(p, `Pedidos Disponíveis (Rota ${p.Cod_Rota})`, 'workspace-view', null, `collapseGeral${rotaIndex}`, 'pedidos-disponiveis-card');
                }
            });

            // 3. Sobras
            currentLeftoversForPrinting.filter(searchPredicate).forEach(p => {
                const activeTabPane = document.querySelector('.workspace-tab-pane.active');
                const activeTabId = activeTabPane ? activeTabPane.id : null;
                const leftoversCardId = activeTabPane ? `leftovers-card-${activeTabPane.id}` : null;
                addResult(p, 'Sobras Finais', 'workspace-view', activeTabId, null, leftoversCardId);
            });

            // 4. Outras seções (Resultados Adicionais e abas específicas do Workspace)
            const otherSections = [
                { list: pedidosManualmenteBloqueadosAtuais, local: 'Bloqueado Manualmente', viewId: 'pedidos-bloqueados-view', cardId: 'card-bloqueados', accordionId: 'collapseBloqueados' },
                { list: rota1SemCarga, local: 'Pedidos da Rota 1 para Alteração', viewId: 'alteracao-rota-view', cardId: 'resultado-rota1' },
                { list: pedidosComCFNumericoIsolado, local: 'Pedidos Filtrados (Bloqueio por Regra)', viewId: 'workspace-view', cardId: 'pedidos-filtrados-card', accordionId: 'accordionCF' },
                { list: pedidosFuncionarios, local: 'Pedidos de Funcionários', viewId: 'workspace-view', tabId: 'funcionarios-tab-pane', accordionId: 'collapseFuncionarios' },
                { list: pedidosTransferencias, local: 'Pedidos de Transferência', viewId: 'workspace-view', tabId: 'transferencias-tab-pane', accordionId: 'collapseTransferencias' },
                { list: pedidosExportacao, local: 'Pedidos de Exportação', viewId: 'workspace-view', tabId: 'exportacao-tab-pane', accordionId: 'collapseExportacao' }
            ];

            otherSections.forEach(section => {
                section.list.filter(searchPredicate).forEach(p => {
                    addResult(p, section.local, section.viewId, section.tabId, section.accordionId, section.cardId);
                });
            });

            // 5. Cargas de Truck/Carreta (CF)
            const specialKeysOrder = ["Pedidos Condor (Truck)", "Pedidos de Carreta/Truck sem CF"];
            const sortedCfKeys = Object.keys(gruposPorCFGlobais).sort((a,b) => {
                const aIsSpecial = specialKeysOrder.includes(a);
                const bIsSpecial = specialKeysOrder.includes(b);
                if (aIsSpecial && bIsSpecial) return specialKeysOrder.indexOf(a) - specialKeysOrder.indexOf(b);
                if (aIsSpecial) return -1; if (bIsSpecial) return 1;
                return a.localeCompare(b, undefined, {numeric: true});
            });

            for (const cf in gruposPorCFGlobais) {
                gruposPorCFGlobais[cf].pedidos.filter(searchPredicate).forEach(p => {
                    const index = sortedCfKeys.indexOf(cf);
                    if (index !== -1) {
                        addResult(p, `Carga Truck/Carreta (${cf})`, 'workspace-view', 'cf-tab-pane', `collapseCF-Mesa-${index}`);
                    }
                });
            }

            // Remover duplicatas baseadas no número do pedido
            const uniqueResultados = [];
            const seenPedidos = new Set();
            resultados.forEach(res => {
                if (!seenPedidos.has(res.pedido.Num_Pedido)) { uniqueResultados.push(res); seenPedidos.add(res.pedido.Num_Pedido); }
            });

            if (uniqueResultados.length === 0) {
                searchResultDiv.innerHTML = '<div class="alert alert-warning">Nenhum pedido encontrado para o termo buscado.</div>';
            } else {
                let html = `<div class="alert alert-info d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${uniqueResultados.length} resultado(s) encontrado(s):</h5>
                                <button type="button" class="btn-close" aria-label="Fechar Busca" onclick="recolherBusca()"></button>
                            </div>`;
                html += '<ul class="list-group">';
                uniqueResultados.forEach((res, index) => {
                    const { pedido, local, viewId, tabId, accordionId, cardId } = res;
                    const isPriority = pedidosPrioritarios.includes(String(pedido.Num_Pedido));
                    const isRecall = pedidosRecall.includes(String(pedido.Num_Pedido));
                    const isInLoad = Object.values(activeLoads).some(load => load.pedidos.some(p => p.Num_Pedido === pedido.Num_Pedido));

                    const priorityButtonHtml = isPriority
                        ? `<button class="btn btn-sm btn-outline-secondary" onclick="despriorizarPedido('${res.pedido.Num_Pedido}')"><i class="bi bi-star-slash-fill me-1"></i>Remover Prioridade</button>`
                        : `<button class="btn btn-sm btn-outline-warning" onclick="priorizarPedido('${res.pedido.Num_Pedido}')"><i class="bi bi-star-fill me-1"></i>Priorizar</button>`;

                    const recallButtonHtml = isRecall
                        ? `<button class="btn btn-sm btn-outline-secondary" onclick="despriorizarRecall('${res.pedido.Num_Pedido}')"><i class="bi bi-arrow-repeat me-1"></i>Remover Recall</button>`
                        : `<button class="btn btn-sm btn-outline-info" onclick="priorizarRecall('${res.pedido.Num_Pedido}')"><i class="bi bi-arrow-repeat me-1"></i>Priorizar Recall</button>`;

                    let blockInfoHtml = '';
                    const blockType = String(pedido['BLOQ.'] || '').trim().toUpperCase();
                    if (blockType === 'C') blockInfoHtml = '<span class="badge bg-danger ms-2">Bloqueado: Financeiro</span>';
                    else if (blockType === 'V') blockInfoHtml = '<span class="badge bg-danger ms-2">Bloqueado: Comercial</span>';

                    const params = `\'${pedido.Num_Pedido}\', \'${viewId}\', ${tabId ? `'${tabId}'` : 'null'}, ${accordionId ? `'${accordionId}'` : 'null'}, ${cardId ? `'${cardId}'` : 'null'}`;
                    const clickableAreaStyle = 'cursor: pointer;';

                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div onclick="highlightPedido(${params})" style="${clickableAreaStyle}" class="flex-grow-1 me-3">
                                <strong>Pedido:</strong> ${pedido.Num_Pedido} 
                                ${isInLoad ? '<span class="badge bg-success ms-2">Em Carga Montada</span>' : ''}
                                ${isPriority ? '<span class="badge bg-warning text-dark ms-2">Prioridade</span>' : ''}
                                ${isRecall ? '<span class="badge bg-info ms-2">Recall</span>' : ''}<br>
                                ${blockInfoHtml}
                                <small class="d-block"><strong>Rota:</strong> ${pedido.Cod_Rota || 'N/A'}</small><br>
                                <small><strong>Cliente:</strong> ${pedido.Nome_Cliente} (${pedido.Cidade})</small><br>
                                <small class="text-muted"><strong>Local:</strong> ${local}</small>
                            </div>
                            <div class="btn-group">
                                ${!isInLoad ? priorityButtonHtml : ''}
                                ${!isInLoad ? recallButtonHtml : ''}
                            </div>
                        </li>`;
                });
                html += '</ul>';
                searchResultDiv.innerHTML = html;
            }
        }

        function recolherBusca() {
            document.getElementById('search-result').innerHTML = '';
        }

        function priorizarPedido(numPedido) {
            numPedido = String(numPedido);
            if (!pedidosPrioritarios.includes(numPedido)) {
                console.log(`Priorizando pedido: ${numPedido}`);
                pedidosPrioritarios.push(numPedido);
                // Se a planilha já foi processada, reprocessa para aplicar a prioridade
                saveStateToLocalStorage(); // Salva a prioridade imediatamente
                if (planilhaData.length > 0) processar();
            }
        }

        function priorizarRecall(numPedido) {
            numPedido = String(numPedido);
            if (!pedidosRecall.includes(numPedido)) {
                console.log(`Priorizando para Recall: ${numPedido}`);
                pedidosRecall.push(numPedido);
                saveStateToLocalStorage();
                if (planilhaData.length > 0) processar();
            }
        }

        function despriorizarRecall(numPedido) {
            numPedido = String(numPedido);
            const index = pedidosRecall.indexOf(numPedido);
            if (index > -1) {
                console.log(`Removendo prioridade de Recall: ${numPedido}`);
                pedidosRecall.splice(index, 1);
                saveStateToLocalStorage();
                if (planilhaData.length > 0) processar();
            }
        }

        function despriorizarPedido(numPedido) {
            numPedido = String(numPedido);
            const index = pedidosPrioritarios.indexOf(numPedido);
            if (index > -1) {
                console.log(`Removendo prioridade do pedido: ${numPedido}`);
                pedidosPrioritarios.splice(index, 1);
                // Se a planilha já foi processada, reprocessa para remover a prioridade
                saveStateToLocalStorage(); // Salva a remoção da prioridade imediatamente
                if (planilhaData.length > 0) processar();
            }
        }

        function highlightPedido(numPedido, viewId, tabId, collapseId, cardId = null) {
            const scrollToTarget = () => {
                setTimeout(() => { // Delay para garantir que todas as animações de UI (abas, accordions) terminaram
                    let targetElement;
                    // Prioridade 1: Tenta encontrar a linha da tabela (TR) do pedido pelo seu ID único.
                    targetElement = document.getElementById(`pedido-${numPedido}`);

                    // Prioridade 2: Se não encontrar a linha, tenta o card ou container onde o pedido está.
                    if (!targetElement && cardId) {
                        targetElement = document.getElementById(cardId);
                    }

                    // Prioridade 3 (Fallback): Se ainda não encontrou, tenta o cabeçalho do accordion.
                    // Isso é útil para seções que não têm um cardId, mas têm um collapseId.
                    if (!targetElement && collapseId) {
                        const collapseEl = document.getElementById(collapseId);
                        if (collapseEl) targetElement = collapseEl.previousElementSibling;
                    }

                    document.querySelectorAll('.search-highlight').forEach(el => el.classList.remove('search-highlight', 'table-info'));

                    if (targetElement) {
                        targetElement.classList.add('search-highlight');
                        if (targetElement.tagName === 'TR') {
                            targetElement.classList.add('table-info');
                        }
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300); // Aumentado ligeiramente para garantir a renderização em todas as situações
            };

            // 1. Navegar para a View principal (Resumo, Mesas, etc.)
            const targetLink = document.querySelector(`#sidebar-nav a.nav-link[href="#${viewId}"]`);
            if (targetLink && !targetLink.classList.contains('active')) {
                // Remove active de todos os links
                document.querySelectorAll('#sidebar-nav a.nav-link.active').forEach(l => l.classList.remove('active'));
                
                // Ativa o link alvo
                targetLink.classList.add('active');

                // Se o link alvo está dentro de um submenu, expande o submenu e ativa o link pai
                const parentCollapse = targetLink.closest('.collapse');
                if (parentCollapse) {
                    const parentCollapseInstance = bootstrap.Collapse.getOrCreateInstance(parentCollapse);
                    parentCollapseInstance.show();
                    const parentLink = parentCollapse.previousElementSibling;
                    if (parentLink) {
                        parentLink.classList.add('active');
                    }
                }

                // Mostra a view correta
                document.querySelectorAll('.main-view').forEach(view => view.style.display = 'none');
                document.getElementById(viewId).style.display = 'block';
            }

            // 2. Navegar para a aba interna (se houver) e expandir o accordion
            const expandAccordionAndScroll = () => {
                const collapseElement = collapseId ? document.getElementById(collapseId) : null;
                if (collapseElement && !collapseElement.classList.contains('show') && bootstrap.Collapse.getOrCreateInstance(collapseElement)) {
                    collapseElement.addEventListener('shown.bs.collapse', scrollToTarget, { once: true });
                    bootstrap.Collapse.getOrCreateInstance(collapseElement).show();
                } else {
                    scrollToTarget();
                }
            };

            // Se houver uma aba interna (dentro de 'Mesas de Trabalho'), navega para ela primeiro
            if (tabId) {
                const tabEl = document.querySelector(`button[data-bs-target="#${tabId}"]`);
                if (tabEl && !tabEl.classList.contains('active')) {
                    const tabInstance = bootstrap.Tab.getOrCreateInstance(tabEl);
                    tabEl.addEventListener('shown.bs.tab', expandAccordionAndScroll, { once: true });
                    tabInstance.show();
                } else {
                    expandAccordionAndScroll();
                }
            } else {
                expandAccordionAndScroll();
            }
        }

        document.head.insertAdjacentHTML('beforeend', `<style>
            .search-highlight { animation: highlight-animation 1.5s ease-in-out; }
            @keyframes highlight-animation { 0% { box-shadow: 0 0 0 0px var(--dark-accent-glow); } 50% { box-shadow: 0 0 12px 4px var(--dark-accent); } 100% { box-shadow: 0 0 0 0px var(--dark-accent-glow); } }
        </style>`);
        
        function atualizarListaBloqueados() {
            const divLista = document.getElementById('lista-pedidos-bloqueados');
            divLista.innerHTML = '';
            if (pedidosBloqueados.size === 0) {
                divLista.innerHTML = '<div class="empty-state"><i class="bi bi-shield-slash"></i><p>Nenhum pedido bloqueado.</p></div>';
                return;
            }
            
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            pedidosBloqueados.forEach(numPedido => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center py-1 bg-transparent';
                item.innerHTML = `<span>${numPedido}</span> <button class="btn btn-sm btn-outline-secondary" onclick="desbloquearPedido('${numPedido}')">Desbloquear</button>`;
                list.appendChild(item);
            });
            divLista.appendChild(list);
        }

        function bloquearPedido() {
            const input = document.getElementById('bloquearPedidoInput');
            const numPedido = input.value.trim();
            if (numPedido) {
                pedidosBloqueados.add(numPedido);
                input.value = '';
                saveStateToLocalStorage();
                atualizarListaBloqueados();
                if (planilhaData.length > 0) processar();
            }
        }

        function desbloquearPedido(numPedido) {
            pedidosBloqueados.delete(numPedido);
            saveStateToLocalStorage();
            atualizarListaBloqueados();
            if (planilhaData.length > 0) processar();
        }

        function atualizarListaSemCorte() {
            const divLista = document.getElementById('lista-pedidos-sem-corte');
            divLista.innerHTML = '';
            if (pedidosSemCorte.size === 0) {
                divLista.innerHTML = '<div class="empty-state"><i class="bi bi-scissors"></i><p>Nenhum pedido marcado.</p></div>';
                return;
            }
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            pedidosSemCorte.forEach(numPedido => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center py-1 bg-transparent';
                item.innerHTML = `<span>${numPedido}</span> <button class="btn btn-sm btn-outline-secondary" onclick="removerMarcacaoSemCorte('${numPedido}')">Remover</button>`;
                list.appendChild(item);
            });
            divLista.appendChild(list);
        }

        function marcarPedidosSemCorte() {
            const input = document.getElementById('semCorteInput');
            const numeros = input.value.split('\n').map(n => n.trim()).filter(Boolean);
            numeros.forEach(num => pedidosSemCorte.add(num));
            saveStateToLocalStorage();
            input.value = '';
            atualizarListaSemCorte();
            if (planilhaData.length > 0) processar();
        }

        function removerMarcacaoSemCorte(numPedido) {
            pedidosSemCorte.delete(numPedido);
            saveStateToLocalStorage();
            atualizarListaSemCorte();
            if (planilhaData.length > 0) processar();
        }

        function resetarEstadoGlobal() {
            pedidosGeraisAtuais = [];
            gruposToco = {};
            gruposPorCFGlobais = {};
            pedidosComCFNumericoIsolado = [];
            rota1SemCarga = [];
            pedidosFuncionarios = [];
            pedidosCarretaSemCF = [];
            pedidosTransferencias = [];
            pedidosExportacao = [];
            pedidosCondorTruck = [];
            pedidosManualmenteBloqueadosAtuais = [];
            tocoPedidoIds.clear();
            currentLeftoversForPrinting = [];
            activeLoads = {};
            kpiData = {};
            processedRoutes.clear();
            // As prioridades (pedidosPrioritarios, pedidosRecall) não são limpas aqui,
            // pois são um estado persistente que o usuário controla manualmente.
            // As prioridades não devem ser limpas aqui, pois são um estado persistente.
        }

        function limparTudo(){
            resetarEstadoGlobal();
            originalColumnHeaders = []; 

            processedRouteContexts = {};
            pedidosEspeciaisProcessados.clear();
            pedidosBloqueados.clear();
            pedidosSemCorte.clear();
            pedidosRecall = [];
            pedidosPrioritarios = [];
            pedidosVendaAntecipadaProcessados.clear();
            
            const idsParaLimpar = [
                'resultado-venda-antecipada', 'resultado-carga-especial', 'resultado-bloqueados', 'resultado-geral', 
                'resultado-fiorino-geral', 'resultado-van-geral', 'resultado-34-geral',
                'resultado-rota1', 'kpi-container',
                'resultado-cf-accordion-container', 'resultado-cf-numerico', 'search-result',
                'resultado-funcionarios-tab', 'resultado-transferencias-tab', 'resultado-exportacao-tab'
            ];
            const emptyStateMessages = {
                'resultado-geral': '<div class="empty-state"><i class="bi bi-file-earmark-excel"></i><p>Nenhum pedido de varejo disponível.</p></div>',
                'botoes-fiorino': '<div class="empty-state"><i class="bi bi-box"></i><p>Nenhuma rota de Fiorino disponível. Processe um arquivo para começar.</p></div>',
                'botoes-van': '<div class="empty-state"><i class="bi bi-truck-front-fill"></i><p>Nenhuma rota de Van disponível. Processe um arquivo para começar.</p></div>',
                'botoes-34': '<div class="empty-state"><i class="bi bi-truck-flatbed"></i><p>Nenhuma rota de 3/4 disponível. Processe um arquivo para começar.</p></div>',
                'resultado-toco': '<div class="empty-state"><i class="bi bi-inboxes-fill"></i><p>Nenhuma carga "Toco" encontrada. Processe um arquivo.</p></div>'
            };

            idsParaLimpar.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = '';
            });
            Object.keys(emptyStateMessages).forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = emptyStateMessages[id];
            });

            if (resumoChart) {
                resumoChart.destroy();
                resumoChart = null;
            }
            document.getElementById('card-resumo-geral-container').style.display = 'none';
            document.getElementById('filtro-rota-container').style.display = 'none';
            document.getElementById('summary-empty-state').style.display = 'block';

            document.getElementById('pedidosEspeciaisInput').value = '';
            document.getElementById('bloquearPedidoInput').value = '';
            document.getElementById('pedidoSearchInput').value = '';
            document.getElementById('semCorteInput').value = '';
            document.getElementById('vendaAntecipadaInput').value = '';
            atualizarListaBloqueados();
            atualizarListaSemCorte();
            limparFiltroDeRota();
            
            fileInput.value = '';
            planilhaData = [];
            processarBtn.disabled = true;
            localStorage.removeItem('logisticsRouteContexts'); // Limpeza explícita
            localStorage.removeItem('logisticsAppState');
            statusDiv.innerHTML = '';
        }

        function processar() {
            statusDiv.innerHTML = '<div class="d-flex align-items-center justify-content-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div><span class="text-primary">Processando...</span></div>';
            processarBtn.disabled = true;
            
            setTimeout(() => {
                const resultadoGeralDiv = document.getElementById('resultado-geral');
                const resultadoTocoDiv = document.getElementById('resultado-toco');
                const resultadoCfNumericoDiv = document.getElementById('resultado-cf-numerico');
                const resultadoRota1Div = document.getElementById('resultado-rota1');
                const resultadoBloqueadosDiv = document.getElementById('resultado-bloqueados');
                const resultadoCfAccordionDiv = document.getElementById('resultado-cf-accordion-container');
                const resultadoFuncionariosDiv = document.getElementById('resultado-funcionarios-tab');
                const resultadoTransferenciasDiv = document.getElementById('resultado-transferencias-tab');
                const resultadoExportacaoDiv = document.getElementById('resultado-exportacao-tab');
                
                try {
                    if (planilhaData.length === 0) { throw new Error("Nenhum dado de planilha carregado."); }
                    
                    resetarEstadoGlobal();

                    const rotaInicio = document.getElementById('rotaInicioSelect').value;
                    const rotaFim = document.getElementById('rotaFimSelect').value;
                    let dadosParaProcessar = [...planilhaData];

                    if (rotaInicio && rotaFim) {
                        dadosParaProcessar = planilhaData.filter(p => {
                            const rotaPedido = String(p.Cod_Rota || '');
                            return rotaPedido.localeCompare(rotaInicio, undefined, { numeric: true }) >= 0 &&
                                   rotaPedido.localeCompare(rotaFim, undefined, { numeric: true }) <= 0;
                        });
                        statusDiv.innerHTML = `<p class="text-info">Processando ${dadosParaProcessar.length} pedidos entre as rotas ${rotaInicio} e ${rotaFim}...</p>`;
                    }
                    
                    [
                        'resultado-fiorino-geral', 'resultado-van-geral', 'resultado-34-geral', 'resultado-geral', 
                        'resultado-toco', 'resultado-cf-accordion-container', 'resultado-cf-numerico', 
                        'resultado-rota1', 'resultado-bloqueados', 'resultado-funcionarios-tab', 
                        'resultado-transferencias-tab', 'resultado-exportacao-tab'
                    ].forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.innerHTML = '';
                    });
                    
                    const pedidosExcluidos = new Set();
                    dadosParaProcessar.forEach(p => {
                        const coluna5 = String(p.Coluna5 || '').toUpperCase();
                        if(coluna5.includes('TBL FUNCIONARIO')) {
                            pedidosFuncionarios.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('TBL ESP CARRETA') && !isNumeric(p.CF)) {
                            pedidosCarretaSemCF.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('TABELA TRANSFER') || coluna5.includes('TRANSF. TODESCH')) {
                            pedidosTransferencias.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('TBL EXPORTACAO')) {
                            pedidosExportacao.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('CONDOR (TRUCK)') || coluna5.includes('CONDOR TOD TRUC')) {
                            pedidosCondorTruck.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        }
                    });
                    
                    displayPedidosFuncionarios(resultadoFuncionariosDiv, pedidosFuncionarios);
                    displayPedidosTransferencias(resultadoTransferenciasDiv, pedidosTransferencias);
                    displayPedidosExportacao(resultadoExportacaoDiv, pedidosExportacao);
                    
                    let dadosFiltrados = dadosParaProcessar.filter(p => !pedidosExcluidos.has(p.Num_Pedido));
                    
                    let pedidosDisponiveis = [];
                    dadosFiltrados.filter(p => p.Num_Pedido).forEach(p => {
                        if (pedidosBloqueados.has(String(p.Num_Pedido))) {
                            pedidosManualmenteBloqueadosAtuais.push(p);
                        } else {
                            pedidosDisponiveis.push(p);
                        }
                    });
                    displayPedidosBloqueados(resultadoBloqueadosDiv, pedidosManualmenteBloqueadosAtuais);
                    
                    pedidosDisponiveis = pedidosDisponiveis.filter(p => 
                        !pedidosEspeciaisProcessados.has(String(p.Num_Pedido)) &&
                        !pedidosVendaAntecipadaProcessados.has(String(p.Num_Pedido))
                    );

                    rota1SemCarga = pedidosDisponiveis.filter(p => {
                        const codRota = String(p.Cod_Rota || '').trim();
                        const cfValue = p.CF;
                        const coluna5Value = String(p.Coluna5 || '').trim().toUpperCase();

                        if (codRota !== '1') { return false; }
                        if (isNumeric(cfValue)) { return false; }
                        
                        const filtroDescricoes = ['TBL 08', 'TBL TODESCHINI', 'PROMO BOLINHO'];
                        return filtroDescricoes.some(termo => coluna5Value.includes(termo));
                    });

                    const rota1PedidoIds = new Set(rota1SemCarga.map(p => p.Num_Pedido));
                    displayRota1(resultadoRota1Div, rota1SemCarga);

                    let pedidosParaProcessamentoGeral = pedidosDisponiveis.filter(p => !rota1PedidoIds.has(p.Num_Pedido));

                    const pedidos = pedidosParaProcessamentoGeral.filter(p => String(p.Coluna4) != '500');

                    const clientesComBloqueio = new Set();
                    pedidos.forEach(p => {
                        if (String(p['BLOQ.']).trim()) { 
                            clientesComBloqueio.add(normalizeClientId(p.Cliente));
                        }
                    });

                    const pedidosTocoBase = pedidos.filter(p => (p.Coluna4 && String(p.Coluna4).toUpperCase().includes('TOCO')) || (p.Coluna5 && String(p.Coluna5).toUpperCase().includes('TOCO')));
                    const cfCounts = {};
                    pedidosTocoBase.forEach(p => { if (p.CF && isNumeric(p.CF)) { cfCounts[p.CF] = (cfCounts[p.CF] || 0) + 1; } });
                    const cfsRepetidos = Object.keys(cfCounts).filter(cf => cfCounts[cf] > 1);
                    const pedidosTocoFiltrados = pedidosTocoBase.filter(p => cfsRepetidos.includes(String(p.CF)));
                    gruposToco = pedidosTocoFiltrados.reduce((acc, p) => {
                        const cf = p.CF;
                        if (!acc[cf]) { acc[cf] = { pedidos: [], totalKg: 0, totalCubagem: 0 }; } 
                        acc[cf].pedidos.push(p); 
                        acc[cf].totalKg += p.Quilos_Saldo;
                        acc[cf].totalCubagem += p.Cubagem;
                        return acc;
                    }, {});
                    displayToco(resultadoTocoDiv, gruposToco);
                    tocoPedidoIds = new Set(pedidosTocoFiltrados.map(p => String(p.Num_Pedido)));

                    let pedidosParaProcessamentoVarejo = [];
                    let gruposPorCF = {};
                    pedidosComCFNumericoIsolado = []; // prettier-ignore
                    
                    const truckColuna4Values = new Set(['15', '17', '21', '23']);
                    pedidos.forEach(p => {
                        if (tocoPedidoIds.has(String(p.Num_Pedido))) return;
                        if (truckColuna4Values.has(String(p.Coluna4))) return;
                        
                        if (isNumeric(p.CF)) {
                            const cf = String(p.CF).trim();
                            if (!gruposPorCF[cf]) {
                                gruposPorCF[cf] = { pedidos: [], totalKg: 0, totalCubagem: 0 };
                            }
                            gruposPorCF[cf].pedidos.push(p);
                            gruposPorCF[cf].totalKg += p.Quilos_Saldo;
                            gruposPorCF[cf].totalCubagem += p.Cubagem;
                        } else {
                            if (clientesComBloqueio.has(normalizeClientId(p.Cliente))) {
                                pedidosComCFNumericoIsolado.push(p);
                            } else {
                                pedidosParaProcessamentoVarejo.push(p);
                            }
                        }
                    });
                    
                    gruposPorCFGlobais = gruposPorCF;
                    displayCargasCfAccordion(resultadoCfAccordionDiv, gruposPorCFGlobais, pedidosCarretaSemCF, pedidosCondorTruck);
                    displayPedidosCFNumerico(resultadoCfNumericoDiv, pedidosComCFNumericoIsolado);

                    pedidosGeraisAtuais = [...pedidosParaProcessamentoVarejo]; 
                    const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => {
                        const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += p.Quilos_Saldo; return acc;
                    }, {});
                    displayGerais(resultadoGeralDiv, gruposGerais);
                    
                    updateAndRenderChart();
                    updateAndRenderKPIs();
                    saveStateToLocalStorage();
                    
                    statusDiv.innerHTML = `<p class="text-success">Processamento concluído!</p>`;
                } catch (error) { 
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Ocorreu um erro:</strong></p><pre>${error.stack}</pre>`; 
                    console.error(error); 
                } finally {
                    processarBtn.disabled = false;
                }
            }, 50);
        }

        function updateAndRenderKPIs() {
            // --- Lógica de KPIs Estáticos para Visão de Planejamento ---
            // Os valores são calculados com base nos dados iniciais após o processamento.

            // 1. Calcula totais de Toco
            const pesoTotalToco = Object.values(gruposToco).reduce((sum, g) => sum + g.totalKg, 0);
            const totalPedidosToco = Object.values(gruposToco).reduce((sum, g) => sum + g.pedidos.length, 0);

            // 2. Calcula totais do Varejo
            const totalPedidosVarejo = pedidosGeraisAtuais.length;
            const pesoTotalVarejo = pedidosGeraisAtuais.reduce((sum, p) => sum + p.Quilos_Saldo, 0);

            // 3. Calcula os pedidos que precisam ser predatados (atrasados e sem bloqueio restritivo)
            const todosPedidosParaAnalise = [...pedidosGeraisAtuais, ...pedidosComCFNumericoIsolado, ...pedidosManualmenteBloqueadosAtuais, ...rota1SemCarga];
            const pedidosAPredatar = todosPedidosParaAnalise.filter(p => {
                const bloqueio = String(p['BLOQ.'] || '').trim().toUpperCase();
                return isOverdue(p.Predat) && (bloqueio === '' || bloqueio === 'C');
            });

            // 4. NOVO KPI: Calcula o peso que ficou fora de carga (Saldo para o próximo dia)
            // Lógica corrigida: O valor inicial são os bloqueados. As sobras das montagens são somadas e nunca diminuem o total.
            const pesoDosBloqueados = pedidosManualmenteBloqueadosAtuais.reduce((s, p) => s + p.Quilos_Saldo, 0) + pedidosComCFNumericoIsolado.reduce((s, p) => s + p.Quilos_Saldo, 0);
            const pesoDasSobrasAcumuladas = currentLeftoversForPrinting.reduce((s, p) => s + p.Quilos_Saldo, 0);
            const pesoForaDeCarga = pesoDosBloqueados + pesoDasSobrasAcumuladas;

            // 5. Consolida os dados para os KPIs e armazena
            kpiData.totalPedidos = totalPedidosVarejo + totalPedidosToco;
            kpiData.pesoTotal = pesoTotalVarejo + pesoTotalToco;
            kpiData.pedidosAPredatar = pedidosAPredatar.length;
            kpiData.pesoForaDeCarga = pesoForaDeCarga;

            // Renderiza os KPIs no HTML
            const kpiContainer = document.getElementById('kpi-container');
            kpiContainer.innerHTML = `
                <div class="col-md-3 col-6 mb-3"><div class="card bg-secondary-subtle h-100"><div class="card-body text-center">
                    <h6 class="card-subtitle text-muted">Total Pedidos (Varejo+Toco)</h6>
                    <p class="h3 card-title mb-0">${kpiData.totalPedidos}</p>
                </div></div></div>
                <div class="col-md-3 col-6 mb-3"><div class="card bg-secondary-subtle h-100"><div class="card-body text-center">
                    <h6 class="card-subtitle text-muted">Peso Total (Varejo+Toco)</h6>
                    <p class="h3 card-title mb-0">${(kpiData.pesoTotal / 1000).toFixed(2)}<small class="h5"> t</small></p>
                </div></div></div>
                <div class="col-md-3 col-6 mb-3"><div class="card bg-warning-subtle h-100"><div class="card-body text-center">
                    <h6 class="card-subtitle text-muted">Peso Fora de Carga</h6>
                    <p class="h3 card-title mb-0">${(kpiData.pesoForaDeCarga / 1000).toFixed(2)}<small class="h5"> t</small></p>
                </div></div></div>
                <div class="col-md-3 col-6 mb-3"><div class="card bg-danger-subtle h-100"><div class="card-body text-center">
                    <h6 class="card-subtitle text-muted">Pedidos a Predatar</h6>
                    <p class="h3 card-title mb-0">${kpiData.pedidosAPredatar}</p>
                </div></div></div>
            `;
        }

        function isOverdue(predat) {
            if (!predat) { return false; }
            const date = predat instanceof Date ? predat : new Date(predat);
            if (isNaN(date)) { return false; } 

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date < today;
        }

        function exportarPedidosAtrasados() {
            // Junta os pedidos de varejo com os pedidos de toco para uma análise completa de atrasos.
            const pedidosToco = Object.values(gruposToco).flatMap(g => g.pedidos);
            const todosPedidosParaAnalise = [...pedidosGeraisAtuais, ...pedidosComCFNumericoIsolado, ...pedidosToco];

            if (todosPedidosParaAnalise.length === 0) {
                alert("Por favor, processe a planilha primeiro para ter dados para exportar.");
                return;
            }

            // O filtro é aplicado a todos os pedidos (Varejo + Toco).
            // Inclui pedidos atrasados que não têm bloqueio ou cujo bloqueio é 'C' (crédito).
            const pedidosAtrasados = todosPedidosParaAnalise.filter(p => {
                const bloqueio = String(p['BLOQ.'] || '').trim().toUpperCase();
                // Inclui pedidos atrasados que não têm bloqueio ou cujo bloqueio é 'C'.
                return isOverdue(p.Predat) && (bloqueio === '' || bloqueio === 'C');
            });

            if (pedidosAtrasados.length === 0) {
                alert("Nenhum pedido em atraso (sem bloqueio ou com bloqueio 'C') foi encontrado nos resultados processados.");
                return;
            }

            alert(`${pedidosAtrasados.length} pedidos em atraso serão exportados.`);

            const header = [ 'Cliente', 'Nome_Cliente', 'Cidade', 'UF', 'Num_Pedido', 'Quilos_Saldo', 'Predat', 'Dat_Ped', 'Coluna5' ];
            
            const dataToExport = pedidosAtrasados.map(p => {
                let filteredP = {};
                header.forEach(col => {
                    // Passa o objeto Date diretamente para a biblioteca, sem converter para string.
                    // A biblioteca se encarregará de formatar como data no Excel.
                    filteredP[col] = p[col];
                });
                return filteredP;
            });

            // A opção cellDates:true informa à biblioteca para tratar objetos Date como datas.
            const worksheet = XLSX.utils.json_to_sheet(dataToExport, { header: header, cellDates: true });

            // Aplica o formato de data 'dd/mm/yyyy' às colunas de data
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const predatColIndex = header.indexOf('Predat');
            const datPedColIndex = header.indexOf('Dat_Ped');

            for (let R = range.s.r + 1; R <= range.e.r; ++R) { // Pula o cabeçalho (r + 1)
                [predatColIndex, datPedColIndex].forEach(colIndex => {
                    if (colIndex === -1) return;
                    const cell_address = { c: colIndex, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (worksheet[cell_ref] && worksheet[cell_ref].t === 'd') { // Verifica se a célula é do tipo data
                        worksheet[cell_ref].z = 'dd/mm/yyyy'; // Define o formato
                    }
                });
            }

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Pedidos Atrasados");
            XLSX.writeFile(workbook, "pedidos_atrasados.xlsx");
        }
        
        function createTable(pedidos, columnsToDisplay, sourceId = '') {
            if (!pedidos || pedidos.length === 0) return '';
            const colunasExibir = columnsToDisplay || ['Cod_Rota', 'Cliente', 'Nome_Cliente', 'Agendamento', 'Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cidade', 'Predat', 'BLOQ.', 'Coluna4', 'Coluna5', 'CF'];
            let table = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped table-hover"><thead><tr>';
            colunasExibir.forEach(c => table += `<th>${c.replace('_', ' ')}</th>`);
            table += '</tr></thead><tbody>';
                pedidos.forEach(p => { 
                const isPriorityRow = pedidosPrioritarios.includes(String(p.Num_Pedido));
                const isRecallRow = pedidosRecall.includes(String(p.Num_Pedido));
                let rowClass = isPriorityRow ? 'table-warning' : (isRecallRow ? 'table-info' : '');

                const clienteIdNormalizado = normalizeClientId(p.Cliente);
                table += `<tr id="pedido-${p.Num_Pedido}"
                                     class="${rowClass}"
                                     data-cliente-id="${clienteIdNormalizado}" 
                                     data-pedido-id="${p.Num_Pedido}"
                                     onclick="highlightClientRows(event)"
                                     draggable="true"
                                     ondragstart="dragStart(event, '${p.Num_Pedido}', '${clienteIdNormalizado}', '${sourceId}')">`;
                colunasExibir.forEach(c => {
                    let cellContent = p[c] === undefined || p[c] === null ? '' : p[c];
                    if (c === 'Num_Pedido') { 
                        const isPriority = pedidosPrioritarios.includes(String(p.Num_Pedido));
                        const isRecall = pedidosRecall.includes(String(p.Num_Pedido));
                        const isSemCorte = pedidosSemCorte.has(String(p.Num_Pedido));
                        const priorityBadge = isPriority ? ' <span class="badge bg-warning text-dark">Prioridade</span>' : (isRecall ? ' <span class="badge bg-info">Recall</span>' : '');
                        const semCorteBadge = isSemCorte ? ' <span class="badge bg-transparent" title="Pedido Sem Corte"><i class="bi bi-scissors text-warning"></i></span>' : '';
                        table += `<td>${cellContent}${priorityBadge}${semCorteBadge}</td>`;
                    } else if (c === 'Agendamento' && cellContent === 'Sim') {
                        table += `<td><span class="badge bg-warning text-dark">${cellContent}</span></td>`;
                    } else if (c === 'Predat' || c === 'Dat_Ped') {
                        let formattedDate = '';
                        const dateObj = cellContent instanceof Date ? cellContent : new Date(cellContent);

                        if (dateObj instanceof Date && !isNaN(dateObj)) {
                            formattedDate = dateObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                        } else {
                            formattedDate = cellContent || '';
                        }
                        
                        if (c === 'Predat' && isOverdue(p.Predat)) {
                            table += `<td><span class="text-danger fw-bold">${formattedDate}</span></td>`;
                        } else {
                            table += `<td>${formattedDate}</td>`;
                        }
                    } else if (c === 'Quilos_Saldo' || c === 'Cubagem') {
                        table += `<td>${(cellContent || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                    }
                    else {
                        table += `<td>${cellContent}</td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        function displayGerais(div, grupos) {
            if (Object.keys(grupos).length === 0) { 
                div.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-excel"></i><p>Nenhum pedido de varejo disponível.</p></div>'; 
                document.getElementById('botoes-fiorino').innerHTML = '<div class="empty-state"><i class="bi bi-box"></i><p>Nenhuma rota de Fiorino disponível. Processe um arquivo para começar.</p></div>';
                document.getElementById('botoes-van').innerHTML = '<div class="empty-state"><i class="bi bi-truck-front-fill"></i><p>Nenhuma rota de Van disponível. Processe um arquivo para começar.</p></div>';
                document.getElementById('botoes-34').innerHTML = '<div class="empty-state"><i class="bi bi-truck-flatbed"></i><p>Nenhuma rota de 3/4 disponível. Processe um arquivo para começar.</p></div>';
                return; 
            }

            // Usa a função centralizada para garantir a mesma ordem da busca
            const rotasOrdenadas = getSortedVarejoRoutes(Object.keys(grupos));

            const botoes = { fiorino: '', van: '', tresQuartos: '' };
            const addedButtons = new Set();

            rotasOrdenadas.forEach(rota => {
                let config = rotaVeiculoMap[rota];
                // Lógica para tratar rotas não mapeadas como rotas de São Paulo (Van/3/4)
                if (!config) {
                    config = { type: 'van', title: `Van / 3/4 São Paulo - Rota ${rota}` };
                }

                if (config && !addedButtons.has(rota)) {
                    let rotaValue = `'${rota}'`;
                    if (config.combined) {
                        // prettier-ignore
                        const combinedRoutes = [rota, ...config.combined];
                        rotaValue = `[${combinedRoutes.map(r => `'${r}'`).join(', ')}]`;
                        combinedRoutes.forEach(r => addedButtons.add(r));
                    }

                    // Define o título do botão dinamicamente
                    let buttonTitle = config.title; // prettier-ignore
                    if (config.type === 'van' && !config.title.startsWith('Rota 1')) { // Se for van e não for do Paraná
                        buttonTitle = `${rota} (VAN-3/4- SP)`;
                    }

                    const vehicleType = config.type;
                    const colorClass = vehicleType === 'fiorino' ? 'success' : (vehicleType === 'van' ? 'primary' : 'warning'); // prettier-ignore
                    const functionCall = vehicleType === 'fiorino' ? 'separarCargasFiorino' : (vehicleType === 'van' ? 'separarCargasVan' : 'separarCargas34');
                    const divId = vehicleType === 'fiorino' ? 'resultado-fiorino-geral' : (vehicleType === 'van' ? 'resultado-van-geral' : 'resultado-34-geral');
                    const btnId = `btn-${vehicleType}-${rota}`;
                    botoes[vehicleType] += `<button id="${btnId}" class="btn btn-outline-${colorClass} mt-2 me-2" onclick="${functionCall}(${rotaValue}, '${divId}', '${buttonTitle}', this)">${buttonTitle}</button>`;
                }
            });
            document.getElementById('botoes-fiorino').innerHTML = botoes.fiorino || '<div class="empty-state"><i class="bi bi-box"></i><p>Nenhuma rota de Fiorino encontrada.</p></div>';
            document.getElementById('botoes-van').innerHTML = botoes.van || '<div class="empty-state"><i class="bi bi-truck-front-fill"></i><p>Nenhuma rota de Van encontrada.</p></div>';
            document.getElementById('botoes-34').innerHTML = botoes.tresQuartos || '<div class="empty-state"><i class="bi bi-truck-flatbed"></i><p>Nenhuma rota de 3/4 encontrada.</p></div>';
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionGeral">';
            
            rotasOrdenadas.forEach((rota, index) => {
                const grupo = grupos[rota];
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const veiculo = rotaVeiculoMap[rota]?.type || 'van'; // Assume 'van' para rotas não mapeadas
                
                let rotaDisplay; // Rota: 11101 (Fiorino)
                if (veiculo === 'van' && !rotaVeiculoMap[rota]?.title.startsWith('Rota 1')) {
                    rotaDisplay = `Rota: ${rota} (VAN-3/4- SP)`;
                } else {
                    const veiculoNome = veiculo.replace('tresQuartos', '3/4').replace(/^\w/, c => c.toUpperCase());
                    rotaDisplay = `Rota: ${rota} (${veiculoNome})`;
                }
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingGeral${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral${index}"><strong>${rotaDisplay}</strong> &nbsp; <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${grupo.pedidos.length}</span> <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span></button></h2><div id="collapseGeral${index}" class="accordion-collapse collapse" data-bs-parent="#accordionGeral"><div class="accordion-body">${createTable(grupo.pedidos, null, 'geral')}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }
        
        function displayPedidosBloqueados(div, pedidos) {
            if (pedidos.length === 0) {
                div.innerHTML = '<div class="empty-state"><i class="bi bi-shield-check"></i><p>Nenhum pedido bloqueado manualmente.</p></div>';
                return;
            }
            const totalKg = pedidos.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
            const totalKgFormatado = totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            const accordionId = 'accordionBloqueados';
            const collapseId = 'collapseBloqueados';

            let html = `<div class="accordion accordion-flush" id="${accordionId}">
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}"><strong>Total Bloqueado:</strong> ${pedidos.length} pedidos / ${totalKgFormatado} kg</button></h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}"><div class="accordion-body p-0">${createTable(pedidos)}</div></div>
                </div>
            </div>`;
            div.innerHTML = html;
        }

        function displayPedidosCFNumerico(div, pedidos) {
            if (pedidos.length === 0) { div.innerHTML = '<div class="empty-state"><i class="bi bi-funnel"></i><p>Nenhum pedido filtrado por esta regra.</p></div>'; return; }
            const grupos = pedidos.reduce((acc, p) => {
                const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += p.Quilos_Saldo; return acc;
            }, {});
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionCF">';
            Object.keys(grupos).sort().forEach((rota, index) => {
                const grupo = grupos[rota];
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingCF${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCF${index}"><strong>Rota: ${rota}</strong> &nbsp; <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${grupo.pedidos.length}</span> <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span></button></h2><div id="collapseCF${index}" class="accordion-collapse collapse" data-bs-parent="#accordionCF"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }

        function displayTresQuartos(div, loads) {
            if (div) div.innerHTML = '';
        }
        
        function displayRota1(div, pedidos) {
            if (!pedidos || pedidos.length === 0) {
                div.innerHTML = '<div class="empty-state"><i class="bi bi-check-circle"></i><p>Nenhum pedido da Rota 1 para alteração encontrado.</p></div>';
                return;
            }

            let html = `
                <div class="d-flex justify-content-end mb-2 no-print">
                    <button class="btn btn-sm btn-outline-warning" onclick="imprimirGeneric('resultado-rota1', 'Pedidos Rota 1 para Alteração')">
                        <i class="bi bi-printer-fill me-1"></i>Imprimir Lista
                    </button>
                </div>
                ${createTable(pedidos, ['Num_Pedido', 'Cliente', 'Nome_Cliente', 'Quilos_Saldo', 'Cidade', 'Predat', 'CF', 'Coluna5'])}
            `;
            div.innerHTML = html;
        }

        function createPrintWindow(title) {
            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write(`<style>body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .card { break-inside: avoid; margin-bottom: 1rem; page-break-inside: avoid; } .no-print { display: none !important; } .bg-success { background-color: #198754 !important; color: white !important; } .bg-primary { background-color: #0d6efd !important; color: white !important; } .bg-warning { background-color: #ffc107 !important; color: black !important; } .bg-danger { background-color: #dc3545 !important; color: white !important; } .table-responsive { overflow: visible !important; } table, th, td { border: 1px solid #dee2e6 !important; } .table-primary, .table-primary > th, .table-primary > td { --bs-table-bg: #cfe2ff !important; color: #000 !important; } h1, h2, h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }</style></head><body>`);
            return printWindow;
        }

        function imprimirGeneric(divId, title) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;

            const divClone = divToPrint.cloneNode(true);

            // Lógica para buscar o texto da observação salva e colocar na área de impressão
            const allCardsInClone = divClone.querySelectorAll('.card[data-load-id]');
            allCardsInClone.forEach(cardClone => {
                const loadId = cardClone.dataset.loadId;
                const load = activeLoads[loadId];
                const observationText = load?.observation || '';

                const clonePrintDiv = cardClone.querySelector('.print-only-observation');
                if (clonePrintDiv) {
                    const printParagraph = clonePrintDiv.querySelector('p');
                    if (printParagraph && observationText) {
                        printParagraph.innerHTML = `<strong>Observações:</strong><br>${observationText.replace(/\n/g, '<br>')}`;
                        clonePrintDiv.style.display = 'block'; // Garante que seja visível
                    } else if (printParagraph) {
                        printParagraph.innerHTML = '';
                        clonePrintDiv.style.display = 'none'; // Esconde se não houver texto
                    }
                }
            });
            
            const printWindow = createPrintWindow(title);
            printWindow.document.body.innerHTML = `<h3>${title}</h3>` + divClone.outerHTML;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }
        
        function imprimirSobras(title) {
            if (currentLeftoversForPrinting.length === 0) { alert("Nenhuma sobra para imprimir."); return; }
            const totalKgFormatado = currentLeftoversForPrinting.reduce((sum, p) => sum + p.Quilos_Saldo, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const printWindow = createPrintWindow(title);
            let contentToPrint = `<h3>${title} - Total: ${totalKgFormatado} kg</h3>` + createTable(currentLeftoversForPrinting);
            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function imprimirCargasGeneric(divId, title) {
            const containerDiv = document.getElementById(divId);
            if (!containerDiv) return;

            // Seleciona apenas os cards de carga montada, excluindo o card de sobras.
            // O seletor busca por cards que tenham um data-load-id e não sejam o de sobras.
            const cardsParaImprimir = containerDiv.querySelectorAll('.card[data-load-id]:not([data-load-id="leftovers"])');

            if (cardsParaImprimir.length === 0) { alert(`Nenhuma carga montada para imprimir na seção "${title}".`); return; }

            const containerClone = document.createElement('div');

            let finalTitle = title; // Começa com o título padrão

            // Verifica se o título é o da aba de Van e se as cargas são de SP
            if (title === 'Cargas de Van (Varejo)') {
                let isSaoPauloRoute = false;
                for (const card of cardsParaImprimir) {
                    const loadId = card.dataset.loadId;
                    // Verifica se a carga tem pedidos das rotas de SP // prettier-ignore
                    if (activeLoads[loadId] && activeLoads[loadId].pedidos.some(p => ['2555', '2560', '2561', '2571', '2575', '2705', '2735', '2745'].includes(String(p.Cod_Rota)))) {
                        isSaoPauloRoute = true;
                        break; // Encontrou uma, já pode parar
                    }
                }

                // Se for uma rota de SP, altera o título
                if (isSaoPauloRoute) {
                    finalTitle = 'Cargas de Van (Varejo) São Paulo';
                }
            }

            cardsParaImprimir.forEach(originalCard => {
                const cardClone = originalCard.cloneNode(true);
                const loadId = cardClone.dataset.loadId;
                const observationText = activeLoads[loadId]?.observation || '';
                const clonePrintDiv = cardClone.querySelector('.print-only-observation');
                if (clonePrintDiv) {
                    const printParagraph = clonePrintDiv.querySelector('p');
                    if (printParagraph && observationText) {
                        printParagraph.innerHTML = `<strong>Observações:</strong><br>${observationText.replace(/\n/g, '<br>')}`;
                        clonePrintDiv.style.display = 'block';
                    }
                }
                containerClone.appendChild(cardClone);
            });

            const printWindow = createPrintWindow(finalTitle); // Usa o título final
            printWindow.document.body.innerHTML = `<h3>${finalTitle}</h3>` + containerClone.innerHTML; // Usa o título final
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function imprimirTocoIndividual(cf) {
            if (!gruposToco[cf]) { alert(`Nenhuma carga Toco encontrada para o CF: ${cf}`); return; }
            const grupo = gruposToco[cf];
            const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const totalCubagemFormatado = grupo.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const printWindow = createPrintWindow('Imprimir Carga Toco CF: ' + cf);
            let contentToPrint = `<h3>Carga Toco CF: ${cf} - Total: ${totalKgFormatado} kg / ${totalCubagemFormatado} m³</h3>` + createTable(grupo.pedidos, null, `toco-${cf}`);
            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function imprimirCargaManualIndividual(loadId) {
            const load = activeLoads[loadId];
            const cardToPrint = document.getElementById(loadId);

            if (!load || !cardToPrint) {
                alert(`Erro: Carga com ID ${loadId} não encontrada para impressão.`);
                return;
            }

            const cardClone = cardToPrint.cloneNode(true);
            const observationText = load?.observation || '';
            const clonePrintDiv = cardClone.querySelector('.print-only-observation');
            if (clonePrintDiv) {
                const printParagraph = clonePrintDiv.querySelector('p');
                if (printParagraph && observationText) {
                    printParagraph.innerHTML = `<strong>Observações:</strong><br>${observationText.replace(/\n/g, '<br>')}`;
                    clonePrintDiv.style.display = 'block';
                }
            }

            const title = `Impressão - Carga Manual ${load.numero} (${load.vehicleType})`;
            const printWindow = createPrintWindow(title);
            
            printWindow.document.body.innerHTML = `<h3>${title}</h3>` + cardClone.outerHTML;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { 
                printWindow.print(); 
                printWindow.close(); 
            }, 500);
        }
        
        function getVehicleConfig(vehicleType) {
            const configs = {
                minKg: parseFloat(document.getElementById(`${vehicleType}MinCapacity`).value),
                softMaxKg: parseFloat(document.getElementById(`${vehicleType}MaxCapacity`).value),
                softMaxCubage: parseFloat(document.getElementById(`${vehicleType}Cubage`).value),
                hardMaxKg: parseFloat(document.getElementById(`${vehicleType}HardMaxCapacity`)?.value || document.getElementById(`${vehicleType}MaxCapacity`).value),
                hardMaxCubage: parseFloat(document.getElementById(`${vehicleType}HardCubage`)?.value || document.getElementById(`${vehicleType}Cubage`).value),
            };
            return configs;
        }

        function isMoveValid(load, groupToAdd, vehicleType) {
            const config = getVehicleConfig(vehicleType);

            if ((load.totalKg + groupToAdd.totalKg) > config.hardMaxKg) return false;
            if ((load.totalCubagem + groupToAdd.totalCubagem) > config.hardMaxCubage) return false;

            if (groupToAdd.isSpecial) {
                const specialClientIdsInLoad = new Set(
                    load.pedidos
                        .filter(isSpecialClient)
                        .map(p => normalizeClientId(p.Cliente))
                );
                const groupToAddClientId = normalizeClientId(groupToAdd.pedidos[0].Cliente);
                if (!specialClientIdsInLoad.has(groupToAddClientId) && specialClientIdsInLoad.size >= 2) {
                    return false;
                }
            }

            if (groupToAdd.pedidos.some(p => p.Agendamento === 'Sim') && load.pedidos.some(p => p.Agendamento === 'Sim')) return false;

            return true;
        }

        function runHeuristicOptimization(packableGroups, vehicleType) {
            const strategies = [
                { name: 'priority-weight-desc',
                  sorter: (a, b) => {
                    const aHasPrio = a.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                    const bHasPrio = b.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                    if (aHasPrio && !bHasPrio) return -1;
                    if (!aHasPrio && bHasPrio) return 1;
                    return b.totalKg - a.totalKg;
                  }
                },
                { name: 'scheduled-weight-desc',
                  sorter: (a, b) => {
                    const aHasSched = a.pedidos.some(p => p.Agendamento === 'Sim');
                    const bHasSched = b.pedidos.some(p => p.Agendamento === 'Sim');
                    if (aHasSched && !bHasSched) return -1;
                    if (!aHasSched && bHasSched) return 1;
                    return b.totalKg - a.totalKg;
                  }
                },
                { name: 'weight-desc', sorter: (a, b) => b.totalKg - a.totalKg },
                { name: 'weight-asc', sorter: (a, b) => a.totalKg - b.totalKg }
            ];

            let bestResult = null;

            for (const strategy of strategies) {
                const sortedGroups = [...packableGroups].sort(strategy.sorter);
                const result = createSolutionFromHeuristic(sortedGroups, vehicleType);
                
                const leftoverWeight = result.leftovers.reduce((sum, g) => sum + g.totalKg, 0);

                if (bestResult === null || leftoverWeight < bestResult.leftoverWeight) {
                    bestResult = { ...result, leftoverWeight: leftoverWeight, strategy: strategy.name };
                }
            }
            
            console.log(`Nível 1: Melhor estratégia para ${vehicleType} foi ${bestResult.strategy} com ${bestResult.leftoverWeight.toFixed(2)}kg de sobra.`);
            return bestResult;
        }
        
        function createSolutionFromHeuristic(itemsParaEmpacotar, vehicleType) {
            const config = getVehicleConfig(vehicleType);
            let loads = [];
            let leftoverItems = [];

            itemsParaEmpacotar.forEach(item => {
                if (item.totalKg > config.hardMaxKg || item.totalCubagem > config.hardMaxCubage) {
                    leftoverItems.push(item); return;
                }
                
                let bestFit = null;
                for (const load of loads) {
                    if (isMoveValid(load, item, vehicleType)) {
                        const remainingCapacity = config.hardMaxKg - (load.totalKg + item.totalKg);
                        if (bestFit === null || remainingCapacity < bestFit.remainingCapacity) {
                            bestFit = { load: load, remainingCapacity: remainingCapacity };
                        }
                    }
                }

                if (bestFit) {
                    bestFit.load.pedidos.push(...item.pedidos);
                    bestFit.load.totalKg += item.totalKg;
                    bestFit.load.totalCubagem += item.totalCubagem;
                    bestFit.load.usedHardLimit = bestFit.load.totalKg > config.softMaxKg || bestFit.load.totalCubagem > config.softMaxCubage;
                } else {
                    loads.push({
                        pedidos: [...item.pedidos],
                        totalKg: item.totalKg,
                        totalCubagem: item.totalCubagem,
                        isSpecial: item.isSpecial,
                        usedHardLimit: (item.totalKg > config.softMaxKg || item.totalCubagem > config.softMaxCubage)
                    });
                }
            });
            
            let finalLoads = [];
            let unplacedGroups = [];

            loads.forEach(load => {
                const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)) || pedidosRecall.includes(String(p.Num_Pedido)));
                const allowPriorityOverride = true; // Permite para todos os veículos

                if (load.pedidos.length > 0 && (load.totalKg >= config.minKg || (hasPriority && allowPriorityOverride))) {
                    finalLoads.push(load);
                } else if (load.pedidos.length > 0) {
                    const clientGroupsInFailedLoad = Object.values(load.pedidos.reduce((acc, p) => {
                        const clienteId = normalizeClientId(p.Cliente);
                        if (!acc[clienteId]) { acc[clienteId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(p) }; }
                        acc[clienteId].pedidos.push(p);
                        acc[clienteId].totalKg += p.Quilos_Saldo;
                        acc[clienteId].totalCubagem += p.Cubagem;
                        return acc;
                    }, {}));
                    unplacedGroups.push(...clientGroupsInFailedLoad);
                }
            });
            
            const leftovers = [...leftoverItems, ...unplacedGroups];
            return { loads: finalLoads, leftovers };
        }

        function getSolutionEnergy(solution, vehicleType) {
            const config = getVehicleConfig(vehicleType);
            const balancingFactor = 0.01; // Fator de peso para a penalidade de balanceamento.

            const leftoverWeight = solution.leftovers.reduce((sum, group) => sum + group.totalKg, 0);
            
            const loadPenalty = solution.loads.reduce((sum, load) => {
                if (load.totalKg > 0 && load.totalKg < config.minKg) {
                    return sum + 1000 + (config.minKg - load.totalKg);
                }
                return sum;
            }, 0);

            let balancePenalty = 0;
            if (solution.loads.length > 1) {
                const weights = solution.loads.map(l => l.totalKg);
                const averageWeight = weights.reduce((sum, w) => sum + w, 0) / weights.length;
                
                // A variância mede o quão espalhados os pesos estão em relação à média.
                const variance = weights.reduce((sum, w) => sum + Math.pow(w - averageWeight, 2), 0) / weights.length;
                balancePenalty = variance * balancingFactor;
            }

            // A energia total é a soma do peso das sobras e das penalidades.
            return leftoverWeight + loadPenalty + balancePenalty;
        }
        
        let thinkingInterval = null;
        function startThinkingText() {
            const phrases = [
                "Analisando combinações...",
                "Testando cenários de encaixe...",
                "Calculando a melhor rota...",
                "Verificando restrições de peso e cubagem...",
                "Buscando o melhor aproveitamento...",
                "Simulando trocas entre cargas...",
                "Otimizando a distribuição...",
                "Refinando a solução encontrada..."
            ];
            let currentIndex = 0;
            const thinkingTextElement = document.getElementById('thinking-text');
            if(thinkingInterval) clearInterval(thinkingInterval);
            thinkingInterval = setInterval(() => {
                if(thinkingTextElement) thinkingTextElement.textContent = phrases[currentIndex];
                currentIndex = (currentIndex + 1) % phrases.length;
            }, 1500);
        }
        function stopThinkingText() { if(thinkingInterval) clearInterval(thinkingInterval); }

        function calculateDisplaySobras(solution, vehicleType) {
            const config = getVehicleConfig(vehicleType);
            let totalSobras = 0;
            totalSobras += solution.leftovers.reduce((sum, group) => sum + group.totalKg, 0);
            solution.loads.forEach(load => {
                if (load.totalKg > 0 && load.totalKg < config.minKg) {
                    totalSobras += load.totalKg;
                }
            });
            return totalSobras;
        }

        function runSimulatedAnnealing(packableGroups, vehicleType, uiText) {
             return new Promise(resolve => {
                  const initialTemp = 1000;
                  const coolingRate = 0.993;
                  const iterationsPerTemp = 200;

                  const initialSortedGroups = [...packableGroups].sort((a, b) => b.totalKg - a.totalKg);
                  let bestSolution = createSolutionFromHeuristic(initialSortedGroups, vehicleType);
                  let currentSolution = deepClone(bestSolution);
                  
                  let currentTemp = initialTemp;
                  
                  const progressBar = document.getElementById('processing-progress-bar');
                  const statusText = document.getElementById('processing-status-text');
                  startThinkingText();

                  function doTemperatureStep() {
                       for (let i = 0; i < iterationsPerTemp; i++) {
                           let neighborSolution = deepClone(currentSolution);
                           let moveMade = false;

                           const moveType = Math.random();
                           if (moveType < 0.7 && neighborSolution.leftovers.length > 0) {
                               const leftoverIndex = Math.floor(Math.random() * neighborSolution.leftovers.length);
                               const groupToPlace = neighborSolution.leftovers[leftoverIndex];
                               const targetLoadIndex = neighborSolution.loads.length > 0 ? Math.floor(Math.random() * (neighborSolution.loads.length + 1)) : 0;

                               if (targetLoadIndex < neighborSolution.loads.length) {
                                   const targetLoad = neighborSolution.loads[targetLoadIndex];
                                   if(isMoveValid(targetLoad, groupToPlace, vehicleType)) {
                                       targetLoad.pedidos.push(...groupToPlace.pedidos);
                                       targetLoad.totalKg += groupToPlace.totalKg;
                                       targetLoad.totalCubagem += groupToPlace.totalCubagem;
                                       neighborSolution.leftovers.splice(leftoverIndex, 1);
                                       moveMade = true;
                                   }
                               } else if (isMoveValid({pedidos:[], totalKg:0, totalCubagem:0}, groupToPlace, vehicleType)) { 
                                   neighborSolution.loads.push(groupToPlace);
                                   neighborSolution.leftovers.splice(leftoverIndex, 1);
                                   moveMade = true;
                               }
                           } else if (neighborSolution.loads.length > 0) {
                               const loadIndex = Math.floor(Math.random() * neighborSolution.loads.length);
                               const load = neighborSolution.loads[loadIndex];
                               
                               if (load.pedidos.length > 0) {
                                   const clientGroupsInLoad = Object.values(load.pedidos.reduce((acc, p) => {
                                       const cId = normalizeClientId(p.Cliente);
                                       if (!acc[cId]) acc[cId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(p) };
                                       acc[cId].pedidos.push(p); acc[cId].totalKg += p.Quilos_Saldo; acc[cId].totalCubagem += p.Cubagem;
                                       return acc;
                                   }, {}));

                                   if(clientGroupsInLoad.length > 0) {
                                       const groupIndexToRemove = Math.floor(Math.random() * clientGroupsInLoad.length);
                                       const groupToMove = clientGroupsInLoad[groupIndexToRemove];
                                       
                                       const idsToRemove = new Set(groupToMove.pedidos.map(p => p.Num_Pedido));
                                       load.pedidos = load.pedidos.filter(p => !idsToRemove.has(p.Num_Pedido));
                                       load.totalKg -= groupToMove.totalKg;
                                       load.totalCubagem -= groupToMove.totalCubagem;
                                       if(load.pedidos.length === 0) neighborSolution.loads.splice(loadIndex,1);

                                       neighborSolution.leftovers.push(groupToMove);
                                       moveMade = true;
                                   }
                               }
                           }
                           
                           if(moveMade){
                               const currentEnergy = getSolutionEnergy(currentSolution, vehicleType);
                               const neighborEnergy = getSolutionEnergy(neighborSolution, vehicleType);

                               if (neighborEnergy < currentEnergy || Math.random() < Math.exp((currentEnergy - neighborEnergy) / currentTemp)) {
                                   currentSolution = neighborSolution;
                                   if (getSolutionEnergy(currentSolution, vehicleType) < getSolutionEnergy(bestSolution, vehicleType)) {
                                       bestSolution = deepClone(currentSolution);
                                   }
                               }
                           }
                       }

                       currentTemp *= coolingRate;
                       const progress = Math.min(100, 100 * (1 - Math.log(currentTemp) / Math.log(initialTemp)));
                       progressBar.style.width = `${progress}%`;
                       statusText.textContent = uiText;

                       if (currentTemp > 1) {
                           requestAnimationFrame(doTemperatureStep);
                       } else {
                           const config = getVehicleConfig(vehicleType);
                           let finalLoads = [];
                           let finalLeftovers = [...bestSolution.leftovers];
                           bestSolution.loads.forEach(load => {
                               if (load.pedidos.length > 0 && load.totalKg >= config.minKg) {
                                   finalLoads.push(load);
                               } else if (load.pedidos.length > 0) {
                                   const groups = Object.values(load.pedidos.reduce((acc, p) => { 
                                       const cId = normalizeClientId(p.Cliente);
                                       if (!acc[cId]) acc[cId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(p) };
                                       acc[cId].pedidos.push(p); acc[cId].totalKg += p.Quilos_Saldo; acc[cId].totalCubagem += p.Cubagem;
                                       return acc; 
                                   }, {}));
                                   finalLeftovers.push(...groups);
                               }
                           });
                           stopThinkingText();
                           console.log(`Otimização para ${vehicleType} finalizada com ${finalLeftovers.reduce((s, g) => s + g.totalKg, 0).toFixed(2)}kg de sobra.`);
                           resolve({ loads: finalLoads, leftovers: finalLeftovers });
                       }
                  }
                  
                  requestAnimationFrame(doTemperatureStep);
             });
        }

        function refinarCargasComTrocas(initialLoads, initialLeftovers, vehicleType) {
            let loads = deepClone(initialLoads);
            let leftovers = deepClone(initialLeftovers);
            let improvementMade;

            if (leftovers.length === 0) {
                return { refinedLoads: loads, remainingLeftovers: leftovers };
            }
            
            let attempts = 0;
            const maxAttempts = (leftovers.length * loads.length) || 1; 

            do {
                improvementMade = false;
                attempts++;
                for (let i = 0; i < leftovers.length; i++) {
                    const leftoverGroup = leftovers[i];

                    for (let j = 0; j < loads.length; j++) {
                        const load = loads[j];

                        const clientGroupsInLoad = Object.values(load.pedidos.reduce((acc, pedido) => {
                           const clienteId = normalizeClientId(pedido.Cliente);
                           if (!acc[clienteId]) acc[clienteId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(pedido) };
                           acc[clienteId].pedidos.push(pedido);
                           acc[clienteId].totalKg += pedido.Quilos_Saldo;
                           acc[clienteId].totalCubagem += pedido.Cubagem;
                           return acc;
                        }, {}));

                        for (let k = 0; k < clientGroupsInLoad.length; k++) {
                            const groupToSwapOut = clientGroupsInLoad[k];
                            
                            const tempLoadAfterRemoval = {
                                pedidos: load.pedidos.filter(p => !groupToSwapOut.pedidos.some(gp => gp.Num_Pedido === p.Num_Pedido)),
                                totalKg: load.totalKg - groupToSwapOut.totalKg,
                                totalCubagem: load.totalCubagem - groupToSwapOut.totalCubagem,
                            };
                            
                            if (isMoveValid(tempLoadAfterRemoval, leftoverGroup, vehicleType)) {
                                const idsToRemove = new Set(groupToSwapOut.pedidos.map(p => p.Num_Pedido));
                                load.pedidos = load.pedidos.filter(p => !idsToRemove.has(p.Num_Pedido));
                                load.totalKg -= groupToSwapOut.totalKg;
                                load.totalCubagem -= groupToSwapOut.totalCubagem;

                                load.pedidos.push(...leftoverGroup.pedidos);
                                load.totalKg += leftoverGroup.totalKg;
                                load.totalCubagem += leftoverGroup.totalCubagem;

                                leftovers.splice(i, 1); 
                                leftovers.push(groupToSwapOut);

                                console.log(`POLIMENTO (Nível 3): Encaixou grupo de ${leftoverGroup.totalKg.toFixed(2)}kg trocando por um de ${groupToSwapOut.totalKg.toFixed(2)}kg.`);
                                improvementMade = true;
                                break;
                            }
                        }
                        if (improvementMade) break;
                    }
                    if (improvementMade) break;
                }
            } while (improvementMade && leftovers.length > 0 && attempts < maxAttempts);

            if(attempts >= maxAttempts) console.warn("Polimento (Nível 3) interrompido para evitar loop infinito.");

            return { refinedLoads: loads, remainingLeftovers: leftovers };
        }
        
        async function separarCargasGeneric(routeOrRoutes, divId, title, vehicleType, buttonElement) {
            const allRouteButtons = document.querySelectorAll('#botoes-fiorino button, #botoes-van button, #botoes-34 button');

            const routesKey = Array.isArray(routeOrRoutes) ? routeOrRoutes.sort().join(',') : String(routeOrRoutes);
            if (processedRoutes.has(routesKey)) {
                alert('Esta rota já foi processada. Para reprocessar, limpe os resultados usando o botão "Limpar Tudo".');
                return;
            }
            
            allRouteButtons.forEach(btn => btn.disabled = true);
            processedRoutes.add(routesKey);

            const resultadoDiv = document.getElementById(divId);
            
            const autoGeneratedContent = resultadoDiv.querySelector('.resultado-container');
            if (autoGeneratedContent) { autoGeneratedContent.remove(); }

            // Restaura o feedback visual no botão da rota processada
            if (buttonElement) {
                const colorClass = vehicleType === 'fiorino' ? 'success' : (vehicleType === 'van' ? 'primary' : 'warning');
                buttonElement.classList.remove(`btn-outline-${colorClass}`);
                buttonElement.classList.add(`btn-${colorClass}`, 'active');
                buttonElement.disabled = true; // Desativa o botão para evitar reprocessamento
                buttonElement.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${title}`;
            }

            if (planilhaData.length === 0) {
                resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; 
                allRouteButtons.forEach(btn => btn.disabled = false);
                return;
            }

            const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [String(routeOrRoutes)];
            let pedidosRota = pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota)));

            const clientGroupsMap = pedidosRota.reduce((acc, pedido) => {
                const clienteId = normalizeClientId(pedido.Cliente);
                if (!acc[clienteId]) { acc[clienteId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(pedido) }; }
                acc[clienteId].pedidos.push(pedido);
                acc[clienteId].totalKg += pedido.Quilos_Saldo;
                acc[clienteId].totalCubagem += pedido.Cubagem;
                return acc;
            }, {});
            const packableGroups = Object.values(clientGroupsMap);

            packableGroups.forEach(group => {
                group.Quilos_Saldo = group.totalKg;
                group.Cubagem = group.totalCubagem;
                if (group.totalCubagem > 0) group.density = group.totalKg / group.totalCubagem;
                else group.density = Infinity; 
            });

            const optimizationLevel = document.getElementById('optimizationLevelSelect').value;
            let optimizationResult;
            
            const modalElement = document.getElementById('processing-modal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            
            try {
                if(optimizationLevel !== '1') {
                    document.getElementById('processing-progress-bar').style.width = '0%';
                    modal.show();
                } else {
                    resultadoDiv.insertAdjacentHTML('beforeend', '<div id="spinner-temp-container" class="d-flex align-items-center justify-content-center p-5"><div class="spinner-border text-primary" role="status"></div><span class="ms-3">Analisando estratégias e montando cargas...</span></div>');
                }

                switch (optimizationLevel) {
                    case '1':
                        console.log(`Executando Nível 1: Heurística Rápida para ${vehicleType}...`);
                        optimizationResult = runHeuristicOptimization(packableGroups, vehicleType);
                        break;
                    case '3':
                        console.log(`Executando Nível 3: Otimização Exaustiva (SA + Polimento Simples) para ${vehicleType}...`);
                        const saResultForPolish = await runSimulatedAnnealing(packableGroups, vehicleType, 'Otimizando... (Nível 3 - Fase 1/2)');
                        
                        document.getElementById('processing-status-text').textContent = 'Otimizando... (Nível 3 - Fase 2/2)';
                        document.getElementById('thinking-text').textContent = 'Aplicando polimento com trocas locais.';
                        document.getElementById('processing-progress-bar').style.width = '100%';

                        const polished = refinarCargasComTrocas(saResultForPolish.loads, saResultForPolish.leftovers, vehicleType);
                        optimizationResult = { loads: polished.refinedLoads, leftovers: polished.remainingLeftovers };
                        break; // Este break estava faltando, foi adicionado para corrigir a lógica.
                    case '4':
                        console.log(`Executando Nível 4: Otimização Reconstrutiva para ${vehicleType}...`);
                        const saResultForReconstruction = await runSimulatedAnnealing(packableGroups, vehicleType, 'Otimizando... (Nível 4 - Fase 1/3)');

                        document.getElementById('processing-status-text').textContent = 'Otimizando... (Nível 4 - Fase 2/3)';
                        document.getElementById('processing-details-text').textContent = 'Reconstruindo cargas ineficientes.';
                        const reconstructed = await refinarComReconstrucao(saResultForReconstruction.loads, saResultForReconstruction.leftovers, vehicleType);

                        document.getElementById('processing-status-text').textContent = 'Otimizando... (Nível 4 - Fase 3/3)';
                        document.getElementById('thinking-text').textContent = 'Aplicando polimento final.';
                        const finalPolished = refinarCargasComTrocas(reconstructed.refinedLoads, reconstructed.remainingLeftovers, vehicleType);
                        optimizationResult = { loads: finalPolished.refinedLoads, leftovers: finalPolished.remainingLeftovers };
                        break;
                    case '2':
                    default:
                        console.log(`Executando Nível 2: Otimização Avançada (SA) para ${vehicleType}...`);
                        optimizationResult = await runSimulatedAnnealing(packableGroups, vehicleType, 'Otimizando... (Nível 2)');
                        break;
                }
            } finally {
                allRouteButtons.forEach(btn => btn.disabled = false);
                if(optimizationLevel !== '1') {
                    modal.hide();
                } else {
                    const spinner = document.getElementById('spinner-temp-container');
                    if (spinner) spinner.remove();
                }
            }
            
            // A partir daqui, a lógica de pós-processamento é unificada.
            optimizationResult.loads.forEach(load => { load.vehicleType = vehicleType; });
            
            // Tenta encaixar sobras em cargas existentes que ainda têm espaço.
            const { refinedLoads, remainingLeftovers } = refineLoadsWithSimpleFit(optimizationResult.loads, optimizationResult.leftovers);

            let primaryLoads = refinedLoads; // Cargas do tipo principal (ex: Fiorino)
            let leftoverGroups = remainingLeftovers; // O que sobrou após o encaixe simples
            let secondaryLoads = [];
            let tertiaryLoads = [];

            // Lógica para tentar usar as sobras em outros tipos de veículos (ex: sobras de Fiorino em uma Van)
            if (vehicleType === 'fiorino' && leftoverGroups.length > 0) {
                const totalLeftoverKg = leftoverGroups.reduce((sum, g) => sum + g.totalKg, 0);
                const vanMin = parseFloat(document.getElementById('vanMinCapacity').value);
                if (totalLeftoverKg >= vanMin && leftoverGroups.length > 0) {
                    const { loads: vanLoads, leftovers: newLeftovers } = runHeuristicOptimization(leftoverGroups, 'van');
                    secondaryLoads = vanLoads.map(l => ({ ...l, vehicleType: 'van' }));
                    leftoverGroups = newLeftovers;
                }
            }
            
            const totalFinalLeftoverKg = leftoverGroups.reduce((sum, g) => sum + g.totalKg, 0);
            const tresQuartosMin = parseFloat(document.getElementById('tresQuartosMinCapacity').value);
            if (totalFinalLeftoverKg >= tresQuartosMin && leftoverGroups.length > 0) {
                                                     const vehicleForTertiary = (vehicleType === 'fiorino' || vehicleType === 'van') ? 'tresQuartos' : '';
                if(vehicleForTertiary) {
                    const { loads: tqLoads, leftovers: newLeftovers } = runHeuristicOptimization(leftoverGroups, vehicleForTertiary);
                    tertiaryLoads = tqLoads.map(l => ({ ...l, vehicleType: 'tresQuartos' }));
                    leftoverGroups = newLeftovers;
                }
            }

            const allPotentialLoads = [ ...primaryLoads, ...secondaryLoads, ...tertiaryLoads ];
            const finalValidLoads = [];
            let finalLeftoverGroups = [...leftoverGroups];

            allPotentialLoads.forEach(load => {
                const config = getVehicleConfig(load.vehicleType);
                const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)) || pedidosRecall.includes(String(p.Num_Pedido)));
                const allowPriorityOverride = true; // Permite para todos os veículos
                
                if (load.totalKg >= config.minKg || (hasPriority && allowPriorityOverride)) {
                    finalValidLoads.push(load);
                } else {
                    const clientGroupsInFailedLoad = Object.values(load.pedidos.reduce((acc, p) => {
                        const clienteId = normalizeClientId(p.Cliente);
                        if (!acc[clienteId]) { acc[clienteId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(p) }; }
                        acc[clienteId].pedidos.push(p);
                        acc[clienteId].totalKg += p.Quilos_Saldo;
                        acc[clienteId].totalCubagem += p.Cubagem;
                        return acc;
                    }, {}));
                    finalLeftoverGroups.push(...clientGroupsInFailedLoad);
                }
            });

            // Limpa as sobras anteriores e define as sobras apenas para esta execução
            const sobrasDestaRota = finalLeftoverGroups.flatMap(group => group.pedidos);
            currentLeftoversForPrinting = [...sobrasDestaRota];


            finalValidLoads.forEach((load, index) => {
                load.numero = `${load.vehicleType.charAt(0).toUpperCase()}${index + 1}`;
                const loadId = `${load.vehicleType}-${Date.now()}-${index}`;
                load.id = loadId;
                activeLoads[loadId] = load;
            });

            // Salvar o contexto da rota processada para recarregamento
            const routeContext = {
                divId: divId,
                title: title,
                routesKey: routesKey,
                buttonId: buttonElement ? buttonElement.id : null
            };
            saveRouteContext(routeContext);

            const vehicleInfo = {
                fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' }
            };
            
            let html = `<h5 class="mt-3">Cargas para <strong>${title}</strong></h5>`;
            
            const generatedLoads = finalValidLoads.filter(l => l.pedidos.length > 0);
            if(generatedLoads.length === 0){
                 html += `<div class="alert alert-secondary">Nenhuma carga foi formada para esta rota.</div>`;
            } else {
                generatedLoads.forEach(load => {
                    html += renderLoadCard(load, load.vehicleType, vehicleInfo[load.vehicleType]);
                });
            }
            
            if (sobrasDestaRota.length > 0) {
                const finalLeftoverKg = sobrasDestaRota.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
                const manualLoadButton = `<button id="start-manual-load-btn" class="btn btn-success ms-auto no-print" onclick="startManualLoadBuilder()"><i class="bi bi-plus-circle-fill me-1"></i>Criar Carga Manual</button>`;
                const printButtonHtml = `<button class="btn btn-info ms-2 no-print" onclick="imprimirSobras('Sobras Finais de ${title}')"><i class="bi bi-printer-fill me-1"></i>Imprimir</button>`;

                html += `<div id="leftovers-card-${divId}" class="drop-zone-card" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" data-load-id="leftovers" data-vehicle-type="leftovers">
                                     <h5 class="mt-4">Sobras Finais: ${finalLeftoverKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h5>
                                     <div class="card mb-3">
                                         <div class="card-header bg-danger text-white d-flex align-items-center">
                                             Pedidos Restantes
                                             <div class="ms-auto">${manualLoadButton}${printButtonHtml}</div>
                                         </div>
                                         <div class="card-body">${createTable(sobrasDestaRota, ['Num_Pedido', 'Quilos_Saldo', 'Agendamento', 'Cubagem', 'Predat', 'Cliente', 'Nome_Cliente', 'Cidade', 'CF'], 'leftovers')}</div>
                                     </div>
                                 </div>`;
            }
            resultadoDiv.innerHTML = `<div class="resultado-container">${html}</div>`;
            updateAndRenderChart();
            updateAndRenderKPIs(); // Adicionado para atualizar os KPIs dinâmicos
            saveStateToLocalStorage();
        }
        
        async function runExpertOptimizer(packableGroups, vehicleType) {
            console.log(`Executando Nível 2: Otimização Especialista para ${vehicleType}...`);
            
            // Fase 1: Otimização principal com Recozimento Simulado
            const saResult = await runSimulatedAnnealing(packableGroups, vehicleType, 'Otimizando... (Fase 1/3: Análise Profunda)');
            
            // Fase 2: Tenta reconstruir a pior carga para melhorar a solução
            document.getElementById('processing-status-text').textContent = 'Otimizando... (Fase 2/3: Reconstrução)';
            document.getElementById('thinking-text').textContent = 'Analisando e reestruturando cargas ineficientes.';
            const reconstructed = await refinarComReconstrucao(saResult.loads, saResult.leftovers, vehicleType);

            // Fase 3: Faz um polimento final, tentando trocar sobras com itens de menor peso nas cargas
            document.getElementById('processing-status-text').textContent = 'Otimizando... (Fase 3/3: Polimento Final)';
            document.getElementById('thinking-text').textContent = 'Buscando últimas oportunidades de encaixe.';
            return refinarCargasComTrocas(reconstructed.refinedLoads, reconstructed.remainingLeftovers, vehicleType);
        }

        function refineLoadsWithSimpleFit(initialLoads, initialLeftovers) {
            let refinedLoads = deepClone(initialLoads);
            let remainingLeftovers = deepClone(initialLeftovers);

            for (let i = remainingLeftovers.length - 1; i >= 0; i--) {
                const leftoverGroup = remainingLeftovers[i];
                
                for (const load of refinedLoads) {
                    const vehicleType = load.vehicleType;
                    if (!vehicleType) continue; 
                    
                    if (isMoveValid(load, leftoverGroup, vehicleType)) {
                        load.pedidos.push(...leftoverGroup.pedidos);
                        load.totalKg += leftoverGroup.totalKg;
                        load.totalCubagem += leftoverGroup.totalCubagem;
                        
                        remainingLeftovers.splice(i, 1);
                        break; 
                    }
                }
            }
            return { refinedLoads, remainingLeftovers };
        }

        async function refinarComReconstrucao(initialLoads, initialLeftovers, vehicleType) {
            let loads = deepClone(initialLoads);
            let leftovers = deepClone(initialLeftovers);

            if (loads.length < 2) {
                console.log("POLIMENTO (Nível 4): Poucas cargas para reconstruir. Pulando etapa.");
                return { refinedLoads: loads, remainingLeftovers: leftovers };
            }

            
            loads.sort((a, b) => a.totalKg - b.totalKg);
            const worstLoad = loads[0]; 

            const config = getVehicleConfig(vehicleType);
            if (worstLoad.totalKg >= config.softMaxKg) {
                console.log("POLIMENTO (Nível 4): A carga menos cheia já está bem otimizada. Pulando etapa.");
                return { refinedLoads: initialLoads, remainingLeftovers: initialLeftovers };
            }

            
            const groupsToReallocate = Object.values(worstLoad.pedidos.reduce((acc, p) => {
                const cId = normalizeClientId(p.Cliente);
                if (!acc[cId]) acc[cId] = { pedidos: [], totalKg: 0, totalCubagem: 0, isSpecial: isSpecialClient(p) };
                acc[cId].pedidos.push(p); 
                acc[cId].totalKg += p.Quilos_Saldo; 
                acc[cId].totalCubagem += p.Cubagem;
                return acc;
            }, {}));

            const newLeftovers = [...leftovers, ...groupsToReallocate];
            const remainingLoads = loads.slice(1);

            
            const { refinedLoads: reconstructedLoads, remainingLeftovers: finalLeftovers } = refineLoadsWithSimpleFit(remainingLoads, newLeftovers);
            
            const originalSobras = initialLeftovers.reduce((sum, g) => sum + g.totalKg, 0);
            const newSobras = finalLeftovers.reduce((sum, g) => sum + g.totalKg, 0);

            if (newSobras < originalSobras) {
                console.log(`POLIMENTO (Nível 4): Reconstrução bem-sucedida! Sobra reduzida de ${originalSobras.toFixed(2)}kg para ${newSobras.toFixed(2)}kg.`);
                return { refinedLoads: reconstructedLoads, remainingLeftovers: finalLeftovers };
            } else {
                console.log("POLIMENTO (Nível 4): Reconstrução não melhorou o resultado. Revertendo.");
                return { refinedLoads: initialLoads, remainingLeftovers: initialLeftovers };
            }
        }

        function saveObservation(event, loadId) {
            event.stopPropagation(); // Impede que outros eventos de clique sejam disparados
            const textarea = document.getElementById(`obs-textarea-${loadId}`);
            if (activeLoads[loadId] && textarea) {
                activeLoads[loadId].observation = textarea.value;
                saveStateToLocalStorage();
                toggleObservationEdit(loadId, false);
            }
        }

        function toggleObservationEdit(loadId, editMode) {
            const container = document.getElementById(`obs-container-${loadId}`);
            if (!container) return;

            const observationText = activeLoads[loadId]?.observation || '';
            if (editMode) {
                container.innerHTML = `
                    <textarea id="obs-textarea-${loadId}" class="form-control form-control-sm" rows="2" placeholder="Ex: Ligar para o cliente antes...">${observationText}</textarea>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-success" onclick="saveObservation(event, '${loadId}')"><i class="bi bi-check-circle me-1"></i>Salvar</button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleObservationEdit('${loadId}', false)"><i class="bi bi-x-circle me-1"></i>Cancelar</button>
                    </div>
                `;
            } else {
                if (observationText) {
                    container.innerHTML = `
                        <p class="form-control-plaintext form-control-sm small p-2 border rounded" style="white-space: pre-wrap; background-color: var(--dark-bg);">${observationText}</p>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleObservationEdit('${loadId}', true)"><i class="bi bi-pencil me-1"></i>Editar</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteObservation('${loadId}')"><i class="bi bi-trash me-1"></i>Excluir</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<button class="btn btn-sm btn-outline-info" onclick="toggleObservationEdit('${loadId}', true)"><i class="bi bi-plus-circle me-1"></i>Adicionar Observação</button>`;
                }
            }
        }

        function deleteObservation(loadId) {
            if (activeLoads[loadId] && confirm('Tem certeza que deseja excluir esta observação?')) {
                activeLoads[loadId].observation = '';
                saveStateToLocalStorage();
                toggleObservationEdit(loadId, false);
            }
        }

        function renderLoadCard(load, vehicleType, vInfo) {
            load.pedidos.sort((a, b) => {
                const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                const clienteCompare = clienteA.localeCompare(clienteB, undefined, { numeric: true });
                if (clienteCompare !== 0) return clienteCompare;
                return pedidoA.localeCompare(pedidoB, undefined, { numeric: true });
            });

            const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const totalCubagemFormatado = (load.totalCubagem || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const isPriorityLoad = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)) || pedidosRecall.includes(String(p.Num_Pedido)));
            const priorityBadge = isPriorityLoad ? '<span class="badge bg-light text-dark ms-3">CARGA COM PRIORIDADE</span>' : '';
            const hardLimitBadge = load.usedHardLimit ? '<span class="badge bg-danger-subtle text-danger-emphasis ms-3"><i class="bi bi-exclamation-triangle-fill"></i> CAPACIDADE EXTRA</span>' : '';
            // prettier-ignore
            const isSaoPauloRoute = load.pedidos.some(p => ['2555', '2560', '2561', '2571', '2575', '2705', '2735', '2745'].includes(String(p.Cod_Rota)));
            const spDescription = isSaoPauloRoute ? ' (São Paulo)' : '';

            const config = getVehicleConfig(vehicleType);
            const maxKg = config.hardMaxKg;

            const isOverloaded = maxKg > 0 && load.totalKg > maxKg;
            const pesoPercentual = maxKg > 0 ? (load.totalKg / maxKg) * 100 : 0;
            let progressColor = 'bg-success';
            if (isOverloaded || pesoPercentual > 100) progressColor = 'bg-danger';
            else if (pesoPercentual > 95) progressColor = 'bg-danger';
            else if (pesoPercentual > 75) progressColor = 'bg-warning';

            const progressBar = `
                <div class="progress mt-2" role="progressbar" aria-label="Capacidade da carga" aria-valuenow="${pesoPercentual}" aria-valuemin="0" aria-valuemax="100" style="height: 10px;">
                  <div class="progress-bar ${progressColor}" style="width: ${Math.min(pesoPercentual, 100)}%"></div>
                </div>`;
            
            const headerColorClass = isOverloaded ? 'bg-danger' : vInfo.colorClass;
            
            const printButton = String(load.id).startsWith('manual-') ? `<button class="btn btn-sm btn-outline-info mb-3 no-print" onclick="imprimirCargaManualIndividual('${load.id}')"><i class="bi bi-printer-fill me-1"></i>Imprimir Esta Carga</button>` : '';

            const observationForPrint = ` 
                <div class="print-only-observation mt-2 p-2 border rounded" style="background-color: #f8f9fa; display: none;">
                    <p class="mb-0"></p>
                </div>`;

            const observationText = load.observation || '';
            let initialObservationHtml;
            if (observationText) {
                initialObservationHtml = `
                    <p class="form-control-plaintext form-control-sm small p-2 border rounded" style="white-space: pre-wrap; background-color: var(--dark-bg);">${observationText}</p>
                    <div class="mt-2"><button class="btn btn-sm btn-outline-secondary" onclick="toggleObservationEdit('${load.id}', true)"><i class="bi bi-pencil me-1"></i>Editar</button> <button class="btn btn-sm btn-outline-danger" onclick="deleteObservation('${load.id}')"><i class="bi bi-trash me-1"></i>Excluir</button></div>`;
            } else {
                initialObservationHtml = `<button class="btn btn-sm btn-outline-info" onclick="toggleObservationEdit('${load.id}', true)"><i class="bi bi-plus-circle me-1"></i>Adicionar Observação</button>`;
            }

            return `<div id="${load.id}" class="card mb-3 drop-zone-card ${isPriorityLoad ? 'border-primary' : ''}" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" data-load-id="${load.id}" data-vehicle-type="${vehicleType}"><div class="card-header ${headerColorClass} ${vInfo.textColor}"><i class="bi ${vInfo.icon} me-2"></i>${vInfo.name} #${load.numero}${spDescription} - <i class="bi bi-database me-1"></i>Total: ${totalKgFormatado} kg / <i class="bi bi-rulers me-1"></i>${totalCubagemFormatado} m³ ${priorityBadge} ${hardLimitBadge}</div><div class="card-body">${printButton}${progressBar}<div class="mt-3 no-print" id="obs-container-${load.id}">${initialObservationHtml}</div>${observationForPrint}${createTable(load.pedidos, null, load.id)}</div></div>`;
        }
        
        function separarCargasFiorino(routes, divId, title, buttonElement) { separarCargasGeneric(routes, divId, title, 'fiorino', buttonElement); }
        function separarCargasVan(routes, divId, title, buttonElement) { separarCargasGeneric(routes, divId, title, 'van', buttonElement); }
        function separarCargas34(routes, divId, title, buttonElement) { separarCargasGeneric(routes, divId, title, 'tresQuartos', buttonElement); }

        function displayToco(div, grupos) {
            if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="empty-state"><i class="bi bi-inboxes-fill"></i><p>Nenhuma carga "Toco" encontrada.</p></div>'; return; }
            
            const maxKg = parseFloat(document.getElementById('tocoMaxCapacity').value);
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionTocoMesa">'; // ID alterado para evitar conflito
            
            Object.keys(grupos).sort().forEach((cf, index) => {
                const grupo = grupos[cf]; 
                const loadId = `toco-${cf}`;
                grupo.id = loadId;
                grupo.vehicleType = 'toco';
                activeLoads[loadId] = grupo;

                const pedidos = grupo.pedidos;
                pedidos.sort((a, b) => {
                    const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                    const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                    const clienteCompare = clienteA.localeCompare(clienteB, undefined, { numeric: true });
                    if (clienteCompare !== 0) return clienteCompare;
                    return pedidoA.localeCompare(pedidoB, undefined, { numeric: true });
                });
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const isOverloaded = grupo.totalKg > maxKg;
                const weightBadge = isOverloaded
                    ? `<span class="badge bg-danger ms-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>${totalKgFormatado} kg (ACIMA DO PESO!)</span>`
                    : `<span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>`;
                
                const pesoPercentual = (grupo.totalKg / maxKg) * 100;
                let progressColor = 'bg-success';
                if (isOverloaded || pesoPercentual > 100) progressColor = 'bg-danger';
                else if (pesoPercentual > 95) progressColor = 'bg-danger';
                else if (pesoPercentual > 75) progressColor = 'bg-warning';
                const progressBar = `<div class="progress mb-3" role="progressbar" style="height: 10px;"><div class="progress-bar ${progressColor}" style="width: ${Math.min(pesoPercentual, 100)}%"></div></div>`;
                const headerColorClass = isOverloaded ? 'bg-danger' : '';

                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingToco${index}"><button class="accordion-button collapsed ${headerColorClass}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToco${index}"><strong>CF: ${cf}</strong> &nbsp; <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${pedidos.length}</span> ${weightBadge}</button></h2><div id="collapseToco${index}" class="accordion-collapse collapse" data-bs-parent="#accordionTocoMesa"><div class="accordion-body drop-zone-card" id="${loadId}" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" data-load-id="${loadId}" data-vehicle-type="toco"><button class="btn btn-sm btn-outline-info mb-3 no-print" onclick="imprimirTocoIndividual('${cf}')"><i class="bi bi-printer-fill me-1"></i>Imprimir</button>${progressBar}${createTable(pedidos, null, loadId)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }

        function displayCargasCfAccordion(div, grupos, pedidosCarreta, pedidosCondor) {
            let todosOsGrupos = {...grupos};
            const chaveCarreta = "Pedidos de Carreta/Truck sem CF";
            const chaveCondor = "Pedidos Condor (Truck)";

            if (pedidosCarreta?.length > 0) {
                todosOsGrupos[chaveCarreta] = {
                    pedidos: pedidosCarreta,
                    totalKg: pedidosCarreta.reduce((sum, p) => sum + p.Quilos_Saldo, 0),
                    totalCubagem: pedidosCarreta.reduce((sum, p) => sum + p.Cubagem, 0)
                };
                gruposPorCFGlobais[chaveCarreta] = todosOsGrupos[chaveCarreta];
            }
            if (pedidosCondor?.length > 0) {
                todosOsGrupos[chaveCondor] = {
                    pedidos: pedidosCondor,
                    totalKg: pedidosCondor.reduce((sum, p) => sum + p.Quilos_Saldo, 0),
                    totalCubagem: pedidosCondor.reduce((sum, p) => sum + p.Cubagem, 0)
                };
                gruposPorCFGlobais[chaveCondor] = todosOsGrupos[chaveCondor];
            }

            if (Object.keys(todosOsGrupos).length === 0) {
                div.innerHTML = '<div class="empty-state"><i class="bi bi-truck"></i><p>Nenhum grupo de carga Truck encontrado. Processe um arquivo.</p></div>';
                return;
            }
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionCargasPorCF">';
            
            const specialKeysOrder = [chaveCondor, chaveCarreta];
            const sortedKeys = Object.keys(todosOsGrupos).sort((a,b) => {
                const aIsSpecial = specialKeysOrder.includes(a);
                const bIsSpecial = specialKeysOrder.includes(b);

                if (aIsSpecial && bIsSpecial) {
                    return specialKeysOrder.indexOf(a) - specialKeysOrder.indexOf(b);
                }
                if (aIsSpecial) return -1;
                if (bIsSpecial) return 1;
                return a.localeCompare(b, undefined, {numeric: true});
            });

            sortedKeys.forEach((cf, index) => {
                const grupo = todosOsGrupos[cf];
                
                grupo.pedidos.sort((a, b) => {
                    const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                    const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                    const clienteCompare = clienteA.localeCompare(clienteB, undefined, { numeric: true });
                    if (clienteCompare !== 0) return clienteCompare;
                    return pedidoA.localeCompare(pedidoB, undefined, { numeric: true });
                });

                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const totalCubagemFormatado = grupo.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const rotas = [...new Set(grupo.pedidos.map(p => p.Cod_Rota))].join(', ');
                const collapseId = `collapseCF-Mesa-${index}`;

                accordionHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCargaCFMesa${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <strong>${isNumeric(cf) ? "CF: " : ""}${cf}</strong> &nbsp;
                                <span class="badge bg-secondary ms-2" title="Rotas">${rotas || 'N/A'}</span>
                                <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>
                                <span class="badge bg-light text-dark ms-2"><i class="bi bi-rulers me-1"></i>${totalCubagemFormatado} m³</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#accordionCargasPorCF">
                            <div class="accordion-body">
                                <button class="btn btn-sm btn-outline-info mb-3 no-print" onclick="imprimirCargaCFIndividual('${cf}')">
                                    <i class="bi bi-printer-fill me-1"></i>Imprimir esta Carga
                                </button>
                                ${createTable(grupo.pedidos)}
                            </div>
                        </div>
                    </div>`;
            });
            accordionHtml += '</div>';
            div.innerHTML = accordionHtml;
        }

        function imprimirCargaCFIndividual(cf) {
            if (!gruposPorCFGlobais || !gruposPorCFGlobais[cf]) {
                alert(`Nenhuma carga encontrada para: ${cf}`);
                return;
            }
            const grupo = gruposPorCFGlobais[cf];
            const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const totalCubagemFormatado = grupo.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const printWindow = createPrintWindow(`Imprimir Carga: ${cf}`);
                let contentToPrint = `<h3>Carga: ${cf} - Total: ${totalKgFormatado} kg / ${totalCubagemFormatado} m³</h3>` + createTable(grupo.pedidos, null, `cf-${cf}`);
            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function montarCargaPredefinida(inputId, resultadoId, processedSet, nomeCarga) {
            const resultadoDiv = document.getElementById(resultadoId);
            const input = document.getElementById(inputId);
            resultadoDiv.innerHTML = '';

            if (planilhaData.length === 0) {
                resultadoDiv.innerHTML = '<div class="alert alert-warning">Por favor, carregue la planilha primeiro.</div>';
                return;
            }

            const numerosPedidos = input.value.split('\n').map(n => n.trim()).filter(Boolean);

            if (numerosPedidos.length === 0) {
                alert(`Nenhum número de pedido foi inserido para a ${nomeCarga}.`);
                return;
            }

            const pedidosSelecionados = [];
            const pedidosNaoEncontrados = [];

            numerosPedidos.forEach(num => {
                const pedidoEncontrado = planilhaData.find(p => String(p.Num_Pedido) === num);
                if (pedidoEncontrado) {
                    pedidosSelecionados.push(pedidoEncontrado);
                } else {
                    pedidosNaoEncontrados.push(num);
                }
            });

            if (pedidosNaoEncontrados.length > 0) {
                alert(`Os seguintes pedidos não foram encontrados na planilha: ${pedidosNaoEncontrados.join(', ')}. Verifique os números e tente novamente.`);
                return;
            }

            const totalKg = pedidosSelecionados.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
            const totalCubagem = pedidosSelecionados.reduce((sum, p) => sum + p.Cubagem, 0);

            const veiculos = [
                { tipo: 'fiorino', nome: 'Fiorino', maxKg: parseFloat(document.getElementById('fiorinoHardMaxCapacity').value), maxCubagem: parseFloat(document.getElementById('fiorinoHardCubage').value) },
                { tipo: 'van', nome: 'Van', maxKg: parseFloat(document.getElementById('vanHardMaxCapacity').value), maxCubagem: parseFloat(document.getElementById('vanHardCubage').value) }, // Corrigido para vanHardCubage
                { tipo: 'tresQuartos', nome: '3/4', maxKg: parseFloat(document.getElementById('tresQuartosMaxCapacity').value), maxCubagem: parseFloat(document.getElementById('tresQuartosCubage').value) },
            ];

            let veiculoEscolhido = null;

            for (const veiculo of veiculos) {
                if (totalKg <= veiculo.maxKg && totalCubagem <= veiculo.maxCubagem) {
                    veiculoEscolhido = veiculo;
                    break;
                }
            }
            
            if (veiculoEscolhido) {
                numerosPedidos.forEach(num => processedSet.add(num));
                pedidosSelecionados.forEach(p => processedSet.add(String(p.Num_Pedido)));

                const loadId = `${nomeCarga.toLowerCase().replace(/\s+/g, '-')}-1`;
                const load = {
                    id: loadId, // ID Fixo para que possa ser substituído se a carga for remontada
                    pedidos: pedidosSelecionados,
                    totalKg: totalKg,
                    totalCubagem: totalCubagem,
                    numero: nomeCarga,
                    vehicleType: veiculoEscolhido.tipo
                };
                activeLoads[loadId] = load;
                
                const vehicleInfo = {
                    fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                    van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                    tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' }
                };

                resultadoDiv.innerHTML = `
                    <div class="alert alert-success d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Carga ${nomeCarga} montada com sucesso!</strong> Estes ${pedidosSelecionados.length} pedidos foram agrupados em um(a) <strong>${veiculoEscolhido.nome}</strong>.
                            <br>Eles serão removidos da análise geral quando você clicar em "Processar Cargas".
                        </div>
                        <button class="btn btn-light btn-sm no-print" onclick="imprimirGeneric('${resultadoId}', 'Carga ${nomeCarga}')"><i class="bi bi-printer-fill me-1"></i> Imprimir Carga</button>
                    </div>
                    ${renderLoadCard(load, veiculoEscolhido.tipo, vehicleInfo[veiculoEscolhido.tipo])}
                `;                
                // Se o processamento principal já ocorreu, remove os pedidos da lista de disponíveis
                if (pedidosGeraisAtuais.length > 0) {
                    processar();
                }
                saveStateToLocalStorage();

            } else {
                alert(`Não foi possível montar a carga. O total excede a capacidade dos veículos.\nPeso Total: ${totalKg.toFixed(2)} kg\nCubagem Total: ${totalCubagem.toFixed(2)} m³`);
            }
        }
        
        function highlightClientRows(event) {
            const clickedRow = event.target.closest('tr');
            if (!clickedRow || !clickedRow.dataset.clienteId) return;

            const clienteId = clickedRow.dataset.clienteId;
            const isAlreadyHighlighted = clickedRow.classList.contains('client-highlight');

            document.querySelectorAll('tr.client-highlight').forEach(row => {
                row.classList.remove('client-highlight');
            });

            if (!isAlreadyHighlighted) {
                document.querySelectorAll(`tr[data-cliente-id='${clienteId}']`).forEach(row => {
                    row.classList.add('client-highlight');
                });
            }
        }
        
        function dragStart(event, pedidoId, clienteId, sourceId) {
            event.dataTransfer.setData("text/plain", JSON.stringify({ pedidoId, clienteId, sourceId }));
            event.dataTransfer.effectAllowed = "move";
        }

        function dragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = "move";
            const dropZoneCard = event.target.closest('.drop-zone-card');
            if (dropZoneCard) {
                dropZoneCard.classList.add('drag-over');
            }
        }

        function dragLeave(event) {
            const dropZoneCard = event.target.closest('.drop-zone-card');
            if (dropZoneCard) {
                dropZoneCard.classList.remove('drag-over');
            }
        }
        
        function drop(event) {
            event.preventDefault();
            const dropZoneCard = event.target.closest('.drop-zone-card');
            if (!dropZoneCard) return;
            dropZoneCard.classList.remove('drag-over');

            const { clienteId, sourceId } = JSON.parse(event.dataTransfer.getData("text/plain"));
            const targetId = dropZoneCard.dataset.loadId;

            if (sourceId === targetId) return; 

            let sourceLoad, targetLoad;
            let sourceIsLeftovers = sourceId === 'leftovers';
            let targetIsLeftovers = targetId === 'leftovers';
            let sourceIsGeral = sourceId === 'geral';
            let targetIsManualBuilder = targetId === 'manual-builder';
            let sourceIsManualBuilder = sourceId === 'manual-builder';

            if (sourceIsLeftovers) {
                sourceLoad = { pedidos: currentLeftoversForPrinting };
            } else if (sourceIsGeral) {
                sourceLoad = { pedidos: pedidosGeraisAtuais };
            } else if (sourceIsManualBuilder) {
                sourceLoad = manualLoadInProgress;
            } else {
                sourceLoad = activeLoads[sourceId];
            }

            if (targetIsLeftovers) {
                targetLoad = { pedidos: currentLeftoversForPrinting, totalKg: 0, totalCubagem: 0 };
            } else if (targetIsManualBuilder) {
                targetLoad = manualLoadInProgress;
            } else {
                targetLoad = activeLoads[targetId];
            }
            
            if (!sourceLoad || !targetLoad) {
                console.error("ERRO: Carga de origem ou destino não encontrada.", { sourceId, targetId, activeLoads });
                return;
            }

            const clientOrdersToMove = sourceLoad.pedidos.filter(p => normalizeClientId(p.Cliente) === clienteId);
            if (clientOrdersToMove.length === 0) return;

            const orderIdsToMove = new Set(clientOrdersToMove.map(p => p.Num_Pedido));
            const clientBlockKg = clientOrdersToMove.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
            const clientBlockCubagem = clientOrdersToMove.reduce((sum, p) => sum + p.Cubagem, 0);
            
            if (!targetIsLeftovers && !targetIsManualBuilder) {
                const targetVehicleType = targetLoad.vehicleType;
                if (targetVehicleType) { 
                    const config = getVehicleConfig(targetVehicleType);
                    if ((targetLoad.totalKg + clientBlockKg > config.hardMaxKg) || (targetLoad.totalCubagem + clientBlockCubagem > config.hardMaxCubage)) {
                        const overWeight = (targetLoad.totalKg + clientBlockKg) - config.hardMaxKg;
                        const confirmation = confirm(`AVISO: Mover este grupo excede a capacidade do veículo em ${overWeight.toFixed(2)} kg.\n\nDeseja continuar mesmo assim?`);
                        if (!confirmation) return;
                    }
                }
            }
            
            if (sourceIsLeftovers) {
                currentLeftoversForPrinting = sourceLoad.pedidos.filter(p => !orderIdsToMove.has(p.Num_Pedido));
            } else if (sourceIsGeral) {
                pedidosGeraisAtuais = sourceLoad.pedidos.filter(p => !orderIdsToMove.has(p.Num_Pedido));
            } else {
                sourceLoad.pedidos = sourceLoad.pedidos.filter(p => !orderIdsToMove.has(p.Num_Pedido));
                sourceLoad.totalKg -= clientBlockKg;
                sourceLoad.totalCubagem -= clientBlockCubagem;
            }

            if (targetIsLeftovers) {
                currentLeftoversForPrinting.push(...clientOrdersToMove);
            } else {
                targetLoad.pedidos.push(...clientOrdersToMove);
                targetLoad.totalKg += clientBlockKg;
                targetLoad.totalCubagem += clientBlockCubagem;
            }

            if (sourceIsManualBuilder) {
                updateManualBuilderUI();
            } else {
                updateLoadUI(sourceId);
            }
            
            if (targetIsManualBuilder) {
                updateManualBuilderUI();
            } else {
                updateLoadUI(targetId);
            }

            updateAndRenderChart();
            updateAndRenderKPIs(); // Adicionado para atualizar os KPIs dinâmicos
            saveStateToLocalStorage();
        }

        function updateLoadUI(loadId) {
            const activeTabPane = document.querySelector('.tab-pane.active');
            
            if (loadId === 'leftovers' || loadId === 'geral') {
                const geraisDiv = document.getElementById('resultado-geral');
                if (geraisDiv) {
                    const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => {
                        const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += p.Quilos_Saldo; return acc;
                    }, {});
                    displayGerais(geraisDiv, gruposGerais);
                }
                
                const leftoversCard = activeTabPane ? activeTabPane.querySelector('[data-load-id="leftovers"]') : null;
                if (!leftoversCard) return;

                if (currentLeftoversForPrinting.length === 0) {
                    leftoversCard.innerHTML = `
                        <h5 class="mt-4">Sobras Finais: 0,00 kg</h5>
                        <div class="card mb-3">
                            <div class="card-header bg-danger text-white d-flex align-items-center">
                                Pedidos Restantes
                            </div>
                            <div class="card-body">
                                <p class="text-muted text-center py-3">Todos os pedidos foram alocados.</p>
                            </div>
                        </div>`;
                } else {
                    const totalKgUnassigned = currentLeftoversForPrinting.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
                    const manualLoadButton = `<button id="start-manual-load-btn" class="btn btn-success ms-auto no-print" onclick="startManualLoadBuilder()"><i class="bi bi-plus-circle-fill me-1"></i>Criar Carga Manual</button>`;
                    const printButtonHtml = `<button class="btn btn-info ms-2 no-print" onclick="imprimirSobras('Sobras Finais')"><i class="bi bi-printer-fill me-1"></i>Imprimir</button>`;
                    leftoversCard.innerHTML = `
                        <h5 class="mt-4">Sobras Finais: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h5>
                        <div class="card mb-3">
                            <div class="card-header bg-danger text-white d-flex align-items-center">
                                Pedidos Restantes
                                <div class="ms-auto">${manualLoadButton}${printButtonHtml}</div>
                            </div>
                            <div class="card-body">${createTable(currentLeftoversForPrinting, ['Num_Pedido', 'Quilos_Saldo', 'Agendamento', 'Cubagem', 'Predat', 'Cliente', 'Nome_Cliente', 'Cidade', 'CF'], 'leftovers')}</div>
                        </div>`;
                }
                return;
            }

            const load = activeLoads[loadId];
            if (!load) return;

            const cardElement = document.getElementById(loadId);
            if (!cardElement) return;

            const vInfoMap = {
                fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' },
                toco: { name: 'Toco', colorClass: 'bg-dark', textColor: 'text-white', icon: 'bi-inboxes-fill'}
            };
            const vInfo = vInfoMap[load.vehicleType];
            
            if(load.vehicleType !== 'toco') {
                cardElement.outerHTML = renderLoadCard(load, load.vehicleType, vInfo);
            } else {
                const accordionBody = cardElement;
                const progressBarContainer = accordionBody.querySelector('.progress');
                const tableContainer = accordionBody.querySelector('.table-responsive');
                const headerButton = accordionBody.closest('.accordion-item').querySelector('.accordion-button');
                
                const maxKg = parseFloat(document.getElementById('tocoMaxCapacity').value);
                const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const isOverloaded = load.totalKg > maxKg;
                const pesoPercentual = (load.totalKg / maxKg) * 100;
                let progressColor = isOverloaded || pesoPercentual > 100 ? 'bg-danger' : (pesoPercentual > 75 ? 'bg-warning' : 'bg-success');
                
                progressBarContainer.querySelector('.progress-bar').style.width = `${Math.min(pesoPercentual, 100)}%`;
                progressBarContainer.querySelector('.progress-bar').className = `progress-bar ${progressColor}`;
                if(tableContainer) {
                    tableContainer.outerHTML = createTable(load.pedidos, null, loadId);
                } else {
                    accordionBody.insertAdjacentHTML('beforeend', createTable(load.pedidos, null, loadId));
                }

                const weightBadge = headerButton.querySelector('.badge.bg-info, .badge.bg-danger');
                if(weightBadge) {
                    weightBadge.outerHTML = isOverloaded
                    ? `<span class="badge bg-danger ms-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>${totalKgFormatado} kg (ACIMA DO PESO!)</span>`
                    : `<span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>`;
                }
                headerButton.classList.toggle('bg-danger', isOverloaded);
            }
        }
        
        function startManualLoadBuilder() {
            if (document.getElementById('manual-load-builder-wrapper')) return; 

            manualLoadInProgress = {
                pedidos: [], totalKg: 0, totalCubagem: 0, vehicleType: 'fiorino' 
            };
            
            const activeTabPane = document.querySelector('.tab-pane.active');
            if (!activeTabPane) {
                alert("Erro: Nenhuma aba de trabalho está ativa.");
                return;
            }

            const builderWrapper = document.createElement('div');
            builderWrapper.id = 'manual-load-builder-wrapper';
            builderWrapper.className = 'p-3 border-top border-secondary'; 
            
            builderWrapper.innerHTML = `
                <div class="card border-info shadow-lg" id="manual-load-card">
                    <div class="card-header bg-info text-dark"><h5 class="mb-0"><i class="bi bi-tools me-2"></i>Painel de Montagem de Carga Manual</h5></div>
                    <div class="card-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-4"><label for="manualVehicleType" class="form-label">Montar para o veículo:</label><select id="manualVehicleType" class="form-select" onchange="updateManualBuilderUI()"><option value="fiorino">Fiorino</option><option value="van">Van</option><option value="tresQuartos">3/4</option></select></div>
                            <div class="col-md-5"><p class="mb-1"><strong>Peso Total:</strong> <span id="manualLoadKg">0,00</span> kg</p><p class="mb-0"><strong>Cubagem Total:</strong> <span id="manualLoadCubage">0,00</span> m³</p></div>
                            <div class="col-md-3 text-end"><button class="btn btn-danger me-2" onclick="cancelManualLoad()"><i class="bi bi-x-circle me-1"></i>Cancelar</button><button id="finalizeManualLoadBtn" class="btn btn-success" onclick="finalizeManualLoad()" disabled><i class="bi bi-check-circle me-1"></i>Criar</button></div>
                        </div>
                        <div id="manual-progress-bar-container"></div>
                        <div id="manual-drop-zone" class="p-3 border rounded drop-zone-card" style="background-color: var(--dark-bg); min-height: 150px;" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" data-load-id="manual-builder">
                            <p class="text-muted text-center" id="manual-drop-text">Arraste os pedidos da lista de "Sobras" para cá.</p>
                            <div id="manual-load-table-container"></div>
                        </div>
                    </div>
                </div>`;
            
            activeTabPane.appendChild(builderWrapper);
            
            const startBtn = activeTabPane.querySelector('#start-manual-load-btn');
            if (startBtn) startBtn.style.display = 'none';
            updateManualBuilderUI(); 
        }

        function updateManualBuilderUI() {
            if (!manualLoadInProgress) return;

            const vehicleType = document.getElementById('manualVehicleType').value;
            manualLoadInProgress.vehicleType = vehicleType;

            document.getElementById('manualLoadKg').textContent = manualLoadInProgress.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('manualLoadCubage').textContent = manualLoadInProgress.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const tableContainer = document.getElementById('manual-load-table-container');
            const dropText = document.getElementById('manual-drop-text');
            if (manualLoadInProgress.pedidos.length > 0) {
                tableContainer.innerHTML = createTable(manualLoadInProgress.pedidos, null, 'manual-builder');
                dropText.style.display = 'none';
            } else {
                tableContainer.innerHTML = '';
                dropText.style.display = 'block';
            }

            const config = getVehicleConfig(vehicleType);
            
            const finalizeBtn = document.getElementById('finalizeManualLoadBtn');
            finalizeBtn.disabled = manualLoadInProgress.totalKg < config.minKg;
            
            const pesoPercentual = config.hardMaxKg > 0 ? (manualLoadInProgress.totalKg / config.hardMaxKg) * 100 : 0;
            let progressColor = 'bg-secondary';
            if(manualLoadInProgress.totalKg >= config.minKg) progressColor = 'bg-success';
            if (pesoPercentual > 75) progressColor = 'bg-warning';
            if (pesoPercentual > 95) progressColor = 'bg-danger';

            document.getElementById('manual-progress-bar-container').innerHTML = `
                <div class="progress mb-3" role="progressbar" style="height: 10px;">
                    <div class="progress-bar ${progressColor}" style="width: ${Math.min(pesoPercentual, 100)}%"></div>
                </div>
            `;
        }

        function finalizeManualLoad() {
            if (!manualLoadInProgress || manualLoadInProgress.pedidos.length === 0) return;

            const vehicleType = manualLoadInProgress.vehicleType;
            const newLoad = {
                ...manualLoadInProgress,
                id: `manual-${vehicleType}-${Date.now()}`,
                numero: `M-${Object.keys(activeLoads).filter(k => k.startsWith('manual')).length + 1}`
            };

            activeLoads[newLoad.id] = newLoad;
            
            const vehicleInfo = {
                fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' }
            };

            const newCardHTML = renderLoadCard(newLoad, vehicleType, vehicleInfo[vehicleType]);
            
            const activeTabPane = document.querySelector('.tab-pane.active');
            const resultContainer = activeTabPane ? activeTabPane.querySelector('.resultado-container') : null;

            if(resultContainer) {
               resultContainer.insertAdjacentHTML('beforeend', newCardHTML);
               alert(`Carga manual ${newLoad.numero} criada com sucesso para ${vehicleInfo[vehicleType].name} e adicionada à aba atual!`);
            }

            const builderWrapper = document.getElementById('manual-load-builder-wrapper');
            if (builderWrapper) builderWrapper.remove();
            manualLoadInProgress = null;
            
            const startBtn = activeTabPane ? activeTabPane.querySelector('#start-manual-load-btn') : null;
            if(startBtn) startBtn.style.display = 'inline-block';
            
            setTimeout(() => {
                const newCardElement = document.getElementById(newLoad.id);
                if(newCardElement) {
                    newCardElement.scrollIntoView({ behavior: 'smooth', block: 'center'});
                    newCardElement.classList.add('border-info');
                    setTimeout(() => newCardElement.classList.remove('border-info'), 2500);
                }
            }, 300);

            updateAndRenderChart();
            updateAndRenderKPIs(); // Adicionado para atualizar os KPIs dinâmicos
            saveStateToLocalStorage();
        }

        function cancelManualLoad() {
             if (!manualLoadInProgress) return;
             
             currentLeftoversForPrinting.push(...manualLoadInProgress.pedidos);
             
             const builderWrapper = document.getElementById('manual-load-builder-wrapper');
             if (builderWrapper) builderWrapper.remove();
             manualLoadInProgress = null;

             updateLoadUI('leftovers'); 
             
             const activeTabPane = document.querySelector('.tab-pane.active');
             const startBtn = activeTabPane ? activeTabPane.querySelector('#start-manual-load-btn') : null;
             if(startBtn) startBtn.style.display = 'inline-block'; 
             updateAndRenderKPIs(); // Adicionado para atualizar os KPIs dinâmicos
        }

        function displayPedidosFuncionarios(div, pedidos) {
            if (!div) return;
            if (pedidos.length === 0) {
                div.innerHTML = '<div class="empty-state"><i class="bi bi-people-fill"></i><p>Nenhum pedido de funcionário encontrado.</p></div>';
                return;
            }

            pedidos.sort((a, b) => {
                const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                const clienteCompare = clienteA.localeCompare(clienteB, undefined, { numeric: true });
                if (clienteCompare !== 0) return clienteCompare;
                return pedidoA.localeCompare(pedidoB, undefined, { numeric: true });
            });

            const totalKg = pedidos.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
            const totalKgFormatado = totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            const accordionId = 'accordionFuncionarios';
            const collapseId = 'collapseFuncionarios';
            const headerId = 'headingFuncionarios';
            const printAreaId = 'funcionarios-print-area';

            let accordionHtml = `<div class="accordion accordion-flush" id="${accordionId}">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headerId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <strong>Pedidos de Funcionários</strong> &nbsp;
                            <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${pedidos.length} Pedidos</span>
                            <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                        <div class="accordion-body" id="${printAreaId}">
                            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                <p class="text-muted small mb-0">Pedidos com a tag "TBL FUNCIONARIO" na Coluna 5, separados automaticamente.</p>
                                <button class="btn btn-sm btn-outline-info" onclick="imprimirGeneric('${printAreaId}', 'Pedidos de Funcionários')">
                                    <i class="bi bi-printer-fill me-1"></i>Imprimir Lista
                                </button>
                            </div>
                            ${createTable(pedidos, ['Num_Pedido', 'Cliente', 'Nome_Cliente', 'Quilos_Saldo', 'Cidade', 'Predat', 'Coluna5', 'BLOQ.'])}
                        </div>
                    </div>
                </div>
            </div>`;

            div.innerHTML = accordionHtml;
        }

        function displayPedidosTransferencias(div, pedidos) {
            if (!div) return;
            if (pedidos.length === 0) {
                div.innerHTML = '<div class="empty-state"><i class="bi bi-arrow-left-right"></i><p>Nenhum pedido de transferência encontrado.</p></div>';
                return;
            }

            pedidos.sort((a, b) => {
                const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                const clienteCompare = clienteA.localeCompare(clienteB, undefined, { numeric: true });
                if (clienteCompare !== 0) return clienteCompare;
                return pedidoA.localeCompare(pedidoB, undefined, { numeric: true });
            });

            const totalKg = pedidos.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
            const totalKgFormatado = totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const accordionId = 'accordionTransferencias';
            const collapseId = 'collapseTransferencias';
            const headerId = 'headingTransferencias';
            const printAreaId = 'transferencias-print-area';

            let accordionHtml = `<div class="accordion accordion-flush" id="${accordionId}">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headerId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <strong>Pedidos de Transferência</strong> &nbsp;
                            <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${pedidos.length} Pedidos</span>
                            <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                        <div class="accordion-body" id="${printAreaId}">
                            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                <p class="text-muted small mb-0">Pedidos com a tag "TABELA TRANSFER" na Coluna 5, separados automaticamente.</p>
                                <button class="btn btn-sm btn-outline-info" onclick="imprimirGeneric('${printAreaId}', 'Pedidos de Transferência')">
                                    <i class="bi bi-printer-fill me-1"></i>Imprimir Lista
                                </button>
                            </div>
                            ${createTable(pedidos, ['Num_Pedido', 'Cliente', 'Nome_Cliente', 'Quilos_Saldo', 'Cidade', 'Predat', 'Coluna5', 'BLOQ.'])}
                        </div>
                    </div>
                </div>
            </div>`;

            div.innerHTML = accordionHtml;
        }

        function displayPedidosExportacao(div, pedidos) {
            if (!div) return;
            if (pedidos.length === 0) {
                div.innerHTML = '<div class="empty-state"><i class="bi bi-globe-americas"></i><p>Nenhum pedido de exportação encontrado.</p></div>';
                return;
            }

            pedidos.sort((a, b) => {
                const clienteA = String(a.Cliente); const clienteB = String(b.Cliente);
                const pedidoA = String(a.Num_Pedido); const pedidoB = String(b.Num_Pedido);
                const clienteCompare = clienteA.localeCompare(clienteB, undefined, { numeric: true });
                if (clienteCompare !== 0) return clienteCompare;
                return pedidoA.localeCompare(pedidoB, undefined, { numeric: true });
            });

            const totalKg = pedidos.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
            const totalKgFormatado = totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const accordionId = 'accordionExportacao';
            const collapseId = 'collapseExportacao';
            const headerId = 'headingExportacao';
            const printAreaId = 'exportacao-print-area'; // Este ID é usado no botão de imprimir

            let accordionHtml = `<div class="accordion accordion-flush" id="${accordionId}">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headerId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <strong>Pedidos de Exportação</strong> &nbsp;
                            <span class="badge bg-secondary ms-2"><i class="bi bi-box me-1"></i>${pedidos.length} Pedidos</span>
                            <span class="badge bg-info ms-2"><i class="bi bi-database me-1"></i>${totalKgFormatado} kg</span>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                        <div class="accordion-body" id="${printAreaId}"><div class="d-flex justify-content-between align-items-center mb-3 no-print"><p class="text-muted small mb-0">Pedidos com a tag "TBL EXPORTACAO" na Coluna 5.</p><button class="btn btn-sm btn-outline-info" onclick="imprimirGeneric('${printAreaId}', 'Pedidos de Exportação')"><i class="bi bi-printer-fill me-1"></i>Imprimir Lista</button></div>${createTable(pedidos, ['Num_Pedido', 'Cliente', 'Nome_Cliente', 'Quilos_Saldo', 'Cidade', 'Predat', 'Coluna5', 'BLOQ.'])}</div>
                    </div>
                </div></div>`;
            div.innerHTML = accordionHtml;
        }

        function gerarRelatorioPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // --- 1. Coleta e Agrupamento de Dados ---
            const allLoads = Object.values(activeLoads);
            if (allLoads.length === 0 && currentLeftoversForPrinting.length === 0 && pedidosTransferencias.length === 0 && pedidosExportacao.length === 0 && pedidosFuncionarios.length === 0) {
                alert("Não há dados processados para gerar o relatório. Por favor, processe um arquivo primeiro.");
                return;
            }

            const varejoLoads = allLoads.filter(l => ['fiorino', 'van', 'tresQuartos', 'toco'].includes(l.vehicleType));
            const manualLoads = allLoads.filter(l => !['fiorino', 'van', 'tresQuartos', 'toco'].includes(l.vehicleType));

            const resumoVarejo = varejoLoads.reduce((acc, load) => {
                const type = load.vehicleType === 'tresQuartos' ? '3/4' : load.vehicleType.charAt(0).toUpperCase() + load.vehicleType.slice(1);
                if (!acc[type]) {
                    acc[type] = { veiculos: 0, peso: 0, pedidos: 0 };
                }
                acc[type].veiculos++;
                acc[type].peso += load.totalKg;
                acc[type].pedidos += load.pedidos.length;
                return acc;
            }, {});

            const totalPedidosAlocados = allLoads.reduce((sum, l) => sum + l.pedidos.length, 0);
            const totalPesoAlocado = allLoads.reduce((sum, l) => sum + l.totalKg, 0);
            const totalVeiculos = varejoLoads.length + manualLoads.length;

            // --- 2. Construção do PDF ---
            const today = new Date().toLocaleDateString('pt-BR');
            let finalY = 10; // Inicia a posição Y

            // Cabeçalho
            doc.setFontSize(20);
            doc.setTextColor('#00bfa5');
            doc.text("ApexLog", 14, 20);
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.text("Relatório de Previsão de Expedição", 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(120);
            doc.text(`Data de Geração: ${today}`, 200, 26, { align: 'right' });
            doc.setLineWidth(0.5);
            doc.setDrawColor('#00bfa5');
            doc.line(14, 29, 200, 29);

            finalY = 35; // Posição Y após o cabeçalho
            // Resumo Geral
            doc.setFontSize(14);
            doc.setTextColor(40);
            doc.text("Resumo Geral da Previsão", 14, finalY);
            doc.autoTable({
                startY: finalY + 6,
                body: [
                    ['Total de Veículos Previstos:', totalVeiculos.toString()],
                    ['Peso Total Alocado (kg):', totalPesoAlocado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })],
                    ['Total de Pedidos Alocados:', totalPedidosAlocados.toString()],
                    ['Pedidos em Sobra (Não alocados):', currentLeftoversForPrinting.length.toString()],
                ],
                theme: 'striped',
                styles: { fontSize: 10, cellPadding: 2.5 },
                bodyStyles: { fillColor: false }, // Fundo transparente para o corpo
                columnStyles: { 0: { fontStyle: 'bold' } }
            });

            finalY = doc.lastAutoTable.finalY; // Atualiza a posição Y

            // Detalhamento Varejo
            const bodyVarejo = Object.keys(resumoVarejo).map(tipo => {
                const data = resumoVarejo[tipo];
                const pesoMedio = data.veiculos > 0 ? (data.peso / data.veiculos) : 0;
                return [
                    tipo,
                    data.veiculos,
                    data.peso.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
                    pesoMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
                    data.pedidos
                ];
            });

            if (bodyVarejo.length > 0) {
                finalY += 10; // Adiciona um espaço antes da próxima seção
                doc.setFontSize(14);
                doc.setTextColor(40);
                doc.text("Detalhamento de Cargas (Varejo)", 14, finalY);
                doc.autoTable({
                    head: [['Tipo de Veículo', 'Qtd. Veículos', 'Peso Total (kg)', 'Peso Médio/Veículo (kg)', 'Qtd. Pedidos']],
                    body: bodyVarejo,
                    startY: finalY + 6,
                    headStyles: { fillColor: [0, 191, 165], textColor: 255 }
                });
                finalY = doc.lastAutoTable.finalY; // Atualiza a posição Y
            }

            // Outras Categorias (Re-adicionado)
            const bodyOutros = [];
            if(pedidosTransferencias.length > 0) bodyOutros.push(['Transferências', pedidosTransferencias.length, pedidosTransferencias.reduce((s, p) => s + p.Quilos_Saldo, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })]);
            if(pedidosExportacao.length > 0) bodyOutros.push(['Exportação', pedidosExportacao.length, pedidosExportacao.reduce((s, p) => s + p.Quilos_Saldo, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })]);
            
            const totalPedidosTruck = Object.values(gruposPorCFGlobais).reduce((sum, g) => sum + g.pedidos.length, 0);
            const totalPesoTruck = Object.values(gruposPorCFGlobais).reduce((sum, g) => sum + g.totalKg, 0);
            if (totalPedidosTruck > 0) {
                bodyOutros.push(['Truck / Carreta', totalPedidosTruck, totalPesoTruck.toLocaleString('pt-BR', { minimumFractionDigits: 2 })]);
            }
            if(pedidosFuncionarios.length > 0) bodyOutros.push(['Funcionários', pedidosFuncionarios.length, pedidosFuncionarios.reduce((s, p) => s + p.Quilos_Saldo, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })]);

            if (bodyOutros.length > 0) {
                finalY += 10; // Adiciona um espaço
                doc.setFontSize(14);
                doc.setTextColor(40);
                doc.text("Outras Categorias de Pedidos", 14, finalY);
                doc.autoTable({
                    head: [['Categoria', 'Qtd. Pedidos', 'Peso Total (kg)']],
                    body: bodyOutros,
                    startY: finalY + 6,
                    headStyles: { fillColor: [80, 90, 110], textColor: 255 }
                });
            }

            // Rodapé e Salvamento
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width / 2, 287, { align: 'center' });
                doc.text('Este é um relatório de previsão e pode sofrer alterações.', 14, 287);
            }

            doc.save(`Previsao_Expedicao_${today.replace(/\//g, '-')}.pdf`);
        }

        // ================================================================================================
        //  LÓGICA DE PERSISTÊNCIA DE ESTADO
        // ================================================================================================
        
        function saveStateToLocalStorage() {
            if (typeof(Storage) === "undefined") {
                console.warn("Seu navegador não suporta Local Storage. O progresso não será salvo.");
                return;
            }
            try {
                const state = {
                    planilhaData,
                    originalColumnHeaders,
                    pedidosGeraisAtuais,
                    gruposToco,
                    gruposPorCFGlobais,
                    pedidosComCFNumericoIsolado,
                    pedidosManualmenteBloqueadosAtuais,
                    pedidosPrioritarios: Array.from(pedidosPrioritarios),
                    pedidosBloqueados: Array.from(pedidosBloqueados),
                    pedidosRecall: Array.from(pedidosRecall),
                    pedidosEspeciaisProcessados: Array.from(pedidosEspeciaisProcessados), 
                    pedidosSemCorte: Array.from(pedidosSemCorte),
                    pedidosVendaAntecipadaProcessados: Array.from(pedidosVendaAntecipadaProcessados),
                    rota1SemCarga,
                    pedidosFuncionarios,
                    pedidosCarretaSemCF,
                    pedidosTransferencias,
                    pedidosExportacao,
                    pedidosCondorTruck,
                    tocoPedidoIds: Array.from(tocoPedidoIds),
                    currentLeftoversForPrinting,
                    activeLoads,
                    kpiData,
                    processedRoutes: Array.from(processedRoutes), // Salva as rotas processadas
                    processedRouteContexts: processedRouteContexts // Salva os contextos
                };
                localStorage.setItem('logisticsAppState', JSON.stringify(state));
                console.log("Estado da aplicação salvo no Local Storage.");
            } catch (e) {
                console.error("Erro ao salvar o estado no Local Storage:", e);
                alert("Erro ao salvar o estado. O armazenamento pode estar cheio.");
            }
        }

        function saveRouteContext(context) {
            // Agora apenas atualiza a variável global. O salvamento ocorre em saveStateToLocalStorage.
            if (!processedRouteContexts) {
                processedRouteContexts = {};
            }
            processedRouteContexts[context.routesKey] = context;
        }

        function loadStateFromLocalStorage() {
            if (typeof(Storage) === "undefined") return;

            const savedStateJSON = localStorage.getItem('logisticsAppState');
            if (!savedStateJSON) {
                console.log("Nenhum estado salvo encontrado.");
                return;
            }

            try {
                const savedState = JSON.parse(savedStateJSON);
                
                // Função auxiliar para garantir que as datas sejam objetos Date
                const reviveDates = (data) => {
                    if (!data) return [];
                    return data.map(item => {
                        if (item.Predat && typeof item.Predat === 'string') item.Predat = new Date(item.Predat);
                        if (item.Dat_Ped && typeof item.Dat_Ped === 'string') item.Dat_Ped = new Date(item.Dat_Ped);
                        return item;
                    });
                };

                planilhaData = savedState.planilhaData || [];
                if (planilhaData.length === 0) return;

                originalColumnHeaders = savedState.originalColumnHeaders || [];
                pedidosGeraisAtuais = savedState.pedidosGeraisAtuais || [];
                gruposToco = savedState.gruposToco || {};
                gruposPorCFGlobais = savedState.gruposPorCFGlobais || {};
                pedidosComCFNumericoIsolado = savedState.pedidosComCFNumericoIsolado || [];
                pedidosManualmenteBloqueadosAtuais = savedState.pedidosManualmenteBloqueadosAtuais || [];
                pedidosPrioritarios = savedState.pedidosPrioritarios || [];
                pedidosRecall = savedState.pedidosRecall || [];
                pedidosBloqueados = new Set(savedState.pedidosBloqueados || []);
                pedidosEspeciaisProcessados = new Set(savedState.pedidosEspeciaisProcessados || []);
                pedidosSemCorte = new Set(savedState.pedidosSemCorte || []);
                pedidosVendaAntecipadaProcessados = new Set(savedState.pedidosVendaAntecipadaProcessados || []);
                rota1SemCarga = savedState.rota1SemCarga || [];
                pedidosFuncionarios = savedState.pedidosFuncionarios || [];
                pedidosCarretaSemCF = savedState.pedidosCarretaSemCF || [];
                pedidosTransferencias = savedState.pedidosTransferencias || [];
                pedidosExportacao = savedState.pedidosExportacao || [];
                pedidosCondorTruck = savedState.pedidosCondorTruck || [];
                tocoPedidoIds = new Set(savedState.tocoPedidoIds || []);
                currentLeftoversForPrinting = savedState.currentLeftoversForPrinting || [];
                activeLoads = savedState.activeLoads || {};
                kpiData = savedState.kpiData || {};
                processedRoutes = new Set(savedState.processedRoutes || []);
                processedRouteContexts = savedState.processedRouteContexts || {};

                // Reconverte as strings de data para objetos Date em todas as listas relevantes
                planilhaData = reviveDates(planilhaData);
                pedidosGeraisAtuais = reviveDates(pedidosGeraisAtuais);
                pedidosComCFNumericoIsolado = reviveDates(pedidosComCFNumericoIsolado);
                pedidosManualmenteBloqueadosAtuais = reviveDates(pedidosManualmenteBloqueadosAtuais);
                rota1SemCarga = reviveDates(rota1SemCarga);
                pedidosFuncionarios = reviveDates(pedidosFuncionarios);
                pedidosCarretaSemCF = reviveDates(pedidosCarretaSemCF);
                pedidosTransferencias = reviveDates(pedidosTransferencias);
                pedidosExportacao = reviveDates(pedidosExportacao);
                pedidosCondorTruck = reviveDates(pedidosCondorTruck);
                currentLeftoversForPrinting = reviveDates(currentLeftoversForPrinting);
                Object.values(activeLoads).forEach(load => load.pedidos = reviveDates(load.pedidos));
                Object.values(gruposToco).forEach(group => group.pedidos = reviveDates(group.pedidos));
                Object.values(gruposPorCFGlobais).forEach(group => group.pedidos = reviveDates(group.pedidos));

                // Re-renderizar a UI com os dados carregados
                statusDiv.innerHTML = `<p class="text-success">Progresso anterior restaurado com sucesso!</p>`;
                processarBtn.disabled = false;

                // Ativa a primeira aba de navegação e mostra a view correspondente
                const activeLink = document.querySelector('#sidebar-nav a.nav-link.active');
                if (!activeLink) {
                    document.querySelectorAll('.main-view').forEach(v => v.style.display = 'none');
                    const firstLink = document.querySelector('#sidebar-nav a.main-nav-link');
                    if (firstLink) {
                        firstLink.classList.add('active');
                        const targetViewId = firstLink.getAttribute('href');
                        if (targetViewId) {
                            const targetView = document.querySelector(targetViewId);
                            if (targetView) targetView.style.display = 'block';
                        }
                    }
                }

                popularFiltrosDeRota();
                atualizarListaBloqueados();
                atualizarListaSemCorte();
                
                // Re-renderizar todas as seções principais
                const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => { const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += p.Quilos_Saldo; return acc; }, {});
                displayGerais(document.getElementById('resultado-geral'), gruposGerais);
                displayToco(document.getElementById('resultado-toco'), gruposToco);
                displayCargasCfAccordion(document.getElementById('resultado-cf-accordion-container'), gruposPorCFGlobais, pedidosCarretaSemCF, pedidosCondorTruck);
                
                // Adicionado para restaurar todas as outras seções da UI
                displayPedidosBloqueados(document.getElementById('resultado-bloqueados'), pedidosManualmenteBloqueadosAtuais);
                displayRota1(document.getElementById('resultado-rota1'), rota1SemCarga);
                displayPedidosCFNumerico(document.getElementById('resultado-cf-numerico'), pedidosComCFNumericoIsolado);
                displayPedidosFuncionarios(document.getElementById('resultado-funcionarios-tab'), pedidosFuncionarios);
                displayPedidosTransferencias(document.getElementById('resultado-transferencias-tab'), pedidosTransferencias);
                displayPedidosExportacao(document.getElementById('resultado-exportacao-tab'), pedidosExportacao);
                reRenderManualLoads();

                reRenderActiveLoads(processedRouteContexts);
                if (Object.keys(kpiData).length > 0) updateAndRenderKPIs();
                updateAndRenderChart();

                console.log("Estado da aplicação restaurado do Local Storage.");
            } catch (e) {
                console.error("Erro ao carregar o estado do Local Storage:", e);
                localStorage.removeItem('logisticsAppState'); // Limpa estado corrompido
            }
        }

        function reRenderManualLoads() {
            const manualLoads = Object.values(activeLoads).filter(load => load.id.includes('venda-antecipada') || load.id.includes('especial'));
            if (manualLoads.length === 0) return;

            const vehicleInfo = {
                fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' }
            };

            manualLoads.forEach(load => {
                const resultadoId = load.id.startsWith('venda-antecipada') ? 'resultado-venda-antecipada' : 'resultado-carga-especial';
                const resultadoDiv = document.getElementById(resultadoId);
                if (resultadoDiv) {
                    resultadoDiv.innerHTML = `
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <div><strong>Carga ${load.numero} restaurada.</strong></div>
                            <button class="btn btn-light btn-sm no-print" onclick="imprimirGeneric('${resultadoId}', 'Carga ${load.numero}')"><i class="bi bi-printer-fill me-1"></i> Imprimir Carga</button>
                        </div>
                        ${renderLoadCard(load, load.vehicleType, vehicleInfo[load.vehicleType])}`;
                }
            });
        }

        function reRenderActiveLoads(processedRouteContexts) {
            if (Object.keys(activeLoads).length === 0) return;

            const vehicleInfo = {
                fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white', icon: 'bi-box-seam-fill' },
                van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white', icon: 'bi-truck-front-fill' },
                tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark', icon: 'bi-truck-flatbed' }
            };

            // Agrupa as cargas por contexto de rota (divId)
            const loadsByContext = {};

            // Processa os contextos para reativar os botões e preparar os containers
            for (const contextKey in processedRouteContexts) {
                const context = processedRouteContexts[contextKey];
                const resultadoDiv = document.getElementById(context.divId);
                if (!resultadoDiv) continue;

                // Limpa e prepara o container da rota
                resultadoDiv.innerHTML = `<div class="resultado-container"><h5 class="mt-3">Cargas para <strong>${context.title}</strong></h5></div>`;

                // Reativa o botão da rota processada
                // Reativa o botão da rota processada
                const routeButton = document.getElementById(context.buttonId);
                if (routeButton) {
                    const vehicleType = routeButton.id.split('-')[1];
                    const colorClass = vehicleType === 'fiorino' ? 'success' : (vehicleType === 'van' ? 'primary' : 'warning');
                    routeButton.classList.remove(`btn-outline-${colorClass}`);
                    routeButton.classList.add(`btn-${colorClass}`, 'active');
                    routeButton.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${context.title}`;
                    routeButton.disabled = true; // Garante que o botão permaneça desativado
                }
            }

            // Renderiza cada carga no seu respectivo container
            for (const loadId in activeLoads) {
                const load = activeLoads[loadId];
                if (!load.id || !load.vehicleType || !vehicleInfo[load.vehicleType] || load.id.startsWith('manual-') || load.id.startsWith('venda-antecipada') || load.id.startsWith('especial')) continue;

                const context = Object.values(processedRouteContexts).find(c => load.pedidos.some(p => c.routesKey.split(',').includes(String(p.Cod_Rota))));
                if (context) {
                    const resultadoDiv = document.getElementById(context.divId);
                    const container = resultadoDiv?.querySelector('.resultado-container');
                    if (container) container.insertAdjacentHTML('beforeend', renderLoadCard(load, load.vehicleType, vehicleInfo[load.vehicleType]));
                }
            }

            // Renderiza as sobras na última aba ativa (ou na primeira, como fallback)
            if (currentLeftoversForPrinting.length > 0) {
                const lastContext = Object.values(processedRouteContexts).pop();
                if (lastContext) {
                    const resultadoDiv = document.getElementById(lastContext.divId);
                    if (resultadoDiv) {
                        const finalLeftoverKg = currentLeftoversForPrinting.reduce((sum, p) => sum + p.Quilos_Saldo, 0);
                        const manualLoadButton = `<button id="start-manual-load-btn" class="btn btn-success ms-auto no-print" onclick="startManualLoadBuilder()"><i class="bi bi-plus-circle-fill me-1"></i>Criar Carga Manual</button>`;
                        const printButtonHtml = `<button class="btn btn-info ms-2 no-print" onclick="imprimirSobras('Sobras Finais de ${lastContext.title}')"><i class="bi bi-printer-fill me-1"></i>Imprimir</button>`;

                        let leftoversHtml = `<div id="leftovers-card-${lastContext.divId}" class="drop-zone-card" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" data-load-id="leftovers" data-vehicle-type="leftovers">
                                             <h5 class="mt-4">Sobras Finais: ${finalLeftoverKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h5>
                                             <div class="card mb-3">
                                                 <div class="card-header bg-danger text-white d-flex align-items-center">
                                                     Pedidos Restantes
                                                     <div class="ms-auto">${manualLoadButton}${printButtonHtml}</div>
                                                 </div>
                                                 <div class="card-body">${createTable(currentLeftoversForPrinting, ['Num_Pedido', 'Quilos_Saldo', 'Agendamento', 'Cubagem', 'Predat', 'Cliente', 'Nome_Cliente', 'Cidade', 'CF'], 'leftovers')}</div>
                                             </div>
                                         </div>`;
                        resultadoDiv.querySelector('.resultado-container').insertAdjacentHTML('beforeend', leftoversHtml);
                    }
                }
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
