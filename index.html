<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separação de Cargas Otimizado</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        :root {
            --dark-bg: #10101a;
            --dark-surface: rgba(28, 28, 42, 0.75);
            --dark-surface-secondary: rgba(40, 40, 60, 0.8);
            --dark-border: rgba(90, 80, 130, 0.3);
            --dark-primary: #6a5acd; /* SlateBlue */
            --dark-primary-hover: #7b68ee; /* MediumSlateBlue */
            --dark-primary-glow: rgba(106, 90, 205, 0.4);
            --dark-text-primary: #f0f0f5;
            --dark-text-secondary: #a0a0b0;
            --box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --backdrop-blur: 10px;
        }

        /* --- Melhorias Gerais --- */
        body {
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 1% 1%, rgba(106, 90, 205, 0.2) 0%, transparent 40%), 
                              radial-gradient(circle at 99% 99%, rgba(74, 124, 242, 0.2) 0%, transparent 40%);
            font-family: 'Inter', sans-serif;
            color: var(--dark-text-primary);
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--dark-bg); }
        ::-webkit-scrollbar-thumb { background-color: var(--dark-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--dark-primary-hover); }

        h1, h2, h3, h4, h5 { font-weight: 700; letter-spacing: -0.5px; }
        
        /* --- Tipografia Responsiva (Valores ajustados para uma aparência mais compacta e profissional) --- */
        h1.h2 { font-size: clamp(1.35rem, 2vw, 1.75rem); }
        h3 { font-size: clamp(1.15rem, 1.7vw, 1.4rem); }
        .card-title.h5, .modal-title { font-size: clamp(1rem, 1.2vw, 1.1rem); }
        #sidebar .fs-4 { font-size: clamp(1.1rem, 1.5vw, 1.25rem); }


        /* --- Animações --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--dark-primary-glow); }
            50% { box-shadow: 0 0 20px var(--dark-primary-glow), 0 0 10px var(--dark-primary-glow); }
            100% { box-shadow: 0 0 5px var(--dark-primary-glow); }
        }
        .animated-entry { animation: fadeIn 0.6s ease-out forwards; }
        .animated-entry:nth-child(1) { animation-delay: 0.1s; }
        .animated-entry:nth-child(2) { animation-delay: 0.2s; }
        .animated-entry:nth-child(3) { animation-delay: 0.3s; }

        /* --- Layout Principal --- */
        #main-content {
            --sidebar-width: clamp(280px, 18vw, 340px);
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            animation: fadeIn 0.5s ease-out;
            min-width: 0; 
        }

        /* --- Sidebar (CORREÇÃO VERTICAL APLICADA) --- */
        #sidebar {
            width: clamp(280px, 18vw, 340px);
            height: 100vh; /* Alterado de min-height para height */
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            background: var(--dark-surface);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
            border-right: 1px solid var(--dark-border);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        /* Nova área de conteúdo rolável da sidebar */
        .sidebar-scrollable-content {
            flex: 1 1 auto; /* Permite que este elemento cresça e encolha */
            overflow-y: auto;
            min-height: 0; /* Essencial para que o overflow funcione em um flex child */
            padding: 0 0.5rem; /* Adiciona um pequeno padding lateral */
        }
        
        .sidebar-scrollable-content::-webkit-scrollbar { width: 6px; }
        .sidebar-scrollable-content::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollable-content::-webkit-scrollbar-thumb { background-color: var(--dark-primary); border-radius: 10px; }
        .sidebar-scrollable-content::-webkit-scrollbar-thumb:hover { background-color: var(--dark-primary-hover); }

        #sidebar .sidebar-header { padding: 1.25rem; } /* Padding reduzido */
        #sidebar .sidebar-header .fs-4 { font-weight: 700; }
        #sidebar .sidebar-step { margin-bottom: 1.25rem; } /* Margem reduzida */
        #sidebar .step-number {
            background-color: var(--dark-primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 0.75rem;
        }
        #sidebar .form-label { font-weight: 500; color: var(--dark-text-secondary); }

        #sidebar .nav-link {
            color: var(--dark-text-secondary);
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        #sidebar .nav-link:hover {
            background-color: var(--dark-surface-secondary);
            color: var(--dark-text-primary);
            transform: translateX(5px);
        }
        #sidebar .nav-link.active {
            background: var(--dark-primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px var(--dark-primary-glow);
        }

        /* --- Estilo dos Cards --- */
        .card {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 1rem;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
        }
        .card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            border-color: var(--dark-primary-glow);
        }
        .card-header {
            background-color: var(--dark-surface-secondary);
            border-bottom: 1px solid var(--dark-border);
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        .card-body { padding: 1.5rem; }

        /* --- Botões e Controles --- */
        .btn {
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            padding: 0.6rem 1.2rem;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--dark-primary), var(--dark-primary-hover));
            border: none;
        }
        .btn-primary:hover { box-shadow: 0 4px 20px var(--dark-primary-glow); }
        .form-control, .form-select {
            background-color: var(--dark-surface-secondary);
            border: 1px solid var(--dark-border);
            color: var(--dark-text-primary);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--dark-surface-secondary);
            border-color: var(--dark-primary);
            box-shadow: 0 0 0 .25rem var(--dark-primary-glow);
            color: var(--dark-text-primary);
        }
        
        /* --- Componentes --- */
        .modal-content {
            background-color: var(--dark-surface);
            backdrop-filter: blur(var(--backdrop-blur));
            border-radius: 1rem;
            border: 1px solid var(--dark-border);
        }
        
        .accordion-item, .accordion-button {
            background-color: transparent;
            border-color: var(--dark-border);
        }
        .accordion-button {
            background-color: var(--dark-surface-secondary);
            color: var(--dark-text-primary);
            font-weight: 600;
        }
        .accordion-button:not(.collapsed) {
            background: linear-gradient(45deg, var(--dark-primary), var(--dark-primary-hover));
            color: white;
        }
        .accordion-button:focus { box-shadow: 0 0 0 .25rem var(--dark-primary-glow); }
        .accordion-body { background-color: var(--dark-surface); }
        
        .table { --bs-table-hover-bg: rgba(106, 90, 205, 0.15); }
        thead th {
            background-color: var(--dark-surface-secondary);
            font-weight: 600;
            border-bottom: 2px solid var(--dark-primary);
        }
        tbody td { padding: 0.75rem; vertical-align: middle; }
        tbody tr { transition: background-color 0.2s ease; }

        .nav-tabs .nav-link {
            color: var(--dark-text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link.active, .nav-tabs .nav-item.show .nav-link {
            color: var(--dark-primary);
            background-color: transparent;
            border-color: var(--dark-primary);
        }
        .tab-content {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-top: none;
            border-radius: 0 0 0.8rem 0.8rem;
            padding: 1.5rem;
        }

        /* Melhoria de Usabilidade */
        .empty-state {
            text-align: center;
            padding: 2rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: 0.8rem;
            color: var(--dark-text-secondary);
        }
        .empty-state .bi { font-size: 2.5rem; color: var(--dark-primary); margin-bottom: 1rem; }
        
        tr.client-highlight > td {
            background-color: rgba(123, 104, 238, 0.3) !important;
        }
        
        .drop-zone-card.drag-over {
            border: 2px dashed var(--dark-primary);
            animation: glow 1.5s infinite ease-in-out;
        }

        /* --- Responsividade --- */
        @media (max-width: 992px) {
            body { display: flex; flex-direction: column; }
            #sidebar {
                position: relative;
                width: 100%;
                height: auto; /* Alterado de min-height */
                margin-bottom: 1.5rem;
                border-right: none;
                border-bottom: 1px solid var(--dark-border);
            }
            .sidebar-scrollable-content { overflow-y: visible; } /* Desativa a rolagem no mobile */
            #main-content { margin-left: 0; width: 100%; }
        }
        
        /* --- Estilos de Impressão --- */
        @media print {
            body { background-color: #fff; color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-content { margin-left: 0 !important; width: 100% !important; }
            .no-print, #sidebar, .sidebar-step { display: none !important; }
            .container, .card, .accordion-item, .accordion-body, .card-header, .modal-content { background-color: #fff !important; color: #000 !important; border: 1px solid #dee2e6 !important; box-shadow: none !important; }
            button, .status-message, .card-subtitle, .accordion-button.collapsed, .accordion-collapse.collapse, .nav-tabs, .tab-content { display: none !important; }
            .table-responsive { overflow: visible !important; }
            table, th, td { border: 1px solid #dee2e6 !important; color: #000 !important; }
            h1, h2, h3, h4, h5 { color: #000 !important; }
            .accordion-collapse, .tab-pane { display: block !important; padding: 0 !important; }
            .accordion-button { display: block !important; background-color: #f8f9fa !important; color: #000 !important; }
            .bg-warning { background-color: #ffc107 !important; color: black !important; }
            .bg-success, .bg-primary, .bg-danger { color: white !important; }
            .text-danger { color: #dc3545 !important; }
        }
    </style>
</head>
<body>
    
    <div class="d-flex">
        <nav id="sidebar" class="p-3 text-white no-print">
            <div class="sidebar-header d-flex align-items-center mb-3">
                <i class="bi bi-box-seam-fill me-3 fs-1" style="color: var(--dark-primary);"></i>
                <span class="fs-4">Otimizador</span>
            </div>
            
            <div class="sidebar-scrollable-content">
                <hr>
                <div id="sidebar-controls">
                    <div class="sidebar-step">
                        <h6 class="form-label text-uppercase small"><span class="step-number">1</span> Carregar Arquivo</h6>
                        <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="autoProcessCheckbox">
                            <label class="form-check-label small" for="autoProcessCheckbox">Processar ao selecionar</label>
                        </div>
                    </div>

                    <div id="filtro-rota-container" class="sidebar-step" style="display: none;">
                        <h6 class="form-label text-uppercase small"><span class="step-number">2</span> Filtrar Rotas (Opcional)</h6>
                        <div class="mb-2">
                            <select id="rotaInicioSelect" class="form-select form-select-sm">
                                <option value="">Rota de Início...</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <select id="rotaFimSelect" class="form-select form-select-sm">
                                <option value="">Rota de Fim...</option>
                            </select>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-1" onclick="limparFiltroDeRota()">Limpar Filtro</button>
                    </div>

                    <div class="sidebar-step d-grid mt-4">
                        <h6 class="form-label text-uppercase small"><span class="step-number">3</span> Otimizar</h6>
                        <button class="btn btn-primary" id="processarBtn" onclick="processar()" disabled>
                            <i class="bi bi-magic me-2"></i>Processar Cargas
                        </button>
                        <div id="status" class="mt-2 status-message small text-center"></div>
                    </div>
                </div>

                <hr>

                <ul class="nav nav-pills flex-column" id="sidebar-nav">
                    <li class="nav-item mb-1"><a href="#card-resumo-geral-container" class="nav-link"><i class="bi bi-pie-chart-fill me-2 fs-5"></i>Resumo</a></li>
                    <li class="mb-1"><a href="#workspace-card" class="nav-link"><i class="bi bi-tools me-2 fs-5"></i>Mesas de Trabalho</a></li>
                    <li class="mb-1"><a href="#additional-results" class="nav-link"><i class="bi bi-clipboard2-data-fill me-2 fs-5"></i>Resultados Adicionais</a></li>
                </ul>
            </div>
            <div class="d-grid gap-2 mt-auto pt-3 border-top border-secondary">
                <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#configModal"><i class="bi bi-sliders me-2"></i>Configurações & Ações</button>
                <button class="btn btn-outline-danger" id="limparResultadosBtn"><i class="bi bi-eraser-fill me-2"></i>Limpar Tudo</button>
            </div>
        </nav>

        <main id="main-content" class="p-4 p-lg-5">
            
            <h1 class="h2 mb-4 animated-entry">Dashboard de Separação de Cargas</h1>

            <div id="resultado-venda-antecipada" class="mb-4"></div>
            <div id="resultado-carga-especial" class="mb-4"></div>
            
            <div class="card animated-entry mb-4" id="card-resumo-geral-container" style="display: none;">
                <div class="card-header"><i class="bi bi-bar-chart-line-fill me-2"></i>Resumo Geral (Varejo)</div>
                <div class="card-body">
                    <div id="chart-resumo-veiculos"></div>
                </div>
            </div>

            <div class="row" id="workspace-card">
                <div class="col-lg-8 mb-4 animated-entry">
                    <div class="card h-100">
                        <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-tools me-2"></i>Mesa de Trabalho: Montagem de Cargas</h2></div>
                        <div class="card-body p-0">
                             <ul class="nav nav-tabs nav-fill px-3 pt-2" id="vehicleTabs" role="tablist">
                                 <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fiorino-tab-pane"><i class="bi bi-box-seam-fill me-2"></i>Fiorino</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#van-tab-pane"><i class="bi bi-truck-front-fill me-2"></i>Van</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tres-quartos-tab-pane"><i class="bi bi-truck-flatbed me-2"></i>3/4</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cf-tab-pane"><i class="bi bi-truck me-2"></i>Truck/Carreta</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#funcionarios-tab-pane"><i class="bi bi-people-fill me-2"></i>Funcionários</button></li>
                                 <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#transferencias-tab-pane"><i class="bi bi-arrow-left-right me-2"></i>Transferências</button></li>
                             </ul>
                            <div class="tab-content" id="vehicleTabsContent">
                                <div class="tab-pane fade show active workspace-tab-pane" id="fiorino-tab-pane" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota para montar as Fiorinos.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-fiorino-geral', 'Cargas de Fiorino (Varejo)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-fiorino"><div class="empty-state"><i class="bi bi-box"></i><p>Nenhuma rota de Fiorino disponível. Processe um arquivo para começar.</p></div></div>
                                    <hr class="no-print"><div id="resultado-fiorino-geral" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade workspace-tab-pane" id="van-tab-pane" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota para montar as Vans.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-van-geral', 'Cargas de Van (Varejo)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-van"><div class="empty-state"><i class="bi bi-truck-front-fill"></i><p>Nenhuma rota de Van disponível. Processe um arquivo para começar.</p></div></div>
                                    <hr class="no-print"><div id="resultado-van-geral" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade workspace-tab-pane" id="tres-quartos-tab-pane" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                                        <p class="card-subtitle text-body-secondary small mb-0">Selecione uma rota para montar as cargas 3/4.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="imprimirCargasGeneric('resultado-34-geral', 'Cargas de 3/4 (Varejo)')"><i class="bi bi-printer-fill me-1"></i>Imprimir Cargas</button>
                                    </div>
                                    <div class="mb-3 no-print" id="botoes-34"><div class="empty-state"><i class="bi bi-truck-flatbed"></i><p>Nenhuma rota de 3/4 disponível. Processe um arquivo para começar.</p></div></div>
                                    <hr class="no-print"><div id="resultado-34-geral" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade" id="cf-tab-pane" role="tabpanel">
                                    <div id="resultado-cf-accordion-container"><div class="empty-state"><i class="bi bi-truck"></i><p>Nenhum grupo de carga maior encontrado. Processe um arquivo.</p></div></div>
                                </div>
                                <div class="tab-pane fade" id="funcionarios-tab-pane" role="tabpanel">
                                    <div id="resultado-funcionarios-tab"><div class="empty-state"><i class="bi bi-people-fill"></i><p>Nenhum pedido de funcionário encontrado. Processe um arquivo.</p></div></div>
                                </div>
                                <div class="tab-pane fade" id="transferencias-tab-pane" role="tabpanel">
                                    <div id="resultado-transferencias-tab"><div class="empty-state"><i class="bi bi-arrow-left-right"></i><p>Nenhum pedido de transferência encontrado. Processe um arquivo.</p></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4 animated-entry">
                    <div class="card" id="pedidos-disponiveis-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="card-title h5 mb-0"><i class="bi bi-list-check me-2"></i>Pedidos Disponíveis (Varejo)</h2>
                            <div class="no-print"><button class="btn btn-sm btn-outline-danger" onclick="exportarPedidosAtrasados()"><i class="bi bi-file-earmark-excel-fill me-1"></i>Atrasados</button></div>
                        </div>
                       <div class="card-body">
                           <div class="input-group mb-3 no-print"><input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar por Nº do Pedido..."><button class="btn btn-outline-secondary" type="button" onclick="buscarPedido()"><i class="bi bi-search"></i></button></div>
                           <div id="search-result" class="mb-3"></div>
                           <div id="resultado-geral"><div class="empty-state"><i class="bi bi-file-earmark-excel"></i><p>Nenhum pedido de varejo disponível.</p></div></div>
                       </div>
                    </div>
                </div>
            </div>

            <div id="additional-results">
                <hr class="my-5">
                <h3 class="mb-4 animated-entry">Resultados Adicionais da Análise</h3>
                
                <div class="card mb-4 border-danger animated-entry">
                    <div class="card-header bg-danger-subtle text-danger-emphasis"><h2 class="card-title h5 mb-0"><i class="bi bi-slash-circle-fill me-2"></i>Pedidos Bloqueados Manualmente</h2></div>
                    <div class="card-body"><div id="resultado-bloqueados"></div></div>
                </div>

                <div class="card mb-4 border-warning animated-entry">
                    <div class="card-header bg-warning-subtle text-warning-emphasis"><h2 class="card-title h5 mb-0"><i class="bi bi-sign-turn-right-fill me-2"></i>Pedidos da Rota 1 para Alteração</h2></div>
                    <div class="card-body"><div id="resultado-rota1"></div></div>
                </div>

                <div class="card mb-4 animated-entry">
                    <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-inboxes-fill me-2"></i>Cargas "Toco"</h2></div>
                    <div class="card-body"><div id="resultado-toco"></div></div>
                </div>
                                
                <div class="card mb-4 animated-entry">
                    <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-funnel-fill me-2"></i>Pedidos Filtrados (Bloqueio de Varejo por Regra)</h2></div>
                    <div class="card-body"><div id="resultado-cf-numerico"></div></div>
                </div>
            </div>

        </main>
    </div>

    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Configurações & Ações Manuais</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-cpu-fill me-2"></i>Algoritmo de Otimização (Varejo)</h2></div>
                                <div class="card-body">
                                    <label for="optimizationLevelSelect" class="form-label">Nível de Otimização:</label>
                                    <select class="form-select" id="optimizationLevelSelect">
                                        <option value="1">Nível 1: Rápido (Heurística Simples)</option>
                                        <option value="2" selected>Nível 2: Avançado (Padrão)</option>
                                        <option value="3">Nível 3: Exaustivo (Polimento Simples)</option>
                                        <option value="4">Nível 4: Reconstrutivo (Polimento Avançado)</option>
                                    </select>
                                    <div class="form-text mt-3 small">
                                        <p class="mb-1"><strong>Nível 1:</strong> Agrupa por clientes e preenche as cargas de forma sequencial.</p>
                                        <p class="mb-1"><strong>Nível 2:</strong> Testa milhares de combinações para reduzir as sobras, mantendo os grupos.</p>
                                        <p class="mb-1"><strong>Nível 3:</strong> Executa o Nível 2 e depois tenta encaixar sobras trocando grupos entre as cargas.</p>
                                        <p class="mb-0"><strong>Nível 4:</strong> Executa o Nível 3 e depois "desmonta" as piores cargas para tentar reconstruí-las de forma mais eficiente.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                             <div class="card h-100">
                                 <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-slash-circle-fill me-2"></i>Bloqueio Manual</h2></div>
                                 <div class="card-body d-flex flex-column">
                                     <label for="bloquearPedidoInput" class="form-label">Número do Pedido a Bloquear:</label>
                                     <div class="input-group mb-3"><input type="text" class="form-control" id="bloquearPedidoInput" placeholder="Digite o número..."><button class="btn btn-outline-danger" type="button" onclick="bloquearPedido()">Bloquear</button></div>
                                     <label class="form-label mt-2">Pedidos Bloqueados:</label>
                                     <div id="lista-pedidos-bloqueados" class="p-2 border rounded flex-grow-1" style="background-color: var(--dark-bg); min-height: 150px;"><div class="empty-state"><i class="bi bi-shield-slash"></i><p>Nenhum pedido bloqueado.</p></div></div>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-truck me-2"></i>Configurações de Veículos</h2></div>
                        <div class="card-body">
                             <div class="row g-3 mb-3 border-bottom pb-3 border-secondary">
                                 <div class="col-md-12"><strong class="text-success fs-5">Fiorino</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="fiorinoMinCapacity" value="300" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Pref. (kg)</label><input type="number" class="form-control" id="fiorinoMaxCapacity" value="500" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Pref. (m³)</label><input type="number" class="form-control" id="fiorinoCubage" value="1.5" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetFiorino">Reset</button></div>
                                 <div class="col-md-3"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Peso Máx Final (kg)</label><input type="number" class="form-control" id="fiorinoHardMaxCapacity" value="560" step="10"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Cubagem Máx Final (m³)</label><input type="number" class="form-control" id="fiorinoHardCubage" value="1.7" step="0.1"></div>
                             </div>
                            <div class="row g-3 mb-3 border-bottom pb-3 border-secondary">
                                 <div class="col-md-12"><strong class="text-primary fs-5">Van</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="vanMinCapacity" value="1100" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Pref. (kg)</label><input type="number" class="form-control" id="vanMaxCapacity" value="1560" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Pref. (m³)</label><input type="number" class="form-control" id="vanCubage" value="5.0" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetVan">Reset</button></div>
                                 <div class="col-md-3"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Peso Máx Final (kg)</label><input type="number" class="form-control" id="vanHardMaxCapacity" value="1600" step="10"></div>
                                 <div class="col-md-3"><label class="form-label fw-bold">Cubagem Máx Final (m³)</label><input type="number" class="form-control" id="vanHardCubage" value="5.6" step="0.1"></div>
                             </div>
                            <div class="row g-3 mb-3 border-bottom pb-3 border-secondary">
                                 <div class="col-md-12"><strong class="text-warning fs-5">3/4</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="tresQuartosMinCapacity" value="2300" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Máx (kg)</label><input type="number" class="form-control" id="tresQuartosMaxCapacity" value="4100" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Máx (m³)</label><input type="number" class="form-control" id="tresQuartosCubage" value="15.0" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetTresQuartos">Reset</button></div>
                             </div>
                            <div class="row g-3">
                                 <div class="col-md-12"><strong class="fs-5">Toco</strong></div>
                                 <div class="col-md-3"><label class="form-label">Peso Mín (kg)</label><input type="number" class="form-control" id="tocoMinCapacity" value="5000" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Peso Máx (kg)</label><input type="number" class="form-control" id="tocoMaxCapacity" value="8500" step="10"></div>
                                 <div class="col-md-3"><label class="form-label">Cubagem Máx (m³)</label><input type="number" class="form-control" id="tocoCubage" value="30.0" step="0.1"></div>
                                 <div class="col-md-3 d-flex align-items-end"><button class="btn btn-secondary w-100" id="resetToco">Reset</button></div>
                             </div>
                            <div class="mt-4 d-flex justify-content-end"><button class="btn btn-success me-2" id="saveConfig"><i class="bi bi-check-circle-fill me-2"></i>Salvar Tudo</button><button class="btn btn-danger" id="resetAllConfigs"><i class="bi bi-arrow-clockwise me-2"></i>Resetar Tudo</button></div>
                            <div id="configStatus" class="mt-2 status-message text-end"></div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                       <div class="col-lg-6 mb-4 mb-lg-0">
                           <div class="card h-100">
                               <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-scissors me-2"></i>Pedidos Sem Corte</h2></div>
                               <div class="card-body d-flex flex-column">
                                   <label for="semCorteInput" class="form-label">Pedidos a marcar como "Sem Corte":</label>
                                   <div class="input-group mb-3"><textarea class="form-control" id="semCorteInput" rows="3" placeholder="Cole os números aqui..."></textarea><button class="btn btn-outline-warning" type="button" onclick="marcarPedidosSemCorte()">Marcar</button></div>
                                   <label class="form-label mt-2">Pedidos Marcados:</label>
                                   <div id="lista-pedidos-sem-corte" class="p-2 border rounded flex-grow-1" style="background-color: var(--dark-bg); min-height: 100px;"><div class="empty-state"><i class="bi bi-scissors"></i><p>Nenhum pedido marcado.</p></div></div>
                               </div>
                           </div>
                       </div>
                       <div class="col-lg-6 mb-4 mb-lg-0">
                           <div class="card h-100">
                               <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-star-fill me-2"></i>Carga Especial</h2></div>
                               <div class="card-body d-flex flex-column">
                                   <label for="pedidosEspeciaisInput" class="form-label">Números dos Pedidos (um por linha):</label>
                                   <textarea class="form-control flex-grow-1" id="pedidosEspeciaisInput" rows="5" placeholder="Cole os números aqui..."></textarea>
                                   <button class="btn btn-info w-100 mt-3" type="button" onclick="montarCargaPredefinida('pedidosEspeciaisInput', 'resultado-carga-especial', pedidosEspeciaisProcessados, 'Especial')"><i class="bi bi-magic me-2"></i>Montar Carga Especial</button>
                               </div>
                           </div>
                       </div>
                    </div>
                     <div class="row mt-4">
                       <div class="col-lg-6">
                           <div class="card h-100">
                               <div class="card-header"><h2 class="card-title h5 mb-0"><i class="bi bi-cash-coin me-2"></i>Venda Antecipada</h2></div>
                               <div class="card-body d-flex flex-column">
                                   <label for="vendaAntecipadaInput" class="form-label">Pedidos de Venda Antecipada:</label>
                                   <textarea class="form-control flex-grow-1" id="vendaAntecipadaInput" rows="5" placeholder="Cole os números aqui..."></textarea>
                                   <button class="btn btn-success w-100 mt-3" type="button" onclick="montarCargaPredefinida('vendaAntecipadaInput', 'resultado-venda-antecipada', pedidosVendaAntecipadaProcessados, 'Venda Antecipada')"><i class="bi bi-box-seam me-2"></i>Montar Carga Antecipada</button>
                               </div>
                           </div>
                       </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade no-print" id="processing-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
                    <h5 id="processing-status-text" class="mb-2">Otimizando Cargas...</h5>
                    <div class="progress" role="progressbar" style="height: 10px;"><div id="processing-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div></div>
                    <small id="processing-details-text" class="text-muted mt-2 d-block"></small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================================================================================
        //  A LÓGICA DO GRÁFICO FOI ATUALIZADA PARA MELHORAR A VISUALIZAÇÃO DOS NÚMEROS E A ESTÉTICA.
        //  O RESTANTE DO CÓDIGO JAVASCRIPT PERMANECE IDÊNTICO E TOTALMENTE FUNCIONAL.
        // ================================================================================================
        let resumoChart = null;

        function updateAndRenderChart() {
            const vehicleCounts = { fiorino: 0, van: 0, tresQuartos: 0, toco: 0 };
            const vehicleWeights = { fiorino: 0, van: 0, tresQuartos: 0, toco: 0 };

            for (const loadId in activeLoads) {
                const load = activeLoads[loadId];
                if (load.vehicleType === 'fiorino') {
                    vehicleCounts.fiorino++;
                    vehicleWeights.fiorino += load.totalKg;
                } else if (load.vehicleType === 'van') {
                    vehicleCounts.van++;
                    vehicleWeights.van += load.totalKg;
                } else if (load.vehicleType === 'tresQuartos') {
                    vehicleCounts.tresQuartos++;
                    vehicleWeights.tresQuartos += load.totalKg;
                }
            }

            vehicleCounts.toco = Object.keys(gruposToco).length;
            for (const cf in gruposToco) {
                vehicleWeights.toco += gruposToco[cf].totalKg;
            }

            const totalVarejoCount = vehicleCounts.fiorino + vehicleCounts.van + vehicleCounts.tresQuartos + vehicleCounts.toco;
            const totalVarejoWeight = vehicleWeights.fiorino + vehicleWeights.van + vehicleWeights.tresQuartos + vehicleWeights.toco;

            const countSeriesData = [vehicleCounts.fiorino, vehicleCounts.van, vehicleCounts.tresQuartos, vehicleCounts.toco, totalVarejoCount];
            const weightSeriesData = [vehicleWeights.fiorino, vehicleWeights.van, vehicleWeights.tresQuartos, vehicleWeights.toco, totalVarejoWeight];
            const categories = ['Fiorino', 'Van', '3/4', 'Toco', 'Total Varejo'];

            const series = [
                { name: 'Quantidade', type: 'column', data: countSeriesData },
                { name: 'Peso (kg)', type: 'column', data: weightSeriesData }
            ];

            if (resumoChart) {
                resumoChart.updateSeries(series);
            } else {
                const options = {
                    series: series,
                    chart: {
                        height: 350,
                        type: 'line',
                        stacked: false,
                        toolbar: { show: false },
                        foreColor: 'var(--dark-text-secondary)',
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800,
                            animateGradually: {
                                enabled: true,
                                delay: 150
                            },
                            dynamicAnimation: {
                                enabled: true,
                                speed: 350
                            }
                        }
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'dark',
                            type: "vertical",
                            shadeIntensity: 0.5,
                            gradientToColors: undefined,
                            inverseColors: false,
                            opacityFrom: 0.85,
                            opacityTo: 0.95,
                            stops: [0, 100]
                        }
                    },
                    stroke: {
                        width: [0, 0],
                        curve: 'smooth'
                    },
                    plotOptions: {
                        bar: {
                            columnWidth: '60%',
                            borderRadius: 5
                        }
                    },
                    colors: ['#6a5acd', '#00e396'],
                    dataLabels: {
                        enabled: true,
                        formatter: function (val, { seriesIndex }) {
                            if (seriesIndex === 0) { // Quantidade
                                return val.toFixed(0);
                            } else { // Peso
                                if (val >= 1000) {
                                    return (val / 1000).toFixed(1) + 'k';
                                }
                                return val.toFixed(0);
                            }
                        },
                        offsetY: -25,
                        style: {
                            fontSize: '13px',
                            fontWeight: 'bold',
                            colors: ['#fff']
                        },
                        background: {
                          enabled: true,
                          foreColor: '#fff',
                          borderRadius: 3,
                          padding: 5,
                          opacity: 0.7,
                          borderWidth: 1,
                          borderColor: '#666',
                        },
                    },
                    grid: {
                        borderColor: 'var(--dark-border)',
                        strokeDashArray: 4,
                        yaxis: { lines: { show: true } }
                    },
                    xaxis: {
                        categories: categories,
                        labels: { 
                            style: { 
                                fontWeight: 600,
                                fontSize: '13px'
                            } 
                        }
                    },
                    yaxis: [
                        {
                            seriesName: 'Quantidade',
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: '#6a5acd' },
                            labels: {
                                style: { colors: '#6a5acd' },
                                formatter: function (val) {
                                    return val.toFixed(0);
                                }
                            },
                            title: {
                                text: "Quantidade de Veículos",
                                style: { color: '#6a5acd', fontWeight: 600 }
                            },
                        },
                        {
                            seriesName: 'Peso (kg)',
                            opposite: true,
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: '#00e396' },
                            labels: {
                                style: { colors: '#00e396' },
                                formatter: function (val) {
                                    return (val / 1000).toFixed(1) + "k kg";
                                }
                            },
                            title: {
                                text: "Peso Total (kg)",
                                style: { color: '#00e396', fontWeight: 600 }
                            }
                        }
                    ],
                    tooltip: {
                        theme: 'dark',
                        shared: true,
                        intersect: false,
                        y: {
                            formatter: function (val, { seriesIndex }) {
                                if (seriesIndex === 0) { // Quantidade
                                    return val.toFixed(0) + " veículos";
                                } else { // Peso
                                    return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " kg";
                                }
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right',
                        offsetY: -10
                    }
                };

                const chartContainer = document.querySelector("#chart-resumo-veiculos");
                if (chartContainer) {
                    chartContainer.innerHTML = '';
                    resumoChart = new ApexCharts(chartContainer, options);
                    resumoChart.render();
                }
            }

            const container = document.getElementById('card-resumo-geral-container');
            if (container) container.style.display = 'block';
        }
        
        const agendamentoClientCodes = new Set([
            '1398', '1494', '4639', '4872', '5546', '6896', 'D11238', '17163', '19622', '20350', '22545', '23556', '23761', '24465', '29302', '32462', '32831', '32851', '32869', '32905', '33039', '33046', '33047', '33107', '33388', '33392', '33400', '33401', '33403', '33406', '33420', '33494', '33676', '33762', '33818', '33859', '33907', '33971', '34011', '34096', '34167', '34425', '34511', '34810', '34981', '35050', '35054', '35798', '36025', '36580', '36792', '36853', '36945', '37101', '37589', '37634', '38207', '38448', '38482', '38564', '38681', '38735', 'D38896', '39081', '39177', '39620', '40144', '40442', '40702', '40844', '41233', '42200', '42765', '47244', '47253', '47349', '50151', '50816', '51993', '52780', '53134', '58645', '60900', '61182', '61315', '61316', '61317', '61318', '61324', '63080', '63500', '63705', '64288', '66590', '67660', '67884', '69281', '69286', '69318', '70968', '71659', '73847', '76019', '76580', '77475', '77520', '78895', '79838', '80727', '81353', 'DB3183', '83184', '83634', '85534', 'DB6159', '86350', '86641', '89073', '89151', '90373', '92017', '95092', '95660', '96758', '98227', '99268', '100087', '101246', '101253', '101346', '103518', '105394', '106198', '109288', '110023', '110894', '111145', '111154', '111302', '112207', '112670', '117028', '117123', '120423', '120455', '120473', '120533', '121747', '122155', '122785', '123815', '124320', '125228', '126430', '131476', '132397', '133916', '135395', '135928', '136086', '136260', '137919', '138825', '139013', '139329', '139611', '143102', '44192', '144457', '145014', '145237', '145322', '146644', '146988', '148071', '149598', '150503', '151981', '152601', '152835', '152925', '153289', '154423', '154778', '154808', '155177', '155313', '155368', '155419', '155475', '155823', '155888', '156009', '156585', '156696', '157403', '158235', '159168', '160382', '160982', '161737', '162499', '162789', '163234', '163382', '163458', '164721', '164779', '164780', '164924', '165512', '166195', '166337', '166353', '166468', '166469', '167353', '167810', '167819', '168464', '169863', '169971', '170219', '170220', '170516', '171147', '171160', '171191', '171200', '171320', '171529', '171642', '171863', '172270', '172490', '172656', '172859', '173621', '173964', '173977', '174249', '174593', '174662', '174901', '175365', '175425', '175762', '175767', '175783', '176166', '176278', '176453', '176747', '177327', '177488', '177529', '177883', '177951', '177995', '178255', '178377', '178666', '179104', '179510', '179542', '179690', '180028', '180269', '180342', '180427', '180472', '180494', '180594', '180772', '181012', '181052', '181179', '182349', '182885', '182901', '183011', '183016', '183046', '183048', '183069', '183070', '183091', '183093', '183477', '183676', '183787', '184011', '184038', '189677', '190163', '190241', '190687', '190733', '191148', '191149', '191191', '191902', '191972', '192138', '192369', '192638', '192713', '193211', '193445', '193509', '194432', '194508', '194750', '194751', '194821', '194831', '195287', '195338', '195446', '196118', '196405', '196446', '196784', '197168', '197249', '197983', '198187', '198438', '198747', '198796', '198895', '198907', '198908', '199172', '199615', '199625', '199650', '199651', '199713', '199733', '199927', '199991', '200091', '200194', '200239', '200253', '200382', '200404', '200597', '200917', '201294', '201754', '201853', '201936', '201948', '201956', '201958', '201961', '201974', '202022', '202187', '202199', '202714', '203072', '203093', '203201', '203435', '203436', '203451', '203512', '203769', '204895', '204910', '204911', '204913', '204914', '204915', '204917', '204971', '204979', '205108', '205220', '205744', '205803', '206116', '206163', '206208', '206294', '206380', '206628', '206730', '206731', '206994', '207024', '207029', '207403', '207689', '207902', '208489', '208613', '208622', '208741', '208822', '208844', '208853', '208922', '209002', '209004', '209248', '209281', '209321', '209322', '209684', '210124', '210230', '210490', '210747', '210759', '210819', '210852', '211059', '211110', '211276', '211277', '211279', '211332', '211411', '212401', '212417', '212573', '212900', '213188', '213189', '213190', '213202', '213203', '213242', '213442', '213454', '213855', '213909', '213910', '213967', '214046', '214150', '214387', '214433', '214442', '214594', '214746', '215022', '215116', '215160', '215161', '215493', '215494', '215651', '215687', '215733', '215777', '215942', '216112', '216393', '216400', '216630', '216684', '217190', '217283', '217310', '217343', '217545', '217605', '217828', '217871', '217872', '217877', '217949', '217965', '218169', '218196', '218383', '218486', '218578', '218580', '218640', '218820', '218845', '219539', '219698', '219715', '219884', '220158', '220183', '220645', '220950', '221023', '221248', '221251', '222164', '222165', '223025', '223379', '223525', '223703', '223727', '223877', '223899', '223900', '223954', '224956', '224957', '224958', '224959', '224961', '224962', '225112', '225408', '225449', '225904', '226903', '226939', '227190', '227387', '228589', '228693', '228695'
        ]);

        const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO', 'BOM DIA'];
        
        // ================================================================================================
        //  INÍCIO DO SEU CÓDIGO JAVASCRIPT ORIGINAL (COM CORREÇÕES)
        // ================================================================================================

        function deepClone(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }
            if (obj instanceof Date) {
                return new Date(obj.getTime());
            }
            if (Array.isArray(obj)) {
                const arrCopy = [];
                for (let i = 0; i < obj.length; i++) {
                    arrCopy[i] = deepClone(obj[i]);
                }
                return arrCopy;
            }
            const objCopy = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    objCopy[key] = deepClone(obj[key]);
                }
            }
            return objCopy;
        }

        function normalizeClientId(id) {
            if (id === null || typeof id === 'undefined') return '';
            return String(id).trim().replace(/^0+/, '');
        }

        function checkAgendamento(pedido) {
            const normalizedCode = normalizeClientId(pedido.Cliente);
            pedido.Agendamento = agendamentoClientCodes.has(normalizedCode) ? 'Sim' : 'Não';
        }

        const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());
        
        let planilhaData = [];
        let originalColumnHeaders = [];
        let pedidosGeraisAtuais = [];
        let gruposToco = {};
        let gruposPorCFGlobais = {};
        let pedidosComCFNumericoIsolado = [];
        let pedidosManualmenteBloqueadosAtuais = [];
        let pedidosPrioritarios = [];
        let pedidosBloqueados = new Set();
        let pedidosEspeciaisProcessados = new Set();
        let pedidosSemCorte = new Set();
        let pedidosVendaAntecipadaProcessados = new Set();
        let rota1SemCarga = [];
        let pedidosFuncionarios = [];
        let pedidosCarretaSemCF = [];
        let pedidosTransferencias = [];
        let pedidosCondorTruck = [];
        let tocoPedidoIds = new Set();
        let currentLeftoversForPrinting = [];
        let activeLoads = {};
        let manualLoadInProgress = null;

        const defaultConfigs = {
            fiorinoMinCapacity: 300, fiorinoMaxCapacity: 500, fiorinoCubage: 1.5, fiorinoHardMaxCapacity: 560, fiorinoHardCubage: 1.7,
            vanMinCapacity: 1100, vanMaxCapacity: 1560, vanCubage: 5.0, vanHardMaxCapacity: 1600, vanHardCubage: 5.6,
            tresQuartosMinCapacity: 2300, tresQuartosMaxCapacity: 4100, tresQuartosCubage: 15.0,
            tocoMinCapacity: 5000, tocoMaxCapacity: 8500, tocoCubage: 30.0
        };
        
        function saveConfigurations() {
            const configStatus = document.getElementById('configStatus');
            configStatus.innerHTML = '<p class="text-info">Salvando configurações no armazenamento local...</p>';
            try {
                const configs = {};
                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        configs[key] = parseFloat(element.value);
                    }
                });
                localStorage.setItem('vehicleConfigs', JSON.stringify(configs));
                configStatus.innerHTML = '<p class="text-success">Configurações salvas com sucesso!</p>';
                setTimeout(() => { configStatus.innerHTML = ''; }, 3000);
            } catch (error) {
                console.error("Erro ao salvar no localStorage:", error);
                configStatus.innerHTML = `<p class="text-danger">Erro ao salvar as configurações: ${error.message}</p>`;
            }
        }

        function loadConfigurations() {
            const configStatus = document.getElementById('configStatus');
            configStatus.innerHTML = '<p class="text-info">Carregando configurações...</p>';
            try {
                const savedConfigs = localStorage.getItem('vehicleConfigs');
                const configs = savedConfigs ? JSON.parse(savedConfigs) : defaultConfigs;

                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = configs[key] !== undefined ? configs[key] : defaultConfigs[key];
                    }
                });
                configStatus.innerHTML = '<p class="text-success">Configurações carregadas!</p>';
                setTimeout(() => { configStatus.innerHTML = ''; }, 2000);
            } catch (error) {
                console.error("Erro ao carregar do localStorage:", error);
                configStatus.innerHTML = `<p class="text-warning">Não foi possível carregar configurações. Usando valores padrão.</p>`;
                Object.keys(defaultConfigs).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) { element.value = defaultConfigs[key]; }
                });
            }
        }
        
        function resetFiorino() {
            document.getElementById('fiorinoMinCapacity').value = defaultConfigs.fiorinoMinCapacity;
            document.getElementById('fiorinoMaxCapacity').value = defaultConfigs.fiorinoMaxCapacity;
            document.getElementById('fiorinoCubage').value = defaultConfigs.fiorinoCubage;
            document.getElementById('fiorinoHardMaxCapacity').value = defaultConfigs.fiorinoHardMaxCapacity;
            document.getElementById('fiorinoHardCubage').value = defaultConfigs.fiorinoHardCubage;
            saveConfigurations();
        }
        function resetVan() {
            document.getElementById('vanMinCapacity').value = defaultConfigs.vanMinCapacity;
            document.getElementById('vanMaxCapacity').value = defaultConfigs.vanMaxCapacity;
            document.getElementById('vanCubage').value = defaultConfigs.vanCubage;
            document.getElementById('vanHardMaxCapacity').value = defaultConfigs.vanHardMaxCapacity;
            document.getElementById('vanHardCubage').value = defaultConfigs.vanHardCubage;
            saveConfigurations();
        }
        function resetTresQuartos() {
            document.getElementById('tresQuartosMinCapacity').value = defaultConfigs.tresQuartosMinCapacity;
            document.getElementById('tresQuartosMaxCapacity').value = defaultConfigs.tresQuartosMaxCapacity;
            document.getElementById('tresQuartosCubage').value = defaultConfigs.tresQuartosCubage;
            saveConfigurations();
        }
        function resetToco() {
            document.getElementById('tocoMinCapacity').value = defaultConfigs.tocoMinCapacity;
            document.getElementById('tocoMaxCapacity').value = defaultConfigs.tocoMaxCapacity;
            document.getElementById('tocoCubage').value = defaultConfigs.tocoCubage;
            saveConfigurations();
        }
        function resetAll() {
            Object.keys(defaultConfigs).forEach(key => { 
                const element = document.getElementById(key);
                if(element) element.value = defaultConfigs[key]; 
            });
            saveConfigurations();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadConfigurations(); 
            } catch (e) {
                console.error("Falha crítica ao carregar configurações, listeners ainda serão ativados.", e);
            }

            document.getElementById('saveConfig').addEventListener('click', saveConfigurations);
            document.getElementById('resetFiorino').addEventListener('click', resetFiorino);
            document.getElementById('resetVan').addEventListener('click', resetVan);
            document.getElementById('resetTresQuartos').addEventListener('click', resetTresQuartos);
            document.getElementById('resetToco').addEventListener('click', resetToco);
            document.getElementById('resetAllConfigs').addEventListener('click', resetAll);
            document.getElementById('limparResultadosBtn').addEventListener('click', limparTudo);

            document.querySelectorAll('#sidebar-nav a').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector('#sidebar-nav a.active')?.classList.remove('active');
                    this.classList.add('active');
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });

        const rotaVeiculoMap = {
            '11101': { type: 'fiorino', title: 'Rota 11101' }, '11301': { type: 'fiorino', title: 'Rota 11301' }, '11311': { type: 'fiorino', title: 'Rota 11311' }, '11561': { type: 'fiorino', title: 'Rota 11561' }, '11721': { type: 'fiorino', title: 'Rotas 11721 & 11731', combined: ['11731'] }, '11731': { type: 'fiorino', title: 'Rotas 11721 & 11731', combined: ['11721'] },
            '11102': { type: 'van', title: 'Rota 11102' }, '11331': { type: 'van', title: 'Rota 11331' }, '11341': { type: 'van', title: 'Rota 11341' }, '11342': { type: 'van', title: 'Rota 11342' }, '11351': { type: 'van', title: 'Rota 11351' }, '11521': { type: 'van', title: 'Rota 11521' }, '11531': { type: 'van', title: 'Rota 11531' }, '11551': { type: 'van', title: 'Rota 11551' }, '11571': { type: 'van', title: 'Rota 11571' }, '11701': { type: 'van', title: 'Rota 11701' }, '11711': { type: 'van', title: 'Rota 11711' },
            '11361': { type: 'tresQuartos', title: 'Rota 11361' }, '11501': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11502', '11511'] }, '11502': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11501', '11511'] }, '11511': { type: 'tresQuartos', title: 'Rotas 11501, 11502 & 11511', combined: ['11501', '11502'] }, '11541': { type: 'tresQuartos', title: 'Rota 11541' }
        };
        
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');
        const isNumeric = (str) => str && /^\d+$/.test(String(str).trim());

        fileInput.addEventListener('change', (event) => { handleFile(event.target.files[0]); });

        function handleFile(file) {
            if (!file) return;
            limparTudo();
            statusDiv.innerHTML = '<p class="text-info">Carregando planilha...</p>';
            processarBtn.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates:true});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    let headerRowIndex = -1;
                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && row.some(cell => String(cell).trim().toLowerCase() === 'cod_rota')) {
                            headerRowIndex = i;
                            originalColumnHeaders = row.map(h => h ? String(h).trim() : '');
                            break;
                        }
                    }

                    if (headerRowIndex === -1) throw new Error("Não foi possível encontrar a linha de cabeçalho com 'Cod_Rota'. Verifique o arquivo.");
                    
                    const dataRows = rawData.slice(headerRowIndex + 1);
                    planilhaData = dataRows.map(row => { 
                        const pedido = {}; 
                        originalColumnHeaders.forEach((header, i) => { 
                            if (header) { 
                                if ((header.toLowerCase() === 'predat' || header.toLowerCase() === 'dat_ped')) {
                                    let cellValue = row[i];
                                    if (typeof cellValue === 'number') {
                                        const date = new Date(Math.round((cellValue - 25569) * 86400 * 1000));
                                        if (!isNaN(date.getTime())) {
                                            pedido[header] = date;
                                        } else {
                                            pedido[header] = '';
                                        }
                                    } else if (cellValue instanceof Date) {
                                       if (!isNaN(cellValue.getTime())) {
                                           pedido[header] = cellValue;
                                       } else {
                                           pedido[header] = '';
                                       }
                                    } else {
                                        pedido[header] = cellValue !== undefined ? cellValue : '';
                                    }
                                } else {
                                    pedido[header] = row[i] !== undefined ? row[i] : ''; 
                                }
                            } 
                        }); 
                        pedido.Quilos_Saldo = parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0;
                        pedido.Cubagem = parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0;
                        return pedido; 
                    });
                    planilhaData.forEach(checkAgendamento);
                    statusDiv.innerHTML = `<p class="text-success">Planilha "${file.name}" carregada.</p>`;
                    processarBtn.disabled = false;
                    
                    popularFiltrosDeRota();

                    if (document.getElementById('autoProcessCheckbox').checked) {
                        processar();
                    }

                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Erro:</strong> ${error.message}</p>`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function popularFiltrosDeRota() {
            const container = document.getElementById('filtro-rota-container');
            const rotaInicioSelect = document.getElementById('rotaInicioSelect');
            const rotaFimSelect = document.getElementById('rotaFimSelect');

            rotaInicioSelect.innerHTML = '<option value="">Rota de Início...</option>';
            rotaFimSelect.innerHTML = '<option value="">Rota de Fim...</option>';

            if (planilhaData.length === 0) {
                container.style.display = 'none';
                return;
            }

            const rotas = [...new Set(planilhaData.map(p => String(p.Cod_Rota || ''))) ].filter(Boolean);
            rotas.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

            rotas.forEach(rota => {
                rotaInicioSelect.innerHTML += `<option value="${rota}">${rota}</option>`;
                rotaFimSelect.innerHTML += `<option value="${rota}">${rota}</option>`;
            });

            container.style.display = 'block';
        }

        function limparFiltroDeRota() {
            document.getElementById('rotaInicioSelect').selectedIndex = 0;
            document.getElementById('rotaFimSelect').selectedIndex = 0;
        }


        function buscarPedido() {
            const searchInput = document.getElementById('pedidoSearchInput').value.trim();
            const searchResultDiv = document.getElementById('search-result');
            searchResultDiv.innerHTML = '';
            if (!searchInput) return;
            if (planilhaData.length === 0) { searchResultDiv.innerHTML = '<p class="text-warning">Por favor, carregue e processe a planilha primeiro.</p>'; return; }
            let pedidoEncontrado = null; let local = 'Não encontrado'; let accordionId = '';
            
            if (currentLeftoversForPrinting.length > 0) {
                 pedidoEncontrado = currentLeftoversForPrinting.find(p => String(p.Num_Pedido) === searchInput);
                 if (pedidoEncontrado) local = 'Sobras Finais (na Mesa de Trabalho)';
            }
            if (!pedidoEncontrado) {
                for (const loadId in activeLoads) {
                    const load = activeLoads[loadId];
                    pedidoEncontrado = load.pedidos.find(p => String(p.Num_Pedido) === searchInput);
                    if (pedidoEncontrado) {
                        local = `Carga #${load.numero || loadId.split('-')[1]} (${load.vehicleType})`;
                        break;
                    }
                }
            }
            if (!pedidoEncontrado) {
                pedidoEncontrado = pedidosManualmenteBloqueadosAtuais.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Bloqueado Manualmente'; }
            }
            if (!pedidoEncontrado) {
                pedidoEncontrado = pedidosGeraisAtuais.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos Disponíveis (Varejo)'; accordionId = 'accordionGeral'; } 
            }
            if (!pedidoEncontrado) {
                pedidoEncontrado = pedidosComCFNumericoIsolado.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos Filtrados (Bloqueio de Varejo)'; accordionId = 'accordionCF'; }
            }
            if (!pedidoEncontrado) {
                for (const cf in gruposToco) {
                    pedidoEncontrado = gruposToco[cf].pedidos.find(p => String(p.Num_Pedido) === searchInput);
                    if (pedidoEncontrado) { local = `Cargas "Toco" (CF: ${cf})`; accordionId = 'accordionToco'; break; }
                }
            }
             if (!pedidoEncontrado) {
                for (const cf in gruposPorCFGlobais) {
                    pedidoEncontrado = gruposPorCFGlobais[cf].pedidos.find(p => String(p.Num_Pedido) === searchInput);
                    if (pedidoEncontrado) { local = `Cargas Truck e Carreta (${cf})`; accordionId = 'accordionCargasPorCF'; break; }
                }
            }
            if (!pedidoEncontrado) {
                pedidoEncontrado = rota1SemCarga.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos da Rota 1 para Alteração'; }
            }
             if (!pedidoEncontrado) {
                pedidoEncontrado = pedidosFuncionarios.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos de Funcionários'; accordionId = 'accordionFuncionarios';}
            }
             if (!pedidoEncontrado) {
                pedidoEncontrado = pedidosTransferencias.find(p => String(p.Num_Pedido) === searchInput);
                if (pedidoEncontrado) { local = 'Pedidos de Transferência'; accordionId = 'accordionTransferencias'; }
            }
             if (!pedidoEncontrado) {
                  const originalPedido = planilhaData.find(p => String(p.Num_Pedido) === searchInput);
                  if (originalPedido) {
                          pedidoEncontrado = originalPedido;
                          if(pedidosBloqueados.has(String(originalPedido.Num_Pedido))) {
                                local = 'Bloqueado Manualmente por você.';
                          } else if (pedidosEspeciaisProcessados.has(String(originalPedido.Num_Pedido))) {
                              local = 'Alocado na Carga Especial.';
                          } else if (pedidosVendaAntecipadaProcessados.has(String(originalPedido.Num_Pedido))) {
                              local = 'Alocado na Carga de Venda Antecipada.';
                          }
                          else {
                               local = 'Encontrado na planilha original, mas foi filtrado por alguma regra.';
                          }
                  }
             }

            if (pedidoEncontrado) {
                let buttons = '';
                if (local.startsWith('Pedidos Disponíveis') || local.startsWith('Sobras')) {
                    const isPrioritized = pedidosPrioritarios.includes(String(pedidoEncontrado.Num_Pedido));
                    buttons = `<button class="btn btn-primary btn-sm" onclick="priorizarPedido('${pedidoEncontrado.Num_Pedido}')" ${isPrioritized ? 'disabled' : ''}>${isPrioritized ? 'Prioridade Marcada' : 'Marcar como Prioridade'}</button>
                                     <button class="btn btn-secondary btn-sm ms-2" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`;
                } else if (accordionId || local.startsWith('Carga')) { 
                    buttons = `<button class="btn btn-secondary btn-sm" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`;
                }
                searchResultDiv.innerHTML = `<div class="alert alert-info"><h5>Pedido ${searchInput} encontrado!</h5><p class="mb-1"><strong>Local:</strong> ${local}</p><p class="mb-1"><strong>Cliente:</strong> ${pedidoEncontrado.Nome_Cliente}<br><strong>Peso:</strong> ${pedidoEncontrado.Quilos_Saldo} kg</p>${buttons ? `<div class="mt-2">${buttons}</div>` : ''}</div>`;
            } else { searchResultDiv.innerHTML = '<p class="text-danger">Pedido não encontrado em nenhuma das listas.</p>'; }
        }

        function priorizarPedido(numPedido) { if (!pedidosPrioritarios.includes(String(numPedido))) { pedidosPrioritarios.push(String(numPedido)); buscarPedido(); } }

        function highlightPedido(numPedido) {
            document.querySelectorAll('tr.table-info').forEach(r => r.classList.remove('table-info'));
            const row = document.getElementById(`pedido-${numPedido}`);
            if (row) {
                row.classList.add('table-info');
                const collapseEl = row.closest('.accordion-collapse');
                if (collapseEl && !collapseEl.classList.contains('show')) { 
                    bootstrap.Collapse.getOrCreateInstance(collapseEl).show(); 
                }
                setTimeout(() => { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 350);
            }
        }
        
        function atualizarListaBloqueados() {
            const divLista = document.getElementById('lista-pedidos-bloqueados');
            divLista.innerHTML = '';
            if (pedidosBloqueados.size === 0) {
                divLista.innerHTML = '<div class="empty-state"><i class="bi bi-shield-slash"></i><p>Nenhum pedido bloqueado.</p></div>';
                return;
            }
            
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            pedidosBloqueados.forEach(numPedido => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center py-1 bg-transparent';
                item.innerHTML = `<span>${numPedido}</span> <button class="btn btn-sm btn-outline-secondary" onclick="desbloquearPedido('${numPedido}')">Desbloquear</button>`;
                list.appendChild(item);
            });
            divLista.appendChild(list);
        }

        function bloquearPedido() {
            const input = document.getElementById('bloquearPedidoInput');
            const numPedido = input.value.trim();
            if (numPedido) {
                pedidosBloqueados.add(numPedido);
                input.value = '';
                atualizarListaBloqueados();
            }
        }

        function desbloquearPedido(numPedido) {
            pedidosBloqueados.delete(numPedido);
            atualizarListaBloqueados();
        }

        function atualizarListaSemCorte() {
            const divLista = document.getElementById('lista-pedidos-sem-corte');
            divLista.innerHTML = '';
            if (pedidosSemCorte.size === 0) {
                divLista.innerHTML = '<div class="empty-state"><i class="bi bi-scissors"></i><p>Nenhum pedido marcado.</p></div>';
                return;
            }
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            pedidosSemCorte.forEach(numPedido => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center py-1 bg-transparent';
                item.innerHTML = `<span>${numPedido}</span> <button class="btn btn-sm btn-outline-secondary" onclick="removerMarcacaoSemCorte('${numPedido}')">Remover</button>`;
                list.appendChild(item);
            });
            divLista.appendChild(list);
        }

        function marcarPedidosSemCorte() {
            const input = document.getElementById('semCorteInput');
            const numeros = input.value.split('\n').map(n => n.trim()).filter(Boolean);
            numeros.forEach(num => pedidosSemCorte.add(num));
            input.value = '';
            atualizarListaSemCorte();
        }

        function removerMarcacaoSemCorte(numPedido) {
            pedidosSemCorte.delete(numPedido);
            atualizarListaSemCorte();
        }

        function resetarEstadoGlobal() {
        // CORREÇÃO INICIADA: Preservar cargas manuais durante o reprocessamento
        const predefinedLoads = {};
        for (const key in activeLoads) {
            // Mantém cargas que foram criadas manualmente ou de forma pré-definida
            if (key.startsWith('especial') || key.startsWith('venda-antecipada') || key.startsWith('manual-')) {
                predefinedLoads[key] = activeLoads[key];
            }
        }
        
            pedidosGeraisAtuais = [];
            gruposToco = {};
            gruposPorCFGlobais = {};
            pedidosComCFNumericoIsolado = [];
            rota1SemCarga = [];
            pedidosFuncionarios = [];
            pedidosCarretaSemCF = [];
            pedidosTransferencias = [];
            pedidosCondorTruck = [];
            pedidosManualmenteBloqueadosAtuais = [];
            pedidosPrioritarios = [];
            tocoPedidoIds.clear();
            currentLeftoversForPrinting = [];
            activeLoads = predefinedLoads; // Restaura as cargas manuais em vez de apagar tudo
        }

        function limparTudo(){
            resetarEstadoGlobal();
            originalColumnHeaders = []; 

            pedidosEspeciaisProcessados.clear();
            pedidosBloqueados.clear();
            pedidosSemCorte.clear();
            pedidosVendaAntecipadaProcessados.clear();
            activeLoads = {}; // Limpa completamente ao clicar em "Limpar Tudo"
            
            const idsParaLimpar = [
                'resultado-venda-antecipada', 'resultado-carga-especial', 'resultado-bloqueados', 'resultado-geral', 
                'resultado-fiorino-geral', 'resultado-van-geral', 'resultado-34-geral',
                'resultado-rota1', 'resultado-toco', 
                'resultado-cf-accordion-container', 'resultado-cf-numerico', 'search-result', 
                'resultado-funcionarios-tab', 'resultado-transferencias-tab'
            ];
            const emptyStateMessages = {
                'resultado-geral': '<div class="empty-state"><i class="bi bi-file-earmark-excel"></i><p>Nenhum pedido de varejo disponível.</p></div>',
                'botoes-fiorino': '<div class="empty-state"><i class="bi bi-box"></i><p>Nenhuma rota de Fiorino disponível. Processe um arquivo para começar.</p></div>',
                'botoes-van': '<div class="empty-state"><i class="bi bi-truck-front-fill"></i><p>Nenhuma rota de Van disponível. Processe um arquivo para começar.</p></div>',
                'botoes-34': '<div class="empty-state"><i class="bi bi-truck-flatbed"></i><p>Nenhuma rota de 3/4 disponível. Processe um arquivo para começar.</p></div>'
            };

            idsParaLimpar.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = '';
            });
            Object.keys(emptyStateMessages).forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = emptyStateMessages[id];
            });

            if (resumoChart) {
                resumoChart.destroy();
                resumoChart = null;
            }
            document.getElementById('card-resumo-geral-container').style.display = 'none';
            document.getElementById('filtro-rota-container').style.display = 'none';

            document.getElementById('pedidosEspeciaisInput').value = '';
            document.getElementById('bloquearPedidoInput').value = '';
            document.getElementById('pedidoSearchInput').value = '';
            document.getElementById('semCorteInput').value = '';
            document.getElementById('vendaAntecipadaInput').value = '';
            atualizarListaBloqueados();
            atualizarListaSemCorte();
            limparFiltroDeRota();
            
            fileInput.value = '';
            planilhaData = [];
            processarBtn.disabled = true;
            statusDiv.innerHTML = '';
        }

        function processar() {
            statusDiv.innerHTML = '<div class="d-flex align-items-center justify-content-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div><span class="text-primary">Processando...</span></div>';
            processarBtn.disabled = true;
            
            setTimeout(() => {
                const resultadoGeralDiv = document.getElementById('resultado-geral');
                const resultadoTocoDiv = document.getElementById('resultado-toco');
                const resultadoCfNumericoDiv = document.getElementById('resultado-cf-numerico');
                const resultadoRota1Div = document.getElementById('resultado-rota1');
                const resultadoBloqueadosDiv = document.getElementById('resultado-bloqueados');
                const resultadoCfAccordionDiv = document.getElementById('resultado-cf-accordion-container');
                const resultadoFuncionariosDiv = document.getElementById('resultado-funcionarios-tab');
                const resultadoTransferenciasDiv = document.getElementById('resultado-transferencias-tab');
                
                try {
                    if (planilhaData.length === 0) { throw new Error("Nenhum dado de planilha carregado."); }
                    
                    resetarEstadoGlobal();

                    const rotaInicio = document.getElementById('rotaInicioSelect').value;
                    const rotaFim = document.getElementById('rotaFimSelect').value;
                    let dadosParaProcessar = [...planilhaData];

                    if (rotaInicio && rotaFim) {
                        dadosParaProcessar = planilhaData.filter(p => {
                            const rotaPedido = String(p.Cod_Rota || '');
                            return rotaPedido.localeCompare(rotaInicio, undefined, { numeric: true }) >= 0 &&
                                   rotaPedido.localeCompare(rotaFim, undefined, { numeric: true }) <= 0;
                        });
                        statusDiv.innerHTML = `<p class="text-info">Processando ${dadosParaProcessar.length} pedidos entre as rotas ${rotaInicio} e ${rotaFim}...</p>`;
                    }
                    
                    [
                        'resultado-fiorino-geral', 'resultado-van-geral', 'resultado-34-geral', 'resultado-geral', 
                        'resultado-toco', 'resultado-cf-accordion-container', 'resultado-cf-numerico', 
                        'resultado-rota1', 'resultado-bloqueados', 'resultado-funcionarios-tab', 'resultado-transferencias-tab'
                    ].forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.innerHTML = '';
                    });
                    
                    const pedidosExcluidos = new Set();
                    dadosParaProcessar.forEach(p => {
                        const coluna5 = String(p.Coluna5 || '').toUpperCase();
                        if(coluna5.includes('TBL FUNCIONARIO')) {
                            pedidosFuncionarios.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('TBL ESP CARRETA') && !isNumeric(p.CF)) {
                            pedidosCarretaSemCF.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('TRANSF. TODESCH')) {
                            pedidosTransferencias.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
                        } else if (coluna5.includes('CONDOR (TRUCK)') || coluna5.includes('CONDOR TOD TRUC')) {
                            pedidosCondorTruck.push(p);
                            pedidosExcluidos.add(p.Num_Pedido);
