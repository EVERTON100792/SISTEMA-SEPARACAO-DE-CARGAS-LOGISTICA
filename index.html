<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separa√ß√£o de Cargas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ... (todo o seu CSS continua o mesmo) ... */
        body {
            background-color: #212529;
        }
        .card {
            background-color: #2b3035;
            border: 1px solid #495057;
        }
        .accordion-button {
            background-color: #343a40;
            color: #f8f9fa;
        }
        .accordion-button:not(.collapsed) {
            background-color: #0d6efd;
            color: white;
        }
        .accordion-body {
            background-color: #2b3035;
        }
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: var(--bs-table-striped-bg);
        }
        .status-message {
            min-height: 24px; /* Prevent layout shift */
        }

        .btn-success, .btn-primary, .btn-warning {
            transition: all 0.2s ease-in-out;
        }

        .btn-success:hover, .btn-primary:hover, .btn-warning:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        @media print {
            body {
                background-color: #fff; /* White background for printing */
                color: #000; /* Black text for printing */
            }
            .container, .card, .accordion-item, .accordion-body {
                background-color: #fff !important;
                color: #000 !important;
                border: none !important;
                box-shadow: none !important;
            }
            /* Hide elements not relevant for printing */
            .no-print,
            .d-flex.align-items-center.mb-3, /* Title and truck icon */
            .card.p-3.mb-4.shadow-sm, /* Input form */
            button, /* All buttons */
            .status-message, /* Status messages */
            .card-subtitle, /* Subtitles */
            .accordion-button.collapsed, /* Collapsed accordion buttons */
            .accordion-collapse.collapse { /* Collapsed accordion content */
                display: none !important;
            }
            /* Ensure tables are visible and well-formatted */
            .table-responsive {
                overflow: visible !important;
            }
            table, th, td {
                border: 1px solid #dee2e6 !important;
                color: #000 !important;
            }
            h1, h2, h3, h4, h5 {
                color: #000 !important;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            /* Ensure all accordion content is visible when printing */
            .accordion-collapse {
                display: block !important;
            }
            .accordion-button {
                display: block !important; /* Make accordion headers visible */
                background-color: #f8f9fa !important; /* Light background for headers */
                color: #000 !important;
                border: 1px solid #dee2e6 !important;
                margin-bottom: 0.5rem;
            }
            .accordion-button strong, .accordion-button .badge {
                color: #000 !important;
            }
        }
        #drop-zone-text {
            border: 2px dashed #495057;
            border-radius: .25rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        #drop-zone.border-primary #drop-zone-text {
            border-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-4">
        <div class="d-flex align-items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-truck me-3" viewBox="0 0 16 16"><path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-4 0a1 1 0 0 1-1-1V3.5ZM1.5 3a.5.5 0 0 0-.5.5V11h.5a1 1 0 0 1 1 1 1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V3.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v.364c-.606.252-1.134.63-1.562 1.136l-1.48-1.85A.5.5 0 0 0 9.02 3H1.5Zm3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm9 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/></svg>
            <h1 class="mb-0">Dashboard de Separa√ß√£o de Cargas</h1>
        </div>

        <div class="card p-3 mb-4 shadow-sm no-print" id="drop-zone">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold">1. Arraste e solte a planilha ou clique para selecionar:</label>
                    <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display: none;">
                    <div id="drop-zone-text" class="text-center p-5 border-2 border-dashed rounded-3">
                        <p>Arraste e solte o arquivo aqui</p>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Selecionar Arquivo</button>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Defina a Faixa de Rotas (Opcional):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="rotaInicialInput" placeholder="Rota Inicial">
                        <input type="text" class="form-control" id="rotaFinalInput" placeholder="Rota Final">
                    </div>
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100" id="processarBtn" onclick="processar()" disabled>3. Processar Cargas</button>
                </div>
            </div>
            <div id="status" class="mt-2 status-message"></div>
        </div>

        <div class="card p-3 mb-4 shadow-sm no-print">
            <h2 class="card-title h5">Configura√ß√µes de Ve√≠culos</h2>
            <p class="card-subtitle mb-3 text-body-secondary small">Defina as capacidades de peso e cubagem para cada tipo de ve√≠culo. Suas configura√ß√µes ser√£o salvas automaticamente.</p>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="fiorinoMaxCapacity" class="form-label">Fiorino - Peso M√°x (kg)</label>
                    <input type="number" class="form-control config-input" id="fiorinoMaxCapacity" value="570" step="10">
                </div>
                <div class="col-md-3">
                    <label for="fiorinoMinCapacity" class="form-label">Fiorino - Peso M√≠n (kg)</label>
                    <input type="number" class="form-control config-input" id="fiorinoMinCapacity" value="330" step="10">
                </div>
                <div class="col-md-3">
                    <label for="fiorinoCubage" class="form-label">Fiorino - Cubagem M√°x (m¬≥)</label>
                    <input type="number" class="form-control config-input" id="fiorinoCubage" value="1.5" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetFiorino">Reset Fiorino</button>
                </div>

                <div class="col-md-3">
                    <label for="vanMaxCapacity" class="form-label">Van - Peso M√°x (kg)</label>
                    <input type="number" class="form-control config-input" id="vanMaxCapacity" value="1560" step="10">
                </div>
                <div class="col-md-3">
                    <label for="vanMinCapacity" class="form-label">Van - Peso M√≠n (kg)</label>
                    <input type="number" class="form-control config-input" id="vanMinCapacity" value="1100" step="10">
                </div>
                <div class="col-md-3">
                    <label for="vanCubage" class="form-label">Van - Cubagem M√°x (m¬≥)</label>
                    <input type="number" class="form-control config-input" id="vanCubage" value="5.0" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetVan">Reset Van</button>
                </div>

                <div class="col-md-3">
                    <label for="tresQuartosMaxCapacity" class="form-label">3/4 - Peso M√°x (kg)</label>
                    <input type="number" class="form-control config-input" id="tresQuartosMaxCapacity" value="4100" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tresQuartosMinCapacity" class="form-label">3/4 - Peso M√≠n (kg)</label>
                    <input type="number" class="form-control config-input" id="tresQuartosMinCapacity" value="2300" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tresQuartosCubage" class="form-label">3/4 - Cubagem M√°x (m¬≥)</label>
                    <input type="number" class="form-control config-input" id="tresQuartosCubage" value="15.0" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetTresQuartos">Reset 3/4</button>
                </div>

                <div class="col-md-3">
                    <label for="tocoMaxCapacity" class="form-label">Toco - Peso M√°x (kg)</label>
                    <input type="number" class="form-control config-input" id="tocoMaxCapacity" value="8500" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tocoMinCapacity" class="form-label">Toco - Peso M√≠n (kg)</label>
                    <input type="number" class="form-control config-input" id="tocoMinCapacity" value="5000" step="10">
                </div>
                <div class="col-md-3">
                    <label for="tocoCubage" class="form-label">Toco - Cubagem M√°x (m¬≥)</label>
                    <input type="number" class="form-control config-input" id="tocoCubage" value="30.0" step="0.1">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="resetToco">Reset Toco</button>
                </div>
            </div>
            <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-success me-2" id="saveConfig">Salvar Configura√ß√µes</button>
                <button class="btn btn-danger" id="resetAllConfigs">Resetar Todas</button>
            </div>
             <div id="configStatus" class="mt-2 status-message"></div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                             <h2 class="card-title h5">Resultados Gerais</h2>
                             <button class="btn btn-sm btn-outline-light no-print" onclick="window.print()">üñ®Ô∏è Imprimir Tudo</button>
                        </div>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos que n√£o s√£o 'Toco', agrupados por rota.</p>
                        <div class="input-group mb-3 no-print">
                            <input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar por N¬∫ do Pedido...">
                            <button class="btn btn-outline-secondary" type="button" onclick="buscarPedido()">Buscar</button>
                        </div>
                        <div id="search-result" class="mb-3"></div>
                        <div id="resultado-geral"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separa√ß√£o de Cargas (Fiorino)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Fiorino para separar as cargas.</p>
                        
                        <div class="no-print">
                            <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11101', 'resultado-fiorino-geral', 'Rota 11101')">Rota 11101</button>
                            <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11301', 'resultado-fiorino-geral', 'Rota 11301')">Rota 11301</button>
                            <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11311', 'resultado-fiorino-geral', 'Rota 11311')">Rota 11311</button>
                            <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11561', 'resultado-fiorino-geral', 'Rota 11561')">Rota 11561</button>
                            <button class="btn btn-success mt-2" onclick="separarCargasFiorino(['11721', '11731'], 'resultado-fiorino-geral', 'Rotas 11721 & 11731')">Rotas 11721 & 11731</button>
                        </div>
                        
                        <div id="resultado-fiorino-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separa√ß√£o de Cargas (Van)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Van para separar as cargas.</p>
                        <div class="no-print">
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11102', 'resultado-van-geral', 'Rota 11102')">Rota 11102</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11331', 'resultado-van-geral', 'Rota 11331')">Rota 11331</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11341', 'resultado-van-geral', 'Rota 11341')">Rota 11341</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11342', 'resultado-van-geral', 'Rota 11342')">Rota 11342</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11351', 'resultado-van-geral', 'Rota 11351')">Rota 11351</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11521', 'resultado-van-geral', 'Rota 11521')">Rota 11521</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11531', 'resultado-van-geral', 'Rota 11531')">Rota 11531</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11551', 'resultado-van-geral', 'Rota 11551')">Rota 11551</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11571', 'resultado-van-geral', 'Rota 11571')">Rota 11571</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11701', 'resultado-van-geral', 'Rota 11701')">Rota 11701</button>
                            <button class="btn btn-primary mt-2" onclick="separarCargasVan('11711', 'resultado-van-geral', 'Rota 11711')">Rota 11711</button>
                        </div>
                        <div id="resultado-van-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separa√ß√£o de Cargas (3/4)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de 3/4 para separar as cargas.</p>
                        <div class="no-print">
                            <button class="btn btn-warning mt-2" onclick="separarCargas34('11361', 'resultado-34-geral', 'Rota 11361')">Rota 11361</button>
                            <button class="btn btn-warning mt-2" onclick="separarCargas34(['11501', '11502', '11511'], 'resultado-34-geral', 'Rotas 11501, 11502 & 11511')">Rotas 11501, 11502 & 11511</button>
                            <button class="btn btn-warning mt-2" onclick="separarCargas34('11541', 'resultado-34-geral', 'Rota 11541')">Rota 11541</button>
                        </div>
                        <div id="resultado-34-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados Cargas 3/4 (Autom√°tico)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Cargas formadas a partir de um pedido muito grande.</p>
                        <div id="resultado-tres-quartos"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados das Cargas "Toco"</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Grupos de cargas onde a Coluna4/5 cont√©m "TOCO" e o CF se repete.</p>
                        <div id="resultado-toco"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        // *** IN√çCIO DA NOVA L√ìGICA DE C√ÅLCULO DE DIST√ÇNCIA 100% GRATUITA ***
        let CargasFiorinoFinalizadas = new Map();

        // MATRIZ DE DIST√ÇNCIAS ATUALIZADA COM 28 CIDADES
        const matrizDeDistancias = {
            'ARAPONGAS': { 'ASTORGA': 34, 'BELA VISTA DO PARA√çSO': 75, 'BOM SUCESSO': 75, 'CAMB√â': 22, 'CENTEN√ÅRIO DO SUL': 66, 'FAXINAL': 96, 'FLOREST√ìPOLIS': 52, 'GUARACI': 86, 'IBIPOR√É': 46, 'JAGUAPIT√É': 46, 'JANDAIA DO SUL': 46, 'JATAIZINHO': 52, 'KALOR√â': 61, 'LONDRINA': 38, 'MANDAGUARI': 48, 'MARIALVA': 60, 'MARIL√ÇNDIA DO SUL': 62, 'MUNHOZ DE MELO': 49, 'PORECATU': 77, 'PRADO FERREIRA': 59, 'PRIMEIRO DE MAIO': 87, 'ROL√ÇNDIA': 10, 'SABAUDIA': 16, 'SANTA F√â': 54, 'SANTO IN√ÅCIO': 73, 'SERTAN√ìPOLIS': 80, 'URA√ç': 85 },
            'ASTORGA': { 'ARAPONGAS': 34, 'BELA VISTA DO PARA√çSO': 82, 'BOM SUCESSO': 68, 'CAMB√â': 42, 'CENTEN√ÅRIO DO SUL': 73, 'FAXINAL': 89, 'FLOREST√ìPOLIS': 59, 'GUARACI': 93, 'IBIPOR√É': 56, 'JAGUAPIT√É': 53, 'JANDAIA DO SUL': 39, 'JATAIZINHO': 62, 'KALOR√â': 54, 'LONDRINA': 48, 'MANDAGUARI': 21, 'MARIALVA': 33, 'MARIL√ÇNDIA DO SUL': 55, 'MUNHOZ DE MELO': 22, 'PORECATU': 84, 'PRADO FERREIRA': 66, 'PRIMEIRO DE MAIO': 94, 'ROL√ÇNDIA': 27, 'SABAUDIA': 18, 'SANTA F√â': 27, 'SANTO IN√ÅCIO': 80, 'SERTAN√ìPOLIS': 89, 'URA√ç': 94 },
            'BELA VISTA DO PARA√çSO': { 'ARAPONGAS': 75, 'ASTORGA': 82, 'BOM SUCESSO': 130, 'CAMB√â': 59, 'CENTEN√ÅRIO DO SUL': 32, 'FAXINAL': 151, 'FLOREST√ìPOLIS': 27, 'GUARACI': 51, 'IBIPOR√É': 65, 'JAGUAPIT√É': 46, 'JANDAIA DO SUL': 103, 'JATAIZINHO': 71, 'KALOR√â': 118, 'LONDRINA': 45, 'MANDAGUARI': 90, 'MARIALVA': 102, 'MARIL√ÇNDIA DO SUL': 119, 'MUNHOZ DE MELO': 85, 'PORECATU': 42, 'PRADO FERREIRA': 34, 'PRIMEIRO DE MAIO': 53, 'ROL√ÇNDIA': 61, 'SABAUDIA': 79, 'SANTA F√â': 89, 'SANTO IN√ÅCIO': 57, 'SERTAN√ìPOLIS': 54, 'URA√ç': 90 },
            'BOM SUCESSO': { 'ARAPONGAS': 75, 'ASTORGA': 68, 'BELA VISTA DO PARA√çSO': 130, 'CAMB√â': 88, 'CENTEN√ÅRIO DO SUL': 121, 'FAXINAL': 26, 'FLOREST√ìPOLIS': 108, 'GUARACI': 142, 'IBIPOR√É': 102, 'JAGUAPIT√É': 92, 'JANDAIA DO SUL': 20, 'JATAIZINHO': 108, 'KALOR√â': 15, 'LONDRINA': 94, 'MANDAGUARI': 47, 'MARIALVA': 59, 'MARIL√ÇNDIA DO SUL': 25, 'MUNHOZ DE MELO': 64, 'PORECATU': 133, 'PRADO FERREIRA': 115, 'PRIMEIRO DE MAIO': 143, 'ROL√ÇNDIA': 68, 'SABAUDIA': 59, 'SANTA F√â': 72, 'SANTO IN√ÅCIO': 129, 'SERTAN√ìPOLIS': 137, 'URA√ç': 142 },
            'CAMB√â': { 'ARAPONGAS': 22, 'ASTORGA': 42, 'BELA VISTA DO PARA√çSO': 59, 'BOM SUCESSO': 88, 'CENTEN√ÅRIO DO SUL': 60, 'FAXINAL': 109, 'FLOREST√ìPOLIS': 46, 'GUARACI': 80, 'IBIPOR√É': 29, 'JAGUAPIT√É': 40, 'JANDAIA DO SUL': 59, 'JATAIZINHO': 35, 'KALOR√â': 74, 'LONDRINA': 16, 'MANDAGUARI': 51, 'MARIALVA': 63, 'MARIL√ÇNDIA DO SUL': 75, 'MUNHOZ DE MELO': 56, 'PORECATU': 71, 'PRADO FERREIRA': 53, 'PRIMEIRO DE MAIO': 72, 'ROL√ÇNDIA': 15, 'SABAUDIA': 26, 'SANTA F√â': 59, 'SANTO IN√ÅCIO': 67, 'SERTAN√ìPOLIS': 64, 'URA√ç': 69 },
            'CENTEN√ÅRIO DO SUL': { 'ARAPONGAS': 66, 'ASTORGA': 73, 'BELA VISTA DO PARA√çSO': 32, 'BOM SUCESSO': 121, 'CAMB√â': 60, 'FAXINAL': 142, 'FLOREST√ìPOLIS': 18, 'GUARACI': 20, 'IBIPOR√É': 66, 'JAGUAPIT√É': 37, 'JANDAIA DO SUL': 94, 'JATAIZINHO': 72, 'KALOR√â': 109, 'LONDRINA': 58, 'MANDAGUARI': 81, 'MARIALVA': 93, 'MARIL√ÇNDIA DO SUL': 110, 'MUNHOZ DE MELO': 76, 'PORECATU': 24, 'PRADO FERREIRA': 25, 'PRIMEIRO DE MAIO': 35, 'ROL√ÇNDIA': 52, 'SABAUDIA': 70, 'SANTA F√â': 80, 'SANTO IN√ÅCIO': 28, 'SERTAN√ìPOLIS': 62, 'URA√ç': 98 },
            'FAXINAL': { 'ARAPONGAS': 96, 'ASTORGA': 89, 'BELA VISTA DO PARA√çSO': 151, 'BOM SUCESSO': 26, 'CAMB√â': 109, 'CENTEN√ÅRIO DO SUL': 142, 'FLOREST√ìPOLIS': 129, 'GUARACI': 163, 'IBIPOR√É': 123, 'JAGUAPIT√É': 113, 'JANDAIA DO SUL': 41, 'JATAIZINHO': 129, 'KALOR√â': 24, 'LONDRINA': 115, 'MANDAGUARI': 68, 'MARIALVA': 80, 'MARIL√ÇNDIA DO SUL': 32, 'MUNHOZ DE MELO': 85, 'PORECATU': 154, 'PRADO FERREIRA': 136, 'PRIMEIRO DE MAIO': 164, 'ROL√ÇNDIA': 89, 'SABAUDIA': 80, 'SANTA F√â': 93, 'SANTO IN√ÅCIO': 150, 'SERTAN√ìPOLIS': 158, 'URA√ç': 163 },
            'FLOREST√ìPOLIS': { 'ARAPONGAS': 52, 'ASTORGA': 59, 'BELA VISTA DO PARA√çSO': 27, 'BOM SUCESSO': 108, 'CAMB√â': 46, 'CENTEN√ÅRIO DO SUL': 18, 'FAXINAL': 129, 'GUARACI': 37, 'IBIPOR√É': 52, 'JAGUAPIT√É': 23, 'JANDAIA DO SUL': 81, 'JATAIZINHO': 58, 'KALOR√â': 96, 'LONDRINA': 44, 'MANDAGUARI': 67, 'MARIALVA': 79, 'MARIL√ÇNDIA DO SUL': 97, 'MUNHOZ DE MELO': 62, 'PORECATU': 29, 'PRADO FERREIRA': 20, 'PRIMEIRO DE MAIO': 39, 'ROL√ÇNDIA': 38, 'SABAUDIA': 56, 'SANTA F√â': 66, 'SANTO IN√ÅCIO': 43, 'SERTAN√ìPOLIS': 48, 'URA√ç': 84 },
            'GUARACI': { 'ARAPONGAS': 86, 'ASTORGA': 93, 'BELA VISTA DO PARA√çSO': 51, 'BOM SUCESSO': 142, 'CAMB√â': 80, 'CENTEN√ÅRIO DO SUL': 20, 'FAXINAL': 163, 'FLOREST√ìPOLIS': 37, 'IBIPOR√É': 86, 'JAGUAPIT√É': 57, 'JANDAIA DO SUL': 114, 'JATAIZINHO': 92, 'KALOR√â': 130, 'LONDRINA': 78, 'MANDAGUARI': 101, 'MARIALVA': 113, 'MARIL√ÇNDIA DO SUL': 130, 'MUNHOZ DE MELO': 96, 'PORECATU': 28, 'PRADO FERREIRA': 45, 'PRIMEIRO DE MAIO': 15, 'ROL√ÇNDIA': 72, 'SABAUDIA': 90, 'SANTA F√â': 100, 'SANTO IN√ÅCIO': 8, 'SERTAN√ìPOLIS': 82, 'URA√ç': 118 },
            'IBIPOR√É': { 'ARAPONGAS': 46, 'ASTORGA': 56, 'BELA VISTA DO PARA√çSO': 65, 'BOM SUCESSO': 102, 'CAMB√â': 29, 'CENTEN√ÅRIO DO SUL': 66, 'FAXINAL': 123, 'FLOREST√ìPOLIS': 52, 'GUARACI': 86, 'JAGUAPIT√É': 46, 'JANDAIA DO SUL': 73, 'JATAIZINHO': 18, 'KALOR√â': 88, 'LONDRINA': 22, 'MANDAGUARI': 65, 'MARIALVA': 77, 'MARIL√ÇNDIA DO SUL': 89, 'MUNHOZ DE MELO': 70, 'PORECATU': 77, 'PRADO FERREIRA': 59, 'PRIMEIRO DE MAIO': 78, 'ROL√ÇNDIA': 32, 'SABAUDIA': 40, 'SANTA F√â': 73, 'SANTO IN√ÅCIO': 73, 'SERTAN√ìPOLIS': 50, 'URA√ç': 55 },
            'JAGUAPIT√É': { 'ARAPONGAS': 46, 'ASTORGA': 53, 'BELA VISTA DO PARA√çSO': 46, 'BOM SUCESSO': 92, 'CAMB√â': 40, 'CENTEN√ÅRIO DO SUL': 37, 'FAXINAL': 113, 'FLOREST√ìPOLIS': 23, 'GUARACI': 57, 'IBIPOR√É': 46, 'JANDAIA DO SUL': 70, 'JATAIZINHO': 52, 'KALOR√â': 85, 'LONDRINA': 43, 'MANDAGUARI': 61, 'MARIALVA': 73, 'MARIL√ÇNDIA DO SUL': 86, 'MUNHOZ DE MELO': 56, 'PORECATU': 48, 'PRADO FERREIRA': 20, 'PRIMEIRO DE MAIO': 59, 'ROL√ÇNDIA': 32, 'SABAUDIA': 50, 'SANTA F√â': 60, 'SANTO IN√ÅCIO': 54, 'SERTAN√ìPOLIS': 56, 'URA√ç': 92 },
            'JANDAIA DO SUL': { 'ARAPONGAS': 46, 'ASTORGA': 39, 'BELA VISTA DO PARA√çSO': 103, 'BOM SUCESSO': 20, 'CAMB√â': 59, 'CENTEN√ÅRIO DO SUL': 94, 'FAXINAL': 41, 'FLOREST√ìPOLIS': 81, 'GUARACI': 114, 'IBIPOR√É': 73, 'JAGUAPIT√É': 70, 'JATAIZINHO': 80, 'KALOR√â': 15, 'LONDRINA': 65, 'MANDAGUARI': 18, 'MARIALVA': 30, 'MARIL√ÇNDIA DO SUL': 25, 'MUNHOZ DE MELO': 35, 'PORECATU': 106, 'PRADO FERREIRA': 88, 'PRIMEIRO DE MAIO': 115, 'ROL√ÇNDIA': 39, 'SABAUDIA': 30, 'SANTA F√â': 43, 'SANTO IN√ÅCIO': 101, 'SERTAN√ìPOLIS': 109, 'URA√ç': 114 },
            'JATAIZINHO': { 'ARAPONGAS': 52, 'ASTORGA': 62, 'BELA VISTA DO PARA√çSO': 71, 'BOM SUCESSO': 108, 'CAMB√â': 35, 'CENTEN√ÅRIO DO SUL': 72, 'FAXINAL': 129, 'FLOREST√ìPOLIS': 58, 'GUARACI': 92, 'IBIPOR√É': 18, 'JAGUAPIT√É': 52, 'JANDAIA DO SUL': 80, 'KALOR√â': 95, 'LONDRINA': 28, 'MANDAGUARI': 72, 'MARIALVA': 84, 'MARIL√ÇNDIA DO SUL': 96, 'MUNHOZ DE MELO': 77, 'PORECATU': 84, 'PRADO FERREIRA': 65, 'PRIMEIRO DE MAIO': 84, 'ROL√ÇNDIA': 38, 'SABAUDIA': 46, 'SANTA F√â': 79, 'SANTO IN√ÅCIO': 79, 'SERTAN√ìPOLIS': 56, 'URA√ç': 45 },
            'KALOR√â': { 'ARAPONGAS': 61, 'ASTORGA': 54, 'BELA VISTA DO PARA√çSO': 118, 'BOM SUCESSO': 15, 'CAMB√â': 74, 'CENTEN√ÅRIO DO SUL': 109, 'FAXINAL': 24, 'FLOREST√ìPOLIS': 96, 'GUARACI': 130, 'IBIPOR√É': 88, 'JAGUAPIT√É': 85, 'JANDAIA DO SUL': 15, 'JATAIZINHO': 95, 'LONDRINA': 80, 'MANDAGUARI': 33, 'MARIALVA': 45, 'MARIL√ÇNDIA DO SUL': 24, 'MUNHOZ DE MELO': 50, 'PORECATU': 121, 'PRADO FERREIRA': 103, 'PRIMEIRO DE MAIO': 131, 'ROL√ÇNDIA': 54, 'SABAUDIA': 45, 'SANTA F√â': 58, 'SANTO IN√ÅCIO': 117, 'SERTAN√ìPOLIS': 125, 'URA√ç': 130 },
            'LONDRINA': { 'ARAPONGAS': 38, 'ASTORGA': 48, 'BELA VISTA DO PARA√çSO': 45, 'BOM SUCESSO': 94, 'CAMB√â': 16, 'CENTEN√ÅRIO DO SUL': 58, 'FAXINAL': 115, 'FLOREST√ìPOLIS': 44, 'GUARACI': 78, 'IBIPOR√É': 22, 'JAGUAPIT√É': 43, 'JANDAIA DO SUL': 65, 'JATAIZINHO': 28, 'KALOR√â': 80, 'MANDAGUARI': 57, 'MARIALVA': 69, 'MARIL√ÇNDIA DO SUL': 81, 'MUNHOZ DE MELO': 62, 'PORECATU': 70, 'PRADO FERREIRA': 52, 'PRIMEIRO DE MAIO': 70, 'ROL√ÇNDIA': 25, 'SABAUDIA': 32, 'SANTA F√â': 65, 'SANTO IN√ÅCIO': 65, 'SERTAN√ìPOLIS': 54, 'URA√ç': 60 },
            'MANDAGUARI': { 'ARAPONGAS': 48, 'ASTORGA': 21, 'BELA VISTA DO PARA√çSO': 90, 'BOM SUCESSO': 47, 'CAMB√â': 51, 'CENTEN√ÅRIO DO SUL': 81, 'FAXINAL': 68, 'FLOREST√ìPOLIS': 67, 'GUARACI': 101, 'IBIPOR√É': 65, 'JAGUAPIT√É': 61, 'JANDAIA DO SUL': 18, 'JATAIZINHO': 72, 'KALOR√â': 33, 'LONDRINA': 57, 'MARIALVA': 12, 'MARIL√ÇNDIA DO SUL': 34, 'MUNHOZ DE MELO': 23, 'PORECATU': 92, 'PRADO FERREIRA': 74, 'PRIMEIRO DE MAIO': 102, 'ROL√ÇNDIA': 38, 'SABAUDIA': 28, 'SANTA F√â': 31, 'SANTO IN√ÅCIO': 88, 'SERTAN√ìPOLIS': 98, 'URA√ç': 103 },
            'MARIALVA': { 'ARAPONGAS': 60, 'ASTORGA': 33, 'BELA VISTA DO PARA√çSO': 102, 'BOM SUCESSO': 59, 'CAMB√â': 63, 'CENTEN√ÅRIO DO SUL': 93, 'FAXINAL': 80, 'FLOREST√ìPOLIS': 79, 'GUARACI': 113, 'IBIPOR√É': 77, 'JAGUAPIT√É': 73, 'JANDAIA DO SUL': 30, 'JATAIZINHO': 84, 'KALOR√â': 45, 'LONDRINA': 69, 'MANDAGUARI': 12, 'MARIL√ÇNDIA DO SUL': 46, 'MUNHOZ DE MELO': 18, 'PORECATU': 104, 'PRADO FERREIRA': 86, 'PRIMEIRO DE MAIO': 114, 'ROL√ÇNDIA': 50, 'SABAUDIA': 40, 'SANTA F√â': 25, 'SANTO IN√ÅCIO': 100, 'SERTAN√ìPOLIS': 110, 'URA√ç': 115 },
            'MARIL√ÇNDIA DO SUL': { 'ARAPONGAS': 62, 'ASTORGA': 55, 'BELA VISTA DO PARA√çSO': 119, 'BOM SUCESSO': 25, 'CAMB√â': 75, 'CENTEN√ÅRIO DO SUL': 110, 'FAXINAL': 32, 'FLOREST√ìPOLIS': 97, 'GUARACI': 130, 'IBIPOR√É': 89, 'JAGUAPIT√É': 86, 'JANDAIA DO SUL': 25, 'JATAIZINHO': 96, 'KALOR√â': 24, 'LONDRINA': 81, 'MANDAGUARI': 34, 'MARIALVA': 46, 'MUNHOZ DE MELO': 51, 'PORECATU': 122, 'PRADO FERREIRA': 104, 'PRIMEIRO DE MAIO': 131, 'ROL√ÇNDIA': 55, 'SABAUDIA': 46, 'SANTA F√â': 59, 'SANTO IN√ÅCIO': 117, 'SERTAN√ìPOLIS': 125, 'URA√ç': 130 },
            'MUNHOZ DE MELO': { 'ARAPONGAS': 49, 'ASTORGA': 22, 'BELA VISTA DO PARA√çSO': 85, 'BOM SUCESSO': 64, 'CAMB√â': 56, 'CENTEN√ÅRIO DO SUL': 76, 'FAXINAL': 85, 'FLOREST√ìPOLIS': 62, 'GUARACI': 96, 'IBIPOR√É': 70, 'JAGUAPIT√É': 56, 'JANDAIA DO SUL': 35, 'JATAIZINHO': 77, 'KALOR√â': 50, 'LONDRina': 62, 'MANDAGUARI': 23, 'MARIALVA': 18, 'MARIL√ÇNDIA DO SUL': 51, 'PORECATU': 87, 'PRADO FERREIRA': 69, 'PRIMEIRO DE MAIO': 97, 'ROL√ÇNDIA': 39, 'SABAUDIA': 30, 'SANTA F√â': 9, 'SANTO IN√ÅCIO': 83, 'SERTAN√ìPOLIS': 93, 'URA√ç': 98 },
            'PORECATU': { 'ARAPONGAS': 77, 'ASTORGA': 84, 'BELA VISTA DO PARA√çSO': 42, 'BOM SUCESSO': 133, 'CAMB√â': 71, 'CENTEN√ÅRIO DO SUL': 24, 'FAXINAL': 154, 'FLOREST√ìPOLIS': 29, 'GUARACI': 28, 'IBIPOR√É': 77, 'JAGUAPIT√É': 48, 'JANDAIA DO SUL': 106, 'JATAIZINHO': 84, 'KALOR√â': 121, 'LONDRINA': 70, 'MANDAGUARI': 92, 'MARIALVA': 104, 'MARIL√ÇNDIA DO SUL': 122, 'MUNHOZ DE MELO': 87, 'PRADO FERREIRA': 44, 'PRIMEIRO DE MAIO': 36, 'ROL√ÇNDIA': 63, 'SABAUDIA': 81, 'SANTA F√â': 91, 'SANTO IN√ÅCIO': 34, 'SERTAN√ìPOLIS': 74, 'URA√ç': 110 },
            'PRADO FERREIRA': { 'ARAPONGAS': 59, 'ASTORGA': 66, 'BELA VISTA DO PARA√çSO': 34, 'BOM SUCESSO': 115, 'CAMB√â': 53, 'CENTEN√ÅRIO DO SUL': 25, 'FAXINAL': 136, 'FLOREST√ìPOLIS': 20, 'GUARACI': 45, 'IBIPOR√É': 59, 'JAGUAPIT√É': 20, 'JANDAIA DO SUL': 88, 'JATAIZINHO': 65, 'KALOR√â': 103, 'LONDRINA': 52, 'MANDAGUARI': 74, 'MARIALVA': 86, 'MARIL√ÇNDIA DO SUL': 104, 'MUNHOZ DE MELO': 69, 'PORECATU': 44, 'PRIMEIRO DE MAIO': 47, 'ROL√ÇNDIA': 45, 'SABAUDIA': 63, 'SANTA F√â': 73, 'SANTO IN√ÅCIO': 41, 'SERTAN√ìPOLIS': 56, 'URA√ç': 92 },
            'PRIMEIRO DE MAIO': { 'ARAPONGAS': 87, 'ASTORGA': 94, 'BELA VISTA DO PARA√çSO': 53, 'BOM SUCESSO': 143, 'CAMB√â': 72, 'CENTEN√ÅRIO DO SUL': 35, 'FAXINAL': 164, 'FLOREST√ìPOLIS': 39, 'GUARACI': 15, 'IBIPOR√É': 78, 'JAGUAPIT√É': 59, 'JANDAIA DO SUL': 115, 'JATAIZINHO': 84, 'KALOR√â': 131, 'LONDRINA': 70, 'MANDAGUARI': 102, 'MARIALVA': 114, 'MARIL√ÇNDIA DO SUL': 131, 'MUNHOZ DE MELO': 97, 'PORECATU': 36, 'PRADO FERREIRA': 47, 'ROL√ÇNDIA': 73, 'SABAUDIA': 91, 'SANTA F√â': 101, 'SANTO IN√ÅCIO': 21, 'SERTAN√ìPOLIS': 74, 'URA√ç': 110 },
            'ROL√ÇNDIA': { 'ARAPONGAS': 10, 'ASTORGA': 27, 'BELA VISTA DO PARA√çSO': 61, 'BOM SUCESSO': 68, 'CAMB√â': 15, 'CENTEN√ÅRIO DO SUL': 52, 'FAXINAL': 89, 'FLOREST√ìPOLIS': 38, 'GUARACI': 72, 'IBIPOR√É': 32, 'JAGUAPIT√É': 32, 'JANDAIA DO SUL': 39, 'JATAIZINHO': 38, 'KALOR√â': 54, 'LONDRINA': 25, 'MANDAGUARI': 38, 'MARIALVA': 50, 'MARIL√ÇNDIA DO SUL': 55, 'MUNHOZ DE MELO': 39, 'PORECATU': 63, 'PRADO FERREIRA': 45, 'PRIMEIRO DE MAIO': 73, 'SABAUDIA': 17, 'SANTA F√â': 44, 'SANTO IN√ÅCIO': 60, 'SERTAN√ìPOLIS': 66, 'URA√ç': 71 },
            'SABAUDIA': { 'ARAPONGAS': 16, 'ASTORGA': 18, 'BELA VISTA DO PARA√çSO': 79, 'BOM SUCESSO': 59, 'CAMB√â': 26, 'CENTEN√ÅRIO DO SUL': 70, 'FAXINAL': 80, 'FLOREST√ìPOLIS': 56, 'GUARACI': 90, 'IBIPOR√É': 40, 'JAGUAPIT√É': 50, 'JANDAIA DO SUL': 30, 'JATAIZINHO': 46, 'KALOR√â': 45, 'LONDRINA': 32, 'MANDAGUARI': 28, 'MARIALVA': 40, 'MARIL√ÇNDIA DO SUL': 46, 'MUNHOZ DE MELO': 30, 'PORECATU': 81, 'PRADO FERREIRA': 63, 'PRIMEIRO DE MAIO': 91, 'ROL√ÇNDIA': 17, 'SANTA F√â': 35, 'SANTO IN√ÅCIO': 77, 'SERTAN√ìPOLIS': 85, 'URA√ç': 90 },
            'SANTA F√â': { 'ARAPONGAS': 54, 'ASTORGA': 27, 'BELA VISTA DO PARA√çSO': 89, 'BOM SUCESSO': 72, 'CAMB√â': 59, 'CENTEN√ÅRIO DO SUL': 80, 'FAXINAL': 93, 'FLOREST√ìPOLIS': 66, 'GUARACI': 100, 'IBIPOR√É': 73, 'JAGUAPIT√É': 60, 'JANDAIA DO SUL': 43, 'JATAIZINHO': 79, 'KALOR√â': 58, 'LONDRINA': 65, 'MANDAGUARI': 31, 'MARIALVA': 25, 'MARIL√ÇNDIA DO SUL': 59, 'MUNHOZ DE MELO': 9, 'PORECATU': 91, 'PRADO FERREIRA': 73, 'PRIMEIRO DE MAIO': 101, 'ROL√ÇNDIA': 44, 'SABAUDIA': 35, 'SANTO IN√ÅCIO': 87, 'SERTAN√ìPOLIS': 97, 'URA√ç': 102 },
            'SANTO IN√ÅCIO': { 'ARAPONGAS': 73, 'ASTORGA': 80, 'BELA VISTA DO PARA√çSO': 57, 'BOM SUCESSO': 129, 'CAMB√â': 67, 'CENTEN√ÅRIO DO SUL': 28, 'FAXINAL': 150, 'FLOREST√ìPOLIS': 43, 'GUARACI': 8, 'IBIPOR√É': 73, 'JAGUAPIT√É': 54, 'JANDAIA DO SUL': 101, 'JATAIZINHO': 79, 'KALOR√â': 117, 'LONDRINA': 65, 'MANDAGUARI': 88, 'MARIALVA': 100, 'MARIL√ÇNDIA DO SUL': 117, 'MUNHOZ DE MELO': 83, 'PORECATU': 34, 'PRADO FERREIRA': 41, 'PRIMEIRO DE MAIO': 21, 'ROL√ÇNDIA': 60, 'SABAUDIA': 77, 'SANTA F√â': 87, 'SERTAN√ìPOLIS': 70, 'URA√ç': 106 },
            'SERTAN√ìPOLIS': { 'ARAPONGAS': 80, 'ASTORGA': 89, 'BELA VISTA DO PARA√çSO': 54, 'BOM SUCESSO': 137, 'CAMB√â': 64, 'CENTEN√ÅRIO DO SUL': 62, 'FAXINAL': 158, 'FLOREST√ìPOLIS': 48, 'GUARACI': 82, 'IBIPOR√É': 50, 'JAGUAPIT√É': 56, 'JANDAIA DO SUL': 109, 'JATAIZINHO': 56, 'KALOR√â': 125, 'LONDRINA': 54, 'MANDAGUARI': 98, 'MARIALVA': 110, 'MARIL√ÇNDIA DO SUL': 125, 'MUNHOZ DE MELO': 93, 'PORECATU': 74, 'PRADO FERREIRA': 56, 'PRIMEIRO DE MAIO': 74, 'ROL√ÇNDIA': 66, 'SABAUDIA': 85, 'SANTA F√â': 97, 'SANTO IN√ÅCIO': 70, 'URA√ç': 60 },
            'URA√ç': { 'ARAPONGAS': 85, 'ASTORGA': 94, 'BELA VISTA DO PARA√çSO': 90, 'BOM SUCESSO': 142, 'CAMB√â': 69, 'CENTEN√ÅRIO DO SUL': 98, 'FAXINAL': 163, 'FLOREST√ìPOLIS': 84, 'GUARACI': 118, 'IBIPOR√É': 55, 'JAGUAPIT√É': 92, 'JANDAIA DO SUL': 114, 'JATAIZINHO': 45, 'KALOR√â': 130, 'LONDRINA': 60, 'MANDAGUARI': 103, 'MARIALVA': 115, 'MARIL√ÇNDIA DO SUL': 130, 'MUNHOZ DE MELO': 98, 'PORECATU': 110, 'PRADO FERREIRA': 92, 'PRIMEIRO DE MAIO': 110, 'ROL√ÇNDIA': 71, 'SABAUDIA': 90, 'SANTA F√â': 102, 'SANTO IN√ÅCIO': 106, 'SERTAN√ìPOLIS': 60 }
        };

        function calcularDistanciaLocal(loadId) {
            const resultSpan = document.getElementById(`dist-${loadId}`);
            const loadData = CargasFiorinoFinalizadas.get(loadId);
            
            if (!loadData) {
                resultSpan.textContent = "Erro: Carga n√£o encontrada.";
                return;
            }

            resultSpan.innerHTML = ` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculando...`;
            
            let cidadesNaCarga = [...new Set(loadData.pedidos.map(p => String(p.Cidade).toUpperCase().trim()))];
            
            if (cidadesNaCarga.length === 0) {
                resultSpan.textContent = "Nenhuma cidade para calcular.";
                return;
            }

            // Garante que as cidades existem na nossa matriz
            cidadesNaCarga = cidadesNaCarga.filter(cidade => matrizDeDistancias[cidade]);
            
            if (cidadesNaCarga.length === 0) {
                resultSpan.innerHTML = `<strong class="text-warning">Cidades n√£o mapeadas.</strong>`;
                return;
            }

            let totalDistance = 0;
            let currentCity = 'ROL√ÇNDIA';
            let unvisitedCities = [...cidadesNaCarga];

            while (unvisitedCities.length > 0) {
                let closestCity = '';
                let shortestDistance = Infinity;

                for (const city of unvisitedCities) {
                    // Normaliza o nome da cidade atual para o caso de ter alguma varia√ß√£o
                    const currentCityNormalized = Object.keys(matrizDeDistancias).find(k => k.toUpperCase() === currentCity.toUpperCase());
                    if (!currentCityNormalized) break;

                    const distance = matrizDeDistancias[currentCityNormalized]?.[city];
                    if (distance !== undefined && distance < shortestDistance) {
                        shortestDistance = distance;
                        closestCity = city;
                    }
                }

                if (closestCity) {
                    totalDistance += shortestDistance;
                    currentCity = closestCity;
                    unvisitedCities = unvisitedCities.filter(city => city !== closestCity);
                } else {
                    // Se n√£o encontrar uma cidade conectada, quebra o loop
                    console.warn("N√£o foi poss√≠vel encontrar rota para as cidades restantes:", unvisitedCities);
                    break;
                }
            }

            // Adiciona a dist√¢ncia de volta para Rol√¢ndia
            const currentCityNormalized = Object.keys(matrizDeDistancias).find(k => k.toUpperCase() === currentCity.toUpperCase());
            const returnDistance = matrizDeDistancias[currentCityNormalized]?.['ROL√ÇNDIA'];
            if (returnDistance) {
                totalDistance += returnDistance;
            }

            resultSpan.innerHTML = `<strong>Dist√¢ncia Estimada: ${totalDistance.toFixed(0)} km</strong>`;
        }
        // *** FIM DA NOVA L√ìGICA ***


        let planilhaData = [];
        let pedidosGeraisAtuais = [];
        let gruposToco = {};
        let pedidosPrioritarios = [];
        let tocoPedidoIds = new Set();

        const defaultConfigs = {
            fiorinoMaxCapacity: 570, fiorinoMinCapacity: 330, fiorinoCubage: 1.5,
            vanMaxCapacity: 1560, vanMinCapacity: 1100, vanCubage: 5.0,
            tresQuartosMaxCapacity: 4100, tresQuartosMinCapacity: 2300, tresQuartosCubage: 15.0,
            tocoMaxCapacity: 8500, tocoMinCapacity: 5000, tocoCubage: 30.0
        };

        function saveConfigurations() {
            const configStatus = document.getElementById('configStatus');
            try {
                const configs = {};
                Object.keys(defaultConfigs).forEach(key => { configs[key] = document.getElementById(key).value; });
                localStorage.setItem('vehicleConfigs', JSON.stringify(configs));
                configStatus.innerHTML = '<p class="text-success">Configura√ß√µes salvas com sucesso!</p>';
                setTimeout(() => { configStatus.innerHTML = ''; }, 3000);
            } catch (error) {
                configStatus.innerHTML = '<p class="text-danger">Erro ao salvar as configura√ß√µes.</p>';
            }
        }

        function loadConfigurations() {
            const savedConfigs = localStorage.getItem('vehicleConfigs');
            const configs = savedConfigs ? JSON.parse(savedConfigs) : defaultConfigs;
            Object.keys(configs).forEach(key => {
                const element = document.getElementById(key);
                if (element) { element.value = configs[key]; }
            });
        }
        
        function resetFiorino() {
            document.getElementById('fiorinoMaxCapacity').value = defaultConfigs.fiorinoMaxCapacity;
            document.getElementById('fiorinoMinCapacity').value = defaultConfigs.fiorinoMinCapacity;
            document.getElementById('fiorinoCubage').value = defaultConfigs.fiorinoCubage;
            saveConfigurations();
        }
        function resetVan() {
            document.getElementById('vanMaxCapacity').value = defaultConfigs.vanMaxCapacity;
            document.getElementById('vanMinCapacity').value = defaultConfigs.vanMinCapacity;
            document.getElementById('vanCubage').value = defaultConfigs.vanCubage;
            saveConfigurations();
        }
        function resetTresQuartos() {
            document.getElementById('tresQuartosMaxCapacity').value = defaultConfigs.tresQuartosMaxCapacity;
            document.getElementById('tresQuartosMinCapacity').value = defaultConfigs.tresQuartosMinCapacity;
            document.getElementById('tresQuartosCubage').value = defaultConfigs.tresQuartosCubage;
            saveConfigurations();
        }
        function resetToco() {
            document.getElementById('tocoMaxCapacity').value = defaultConfigs.tocoMaxCapacity;
            document.getElementById('tocoMinCapacity').value = defaultConfigs.tocoMinCapacity;
            document.getElementById('tocoCubage').value = defaultConfigs.tocoCubage;
            saveConfigurations();
        }
        function resetAll() {
            Object.keys(defaultConfigs).forEach(key => { document.getElementById(key).value = defaultConfigs[key]; });
            saveConfigurations();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadConfigurations();
            document.getElementById('saveConfig').addEventListener('click', saveConfigurations);
            document.getElementById('resetFiorino').addEventListener('click', resetFiorino);
            document.getElementById('resetVan').addEventListener('click', resetVan);
            document.getElementById('resetTresQuartos').addEventListener('click', resetTresQuartos);
            document.getElementById('resetToco').addEventListener('click', resetToco);
            document.getElementById('resetAllConfigs').addEventListener('click', resetAll);
        });

        const rotaVeiculoMap = {
            '11101': 'Fiorino', '11301': 'Fiorino', '11311': 'Fiorino', '11561': 'Fiorino', '11721': 'Fiorino', '11731': 'Fiorino',
            '11102': 'Van', '11331': 'Van', '11341': 'Van', '11342': 'Van', '11351': 'Van', '11521': 'Van', '11531': 'Van', '11551': 'Van', '11571': 'Van', '11701': 'Van', '11711': 'Van',
            '11361': '3/4', '11501': '3/4', '11502': '3/4', '11511': '3/4', '11541': '3/4',
        };
        
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');
        const dropZone = document.getElementById('drop-zone');
        const dropZoneText = document.getElementById('drop-zone-text');
        const isNumeric = (str) => str && /^\d+$/.test(String(str).trim());

        fileInput.addEventListener('change', (event) => { handleFile(event.target.files[0]); });
        dropZone.addEventListener('dragover', (event) => { event.stopPropagation(); event.preventDefault(); dropZone.classList.add('border-primary'); });
        dropZone.addEventListener('dragleave', (event) => { event.stopPropagation(); event.preventDefault(); dropZone.classList.remove('border-primary'); });
        dropZone.addEventListener('drop', (event) => { event.stopPropagation(); event.preventDefault(); dropZone.classList.remove('border-primary'); handleFile(event.dataTransfer.files[0]); });

        function handleFile(file) {
            if (!file) return;
            statusDiv.innerHTML = '<p class="text-info">Carregando planilha...</p>';
            processarBtn.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    let headerRowIndex = -1, headers = [];
                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && row.includes('Cod_Rota')) { headerRowIndex = i; headers = row.map(h => String(h).trim()); break; }
                    }
                    if (headerRowIndex === -1) throw new Error("N√£o foi poss√≠vel encontrar a linha de cabe√ßalho com 'Cod_Rota'.");
                    const dataRows = rawData.slice(headerRowIndex + 1);
                    planilhaData = dataRows.map(row => { const pedido = {}; headers.forEach((header, i) => { if (header) { pedido[header] = row[i] !== undefined ? row[i] : ''; } }); return pedido; });
                    statusDiv.innerHTML = `<p class="text-success">Planilha \"${file.name}\" carregada. ${planilhaData.length} linhas prontas para processar.</p>`;
                    processarBtn.disabled = false;
                    dropZoneText.innerHTML = `<p>Arquivo \"${file.name}\" carregado.</p><button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Selecionar Outro Arquivo</button>`;
                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Erro ao ler o arquivo:</strong> ${error.message}</p>`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function buscarPedido() {
            const searchInput = document.getElementById('pedidoSearchInput').value.trim();
            const searchResultDiv = document.getElementById('search-result');
            searchResultDiv.innerHTML = '';
            if (!searchInput) return;

            if (planilhaData.length === 0) { searchResultDiv.innerHTML = '<p class="text-warning">Por favor, carregue e processe a planilha primeiro.</p>'; return; }

            let pedidoEncontrado = null; let local = 'N√£o encontrado'; let accordionId = '';

            pedidoEncontrado = pedidosGeraisAtuais.find(p => String(p.Num_Pedido) === searchInput);
            if (pedidoEncontrado) { local = 'Resultados Gerais'; accordionId = 'accordionGeral'; }

            if (!pedidoEncontrado) {
                for (const cf in gruposToco) {
                    pedidoEncontrado = gruposToco[cf].pedidos.find(p => String(p.Num_Pedido) === searchInput);
                    if (pedidoEncontrado) { local = `Cargas "Toco" (CF: ${cf})`; accordionId = 'accordionToco'; break; }
                }
            }
            
            if (!pedidoEncontrado) {
                const originalPedido = planilhaData.find(p => String(p.Num_Pedido) === searchInput);
                if (originalPedido) {
                    pedidoEncontrado = originalPedido;
                    if (tocoPedidoIds.has(String(originalPedido.Num_Pedido))) { local = 'Filtrado (pertence a um grupo Toco)'; }
                    else if (isNumeric(originalPedido.CF)) { local = 'Filtrado (possui CF num√©rico)'; }
                    else if (['21', '23', '17'].includes(String(originalPedido.Coluna4))) { local = 'Filtrado (Coluna4 √© 21, 23, ou 17)'; } 
                    else if (String(originalPedido['BLOQ.']) === 'C' || String(originalPedido['BLOQ.']) === 'V') { local = 'Filtrado (Bloqueio C ou V)'; } 
                    else { local = 'Filtrado (outro motivo, verifique filtros)'; }
                }
            }

            if (pedidoEncontrado) {
                let buttons = '';
                if (local === 'Resultados Gerais') {
                    const isPrioritized = pedidosPrioritarios.includes(String(pedidoEncontrado.Num_Pedido));
                    buttons = `<button class="btn btn-primary btn-sm" onclick="priorizarPedido('${pedidoEncontrado.Num_Pedido}')" ${isPrioritized ? 'disabled' : ''}>${isPrioritized ? 'Prioridade Marcada' : 'Marcar como Prioridade'}</button>
                               <button class="btn btn-secondary btn-sm ms-2" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`;
                } else if (accordionId) {
                     buttons = `<button class="btn btn-secondary btn-sm" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`;
                }
                searchResultDiv.innerHTML = `<div class="alert alert-info"><h5>Pedido ${searchInput} encontrado!</h5><p class="mb-1"><strong>Local:</strong> ${local}</p><p class="mb-1"><strong>Cliente:</strong> ${pedidoEncontrado.Nome_Cliente}<br><strong>Peso:</strong> ${pedidoEncontrado.Quilos_Saldo} kg</p>${buttons ? `<div class="mt-2">${buttons}</div>` : ''}</div>`;
            } else { searchResultDiv.innerHTML = '<p class="text-danger">Pedido n√£o encontrado em nenhuma das listas.</p>'; }
        }

        function priorizarPedido(numPedido) { if (!pedidosPrioritarios.includes(numPedido)) { pedidosPrioritarios.push(numPedido); buscarPedido(); } }

        function highlightPedido(numPedido) {
            const row = document.getElementById(`pedido-${numPedido}`);
            if (row) {
                row.classList.toggle('table-info');
                if (row.classList.contains('table-info')) {
                    const collapseEl = row.closest('.accordion-collapse');
                    if (collapseEl && !collapseEl.classList.contains('show')) { bootstrap.Collapse.getOrCreateInstance(collapseEl).show(); }
                    setTimeout(() => { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 350);
                }
            }
        }

        function processar() {
            const resultadoGeralDiv = document.getElementById('resultado-geral');
            const resultadoTocoDiv = document.getElementById('resultado-toco');
            const resultadoTresQuartosDiv = document.getElementById('resultado-tres-quartos');
            try {
                if (planilhaData.length === 0) { statusDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; return; }
                const rotaInicialInput = document.getElementById('rotaInicialInput').value; const rotaFinalInput = document.getElementById('rotaFinalInput').value;
                resultadoGeralDiv.innerHTML = ''; resultadoTocoDiv.innerHTML = ''; resultadoTresQuartosDiv.innerHTML = '';

                const pedidos = planilhaData.filter(p => String(p.Coluna4) != '500');

                const pedidosTocoBase = pedidos.filter(p => (p.Coluna4 && String(p.Coluna4).toUpperCase().includes('TOCO')) || (p.Coluna5 && String(p.Coluna5).toUpperCase().includes('TOCO')));
                const cfCounts = {};
                pedidosTocoBase.forEach(p => { if (p.CF && isNumeric(p.CF)) { cfCounts[p.CF] = (cfCounts[p.CF] || 0) + 1; } });
                const cfsRepetidos = Object.keys(cfCounts).filter(cf => cfCounts[cf] > 1);
                const pedidosTocoFiltrados = pedidosTocoBase.filter(p => cfsRepetidos.includes(String(p.CF)));
                gruposToco = pedidosTocoFiltrados.reduce((acc, p) => {
                    const cf = p.CF;
                    if (!acc[cf]) { acc[cf] = { pedidos: [], totalKg: 0 }; } acc[cf].pedidos.push(p); acc[cf].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc;
                }, {});
                displayToco(resultadoTocoDiv, gruposToco);

                tocoPedidoIds = new Set(pedidosTocoFiltrados.map(p => String(p.Num_Pedido)));
                const clientesComBloqueio = new Set(); const clientesSemBloqueio = new Set();
                pedidos.forEach(p => { if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') { clientesComBloqueio.add(String(p.Cliente)); } else { clientesSemBloqueio.add(String(p.Cliente)); } });
                const clientesParaRemover = new Set([...clientesComBloqueio].filter(c => clientesSemBloqueio.has(c)));
                const rotaMin = rotaInicialInput ? parseInt(rotaInicialInput, 10) : 0; const rotaMax = rotaFinalInput ? parseInt(rotaFinalInput, 10) : 99999;
                
                const pedidosGeraisFiltrados = pedidos.filter(p => {
                    if (tocoPedidoIds.has(String(p.Num_Pedido))) return false;
                    if (['21', '23', '17'].includes(String(p.Coluna4))) return false;
                    if (isNumeric(p.CF)) { return false; }
                    const rotaAtualNum = parseInt(String(p.Cod_Rota), 10);
                    if (rotaMin > 0 && rotaMax > 0 && !(rotaAtualNum >= rotaMin && rotaAtualNum <= rotaMax)) return false;
                    if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') return false;
                    if (clientesParaRemover.has(String(p.Cliente))) return false;
                    return true;
                });

                let tresQuartosLoads = [];
                const MIN_KG_3_4 = parseFloat(document.getElementById('tresQuartosMinCapacity').value) || defaultConfigs.tresQuartosMinCapacity;
                const MAX_KG_3_4 = parseFloat(document.getElementById('tresQuartosMaxCapacity').value) || defaultConfigs.tresQuartosMaxCapacity;
                const LARGE_ORDER_KG = 1700;

                const largeOrdersByRoute = pedidosGeraisFiltrados.reduce((acc, p) => {
                    const peso = parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                    if (peso >= LARGE_ORDER_KG) { const rota = p.Cod_Rota; if (!acc[rota]) acc[rota] = []; acc[rota].push(p); } return acc;
                }, {});
                const pedidosEmCargas3_4 = new Set();
                Object.keys(largeOrdersByRoute).forEach(rota => {
                    const largeOrders = largeOrdersByRoute[rota];
                    if (largeOrders.length === 1) {
                        const largeOrder = largeOrders[0]; if (pedidosEmCargas3_4.has(largeOrder.Num_Pedido)) return;
                        let newLoad = { pedidos: [largeOrder], totalKg: parseFloat(String(largeOrder.Quilos_Saldo).replace(',', '.')) || 0, rota: rota };
                        const otherOrdersInRoute = pedidosGeraisFiltrados.filter(p => p.Cod_Rota === rota && p.Num_Pedido !== largeOrder.Num_Pedido).sort((a, b) => (parseFloat(String(b.Quilos_Saldo).replace(',', '.')) || 0) - (parseFloat(String(a.Quilos_Saldo).replace(',', '.')) || 0));
                        for (const order of otherOrdersInRoute) {
                            if (pedidosEmCargas3_4.has(order.Num_Pedido)) continue;
                            const orderKg = parseFloat(String(order.Quilos_Saldo).replace(',', '.')) || 0;
                            if (newLoad.totalKg + orderKg <= MAX_KG_3_4) { newLoad.pedidos.push(order); newLoad.totalKg += orderKg; }
                        }
                        if (newLoad.totalKg >= MIN_KG_3_4) { tresQuartosLoads.push(newLoad); newLoad.pedidos.forEach(p => pedidosEmCargas3_4.add(p.Num_Pedido)); }
                    }
                });
                tresQuartosLoads.forEach((load, index) => { load.numero = index + 1; });
                displayTresQuartos(resultadoTresQuartosDiv, tresQuartosLoads);

                pedidosGeraisAtuais = pedidosGeraisFiltrados.filter(p => !pedidosEmCargas3_4.has(p.Num_Pedido));
                
                const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => {
                    const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc;
                }, {});
                displayGerais(resultadoGeralDiv, gruposGerais);

            } catch (error) { statusDiv.innerHTML = `<p class="text-danger"><strong>Ocorreu um erro:</strong></p><pre>${error.stack}</pre>`; console.error(error); }
        }

        function createTable(pedidos, columnsToDisplay) {
            if (!pedidos || pedidos.length === 0) return '';
            const colunasExibir = columnsToDisplay || ['Cod_Rota', 'Cliente', 'Nome_Cliente', 'Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cidade', 'BLOQ.', 'Coluna4', 'Coluna5', 'CF'];
            let table = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped"><thead><tr>';
            colunasExibir.forEach(c => table += `<th>${c}</th>`);
            table += '</tr></thead><tbody>';
            pedidos.forEach(p => { table += `<tr id="pedido-${p.Num_Pedido}">`; colunasExibir.forEach(c => table += `<td>${p[c] === undefined || p[c] === null ? '' : p[c]}</td>`); table += '</tr>'; });
            table += '</tbody></table></div>';
            return table;
        }

        function displayGerais(div, grupos) {
            if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhum pedido geral encontrado.</div>'; return; }
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionGeral">';
            Object.keys(grupos).sort().forEach((rota, index) => {
                const grupo = grupos[rota];
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const veiculo = rotaVeiculoMap[rota] || 'Toco';
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingGeral${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral${index}"><strong>Rota: ${rota} (${veiculo})</strong> &nbsp; <span class="badge bg-secondary ms-2">${grupo.pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span></button></h2><div id="collapseGeral${index}" class="accordion-collapse collapse" data-bs-parent="#accordionGeral"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }

        function displayTresQuartos(div, loads) {
            if (loads.length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhuma carga 3/4 formada.</div>'; return; }
            let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h4 class="mb-0">Cargas 3/4 (Autom√°tico):</h4>${loads.length > 0 ? `<button class="btn btn-sm btn-outline-light no-print" onclick="imprimirCargasGeneric('${div.id}', 'Cargas 3/4 (Autom√°tico)', 'bg-warning', 'text-dark')">üñ®Ô∏è Imprimir Conclu√≠das</button>` : ''}</div>`;
            loads.forEach(load => {
                const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                html += `<div class="card mb-3"><div class="card-header bg-warning text-dark">Carga 3/4 #${load.numero} (Rota: ${load.rota}) - Total: ${totalKgFormatado} kg</div><div class="card-body">${createTable(load.pedidos)}</div></div>`;
            });
            div.innerHTML = html;
        }

        function separarCargasGeneric(routeOrRoutes, divId, title, vehicleType) {
            const resultadoDiv = document.getElementById(divId);
            resultadoDiv.innerHTML = '';
            if (planilhaData.length === 0) {
                resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; return;
            }

            const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [routeOrRoutes];

            const MIN_KG = parseFloat(document.getElementById(`${vehicleType}MinCapacity`).value) || defaultConfigs[`${vehicleType}MinCapacity`];
            const MAX_KG = parseFloat(document.getElementById(`${vehicleType}MaxCapacity`).value) || defaultConfigs[`${vehicleType}MaxCapacity`];
            const MAX_CUBAGEM = parseFloat(document.getElementById(`${vehicleType}Cubage`).value) || defaultConfigs[`${vehicleType}Cubage`];
            
            const pedidosRota = pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota)));
            const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO'];
            const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());

            let packableItems = [];
            const otherPedidos = pedidosRota.filter(p => !isSpecialClient(p));
            const specialPedidos = pedidosRota.filter(p => isSpecialClient(p));

            specialPedidos.forEach(pedido => { packableItems.push({ isSpecial: true, pedidos: [pedido], totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0, totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0, }); });

            const otherClientGroupsMap = otherPedidos.reduce((acc, pedido) => {
                const clienteId = pedido.Cliente; if (!acc[clienteId]) { acc[clienteId] = { isSpecial: false, pedidos: [], totalKg: 0, totalCubagem: 0 }; } acc[clienteId].pedidos.push(pedido); return acc;
            }, {});
            
            Object.values(otherClientGroupsMap).forEach(group => {
                group.totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                group.totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0);
                packableItems.push(group);
            });

            const priorityItems = packableItems.filter(item => item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            const regularItems = packableItems.filter(item => !item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))));
            priorityItems.sort((a, b) => b.totalKg - a.totalKg); regularItems.sort((a, b) => b.totalKg - a.totalKg);
            packableItems = [...priorityItems, ...regularItems];

            let loads = []; let leftoverItems = [];
            packableItems.forEach(item => {
                if (item.totalKg > MAX_KG || item.totalCubagem > MAX_CUBAGEM) { leftoverItems.push(item); return; }
                let placed = false;
                for (const load of loads) {
                    const specialCountInLoad = load.pedidos.filter(p => isSpecialClient(p)).length; const specialOrdersInItem = item.isSpecial ? item.pedidos.length : 0;
                    if ((load.totalKg + item.totalKg <= MAX_KG) && (load.totalCubagem + item.totalCubagem <= MAX_CUBAGEM) && (specialCountInLoad + specialOrdersInItem <= 2)) {
                        load.pedidos.push(...item.pedidos); load.totalKg += item.totalKg; load.totalCubagem += item.totalCubagem; placed = true; break;
                    }
                }
                if (!placed) { loads.push({ pedidos: [...item.pedidos], totalKg: item.totalKg, totalCubagem: item.totalCubagem, }); }
            });

            let finalLoads = []; let unplacedFromMinRule = [];
            loads.forEach(load => {
                const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                if (hasPriority || load.totalKg >= MIN_KG) { finalLoads.push(load); } else { unplacedFromMinRule.push(...load.pedidos); }
            });
            finalLoads.forEach((load, index) => { load.numero = index + 1; });
            
            if (vehicleType === 'fiorino') {
                CargasFiorinoFinalizadas.clear();
                finalLoads.forEach(load => {
                    const loadId = `fiorino-${title.replace(/\s+/g, '-')}-${load.numero}`;
                    load.id = loadId;
                    CargasFiorinoFinalizadas.set(loadId, load);
                });
            }

            let leftoverPedidos = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule);
            
            const vehicleInfo = {
                fiorino: { name: 'Fiorino', colorClass: 'bg-success', textColor: 'text-white' },
                van: { name: 'Van', colorClass: 'bg-primary', textColor: 'text-white' },
                tresQuartos: { name: '3/4', colorClass: 'bg-warning', textColor: 'text-dark' }
            };
            const vInfo = vehicleInfo[vehicleType];

            let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h4 class="mb-0">${finalLoads.length} Carga(s) de ${vInfo.name} para ${title}:</h4>${finalLoads.length > 0 ? `<button class="btn btn-sm btn-outline-light no-print" onclick="imprimirCargasGeneric('${divId}', 'Cargas de ${vInfo.name} - ${title}', '${vInfo.colorClass}', '${vInfo.textColor}')">üñ®Ô∏è Imprimir Conclu√≠das</button>` : ''}</div>`;
            if (finalLoads.length === 0) { html += `<p>Nenhuma carga de ${vInfo.name} foi formada.</p>`; }
            
            finalLoads.forEach(load => {
                const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const totalCubagemFormatado = load.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const isPriorityLoad = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)));
                const priorityBadge = isPriorityLoad ? '<span class="badge bg-light text-dark ms-3">PRIORIDADE</span>' : '';
                
                let fiorinoDistanceHtml = '';
                if (vehicleType === 'fiorino') {
                    fiorinoDistanceHtml = `
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top border-secondary">
                           <span id="dist-${load.id}"></span>
                           <button class="btn btn-outline-info btn-sm no-print" onclick="calcularDistanciaLocal('${load.id}')">üìç Calcular KM Estimado</button>
                        </div>`;
                }

                html += `
                    <div class="card mb-3 ${isPriorityLoad ? 'border-primary' : ''}">
                        <div class="card-header ${vInfo.colorClass} ${vInfo.textColor}">
                            ${vInfo.name} #${load.numero} - Total: ${totalKgFormatado} kg / ${totalCubagemFormatado} m¬≥ ${priorityBadge}
                        </div>
                        <div class="card-body">
                            ${createTable(load.pedidos)}
                            ${fiorinoDistanceHtml}
                        </div>
                    </div>`;
            });
            if (leftoverPedidos.length > 0) {
                const totalKgUnassigned = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                html += `<h5 class="mt-4">Pedidos restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h5><div class="card mb-3"><div class="card-header bg-danger text-white">Detalhes dos Pedidos Restantes</div><div class="card-body">${createTable(leftoverPedidos, ['Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cliente', 'Nome_Cliente', 'Cidade'])}</div></div>`;
            }
            resultadoDiv.innerHTML = html;
        }

        function separarCargasFiorino(routes, divId, title) { separarCargasGeneric(routes, divId, title, 'fiorino'); }
        function separarCargasVan(routes, divId, title) { separarCargasGeneric(routes, divId, title, 'van'); }
        function separarCargas34(routes, divId, title) { separarCargasGeneric(routes, divId, title, 'tresQuartos'); }

        function displayToco(div, grupos) {
            if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhuma carga toco encontrada.</div>'; return; }
            const MAX_KG_TOCO = parseFloat(document.getElementById('tocoMaxCapacity').value) || defaultConfigs.tocoMaxCapacity;
            
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionToco">';
            Object.keys(grupos).sort().forEach((cf, index) => {
                const grupo = grupos[cf]; const pedidos = grupo.pedidos;
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const overWeight = grupo.totalKg > MAX_KG_TOCO;
                const weightBadge = overWeight
                    ? `<span class="badge bg-danger ms-2">${totalKgFormatado} kg (ACIMA DO PESO!)</span>`
                    : `<span class="badge bg-info ms-2">${totalKgFormatado} kg</span>`;
                
                accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingToco${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToco${index}"><strong>CF: ${cf}</strong> &nbsp; <span class="badge bg-secondary ms-2">${pedidos.length} pedidos</span> ${weightBadge}</button></h2><div id="collapseToco${index}" class="accordion-collapse collapse" data-bs-parent="#accordionToco"><div class="accordion-body"><button class="btn btn-sm btn-outline-info mb-3 no-print" onclick="imprimirTocoIndividual('${cf}')">üñ®Ô∏è Imprimir esta Carga Toco</button>${createTable(pedidos)}</div></div></div>`;
            });
            accordionHtml += '</div>'; div.innerHTML = accordionHtml;
        }

        function imprimirCargasGeneric(divId, title, headerBgClass, headerTextClass) {
            const divToPrint = document.getElementById(divId);
            if (!divToPrint) return;

            const completedLoadsCards = divToPrint.querySelectorAll(`.card-header.${headerBgClass}`);
            if (completedLoadsCards.length === 0) {
                alert("Nenhuma carga conclu√≠da para imprimir."); return;
            }

            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Imprimir: ' + title + '</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write(`<style>
                body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .card { break-inside: avoid; margin-bottom: 1rem; page-break-inside: avoid; }
                .no-print { display: none !important; }
                .${headerBgClass} { background-color: ${getComputedStyle(document.querySelector(`.${headerBgClass}`)).backgroundColor} !important; }
                .${headerTextClass} { color: ${getComputedStyle(document.querySelector(`.${headerTextClass}`)).color} !important; }
                .table-responsive { overflow: visible !important; }
                table, th, td { border: 1px solid #dee2e6 !important; }
                h1, h2, h3, h4, h5 { margin-top: 1rem; margin-bottom: 0.5rem; }
            </style></head><body>`);
            
            let contentToPrint = `<h3>${title}</h3>`;
            completedLoadsCards.forEach(header => { contentToPrint += header.closest('.card.mb-3').outerHTML; });

            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function imprimirTocoIndividual(cf) {
            if (!gruposToco[cf]) { alert(`Nenhuma carga Toco encontrada para o CF: ${cf}`); return; }
            const grupo = gruposToco[cf]; const pedidos = grupo.pedidos;
            const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>Imprimir Carga Toco CF: ' + cf + '</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write(`<style>
                body { margin: 20px; }
                .table-responsive { overflow: visible !important; }
                table, th, td { border: 1px solid #dee2e6 !important; }
                h3 { margin-bottom: 1rem; }
            </style></head><body>`);
            
            let contentToPrint = `<h3>Carga Toco CF: ${cf} - Total: ${totalKgFormatado} kg</h3>` + createTable(pedidos);

            printWindow.document.body.innerHTML = contentToPrint;
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
