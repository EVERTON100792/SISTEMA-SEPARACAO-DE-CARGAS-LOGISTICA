<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separação de Cargas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #212529;
        }
        .card {
            background-color: #2b3035;
            border: 1px solid #495057;
        }
        .accordion-button {
            background-color: #343a40;
            color: #f8f9fa;
        }
        .accordion-button:not(.collapsed) {
            background-color: #0d6efd;
            color: white;
        }
        .accordion-body {
            background-color: #2b3035;
        }
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: var(--bs-table-striped-bg);
        }
        .status-message {
            min-height: 24px; /* Prevent layout shift */
        }
        @media print {
            body {
                background-color: #fff; /* White background for printing */
                color: #000; /* Black text for printing */
            }
            .container, .card, .accordion-item, .accordion-body {
                background-color: #fff !important;
                color: #000 !important;
                border: none !important;
                box-shadow: none !important;
            }
            /* Hide elements not relevant for printing */
            .d-flex.align-items-center.mb-3, /* Title and truck icon */
            .card.p-3.mb-4.shadow-sm, /* Input form */
            button, /* All buttons */
            .status-message, /* Status messages */
            .card-subtitle, /* Subtitles */
            .accordion-button.collapsed, /* Collapsed accordion buttons */
            .accordion-collapse.collapse { /* Collapsed accordion content */
                display: none !important;
            }
            /* Ensure tables are visible and well-formatted */
            .table-responsive {
                overflow: visible !important;
            }
            table, th, td {
                border: 1px solid #dee2e6 !important;
                color: #000 !important;
            }
            h3, h4, h5 {
                color: #000 !important;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            /* Ensure all accordion content is visible when printing */
            .accordion-collapse {
                display: block !important;
            }
            .accordion-button {
                display: block !important; /* Make accordion headers visible */
                background-color: #f8f9fa !important; /* Light background for headers */
                color: #000 !important;
                border: 1px solid #dee2e6 !important;
                margin-bottom: 0.5rem;
            }
            .accordion-button strong, .accordion-button .badge {
                color: #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-4">
        <div class="d-flex align-items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-truck me-3" viewBox="0 0 16 16"><path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-4 0a1 1 0 0 1-1-1V3.5ZM1.5 3a.5.5 0 0 0-.5.5V11h.5a1 1 0 0 1 1 1 1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V3.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v.364c-.606.252-1.134.63-1.562 1.136l-1.48-1.85A.5.5 0 0 0 9.02 3H1.5Zm3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm9 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/></svg>
            <h1 class="mb-0">Dashboard de Separação de Cargas</h1>
        </div>

        <div class="card p-3 mb-4 shadow-sm">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold">1. Selecione a Planilha:</label>
                    <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Defina a Faixa de Rotas (Opcional):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="rotaInicialInput" placeholder="Rota Inicial">
                        <input type="text" class="form-control" id="rotaFinalInput" placeholder="Rota Final">
                    </div>
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100" id="processarBtn" onclick="processar()" disabled>3. Processar Cargas</button>
                </div>
            </div>
            <div id="status" class="mt-2 status-message"></div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados das Cargas "Toco"</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Grupos de cargas onde a Coluna4/5 contém "TOCO" e o CF se repete.</p>
                        <div id="resultado-toco"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados Gerais</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Pedidos que não são 'Toco', agrupados por rota.</p>
                        <div id="resultado-geral"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Resultados Cargas 3/4</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Cargas formadas a partir de um pedido muito grande.</p>
                        <div id="resultado-tres-quartos"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="card-title h5">Separação de Cargas (Fiorino)</h2>
                        <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Fiorino para separar as cargas.</p>
                        
                        <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11101', 'resultado-fiorino-geral', 'Rota 11101')">Rota 11101</button>
                        <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11301', 'resultado-fiorino-geral', 'Rota 11301')">Rota 11301</button>
                        <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11311', 'resultado-fiorino-geral', 'Rota 11311')">Rota 11311</button>
                        <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11561', 'resultado-fiorino-geral', 'Rota 11561')">Rota 11561</button>
                        <button class="btn btn-success mt-2" onclick="separarCargasFiorino(['11721', '11731'], 'resultado-fiorino-geral', 'Rotas 11721 & 11731')">Rotas 11721 & 11731</button>
                        
                        <div id="resultado-fiorino-geral" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 mb-4">
                 <button class="btn btn-info mt-2" onclick="window.print()">Imprimir Todos os Resultados</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        let planilhaData = [];
        let pedidosGeraisAtuais = [];

        const distanciasCidades = {
            'LONDRINA': 25,
            'CAMBE': 15,
            'ARAPONGAS': 10,
            'APUCARANA': 30,
            'MARINGA': 65,
            'IBIPORA': 40,
            'SERTANOPOLIS': 60,
            'JATAIZINHO': 50,
            'CORNELIO PROCOPIO': 85,
            'BANDEIRANTES': 115,
            'SANTA MARIANA': 100,
            'JANDAIA DO SUL': 45,
            'MANDAGUARI': 80,
            'PORECATU': 85,
            'PARANAPOEMA': 130
        };

        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            statusDiv.innerHTML = '<p class="text-info">Carregando planilha...</p>';
            processarBtn.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    let headerRowIndex = -1, headers = [];
                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && row.includes('Cod_Rota')) {
                            headerRowIndex = i;
                            headers = row.map(h => String(h).trim());
                            break;
                        }
                    }
                    if (headerRowIndex === -1) throw new Error("Não foi possível encontrar a linha de cabeçalho com 'Cod_Rota'.");
                    const dataRows = rawData.slice(headerRowIndex + 1);
                    planilhaData = dataRows.map(row => {
                        const pedido = {};
                        headers.forEach((header, i) => { if (header) { pedido[header] = row[i] !== undefined ? row[i] : ''; } });
                        return pedido;
                    });
                    statusDiv.innerHTML = `<p class="text-success">Planilha "${file.name}" carregada. ${planilhaData.length} linhas prontas para processar.</p>`;
                    processarBtn.disabled = false;
                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Erro ao ler o arquivo:</strong> ${error.message}</p>`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function processar() {
            const resultadoGeralDiv = document.getElementById('resultado-geral');
            const resultadoTocoDiv = document.getElementById('resultado-toco');
            const resultadoTresQuartosDiv = document.getElementById('resultado-tres-quartos');
            try {
                if (planilhaData.length === 0) {
                    statusDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>';
                    return;
                }
                const rotaInicialInput = document.getElementById('rotaInicialInput').value;
                const rotaFinalInput = document.getElementById('rotaFinalInput').value;
                resultadoGeralDiv.innerHTML = '';
                resultadoTocoDiv.innerHTML = '';
                resultadoTresQuartosDiv.innerHTML = '';

                const pedidos = planilhaData.filter(p => String(p.Coluna4) != '500');

                const pedidosTocoBase = pedidos.filter(p => (p.Coluna4 && String(p.Coluna4).toUpperCase().includes('TOCO')) || (p.Coluna5 && String(p.Coluna5).toUpperCase().includes('TOCO')));
                const cfCounts = {};
                const isNumeric = (str) => /^\d+$/.test(str);
                pedidosTocoBase.forEach(p => { if (p.CF && isNumeric(String(p.CF))) { cfCounts[p.CF] = (cfCounts[p.CF] || 0) + 1; } });
                const cfsRepetidos = Object.keys(cfCounts).filter(cf => cfCounts[cf] > 1);
                const pedidosTocoFiltrados = pedidosTocoBase.filter(p => cfsRepetidos.includes(String(p.CF)));
                const gruposToco = pedidosTocoFiltrados.reduce((acc, p) => {
                    const cf = p.CF;
                    if (!acc[cf]) { acc[cf] = { pedidos: [], totalKg: 0 }; }
                    acc[cf].pedidos.push(p);
                    acc[cf].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                    return acc;
                }, {});
                displayToco(resultadoTocoDiv, gruposToco);

                const tocoPedidoIds = new Set(pedidosTocoFiltrados.map(p => String(p.Num_Pedido)));
                const clientesComBloqueio = new Set();
                const clientesSemBloqueio = new Set();
                pedidos.forEach(p => { if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') { clientesComBloqueio.add(String(p.Cliente)); } else { clientesSemBloqueio.add(String(p.Cliente)); } });
                const clientesParaRemover = new Set([...clientesComBloqueio].filter(c => clientesSemBloqueio.has(c)));
                const rotaMin = rotaInicialInput ? parseInt(rotaInicialInput, 10) : 11101;
                const rotaMax = rotaFinalInput ? parseInt(rotaFinalInput, 10) : 11731;
                const pedidosGeraisFiltrados = pedidos.filter(p => {
                    if (tocoPedidoIds.has(String(p.Num_Pedido))) return false;
                    if (['21', '23', '17'].includes(String(p.Coluna4))) return false;
                    const rotaAtualNum = parseInt(String(p.Cod_Rota), 10);
                    if ((rotaAtualNum === 11311 || rotaAtualNum === 11521 || rotaAtualNum === 11361) && isNumeric(String(p.CF))) {
                        return false;
                    }
                    if (!(rotaAtualNum >= rotaMin && rotaAtualNum <= rotaMax)) return false;
                    if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') return false;
                    if (clientesParaRemover.has(String(p.Cliente))) return false;
                    return true;
                });

                let tresQuartosLoads = [];
                const MIN_KG_3_4 = 2300;
                const MAX_KG_3_4 = 4100;
                const LARGE_ORDER_KG = 1700;

                const largeOrdersByRoute = pedidosGeraisFiltrados.reduce((acc, p) => {
                    const peso = parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                    if (peso >= LARGE_ORDER_KG) {
                        const rota = p.Cod_Rota;
                        if (!acc[rota]) acc[rota] = [];
                        acc[rota].push(p);
                    }
                    return acc;
                }, {});

                const pedidosEmCargas3_4 = new Set();

                Object.keys(largeOrdersByRoute).forEach(rota => {
                    const largeOrders = largeOrdersByRoute[rota];
                    if (largeOrders.length === 1) {
                        const largeOrder = largeOrders[0];
                        if (pedidosEmCargas3_4.has(largeOrder.Num_Pedido)) return;

                        let newLoad = {
                            pedidos: [largeOrder],
                            totalKg: parseFloat(String(largeOrder.Quilos_Saldo).replace(',', '.')) || 0,
                            rota: rota
                        };

                        const otherOrdersInRoute = pedidosGeraisFiltrados
                            .filter(p => p.Cod_Rota === rota && p.Num_Pedido !== largeOrder.Num_Pedido)
                            .sort((a, b) => (parseFloat(String(b.Quilos_Saldo).replace(',', '.')) || 0) - (parseFloat(String(a.Quilos_Saldo).replace(',', '.')) || 0));

                        for (const order of otherOrdersInRoute) {
                            if (pedidosEmCargas3_4.has(order.Num_Pedido)) continue;
                            const orderKg = parseFloat(String(order.Quilos_Saldo).replace(',', '.')) || 0;
                            if (newLoad.totalKg + orderKg <= MAX_KG_3_4) {
                                newLoad.pedidos.push(order);
                                newLoad.totalKg += orderKg;
                            }
                        }

                        if (newLoad.totalKg >= MIN_KG_3_4) {
                            tresQuartosLoads.push(newLoad);
                            newLoad.pedidos.forEach(p => pedidosEmCargas3_4.add(p.Num_Pedido));
                        }
                    }
                });

                tresQuartosLoads.forEach((load, index) => { load.numero = index + 1; });
                displayTresQuartos(resultadoTresQuartosDiv, tresQuartosLoads);

                pedidosGeraisAtuais = pedidosGeraisFiltrados.filter(p => !pedidosEmCargas3_4.has(p.Num_Pedido));
                
                const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => {
                    const rota = p.Cod_Rota;
                    if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; }
                    acc[rota].pedidos.push(p);
                    acc[rota].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0;
                    return acc;
                }, {});
                displayGerais(resultadoGeralDiv, gruposGerais);

            } catch (error) {
                statusDiv.innerHTML = `<p class="text-danger"><strong>Ocorreu um erro:</strong></p><pre>${error.stack}</pre>`;
                console.error(error);
            }
        }

        function createTable(pedidos, columnsToDisplay) {
            if (!pedidos || pedidos.length === 0) return '';
            const colunasExibir = columnsToDisplay || ['Cod_Rota', 'Cliente', 'Nome_Cliente', 'Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cidade', 'BLOQ.', 'Coluna4', 'Coluna5', 'CF'];
            let table = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped"><thead><tr>';
            colunasExibir.forEach(c => table += `<th>${c}</th>`);
            table += '</tr></thead><tbody>';
            pedidos.forEach(p => {
                table += '<tr>';
                colunasExibir.forEach(c => table += `<td>${p[c] === undefined || p[c] === null ? '' : p[c]}</td>`);
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

        function displayGerais(div, grupos) {
            if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhum pedido geral encontrado.</div>'; return; }
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionGeral">';
            Object.keys(grupos).sort().forEach((rota, index) => {
                const grupo = grupos[rota];
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                accordionHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingGeral${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral${index}">
                                <strong>Rota: ${rota}</strong> &nbsp; <span class="badge bg-secondary ms-2">${grupo.pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span>
                            </button>
                        </h2>
                        <div id="collapseGeral${index}" class="accordion-collapse collapse" data-bs-parent="#accordionGeral"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div>
                    </div>`;
            });
            accordionHtml += '</div>';
            div.innerHTML = accordionHtml;
        }

        function displayTresQuartos(div, loads) {
            if (loads.length === 0) {
                div.innerHTML = '<div class="text-center p-3">Nenhuma carga 3/4 formada.</div>';
                return;
            }
            let html = '';
            loads.forEach(load => {
                const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            Carga 3/4 #${load.numero} (Rota: ${load.rota}) - Total: ${totalKgFormatado} kg
                        </div>
                        <div class="card-body">
                            ${createTable(load.pedidos)}
                        </div>
                    </div>
                `;
            });
            div.innerHTML = html;
        }

        function separarCargasFiorino(routeOrRoutes, divId, title) {
            const resultadoDiv = document.getElementById(divId);
            resultadoDiv.innerHTML = '';
            if (planilhaData.length === 0) {
                resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>';
                return;
            }

            const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [routeOrRoutes];
            
            const MAX_KG_FIORINO = 570;
            const MAX_CUBAGEM_FIORINO = 1.5;
            const MIN_KG_FIORINO = 330;
            const MIN_KG_VAN = 1040;
            const MAX_KG_VAN = 1550;
            const MAX_CUBAGEM_VAN = 5.50;

            const pedidosRota = pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota)));
            const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO'];
            const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim());

            let packableItems = [];
            const otherPedidos = pedidosRota.filter(p => !isSpecialClient(p));
            const specialPedidos = pedidosRota.filter(p => isSpecialClient(p));

            specialPedidos.forEach(pedido => {
                packableItems.push({
                    isSpecial: true,
                    pedidos: [pedido],
                    totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0,
                    totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0,
                });
            });

            const otherClientGroupsMap = otherPedidos.reduce((acc, pedido) => {
                const clienteId = pedido.Cliente;
                if (!acc[clienteId]) {
                    acc[clienteId] = { isSpecial: false, pedidos: [], totalKg: 0, totalCubagem: 0 };
                }
                acc[clienteId].pedidos.push(pedido);
                return acc;
            }, {});
            
            Object.values(otherClientGroupsMap).forEach(group => {
                group.totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                group.totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0);
                packableItems.push(group);
            });

            packableItems.sort((a, b) => b.totalKg - a.totalKg);

            let fiorinoLoads = [];
            let leftoverItems = [];

            packableItems.forEach(item => {
                if (item.totalKg > MAX_KG_FIORINO || item.totalCubagem > MAX_CUBAGEM_FIORINO) {
                    leftoverItems.push(item);
                    return;
                }

                let placed = false;
                for (const fiorino of fiorinoLoads) {
                    const specialCountInFiorino = fiorino.pedidos.filter(p => isSpecialClient(p)).length;
                    const specialOrdersInItem = item.isSpecial ? item.pedidos.length : 0;

                    if ( (fiorino.totalKg + item.totalKg <= MAX_KG_FIORINO) &&
                         (fiorino.totalCubagem + item.totalCubagem <= MAX_CUBAGEM_FIORINO) &&
                         (specialCountInFiorino + specialOrdersInItem <= 2) )
                    {
                        fiorino.pedidos.push(...item.pedidos);
                        fiorino.totalKg += item.totalKg;
                        fiorino.totalCubagem += item.totalCubagem;
                        placed = true;
                        break;
                    }
                }

                if (!placed) {
                    fiorinoLoads.push({
                        pedidos: [...item.pedidos],
                        totalKg: item.totalKg,
                        totalCubagem: item.totalCubagem,
                    });
                }
            });

            let finalFiorinoLoads = [];
            let unplacedFromMinRule = [];
            fiorinoLoads.forEach(fiorino => {
                if (fiorino.totalKg >= MIN_KG_FIORINO) {
                    finalFiorinoLoads.push(fiorino);
                } else {
                    unplacedFromMinRule.push(...fiorino.pedidos);
                }
            });

            finalFiorinoLoads.forEach(fiorino => {
                let maxDist = 0;
                const cities = new Set(fiorino.pedidos.map(p => p.Cidade.toUpperCase().trim()));
                for (const city of cities) {
                    const dist = distanciasCidades[city] || 0;
                    if (dist > maxDist) {
                        maxDist = dist;
                    }
                }
                fiorino.distancia = maxDist * 2; // Round trip
            });

            finalFiorinoLoads.sort((a, b) => b.distancia - a.distancia);
            finalFiorinoLoads.forEach((f, index) => f.numero = index + 1);

            let leftoverPedidos = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule);
            
            let vanLoad = null;
            let trulyUnassignedPedidos = [];
            const totalLeftoverKg = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
            const totalLeftoverCubagem = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0);

            if (totalLeftoverKg >= MIN_KG_VAN && totalLeftoverKg <= MAX_KG_VAN && totalLeftoverCubagem <= MAX_CUBAGEM_VAN) {
                vanLoad = {
                    pedidos: leftoverPedidos,
                    totalKg: totalLeftoverKg,
                    totalCubagem: totalLeftoverCubagem,
                    numero: 1
                };
            } else {
                trulyUnassignedPedidos = leftoverPedidos;
            }

            let html = `<h3>${finalFiorinoLoads.length} Carga(s) de Fiorino para ${title}:</h3>`;
            if (finalFiorinoLoads.length === 0) {
                html += '<p>Nenhuma carga de Fiorino foi formada.</p>';
            }
            finalFiorinoLoads.forEach((fiorino, index) => {
                const totalKgFormatado = fiorino.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const totalCubagemFormatado = fiorino.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const distanciaFormatada = fiorino.distancia > 0 ? `(Aprox. ${fiorino.distancia} km)` : '';

                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            Fiorino ${fiorino.numero} - Total: ${totalKgFormatado} kg / ${totalCubagemFormatado} cubagem ${distanciaFormatada}
                        </div>
                        <div class="card-body">
                            ${createTable(fiorino.pedidos)}
                        </div>
                    </div>
                `;
            });

            if (vanLoad) {
                html += `<h3 class="mt-4">1 Carga de Van:</h3>`;
                const totalKgFormatado = vanLoad.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const totalCubagemFormatado = vanLoad.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            Van 1 - Total: ${totalKgFormatado} kg / ${totalCubagemFormatado} cubagem
                        </div>
                        <div class="card-body">
                            ${createTable(vanLoad.pedidos)}
                        </div>
                    </div>
                `;
            }

            if (trulyUnassignedPedidos.length > 0) {
                const totalKgUnassigned = trulyUnassignedPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0);
                html += `<h4 class="mt-4">Pedidos restantes (não couberam em Fiorinos ou Vans): ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h4>`;
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-danger text-white">
                            Detalhes dos Pedidos Restantes
                        </div>
                        <div class="card-body">
                            ${createTable(trulyUnassignedPedidos, ['Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cliente', 'Nome_Cliente', 'Cidade'])}
                        </div>
                    </div>
                `;
            }
            
            resultadoDiv.innerHTML = html;
        }

        function displayToco(div, grupos) {
            if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhuma carga toco encontrada.</div>'; return; }
            let accordionHtml = '<div class="accordion accordion-flush" id="accordionToco">';
            Object.keys(grupos).sort().forEach((cf, index) => {
                const grupo = grupos[cf];
                const pedidos = grupo.pedidos;
                const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                accordionHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingToco${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToco${index}">
                                <strong>CF: ${cf}</strong> &nbsp; <span class="badge bg-secondary ms-2">${pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span>
                            </button>
                        </h2>
                        <div id="collapseToco${index}" class="accordion-collapse collapse" data-bs-parent="#accordionToco"><div class="accordion-body">${createTable(pedidos)}</div></div>
                    </div>`;
            });
            accordionHtml += '</div>';
            div.innerHTML = accordionHtml;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
