<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Separação de Cargas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #212529; }
        .card { background-color: #2b3035; border: 1px solid #495057; }
        .accordion-button { background-color: #343a40; color: #f8f9fa; }
        .accordion-button:not(.collapsed) { background-color: #0d6efd; color: white; }
        .accordion-body { background-color: #2b3035; }
        .table-striped>tbody>tr:nth-of-type(odd)>* { --bs-table-accent-bg: var(--bs-table-striped-bg); }
        .status-message { min-height: 24px; }
        .btn-success, .btn-primary, .btn-warning { transition: all 0.2s ease-in-out; }
        .btn-success:hover, .btn-primary:hover, .btn-warning:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .progress-container { width: 100%; font-size: 0.8em; margin-top: 5px; }
        @media print {
            body { background-color: #fff; color: #000; }
            .container, .card, .accordion-item, .accordion-body { background-color: #fff !important; color: #000 !important; border: none !important; box-shadow: none !important; }
            .d-flex.align-items-center.mb-3, .card.p-3.mb-4.shadow-sm, button, .status-message, .card-subtitle, .accordion-button.collapsed, .accordion-collapse.collapse { display: none !important; }
            .table-responsive { overflow: visible !important; }
            table, th, td { border: 1px solid #dee2e6 !important; color: #000 !important; }
            h3, h4, h5 { color: #000 !important; margin-top: 1rem; margin-bottom: 0.5rem; }
            .accordion-collapse { display: block !important; }
            .accordion-button { display: block !important; background-color: #f8f9fa !important; color: #000 !important; border: 1px solid #dee2e6 !important; margin-bottom: 0.5rem; }
            .accordion-button strong, .accordion-button .badge { color: #000 !important; }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-4">
        <div class="d-flex align-items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-truck me-3" viewBox="0 0 16 16"><path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-4 0a1 1 0 0 1-1-1V3.5ZM1.5 3a.5.5 0 0 0-.5.5V11h.5a1 1 0 0 1 1 1 1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V3.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v.364c-.606.252-1.134.63-1.562 1.136l-1.48-1.85A.5.5 0 0 0 9.02 3H1.5Zm3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm9 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/></svg>
            <h1 class="mb-0">Dashboard de Separação de Cargas</h1>
        </div>

        <div class="card p-3 mb-4 shadow-sm">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold">1. Selecione a Planilha:</label>
                    <input class="form-control" type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Defina a Faixa de Rotas (Opcional):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="rotaInicialInput" placeholder="Rota Inicial">
                        <input type="text" class="form-control" id="rotaFinalInput" placeholder="Rota Final">
                    </div>
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100" id="processarBtn" onclick="processar()" disabled>3. Processar Cargas</button>
                </div>
            </div>
            <div id="status" class="mt-2 status-message"></div>
        </div>
        
        <div class="row">
            <div class="col-lg-12 mb-4"> <div class="card shadow-sm h-100"> <div class="card-body"> <h2 class="card-title h5">Resultados Gerais</h2> <p class="card-subtitle mb-2 text-body-secondary small">Pedidos que não são 'Toco', agrupados por rota.</p> <div class="input-group mb-3"> <input type="text" id="pedidoSearchInput" class="form-control" placeholder="Buscar por Nº do Pedido..."> <button class="btn btn-outline-secondary" type="button" onclick="buscarPedido()">Buscar</button> </div> <div id="search-result" class="mb-3"></div> <div id="resultado-geral"></div> </div> </div> </div>
            <div class="col-lg-12 mb-4"> <div class="card shadow-sm h-100"> <div class="card-body"> <h2 class="card-title h5">Separação de Cargas (Fiorino)</h2> <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Fiorino para separar as cargas.</p> <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11101', 'resultado-fiorino-geral', 'Rota 11101')">Rota 11101</button> <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11301', 'resultado-fiorino-geral', 'Rota 11301')">Rota 11301</button> <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11311', 'resultado-fiorino-geral', 'Rota 11311')">Rota 11311</button> <button class="btn btn-success mt-2" onclick="separarCargasFiorino('11561', 'resultado-fiorino-geral', 'Rota 11561')">Rota 11561</button> <button class="btn btn-success mt-2" onclick="separarCargasFiorino(['11721', '11731'], 'resultado-fiorino-geral', 'Rotas 11721 & 11731')">Rotas 11721 & 11731</button> <div id="resultado-fiorino-geral" class="mt-3"></div> </div> </div> </div>
            <div class="col-lg-12 mb-4"> <div class="card shadow-sm h-100"> <div class="card-body"> <h2 class="card-title h5">Separação de Cargas (Van)</h2> <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de Van para separar as cargas.</p> <div class="dropdown d-inline-block"> <button class="btn btn-primary dropdown-toggle mt-2" type="button" data-bs-toggle="dropdown" aria-expanded="false"> Selecione a Rota (Van) </button> <ul class="dropdown-menu"> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11102', 'resultado-van-geral', 'Rota 11102')">Rota 11102</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11331', 'resultado-van-geral', 'Rota 11331')">Rota 11331</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11341', 'resultado-van-geral', 'Rota 11341')">Rota 11341</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11342', 'resultado-van-geral', 'Rota 11342')">Rota 11342</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11351', 'resultado-van-geral', 'Rota 11351')">Rota 11351</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11521', 'resultado-van-geral', 'Rota 11521')">Rota 11521</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11531', 'resultado-van-geral', 'Rota 11531')">Rota 11531</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11551', 'resultado-van-geral', 'Rota 11551')">Rota 11551</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11571', 'resultado-van-geral', 'Rota 11571')">Rota 11571</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11701', 'resultado-van-geral', 'Rota 11701')">Rota 11701</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargasVan('11711', 'resultado-van-geral', 'Rota 11711')">Rota 11711</a></li> </ul> </div> <div id="resultado-van-geral" class="mt-3"></div> </div> </div> </div>
            <div class="col-lg-12 mb-4"> <div class="card shadow-sm h-100"> <div class="card-body"> <h2 class="card-title h5">Separação de Cargas (3/4)</h2> <p class="card-subtitle mb-2 text-body-secondary small">Selecione uma rota de 3/4 para separar as cargas.</p> <div class="dropdown d-inline-block"> <button class="btn btn-warning dropdown-toggle mt-2" type="button" data-bs-toggle="dropdown" aria-expanded="false"> Selecione a Rota (3/4) </button> <ul class="dropdown-menu"> <li><a class="dropdown-item" href="#" onclick="separarCargas34('11361', 'resultado-34-geral', 'Rota 11361')">Rota 11361</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargas34(['11501', '11502', '11511'], 'resultado-34-geral', 'Rotas 11501, 11502 & 11511')">Rotas 11501, 11502 & 11511</a></li> <li><a class="dropdown-item" href="#" onclick="separarCargas34('11541', 'resultado-34-geral', 'Rota 11541')">Rota 11541</a></li> </ul> </div> <div id="resultado-34-geral" class="mt-3"></div> </div> </div> </div>
            <div class="col-lg-12 mb-4"> <div class="card shadow-sm h-100"> <div class="card-body"> <h2 class="card-title h5">Resultados Cargas 3/4 (Automático)</h2> <p class="card-subtitle mb-2 text-body-secondary small">Cargas formadas a partir de um pedido muito grande.</p> <div id="resultado-tres-quartos"></div> </div> </div> </div>
            <div class="col-lg-12 mb-4"> <div class="card shadow-sm h-100"> <div class="card-body"> <h2 class="card-title h5">Resultados das Cargas "Toco"</h2> <p class="card-subtitle mb-2 text-body-secondary small">Grupos de cargas onde a Coluna4/5 contém "TOCO" e o CF se repete.</p> <div id="resultado-toco"></div> </div> </div> </div>
            <div class="col-lg-12 mb-4"> <button class="btn btn-info mt-2" onclick="window.print()">Imprimir Todos os Resultados</button> </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        // Variáveis de estado da aplicação
        let planilhaData = [];
        let pedidosGeraisAtuais = [];
        let gruposToco = {};
        let pedidosPrioritarios = [];
        let tocoPedidoIds = new Set();

        const distanciasCidades = {
             'LONDRINA': 25, 'CAMBE': 15, 'ARAPONGAS': 10, 'APUCARANA': 30, 'MARINGA': 60, 'IBIPORA': 40, 'SERTANOPOLIS': 60, 'JATAIZINHO': 50, 'CORNELIO PROCOPIO': 85, 'BANDEIRANTES': 115, 'SANTA MARIANA': 100, 'JANDAIA DO SUL': 45, 'MANDAGUARI': 80, 'PORECATU': 85, 'PARANAPOEMA': 130, 'ITAMBARACA': 85, 'CURITIBA': 400, 'PONTA GROSSA': 300, 'IMBAU': 200, 'ORTIGUEIRA': 180, 'MAUA DA SERRA': 100, 'CALIFORNIA': 50, 'CAMPO LARGO': 380, 'SAO JOSE DOS PINHAIS': 420, 'FOZ DO IGUACU': 550, 'COLOMBO': 410, 'GUARAPUAVA': 350, 'PARANAGUA': 450, 'TOLEDO': 400, 'PINHAIS': 400, 'ARAUCARIA': 400, 'UMUARAMA': 250, 'PARANAVAI': 150, 'FRANCISCO BELTRAO': 450, 'CAMPO MOURAO': 180, 'SARANDI': 70, 'PATO BRANCO': 400, 'TELEMACO BORBA': 250, 'CASTRO': 300, 'IRATI': 350, 'UNIAO DA VITORIA': 450, 'PRUDENTOPOLIS': 300, 'MARECHAL CANDIDO RONDON': 400, 'SANTO ANTONIO DA PLATINA': 150, 'LAPA': 400, 'PALMAS': 450, 'SAO MATEUS DO SUL': 400, 'JACAREZINHO': 150, 'MEDIANEIRA': 500, 'PAICANDU': 70, 'GUARATUBA': 500, 'JAGUARIAIVA': 200, 'RIO BRANCO DO SUL': 400, 'PALMEIRA': 350, 'QUEDAS DO IGUACU': 450, 'LARANJEIRAS DO SUL': 350, 'GUAIRA': 300, 'GOIOERE': 150, 'IBAITI': 150, 'PALOTINA': 350, 'IMBITUVA': 300, 'ARAPOTI': 200, 'NOVA ESPERANCA': 100, 'RESERVA': 200, 'ASTORGA': 50, 'CAMBARA': 100, 'CAMPO MAGRO': 400, 'PIRAI DO SUL': 250, 'MATINHOS': 500, 'ITAPERUCU': 400, 'CORONEL VIVIDA': 400, 'ANDIRA': 100, 'MANDIRITUBA': 400, 'CRUZEIRO DO OESTE': 200, 'SANTA TEREZINHA DE ITAIPU': 550, 'SENGES': 200,
        };

        // Elementos do DOM
        const fileInput = document.getElementById('fileInput');
        const processarBtn = document.getElementById('processarBtn');
        const statusDiv = document.getElementById('status');
        
        // --- LÓGICA DE LEITURA DE ARQUIVO (SIMPLIFICADA E COM DIAGNÓSTICO) ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            statusDiv.innerHTML = '<p class="text-info">Lendo a planilha, por favor aguarde...</p>';
            processarBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    let headerRowIndex = -1;
                    let headers = [];
                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && Array.isArray(row) && row.includes('Cod_Rota')) {
                            headerRowIndex = i;
                            headers = row.map(h => String(h || '').trim());
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error("A coluna 'Cod_Rota' não foi encontrada na planilha. Verifique o título da coluna.");
                    }

                    const dataRows = rawData.slice(headerRowIndex + 1);
                    planilhaData = dataRows.map(row => {
                        const pedido = {};
                        headers.forEach((header, i) => {
                            if (header) {
                                pedido[header] = row[i] !== undefined ? row[i] : '';
                            }
                        });
                        return pedido;
                    });
                    
                    // DIAGNÓSTICO DE SUCESSO
                    alert("Planilha lida com sucesso! O botão 'Processar Cargas' será habilitado.");
                    
                    statusDiv.innerHTML = `<p class="text-success">Planilha "${file.name}" carregada. ${planilhaData.length} linhas prontas para processar.</p>`;
                    processarBtn.disabled = false; // <<< HABILITA O BOTÃO

                } catch (error) {
                    // DIAGNÓSTICO DE ERRO
                    alert(`Ocorreu um erro ao ler a planilha: ${error.message}. Verifique o console (F12) para mais detalhes.`);
                    
                    statusDiv.innerHTML = `<p class="text-danger"><strong>Erro ao ler o arquivo:</strong> ${error.message}</p>`;
                    console.error("Erro detalhado:", error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // O RESTANTE DO CÓDIGO PERMANECE IGUAL AO SEU ORIGINAL COM AS MELHORIAS VISUAIS
        
        function calculateEstimatedDistance(pedidos) { /* ...código sem alteração... */ }
        function buscarPedido() { /* ...código sem alteração... */ }
        function priorizarPedido(numPedido) { /* ...código sem alteração... */ }
        function highlightPedido(numPedido) { /* ...código sem alteração... */ }
        function processar() { /* ...código sem alteração... */ }
        function createTable(pedidos, columnsToDisplay) { /* ...código sem alteração... */ }
        function displayGerais(div, grupos) { /* ...código sem alteração... */ }
        function displayTresQuartos(div, loads) { /* ...código com barra de progresso... */ }
        function separarCargas34(routeOrRoutes, divId, title) { /* ...código com barra de progresso... */ }
        function separarCargasVan(routeOrRoutes, divId, title) { /* ...código com barra de progresso... */ }
        function separarCargasFiorino(routeOrRoutes, divId, title) { /* ...código com barra de progresso... */ }
        function displayToco(div, grupos) { /* ...código sem alteração... */ }
        function genericPrint(title, content, style) { /* ...código sem alteração... */ }
        function imprimirCargas(divId) { /* ...código sem alteração... */ }
        function imprimirCargasVan(divId) { /* ...código sem alteração... */ }
        function imprimirCargas34(divId) { /* ...código sem alteração... */ }
        function imprimirCargasTresQuartosAutomatico(divId) { /* ...código sem alteração... */ }
        function imprimirTocoIndividual(cf) { /* ...código sem alteração... */ }

        // --- CÓPIAS DAS FUNÇÕES COM MELHORIAS VISUAIS ---
        
        calculateEstimatedDistance = function(pedidos) { const uniqueCities = new Set(); pedidos.forEach(p => { if (p.Cidade) { uniqueCities.add(String(p.Cidade).toUpperCase().trim()); } }); let totalDistance = 0; uniqueCities.forEach(city => { totalDistance += distanciasCidades[city] || 0; }); return totalDistance * 1.50; }
        buscarPedido = function() { const searchInput = document.getElementById('pedidoSearchInput').value.trim(); const searchResultDiv = document.getElementById('search-result'); searchResultDiv.innerHTML = ''; if (!searchInput) return; if (planilhaData.length === 0) { searchResultDiv.innerHTML = '<p class="text-warning">Por favor, carregue e processe a planilha primeiro.</p>'; return; } let pedidoEncontrado = null, local = 'Não encontrado', accordionId = ''; pedidoEncontrado = pedidosGeraisAtuais.find(p => String(p.Num_Pedido) === searchInput); if (pedidoEncontrado) { local = 'Resultados Gerais'; accordionId = 'accordionGeral'; } if (!pedidoEncontrado) { for (const cf in gruposToco) { pedidoEncontrado = gruposToco[cf].pedidos.find(p => String(p.Num_Pedido) === searchInput); if (pedidoEncontrado) { local = `Cargas "Toco" (CF: ${cf})`; accordionId = 'accordionToco'; break; } } } if (!pedidoEncontrado) { const originalPedido = planilhaData.find(p => String(p.Num_Pedido) === searchInput); if (originalPedido) { pedidoEncontrado = originalPedido; if (tocoPedidoIds.has(String(originalPedido.Num_Pedido))) { local = 'Filtrado (pertence a um grupo Toco)'; } else if (['21', '23', '17'].includes(String(originalPedido.Coluna4))) { local = 'Filtrado (Coluna4 é 21, 23, ou 17)'; } else if (String(originalPedido['BLOQ.']) === 'C' || String(originalPedido['BLOQ.']) === 'V') { local = 'Filtrado (Bloqueio C ou V)'; } else { local = 'Filtrado (outro motivo, verifique filtros de rota ou cliente)'; } } } if (pedidoEncontrado) { let buttons = ''; if (local === 'Resultados Gerais') { const isPrioritized = pedidosPrioritarios.includes(String(pedidoEncontrado.Num_Pedido)); buttons = `<button class="btn btn-primary btn-sm" onclick="priorizarPedido('${pedidoEncontrado.Num_Pedido}')" ${isPrioritized ? 'disabled' : ''}>${isPrioritized ? 'Prioridade Marcada' : 'Marcar como Prioridade'}</button> <button class="btn btn-secondary btn-sm ms-2" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`; } else if (accordionId) { buttons = `<button class="btn btn-secondary btn-sm" onclick="highlightPedido('${pedidoEncontrado.Num_Pedido}')">Destacar na Lista</button>`; } searchResultDiv.innerHTML = `<div class="alert alert-info"><h5>Pedido ${searchInput} encontrado!</h5><p class="mb-1"><strong>Local:</strong> ${local}</p><p class="mb-1"><strong>Cliente:</strong> ${pedidoEncontrado.Nome_Cliente}<br><strong>Peso:</strong> ${pedidoEncontrado.Quilos_Saldo} kg</p>${buttons ? `<div class="mt-2">${buttons}</div>` : ''}</div>`; } else { searchResultDiv.innerHTML = '<p class="text-danger">Pedido não encontrado em nenhuma das listas.</p>'; } }
        priorizarPedido = function(numPedido) { if (!pedidosPrioritarios.includes(numPedido)) { pedidosPrioritarios.push(numPedido); buscarPedido(); } }
        highlightPedido = function(numPedido) { const row = document.getElementById(`pedido-${numPedido}`); if (row) { row.classList.toggle('table-info'); if (row.classList.contains('table-info')) { const collapseEl = row.closest('.accordion-collapse'); if (collapseEl && !collapseEl.classList.contains('show')) { bootstrap.Collapse.getOrCreateInstance(collapseEl).show(); } setTimeout(() => { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 350); } } }
        processar = function() { const loadingModalEl = document.getElementById('loadingModal'); const loadingModal = new bootstrap.Modal(loadingModalEl); const loadingModalText = document.getElementById('loadingModalText'); loadingModalText.textContent = 'Processando cargas...'; loadingModal.show(); setTimeout(() => { const resultadoGeralDiv = document.getElementById('resultado-geral'); const resultadoTocoDiv = document.getElementById('resultado-toco'); const resultadoTresQuartosDiv = document.getElementById('resultado-tres-quartos'); try { if (planilhaData.length === 0) { statusDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; return; } const rotaInicialInput = document.getElementById('rotaInicialInput').value; const rotaFinalInput = document.getElementById('rotaFinalInput').value; resultadoGeralDiv.innerHTML = ''; resultadoTocoDiv.innerHTML = ''; resultadoTresQuartosDiv.innerHTML = ''; const pedidos = planilhaData.filter(p => String(p.Coluna4) != '500'); const pedidosTocoBase = pedidos.filter(p => (p.Coluna4 && String(p.Coluna4).toUpperCase().includes('TOCO')) || (p.Coluna5 && String(p.Coluna5).toUpperCase().includes('TOCO'))); const cfCounts = {}; const isNumeric = (str) => /^\d+$/.test(str); pedidosTocoBase.forEach(p => { if (p.CF && isNumeric(String(p.CF))) { cfCounts[p.CF] = (cfCounts[p.CF] || 0) + 1; } }); const cfsRepetidos = Object.keys(cfCounts).filter(cf => cfCounts[cf] > 1); const pedidosTocoFiltrados = pedidosTocoBase.filter(p => cfsRepetidos.includes(String(p.CF))); gruposToco = pedidosTocoFiltrados.reduce((acc, p) => { const cf = p.CF; if (!acc[cf]) { acc[cf] = { pedidos: [], totalKg: 0 }; } acc[cf].pedidos.push(p); acc[cf].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc; }, {}); displayToco(resultadoTocoDiv, gruposToco); tocoPedidoIds = new Set(pedidosTocoFiltrados.map(p => String(p.Num_Pedido))); const clientesComBloqueio = new Set(); const clientesSemBloqueio = new Set(); pedidos.forEach(p => { if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') { clientesComBloqueio.add(String(p.Cliente)); } else { clientesSemBloqueio.add(String(p.Cliente)); } }); const clientesParaRemover = new Set([...clientesComBloqueio].filter(c => clientesSemBloqueio.has(c))); const rotaMin = rotaInicialInput ? parseInt(rotaInicialInput, 10) : 11101; const rotaMax = rotaFinalInput ? parseInt(rotaFinalInput, 10) : 11731; const pedidosGeraisFiltrados = pedidos.filter(p => { if (tocoPedidoIds.has(String(p.Num_Pedido))) return false; if (['21', '23', '17'].includes(String(p.Coluna4))) return false; const rotaAtualNum = parseInt(String(p.Cod_Rota), 10); if ((rotaAtualNum === 11311 || rotaAtualNum === 11521 || rotaAtualNum === 11361) && isNumeric(String(p.CF))) { return false; } if (!(rotaAtualNum >= rotaMin && rotaAtualNum <= rotaMax)) return false; if (String(p['BLOQ.']) === 'C' || String(p['BLOQ.']) === 'V') return false; if (clientesParaRemover.has(String(p.Cliente))) return false; return true; }); let tresQuartosLoads = []; const MIN_KG_3_4 = 2300; const MAX_KG_3_4 = 4100; const LARGE_ORDER_KG = 1700; const largeOrdersByRoute = pedidosGeraisFiltrados.reduce((acc, p) => { const peso = parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; if (peso >= LARGE_ORDER_KG) { const rota = p.Cod_Rota; if (!acc[rota]) acc[rota] = []; acc[rota].push(p); } return acc; }, {}); const pedidosEmCargas3_4 = new Set(); Object.keys(largeOrdersByRoute).forEach(rota => { if (largeOrdersByRoute[rota].length === 1) { const largeOrder = largeOrdersByRoute[rota][0]; if (pedidosEmCargas3_4.has(largeOrder.Num_Pedido)) return; let newLoad = { pedidos: [largeOrder], totalKg: parseFloat(String(largeOrder.Quilos_Saldo).replace(',', '.')) || 0, rota: rota }; const otherOrdersInRoute = pedidosGeraisFiltrados.filter(p => p.Cod_Rota === rota && p.Num_Pedido !== largeOrder.Num_Pedido).sort((a, b) => (parseFloat(String(b.Quilos_Saldo).replace(',', '.')) || 0) - (parseFloat(String(a.Quilos_Saldo).replace(',', '.')) || 0)); for (const order of otherOrdersInRoute) { if (pedidosEmCargas3_4.has(order.Num_Pedido)) continue; const orderKg = parseFloat(String(order.Quilos_Saldo).replace(',', '.')) || 0; if (newLoad.totalKg + orderKg <= MAX_KG_3_4) { newLoad.pedidos.push(order); newLoad.totalKg += orderKg; } } if (newLoad.totalKg >= MIN_KG_3_4) { tresQuartosLoads.push(newLoad); newLoad.pedidos.forEach(p => pedidosEmCargas3_4.add(p.Num_Pedido)); } } }); tresQuartosLoads.forEach((load, index) => { load.numero = index + 1; }); displayTresQuartos(resultadoTresQuartosDiv, tresQuartosLoads); pedidosGeraisAtuais = pedidosGeraisFiltrados.filter(p => !pedidosEmCargas3_4.has(p.Num_Pedido)); const gruposGerais = pedidosGeraisAtuais.reduce((acc, p) => { const rota = p.Cod_Rota; if (!acc[rota]) { acc[rota] = { pedidos: [], totalKg: 0 }; } acc[rota].pedidos.push(p); acc[rota].totalKg += parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0; return acc; }, {}); displayGerais(resultadoGeralDiv, gruposGerais); } catch (error) { statusDiv.innerHTML = `<p class="text-danger"><strong>Ocorreu um erro:</strong></p><pre>${error.stack}</pre>`; console.error(error); } finally { loadingModal.hide(); } }, 100); }
        createTable = function(pedidos, columnsToDisplay) { if (!pedidos || pedidos.length === 0) return ''; const colunasExibir = columnsToDisplay || ['Cod_Rota', 'Cliente', 'Nome_Cliente', 'Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cidade', 'BLOQ.', 'Coluna4', 'Coluna5', 'CF']; let table = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped"><thead><tr>'; colunasExibir.forEach(c => table += `<th>${c}</th>`); table += '</tr></thead><tbody>'; pedidos.forEach(p => { table += `<tr id="pedido-${p.Num_Pedido}">`; colunasExibir.forEach(c => table += `<td>${p[c] === undefined || p[c] === null ? '' : p[c]}</td>`); table += '</tr>'; }); table += '</tbody></table></div>'; return table; }
        displayGerais = function(div, grupos) { if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhum pedido geral encontrado.</div>'; return; } let accordionHtml = '<div class="accordion accordion-flush" id="accordionGeral">'; Object.keys(grupos).sort().forEach((rota, index) => { const grupo = grupos[rota]; const totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingGeral${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeral${index}"><strong>Rota: ${rota}</strong> &nbsp; <span class="badge bg-secondary ms-2">${grupo.pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span></button></h2><div id="collapseGeral${index}" class="accordion-collapse collapse" data-bs-parent="#accordionGeral"><div class="accordion-body">${createTable(grupo.pedidos)}</div></div></div>`; }); accordionHtml += '</div>'; div.innerHTML = accordionHtml; }
        displayTresQuartos = function(div, loads) { if (loads.length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhuma carga 3/4 formada automaticamente.</div>'; return; } const MAX_KG_3_4 = 4100; let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h3 class="mb-0">Cargas 3/4 (Automático):</h3><button class="btn btn-sm btn-outline-light" onclick="imprimirCargasTresQuartosAutomatico('${div.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir Concluídas</button></div>`; loads.forEach(load => { const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); const weightPercent = (load.totalKg / MAX_KG_3_4 * 100); const progressBar = `<div class="progress-container text-dark"><small>${totalKgFormatado} kg / ${MAX_KG_3_4} kg</small><div class="progress" style="height: 10px;"><div class="progress-bar ${weightPercent > 100 ? 'bg-danger' : 'bg-dark'}" role="progressbar" style="width: ${Math.min(weightPercent, 100)}%;" aria-valuenow="${weightPercent.toFixed(2)}"></div></div></div>`; html += `<div class="card mb-3"><div class="card-header bg-warning text-dark"><div>Carga 3/4 #${load.numero} (Rota: ${load.rota})</div>${progressBar}</div><div class="card-body">${createTable(load.pedidos)}</div></div>`; }); div.innerHTML = html; }
        separarCargas34 = function(routeOrRoutes, divId, title) { const resultadoDiv = document.getElementById(divId); resultadoDiv.innerHTML = ''; if (planilhaData.length === 0) { resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; return; } const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [routeOrRoutes]; const MIN_KG_3_4 = 2300; const MAX_KG_3_4 = 4100; const pedidosRota = pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota))); const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO']; const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim()); let packableItems = []; const otherPedidos = pedidosRota.filter(p => !isSpecialClient(p)); const specialPedidos = pedidosRota.filter(p => isSpecialClient(p)); specialPedidos.forEach(pedido => { packableItems.push({ isSpecial: true, pedidos: [pedido], totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0, totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0 }); }); const otherClientGroupsMap = otherPedidos.reduce((acc, pedido) => { const clienteId = pedido.Cliente; if (!acc[clienteId]) { acc[clienteId] = { isSpecial: false, pedidos: [], totalKg: 0, totalCubagem: 0 }; } acc[clienteId].pedidos.push(pedido); return acc; }, {}); Object.values(otherClientGroupsMap).forEach(group => { group.totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0); group.totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0); packableItems.push(group); }); const priorityItems = packableItems.filter(item => item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)))); const regularItems = packableItems.filter(item => !item.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido)))); priorityItems.sort((a, b) => b.totalKg - a.totalKg); regularItems.sort((a, b) => b.totalKg - a.totalKg); packableItems = [...priorityItems, ...regularItems]; let tresQuartosLoads = [], leftoverItems = []; packableItems.forEach(item => { if (item.totalKg > MAX_KG_3_4) { leftoverItems.push(item); return; } let placed = false; for (const load of tresQuartosLoads) { const specialCountInLoad = load.pedidos.filter(p => isSpecialClient(p)).length, specialOrdersInItem = item.isSpecial ? item.pedidos.length : 0; if ((load.totalKg + item.totalKg <= MAX_KG_3_4) && (specialCountInLoad + specialOrdersInItem <= 2)) { load.pedidos.push(...item.pedidos); load.totalKg += item.totalKg; load.totalCubagem += item.totalCubagem; placed = true; break; } } if (!placed) { tresQuartosLoads.push({ pedidos: [...item.pedidos], totalKg: item.totalKg, totalCubagem: item.totalCubagem }); } }); let finalLoads = [], unplacedFromMinRule = []; tresQuartosLoads.forEach(load => { const hasPriority = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))); if (hasPriority || load.totalKg >= MIN_KG_3_4) { finalLoads.push(load); } else { unplacedFromMinRule.push(...load.pedidos); } }); finalLoads.forEach((load, index) => { load.numero = index + 1; }); let leftoverPedidos = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule); let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h3 class="mb-0">${finalLoads.length} Carga(s) de 3/4 para ${title}:</h3><button class="btn btn-sm btn-outline-light" onclick="imprimirCargas34('${divId}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir Concluídas</button></div>`; if (finalLoads.length === 0) { html += '<p>Nenhuma carga de 3/4 foi formada.</p>'; } else { finalLoads.forEach(load => { const totalKgFormatado = load.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); const isPriorityLoad = load.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))); const priorityBadge = isPriorityLoad ? '<span class="badge bg-dark ms-3">PRIORIDADE</span>' : ''; const weightPercent = (load.totalKg / MAX_KG_3_4 * 100); const progressBar = `<div class="progress-container text-dark"><small>${totalKgFormatado} kg / ${MAX_KG_3_4} kg</small><div class="progress" style="height: 10px;"><div class="progress-bar ${weightPercent > 100 ? 'bg-danger' : 'bg-dark'}" role="progressbar" style="width: ${Math.min(weightPercent, 100)}%;" aria-valuenow="${weightPercent.toFixed(2)}"></div></div></div>`; html += `<div class="card mb-3 ${isPriorityLoad ? 'border-primary' : ''}"><div class="card-header bg-warning text-dark"><div>Carga 3/4 #${load.numero} - Total: ${totalKgFormatado} kg ${priorityBadge}</div>${progressBar}</div><div class="card-body">${createTable(load.pedidos)}</div></div>`; }); } if (leftoverPedidos.length > 0) { const totalKgUnassigned = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0); html += `<h4 class="mt-4">Pedidos restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h4><div class="card mb-3"><div class="card-header bg-danger text-white">Detalhes dos Pedidos Restantes</div><div class="card-body">${createTable(leftoverPedidos, ['Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cliente', 'Nome_Cliente', 'Cidade'])}</div></div>`; } resultadoDiv.innerHTML = html; }
        separarCargasVan = function(routeOrRoutes, divId, title) { const resultadoDiv = document.getElementById(divId); resultadoDiv.innerHTML = ''; if (planilhaData.length === 0) { resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; return; } const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [routeOrRoutes]; const MIN_KG_VAN = 1100; const MAX_KG_VAN = 1560; const MAX_CUBAGEM_VAN = 5.0; const pedidosRota = pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota))); const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO']; const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim()); let packableItems = []; const otherPedidos = pedidosRota.filter(p => !isSpecialClient(p)); const specialPedidos = pedidosRota.filter(p => isSpecialClient(p)); specialPedidos.forEach(pedido => { packableItems.push({ isSpecial: true, pedidos: [pedido], totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0, totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0 }); }); const otherClientGroupsMap = otherPedidos.reduce((acc, pedido) => { const clienteId = pedido.Cliente; if (!acc[clienteId]) { acc[clienteId] = { isSpecial: false, pedidos: [], totalKg: 0, totalCubagem: 0 }; } acc[clienteId].pedidos.push(pedido); return acc; }, {}); Object.values(otherClientGroupsMap).forEach(group => { group.totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0); group.totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0); packableItems.push(group); }); packableItems.sort((a, b) => b.totalKg - a.totalKg); let vanLoads = [], leftoverItems = []; packableItems.forEach(item => { if (item.totalKg > MAX_KG_VAN || item.totalCubagem > MAX_CUBAGEM_VAN) { leftoverItems.push(item); return; } let placed = false; for (const van of vanLoads) { const specialCountInVan = van.pedidos.filter(p => isSpecialClient(p)).length, specialOrdersInItem = item.isSpecial ? item.pedidos.length : 0; if ((van.totalKg + item.totalKg <= MAX_KG_VAN) && (van.totalCubagem + item.totalCubagem <= MAX_CUBAGEM_VAN) && (specialCountInVan + specialOrdersInItem <= 2)) { van.pedidos.push(...item.pedidos); van.totalKg += item.totalKg; van.totalCubagem += item.totalCubagem; placed = true; break; } } if (!placed) { vanLoads.push({ pedidos: [...item.pedidos], totalKg: item.totalKg, totalCubagem: item.totalCubagem }); } }); let finalVanLoads = [], unplacedFromMinRule = []; vanLoads.forEach(van => { const hasPriority = van.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))); if (hasPriority || van.totalKg >= MIN_KG_VAN) { finalVanLoads.push(van); } else { unplacedFromMinRule.push(...van.pedidos); } }); finalVanLoads.forEach((van, index) => { van.numero = index + 1; }); let leftoverPedidos = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule); let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h3 class="mb-0">${finalVanLoads.length} Carga(s) de Van para ${title}:</h3><button class="btn btn-sm btn-outline-light" onclick="imprimirCargasVan('${divId}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir Concluídas</button></div>`; if (finalVanLoads.length === 0) { html += '<p>Nenhuma carga de Van foi formada.</p>'; } else { finalVanLoads.forEach(van => { const totalKgFormatado = van.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); const totalCubagemFormatado = van.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); const isPriorityLoad = van.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))); const priorityBadge = isPriorityLoad ? '<span class="badge bg-light text-dark ms-3">PRIORIDADE</span>' : ''; const weightPercent = (van.totalKg / MAX_KG_VAN * 100); const progressBar = `<div class="progress-container text-white"><small>${totalKgFormatado} kg / ${MAX_KG_VAN} kg</small><div class="progress" style="height: 10px;"><div class="progress-bar ${weightPercent > 100 ? 'bg-danger' : 'bg-light'}" role="progressbar" style="width: ${Math.min(weightPercent, 100)}%;" aria-valuenow="${weightPercent.toFixed(2)}"></div></div></div>`; html += `<div class="card mb-3 ${isPriorityLoad ? 'border-primary' : ''}"><div class="card-header bg-primary text-white"><div>Van #${van.numero} - Total: ${totalKgFormatado} kg / ${totalCubagemFormatado} m³ ${priorityBadge}</div>${progressBar}</div><div class="card-body">${createTable(van.pedidos)}</div></div>`; }); } if (leftoverPedidos.length > 0) { const totalKgUnassigned = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0); html += `<h4 class="mt-4">Pedidos restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h4><div class="card mb-3"><div class="card-header bg-danger text-white">Detalhes dos Pedidos Restantes</div><div class="card-body">${createTable(leftoverPedidos, ['Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cliente', 'Nome_Cliente', 'Cidade'])}</div></div>`; } resultadoDiv.innerHTML = html; }
        separarCargasFiorino = function(routeOrRoutes, divId, title) { const resultadoDiv = document.getElementById(divId); resultadoDiv.innerHTML = ''; if (planilhaData.length === 0) { resultadoDiv.innerHTML = '<p class="text-danger">Nenhum dado de planilha carregado.</p>'; return; } const routes = Array.isArray(routeOrRoutes) ? routeOrRoutes : [routeOrRoutes]; const MAX_KG_FIORINO = 570; const MAX_CUBAGEM_FIORINO = 1.5; const MIN_KG_FIORINO = 330; const pedidosRota = pedidosGeraisAtuais.filter(p => routes.includes(String(p.Cod_Rota))); const specialClientNames = ['IRMAOS MUFFATO S.A', 'FINCO & FINCO']; const isSpecialClient = (p) => p.Nome_Cliente && specialClientNames.includes(p.Nome_Cliente.toUpperCase().trim()); let packableItems = []; const otherPedidos = pedidosRota.filter(p => !isSpecialClient(p)); const specialPedidos = pedidosRota.filter(p => isSpecialClient(p)); specialPedidos.forEach(pedido => { packableItems.push({ isSpecial: true, pedidos: [pedido], totalKg: parseFloat(String(pedido.Quilos_Saldo).replace(',', '.')) || 0, totalCubagem: parseFloat(String(pedido.Cubagem).replace(',', '.')) || 0 }); }); const otherClientGroupsMap = otherPedidos.reduce((acc, pedido) => { const clienteId = pedido.Cliente; if (!acc[clienteId]) { acc[clienteId] = { isSpecial: false, pedidos: [], totalKg: 0, totalCubagem: 0 }; } acc[clienteId].pedidos.push(pedido); return acc; }, {}); Object.values(otherClientGroupsMap).forEach(group => { group.totalKg = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0); group.totalCubagem = group.pedidos.reduce((sum, p) => sum + (parseFloat(String(p.Cubagem).replace(',', '.')) || 0), 0); packableItems.push(group); }); packableItems.sort((a, b) => b.totalKg - a.totalKg); let fiorinoLoads = [], leftoverItems = []; packableItems.forEach(item => { if (item.totalKg > MAX_KG_FIORINO || item.totalCubagem > MAX_CUBAGEM_FIORINO) { leftoverItems.push(item); return; } let placed = false; for (const fiorino of fiorinoLoads) { const specialCountInFiorino = fiorino.pedidos.filter(p => isSpecialClient(p)).length, specialOrdersInItem = item.isSpecial ? item.pedidos.length : 0; if ((fiorino.totalKg + item.totalKg <= MAX_KG_FIORINO) && (fiorino.totalCubagem + item.totalCubagem <= MAX_CUBAGEM_FIORINO) && (specialCountInFiorino + specialOrdersInItem <= 2)) { fiorino.pedidos.push(...item.pedidos); fiorino.totalKg += item.totalKg; fiorino.totalCubagem += item.totalCubagem; placed = true; break; } } if (!placed) { fiorinoLoads.push({ pedidos: [...item.pedidos], totalKg: item.totalKg, totalCubagem: item.totalCubagem }); } }); let finalFiorinoLoads = [], unplacedFromMinRule = []; fiorinoLoads.forEach(fiorino => { const hasPriority = fiorino.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))); if (hasPriority || fiorino.totalKg >= MIN_KG_FIORINO) { finalFiorinoLoads.push(fiorino); } else { unplacedFromMinRule.push(...fiorino.pedidos); } }); finalFiorinoLoads.forEach((fiorino, index) => { fiorino.numero = index + 1; fiorino.estimatedDistance = calculateEstimatedDistance(fiorino.pedidos); }); finalFiorinoLoads.sort((a, b) => a.estimatedDistance - b.estimatedDistance); let leftoverPedidos = leftoverItems.flatMap(item => item.pedidos).concat(unplacedFromMinRule); let html = `<div class="d-flex justify-content-between align-items-center mb-2"><h3 class="mb-0">${finalFiorinoLoads.length} Carga(s) de Fiorino para ${title}:</h3><button class="btn btn-sm btn-outline-light" onclick="imprimirCargas('${divId}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir Concluídas</button></div>`; if (finalFiorinoLoads.length === 0) { html += '<p>Nenhuma carga de Fiorino foi formada.</p>'; } else { finalFiorinoLoads.forEach(fiorino => { const totalKgFormatado = fiorino.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), totalCubagemFormatado = fiorino.totalCubagem.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), estimatedDistanceFormatted = fiorino.estimatedDistance.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); const isPriorityLoad = fiorino.pedidos.some(p => pedidosPrioritarios.includes(String(p.Num_Pedido))), priorityBadge = isPriorityLoad ? '<span class="badge bg-light text-dark ms-3">PRIORIDADE</span>' : ''; const weightPercent = (fiorino.totalKg / MAX_KG_FIORINO * 100); const progressBar = `<div class="progress-container text-white"><small>${totalKgFormatado} kg / ${MAX_KG_FIORINO} kg</small><div class="progress" style="height: 10px;"><div class="progress-bar ${weightPercent > 100 ? 'bg-danger' : 'bg-light'}" role="progressbar" style="width: ${Math.min(weightPercent, 100)}%;" aria-valuenow="${weightPercent.toFixed(2)}"></div></div></div>`; html += `<div class="card mb-3 ${isPriorityLoad ? 'border-primary' : ''}"><div class="card-header bg-success text-white"><div>Fiorino #${fiorino.numero} - ${totalCubagemFormatado} m³ (Dist. Estimada: ${estimatedDistanceFormatted} km) ${priorityBadge}</div>${progressBar}</div><div class="card-body">${createTable(fiorino.pedidos)}</div></div>`; }); } if (leftoverPedidos.length > 0) { const totalKgUnassigned = leftoverPedidos.reduce((sum, p) => sum + (parseFloat(String(p.Quilos_Saldo).replace(',', '.')) || 0), 0); html += `<h4 class="mt-4">Pedidos restantes: ${totalKgUnassigned.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</h4><div class="card mb-3"><div class="card-header bg-danger text-white">Detalhes dos Pedidos Restantes</div><div class="card-body">${createTable(leftoverPedidos, ['Num_Pedido', 'Quilos_Saldo', 'Cubagem', 'Cliente', 'Nome_Cliente', 'Cidade'])}</div></div>`; } resultadoDiv.innerHTML = html; }
        displayToco = function(div, grupos) { if (Object.keys(grupos).length === 0) { div.innerHTML = '<div class="text-center p-3">Nenhuma carga toco encontrada.</div>'; return; } let accordionHtml = '<div class="accordion accordion-flush" id="accordionToco">'; Object.keys(grupos).sort().forEach((cf, index) => { const grupo = grupos[cf], pedidos = grupo.pedidos, totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); accordionHtml += `<div class="accordion-item"><h2 class="accordion-header" id="headingToco${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToco${index}"><strong>CF: ${cf}</strong> &nbsp; <span class="badge bg-secondary ms-2">${pedidos.length} pedidos</span> <span class="badge bg-info ms-2">${totalKgFormatado} kg</span></button></h2><div id="collapseToco${index}" class="accordion-collapse collapse" data-bs-parent="#accordionToco"><div class="accordion-body"><button class="btn btn-sm btn-outline-info mb-3" onclick="imprimirTocoIndividual('${cf}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-1" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 7a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12z"/></svg>Imprimir esta Carga Toco</button>${createTable(pedidos)}</div></div></div>`; }); div.innerHTML = accordionHtml + '</div>'; }
        genericPrint = function(title, content, style) { const printWindow = window.open('', '', 'height=800,width=1200'); printWindow.document.write(`<html><head><title>${title}</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"><style>${style}</style></head><body><h3>${title}</h3>${content}</body></html>`); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500); }
        imprimirCargas = function(divId) { const divToPrint = document.getElementById(divId); if (!divToPrint) return; const loads = divToPrint.querySelectorAll('.card-header.bg-success'); if (loads.length === 0) return alert("Nenhuma carga de Fiorino concluída para imprimir."); let content = ''; loads.forEach(h => content += h.closest('.card.mb-3').outerHTML); genericPrint('Cargas de Fiorino Concluídas', content, `body{margin:20px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.card{break-inside:avoid;margin-bottom:1rem}.card-header{background-color:#198754!important;color:#fff!important}.progress-bar{background-color:#fff!important}table,th,td{border:1px solid #dee2e6!important}`); }
        imprimirCargasVan = function(divId) { const divToPrint = document.getElementById(divId); if (!divToPrint) return; const loads = divToPrint.querySelectorAll('.card-header.bg-primary'); if (loads.length === 0) return alert("Nenhuma carga de Van concluída para imprimir."); let content = ''; loads.forEach(h => content += h.closest('.card.mb-3').outerHTML); genericPrint('Cargas de Van Concluídas', content, `body{margin:20px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.card{break-inside:avoid;margin-bottom:1rem}.card-header{background-color:#0d6efd!important;color:#fff!important}.progress-bar{background-color:#fff!important}table,th,td{border:1px solid #dee2e6!important}`); }
        imprimirCargas34 = function(divId) { const divToPrint = document.getElementById(divId); if (!divToPrint) return; const loads = divToPrint.querySelectorAll('.card-header.bg-warning'); if (loads.length === 0) return alert("Nenhuma carga de 3/4 concluída para imprimir."); let content = ''; loads.forEach(h => content += h.closest('.card.mb-3').outerHTML); genericPrint('Cargas de 3/4 Concluídas', content, `body{margin:20px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.card{break-inside:avoid;margin-bottom:1rem}.card-header{background-color:#ffc107!important;color:#000!important}.progress-bar{background-color:#000!important}table,th,td{border:1px solid #dee2e6!important}`); }
        imprimirCargasTresQuartosAutomatico = function(divId) { const divToPrint = document.getElementById(divId); if (!divToPrint) return; const loads = divToPrint.querySelectorAll('.card-header.bg-warning'); if (loads.length === 0) return alert("Nenhuma carga 3/4 automática para imprimir."); let content = ''; loads.forEach(h => content += h.closest('.card.mb-3').outerHTML); genericPrint('Cargas 3/4 Automáticas Concluídas', content, `body{margin:20px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.card{break-inside:avoid;margin-bottom:1rem}.card-header{background-color:#ffc107!important;color:#000!important}.progress-bar{background-color:#000!important}table,th,td{border:1px solid #dee2e6!important}`); }
        imprimirTocoIndividual = function(cf) { if (!gruposToco[cf]) return alert(`Nenhuma carga Toco encontrada para o CF: ${cf}`); const grupo = gruposToco[cf], totalKgFormatado = grupo.totalKg.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); const content = createTable(grupo.pedidos); genericPrint(`Carga Toco CF: ${cf} - Total: ${totalKgFormatado} kg`, content, `body{margin:20px}table,th,td{border:1px solid #dee2e6!important}`); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
